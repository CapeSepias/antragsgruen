{"version":3,"sources":["shared/DraftSavingEngine.ts"],"names":["DraftSavingEngine","$form","$draftHint","keyBase","_this","this","$html","$","hasClass","localKey","Math","floor","random","key","append","localStorage","hasOwnProperty","indexOf","data","JSON","parse","getItem","lastEdit","Date","$link","__t","dateStr","Intl","DateTimeFormat","attr","weekday","year","month","day","hour","minute","format","find","text","click","ev","preventDefault","$li","delegateTarget","parents","first","bootbox","confirm","result","doRestore","doDelete","removeClass","window","setTimeout","saveInitialData","bind","setInterval","doBackup","prototype","inst","CKEDITOR","instances","getData","each","$input","val","foundChanged","dat","id","getTime","setItem","stringify","removeItem","remove","children","length","addClass","restoreKey","setData","i","el","selectlist","exports"],"mappings":"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","file":"DraftSavingEngine.js","sourcesContent":["export class DraftSavingEngine {\n    private $html: JQuery;\n    private localKey: string;\n\n    constructor(private $form: JQuery, private $draftHint: JQuery, keyBase: string) {\n        this.$html = $('html');\n\n        if (!this.$html.hasClass(\"localstorage\")) {\n            return;\n        }\n\n        this.localKey = keyBase + \"_\" + Math.floor(Math.random() * 1000000);\n\n        let key;\n\n        $form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + this.localKey + '\">');\n\n        for (key in localStorage) if (localStorage.hasOwnProperty(key)) {\n            if (key.indexOf(keyBase + \"_\") == 0) {\n                let data = JSON.parse(localStorage.getItem(key)),\n                    lastEdit = new Date(data['lastEdit']),\n                    $link = $(\"<li><a href='#' class='restore'></a> \" +\n                        \"<a href='#' class='delete glyphicon glyphicon-trash' title='\" + __t(\"std\", \"draft_del\") +\n                        \"'></a></li>\");\n\n\n                $link.data(\"key\", key);\n                let dateStr = new Intl.DateTimeFormat(this.$html.attr(\"lang\"), {\n                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',\n                    hour: 'numeric', minute: 'numeric'\n                }).format(lastEdit);\n                $link.find('.restore').text('Entwurf vom: ' + dateStr).click((ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_restore_confirm\"), (result) => {\n                        if (result) {\n                            this.doRestore($li);\n                        }\n                    });\n                });\n                $link.find('.delete').click((ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_del_confirm\"), (result) => {\n                        if (result) {\n                            this.doDelete($li);\n                        }\n                    });\n                });\n                this.$draftHint.find(\"ul\").append($link);\n                this.$draftHint.removeClass(\"hidden\");\n            }\n        }\n\n        window.setTimeout(this.saveInitialData.bind(this), 2000);\n\n        window.setInterval(this.doBackup.bind(this), 3000);\n    }\n\n    private saveInitialData() {\n        for (let inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                $(\"#\" + inst).data(\"original\", CKEDITOR.instances[inst].getData());\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            $input.data(\"original\", $input.val());\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\");\n            $input.data(\"original\", $input.val());\n        });\n    }\n\n    private doBackup() {\n        let data = {},\n            foundChanged = false,\n            inst;\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                let dat = CKEDITOR.instances[inst].getData();\n                data[inst] = dat;\n                if (dat != $(\"#\" + inst).data(\"original\")) {\n                    foundChanged = true;\n                }\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            data[$input.attr(\"id\")] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\"),\n                id = $(this).find(\".selectlist\").attr(\"id\");\n            data[id] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n\n        if (foundChanged) {\n            data['lastEdit'] = new Date().getTime();\n            localStorage.setItem(this.localKey, JSON.stringify(data));\n        } else {\n            localStorage.removeItem(this.localKey);\n        }\n    }\n\n    private doDelete($li: JQuery) {\n        localStorage.removeItem($li.data(\"key\"));\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    };\n\n    private doRestore($li: JQuery) {\n        let inst,\n            restoreKey = $li.data(\"key\"),\n            data = JSON.parse(localStorage.getItem(restoreKey));\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                if (typeof(data[inst]) != \"undefined\") {\n                    CKEDITOR.instances[inst].setData(data[inst]);\n                }\n            }\n        }\n        if (data.hasOwnProperty(\"amendmentEditorial_wysiwyg\") && data['amendmentEditorial_wysiwyg'] != '') {\n            if (!CKEDITOR.hasOwnProperty('amendmentEditorial_wysiwyg')) {\n                $(\".editorialChange .opener\").click();\n                window.setTimeout(function () {\n                    CKEDITOR.instances['amendmentEditorial_wysiwyg'].setData(data['amendmentEditorial_wysiwyg']);\n                }, 100);\n            }\n        }\n\n        $(\".form-group.plain-text\").each((i, el) => {\n            let $input = $(el).find(\"input[type=text]\");\n            if (typeof(data[$input.attr(\"id\")]) != \"undefined\") {\n                $input.val(data[$input.attr(\"id\")]);\n            }\n        });\n        $(\".form-group.amendmentStatus\").each((i, el) => {\n            let id = $(el).find(\".selectlist\").attr(\"id\");\n            if (typeof(data[id]) != \"undefined\") {\n                $('#' + id).selectlist('selectByValue', data[id]);\n            }\n        });\n\n        this.$form.find(\"input[name=draftId]\").remove();\n        this.$form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + restoreKey + '\">');\n\n        this.localKey = restoreKey;\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    }\n}\n"]}