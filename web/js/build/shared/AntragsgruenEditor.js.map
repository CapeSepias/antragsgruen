{"version":3,"sources":["shared/AntragsgruenEditor.ts"],"names":["AntragsgruenEditor","id","this","$el","$","initialized","data","console","error","attr","ckeditorConfig","createConfig","CKEDITOR","ENTER_BR","ENTER_P","editor","inline","initMaxLen","ckeditor_strip","html","tmp","document","createElement","innerHTML","textContent","innerText","ckeditor_charcount","text","normalizedText","replace","length","prototype","maxLenOnChange","currLen","getData","$currCounter","maxLen","$warning","removeClass","maxLenSoft","$submit","prop","addClass","$fieldset","parents","first","find","on","title","noStrike","trackChanged","allowDiffFormattings","enterMode","coreStyles_strike","element","attributes","class","overrides","coreStyles_underline","toolbarGroups","name","groups","removePlugins","extraPlugins","scayt_sLang","strikeEl","strikeClass","allowedContent","tooltips","getEditor","exports"],"mappings":"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","file":"AntragsgruenEditor.js","sourcesContent":["import domObject = CKEDITOR.dom.domObject;\nimport editor = CKEDITOR.editor;\n\nexport class AntragsgruenEditor {\n    private editor: editor;\n    private $el: JQuery;\n\n    private static ckeditor_strip(html: string): string {\n        let tmp = document.createElement(\"div\");\n        tmp.innerHTML = html;\n\n        if (tmp.textContent == '' && typeof tmp.innerText == 'undefined') {\n            return '';\n        }\n\n        return tmp.textContent || tmp.innerText;\n    }\n\n    private static ckeditor_charcount(text: string): number {\n        let normalizedText = text.replace(/(\\r\\n|\\n|\\r)/gm, \"\").replace(/^\\s+|\\s+$/g, \"\").replace(\"&nbsp;\", \"\");\n        normalizedText = AntragsgruenEditor.ckeditor_strip(normalizedText).replace(/^([\\s\\t\\r\\n]*)$/, \"\");\n\n        return normalizedText.length;\n    }\n\n    private $currCounter: JQuery;\n    private $warning: JQuery;\n    private $submit: JQuery;\n    private maxLen: number;\n    private maxLenSoft: boolean;\n\n    private maxLenOnChange() {\n        let currLen = AntragsgruenEditor.ckeditor_charcount(this.editor.getData());\n        this.$currCounter.text(currLen);\n        if (currLen > this.maxLen) {\n            this.$warning.removeClass('hidden');\n            if (!this.maxLenSoft) {\n                this.$submit.prop(\"disabled\", true);\n            }\n        } else {\n            this.$warning.addClass('hidden');\n            if (!this.maxLenSoft) {\n                this.$submit.prop(\"disabled\", false);\n            }\n        }\n    }\n\n    private initMaxLen() {\n        let $fieldset = this.$el.parents(\".wysiwyg-textarea\").first();\n        if (!$fieldset.data(\"max-len\")) {\n            return;\n        }\n\n        this.maxLen = $fieldset.data(\"max-len\");\n        this.maxLenSoft = false;\n        this.$warning = $fieldset.find('.maxLenTooLong');\n        this.$submit = this.$el.parents(\"form\").first().find(\"button[type=submit]\");\n        this.$currCounter = $fieldset.find(\".maxLenHint .counter\");\n\n        if (this.maxLen < 0) {\n            this.maxLenSoft = true;\n            this.maxLen = -1 * this.maxLen;\n        }\n\n        this.editor.on('change', this.maxLenOnChange);\n        this.maxLenOnChange();\n    }\n\n    private static createConfig(title: string, noStrike: boolean, trackChanged: boolean, allowDiffFormattings: boolean, enterMode: any): any {\n        let ckeditorConfig = {\n            coreStyles_strike: {\n                element: 'span',\n                attributes: {'class': 'strike'},\n                overrides: 'strike'\n            },\n            coreStyles_underline: {\n                element: 'span',\n                attributes: {'class': 'underline'}\n            },\n            toolbarGroups: [\n                {name: 'tools'},\n                {name: 'document', groups: ['mode', 'document', 'doctools']},\n                //{name: 'clipboard', groups: ['clipboard', 'undo']},\n                //{name: 'editing', groups: ['find', 'selection', 'spellchecker']},\n                //{name: 'forms'},\n                {name: 'basicstyles', groups: ['basicstyles', 'cleanup']},\n                {name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi']},\n                {name: 'links'},\n                {name: 'insert'},\n                {name: 'styles'},\n                {name: 'colors'},\n                {name: 'others'}\n            ],\n            removePlugins: 'stylescombo,save,showblocks,specialchar,about,preview,pastetext,magicline',\n            extraPlugins: 'tabletools',\n            scayt_sLang: 'de_DE',\n            title: title,\n            enterMode: enterMode\n        };\n\n        let strikeEl = (noStrike ? '' : ' s'),\n            strikeClass = (noStrike ? '' : ',strike'),\n            allowedContent = '';\n\n        if (trackChanged || allowDiffFormattings) {\n            allowedContent = 'strong' + strikeEl + ' em u sub sup;' +\n                'h2 h3 h4;' +\n                'ul ol li [data-*](ice-ins,ice-del,ice-cts,appendHint){list-style-type};' +\n                //'table tr td th tbody thead caption [border] {margin,padding,width,height,border,border-spacing,border-collapse,align,cellspacing,cellpadding};' +\n                'div [data-*](collidingParagraph,paragraphHolder,hasCollissions);' +\n                'p blockquote [data-*](ice-ins,ice-del,ice-cts,appendHint,collidingParagraphHead){border,margin,padding};' +\n                'span[data-*](ice-ins,ice-del,ice-cts,appendHint,underline' + strikeClass + ',subscript,superscript);' +\n                'a[href,data-*](ice-ins,ice-del,ice-cts,appendHint);' +\n                'br ins del[data-*](ice-ins,ice-del,ice-cts,appendHint);';\n        } else {\n            allowedContent = 'strong' + strikeEl + ' em u sub sup;' +\n                'ul ol li {list-style-type};' +\n                'h2 h3 h4;' +\n                //'table tr td th tbody thead caption [border] {margin,padding,width,height,border,border-spacing,border-collapse,align,cellspacing,cellpadding};' +\n                'p blockquote {border,margin,padding};' +\n                'span(underline' + strikeClass + ',subscript,superscript);' +\n                'a[href];';\n        }\n\n        if (trackChanged) {\n            ckeditorConfig.extraPlugins += ',lite';\n            ckeditorConfig['lite'] = {tooltips: false};\n        } else {\n            ckeditorConfig['removePlugins'] += ',lite';\n        }\n        ckeditorConfig['allowedContent'] = allowedContent;\n        // ckeditorConfig.pasteFilter = allowedContent; // Seems to break copy/pasting some <strong> formatting in 4.5.11\n\n        return ckeditorConfig\n    }\n\n    public getEditor(): editor {\n        return this.editor;\n    }\n\n    constructor(id) {\n        this.$el = $(\"#\" + id);\n\n        let initialized = this.$el.data(\"ckeditor_initialized\");\n        if (typeof (initialized) != \"undefined\" && initialized) {\n            console.error(\"Already initialized: \" + id);\n            return;\n        }\n        \n        this.$el.data(\"ckeditor_initialized\", \"1\");\n        this.$el.attr(\"contenteditable\", \"true\");\n\n        let ckeditorConfig = AntragsgruenEditor.createConfig(\n            this.$el.attr(\"title\"),\n            (this.$el.data(\"no-strike\") == '1'),\n            (this.$el.data('track-changed') == '1'),\n            (this.$el.data('allow-diff-formattings') == '1'),\n            (this.$el.data('enter-mode') == 'br' ? CKEDITOR.ENTER_BR : CKEDITOR.ENTER_P)\n        );\n\n        this.editor = CKEDITOR.inline(id, ckeditorConfig);\n\n        this.initMaxLen();\n    }\n}\n"]}