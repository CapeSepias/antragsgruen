define(["require","exports","../shared/AntragsgruenEditor"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,a,r=4,o=6,d=17,c=8,h=9;(a=n||(n={})).ORIGINAL="orig",a.PROPOSED_PROCEDURE="prop";var l=function(){function a(){}return a.init=function(e,t,n){a.statuses=e,a.versions=t,a.votingData=n,Object.keys(e).forEach(function(e){a.statusListeners[e]=[]})},a.getAmendmentStatus=function(e){return a.statuses[e]},a.getAmendmentVersion=function(e){return a.versions[e]},a.getAmendmentVotingData=function(e){return a.votingData[e]},a.registerParagraph=function(e,t){a.statusListeners[e].push(t)},a.setStatus=function(t,n){a.statuses[t]=n,a.statusListeners[t].forEach(function(e){e.onAmendmentStatusChanged(t,n)})},a.setVersion=function(e,t){a.versions[e]=t,a.statusListeners[e].forEach(function(e){e.onAmendmentVersionChanged()})},a.setVotesYes=function(e,t){a.votingData[e].votesYes=t},a.setVotesNo=function(e,t){a.votingData[e].votesNo=t},a.setVotesAbstention=function(e,t){a.votingData[e].votesAbstention=t},a.setVotesInvalid=function(e,t){a.votingData[e].votesInvalid=t},a.setVotesComment=function(e,t){a.votingData[e].comment=t},a.getAllStatuses=function(){return a.statuses},a.getAllVersions=function(){return a.versions},a.getAllVotingData=function(){return a.votingData},a.statusListeners={},a}(),i=function(){function i(){}return i.removeEmptyParagraphs=function(){$(".paragraphHolder").each(function(e,t){0==t.childNodes.length&&$(t).remove()})},i.accept=function(e,t){void 0===t&&(t=null);var n=$(e);n.hasClass("ice-ins")&&i.insertAccept(e,t),n.hasClass("ice-del")&&i.deleteAccept(e,t)},i.reject=function(e,t){void 0===t&&(t=null);var n=$(e);n.hasClass("ice-ins")&&i.insertReject(n,t),n.hasClass("ice-del")&&i.deleteReject(n,t)},i.insertReject=function(e,t){void 0===t&&(t=null);var n,a=e[0].nodeName.toLowerCase();n="li"==a?e.parent():e,"ul"==a||"ol"==a||"li"==a||"blockquote"==a||"pre"==a||"p"==a?(n.css("overflow","hidden").height(n.height()),n.animate({height:"0"},250,function(){n.remove(),$(".collidingParagraph:empty").remove(),i.removeEmptyParagraphs(),t&&t()})):(n.remove(),t&&t())},i.insertAccept=function(e,t){void 0===t&&(t=null);var n=$(e);n.removeClass("ice-cts ice-ins appendHint moved"),n.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg"),"ul"!=e.nodeName.toLowerCase()&&"ol"!=e.nodeName.toLowerCase()||n.children().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"li"==e.nodeName.toLowerCase()&&n.parent().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"ins"==e.nodeName.toLowerCase()&&n.replaceWith(n.html()),t&&t()},i.deleteReject=function(e,t){void 0===t&&(t=null),e.removeClass("ice-cts ice-del appendHint"),e.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg");var n=e[0].nodeName.toLowerCase();"ul"!=n&&"ol"!=n||e.children().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"li"==n&&e.parent().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"del"==n&&e.replaceWith(e.html()),t&&t()},i.deleteAccept=function(e,t){void 0===t&&(t=null);var n,a=e.nodeName.toLowerCase();n="li"==a?$(e).parent():$(e),"ul"==a||"ol"==a||"li"==a||"blockquote"==a||"pre"==a||"p"==a?(n.css("overflow","hidden").height(n.height()),n.animate({height:"0"},250,function(){n.remove(),$(".collidingParagraph:empty").remove(),i.removeEmptyParagraphs(),t&&t()})):(n.remove(),t&&t())},i}();t.MotionMergeChangeActions=i;var u=function(){function e(i,s,r,e){this.$element=i,this.parent=e;var o=null,d=null;i.popover({container:"body",animation:!1,trigger:"manual",placement:function(e){var a=$(e);return a.data("element",i),window.setTimeout(function(){var e=a.width(),t=i.offset().top,n=i.height();null===o&&0<e&&(o=s-e/2,(d=r+10)<t+19&&(d=t+19),t+n<d&&(d=t+n)),a.css("left",o+"px"),a.css("top",d+"px")},1),"bottom"},html:!0,content:this.getContent.bind(this)}),i.popover("show"),i.find("> .popover").on("mousemove",function(e){e.stopPropagation()}),window.setTimeout(this.removePopupIfInactive.bind(this),1e3)}return e.prototype.getContent=function(){var e=this.$element,t=e.data("cid");null==t&&(t=e.parent().data("cid")),e.parents(".texteditor").first().find("[data-cid="+t+"]").addClass("hover");var n=$('<div><button type="button" class="accept btn btn-sm btn-default"></button><button type="button" class="reject btn btn-sm btn-default"></button><a href="#" class="btn btn-small btn-default opener" target="_blank"><span class="glyphicon glyphicon-new-window"></span></a><div class="initiator" style="font-size: 0.8em;"></div></div>');if(n.find(".opener").attr("href",e.data("link")).attr("title",__t("merge","title_open_in_blank")),n.find(".initiator").text(__t("merge","initiated_by")+": "+e.data("username")),e.hasClass("ice-ins"))n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this));else if(e.hasClass("ice-del"))n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this));else if("li"==e[0].nodeName.toLowerCase()){var a=e.parent();a.hasClass("ice-ins")?(n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this))):a.hasClass("ice-del")?(n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this))):console.log("unknown",a)}else console.log("unknown",e),alert("unknown");return n},e.prototype.removePopupIfInactive=function(){return this.$element.is(":hover")?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):0<$("body").find(".popover:hover").length?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):void this.destroy()},e.prototype.affectedChangesets=function(){var e=this.$element.data("cid");return null==e&&(e=this.$element.parent().data("cid")),this.$element.parents(".texteditor").find("[data-cid="+e+"]")},e.prototype.performActionWithUI=function(e){var t=window.scrollX,n=window.scrollY;this.parent.saveEditorSnapshot(),this.destroy(),e.call(this),this.parent.focusTextarea(),window.scrollTo(t,n)},e.prototype.accept=function(){var n=this;this.performActionWithUI(function(){n.affectedChangesets().each(function(e,t){i.accept(t,function(){n.parent.onChanged()})})})},e.prototype.reject=function(){var n=this;this.performActionWithUI(function(){n.affectedChangesets().each(function(e,t){i.reject(t,function(){n.parent.onChanged()})})})},e.prototype.destroy=function(){this.$element.popover("hide").popover("destroy");var e=this.$element.data("cid");null==e&&(e=this.$element.parent().data("cid"));var n=!1;this.$element.parents(".texteditor").first().find("[data-cid="+e+"]").each(function(e,t){$(t).is(":hover")&&(n=!0)}),n||this.$element.parents(".texteditor").first().find("[data-cid="+e+"]").removeClass("hover");try{$(".popover").each(function(e,t){var n=$(t);n.data("element").is(":hover")||(n.popover("hide").popover("destroy"),n.remove(),console.warn("Removed stale window: ",n))})}catch(e){}},e}(),p=function(){function e(e,t,n){this.$holder=e,this.$changedIndicator=t,this.$mergeActionHolder=n,this.unchangedText=null,this.hasChanged=!1,this.changedListeners=[];var a=e.find(".texteditor"),i=new s.AntragsgruenEditor(a.attr("id"));this.texteditor=i.getEditor(),this.setText(this.texteditor.getData()),e.data("unchanged")&&(this.unchangedText=e.data("unchanged"),this.onChanged()),this.texteditor.on("change",this.onChanged.bind(this))}return e.prototype.prepareText=function(e){var t=$("<div>"+e+"</div>");t.find("ul.appendHint, ol.appendHint").each(function(e,t){var n=$(t),a=n.data("append-hint");n.find("> li").addClass("appendHint").attr("data-append-hint",a).attr("data-link",n.data("link")).attr("data-username",n.data("username")),n.removeClass("appendHint").removeData("append-hint")}),t.find(".moved .moved").removeClass("moved"),t.find(".moved").each(this.markupMovedParagraph.bind(this));var n=t.html();this.texteditor.setData(n),this.unchangedText=this.normalizeHtml(this.texteditor.getData()),this.texteditor.fire("saveSnapshot"),this.onChanged()},e.prototype.addChangedListener=function(e){this.changedListeners.push(e)},e.prototype.markupMovedParagraph=function(e,t){var n,a=$(t),i=a.data("moving-partner-paragraph");n=(n=a.hasClass("inserted")?__t("std","moved_paragraph_from"):__t("std","moved_paragraph_to")).replace(/##PARA##/,i+1),"LI"===a[0].nodeName&&(a=a.parent()),a.attr("data-moving-msg",n)},e.prototype.initializeTooltips=function(){var n=this;this.$holder.on("mouseover",".appendHint",function(e){var t=$(e.currentTarget);0<t.parents(".paragraphWrapper").first().find(".amendmentStatus.open").length||(f.activePopup&&f.activePopup.destroy(),f.activePopup=new u(t,e.pageX,e.pageY,n))})},e.prototype.acceptAll=function(){var e=this;this.saveEditorSnapshot(),this.$holder.find(".ice-ins").each(function(e,t){i.insertAccept(t)}),this.$holder.find(".ice-del").each(function(e,t){i.deleteAccept(t)}),this.onChanged(),window.setTimeout(function(){e.onChanged(),e.saveEditorSnapshot()},1e3)},e.prototype.rejectAll=function(){var e=this;this.saveEditorSnapshot(),this.$holder.find(".ice-ins").each(function(e,t){i.insertReject($(t))}),this.$holder.find(".ice-del").each(function(e,t){i.deleteReject($(t))}),this.onChanged(),window.setTimeout(function(){e.onChanged(),e.saveEditorSnapshot()},1e3)},e.prototype.saveEditorSnapshot=function(){this.texteditor.fire("saveSnapshot")},e.prototype.focusTextarea=function(){},e.prototype.getContent=function(){return this.texteditor.getData()},e.prototype.getUnchangedContent=function(){return this.unchangedText},e.prototype.setText=function(e){this.prepareText(e),this.initializeTooltips()},e.prototype.normalizeHtml=function(t){var n={"&nbsp;":" ","&ndash;":"-","&auml;":"ä","&ouml;":"ö","&uuml;":"ü","&Auml;":"Ä","&Ouml;":"Ö","&Uuml;":"Ü","&szlig;":"ß","&bdquo;":"„","&ldquo;":"“","&bull;":"•","&sect;":"§","&eacute;":"é","&rsquo;":"’","&euro;":"€"};return Object.keys(n).forEach(function(e){t=t.replace(new RegExp(e,"g"),n[e])}),t.replace(/\s+</g,"<").replace(/>\s+/g,">").replace(/<[^>]*>/g,"")},e.prototype.onChanged=function(){this.normalizeHtml(this.texteditor.getData())===this.unchangedText?(this.$changedIndicator.addClass("unchanged"),this.hasChanged=!1):(this.$changedIndicator.removeClass("unchanged"),this.hasChanged=!0),0<this.$holder.find(".ice-ins").length||0<this.$holder.find(".ice-del").length?this.$mergeActionHolder.removeClass("hidden"):this.$mergeActionHolder.addClass("hidden"),this.changedListeners.forEach(function(e){return e()})},e.prototype.hasChanges=function(){return this.hasChanged},e}(),g=function(){function e(e,t){var n=this;this.$holder=e,this.hasUnsavedChanges=!1,this.handledCollisions=[],this.sectionId=parseInt(e.data("sectionId")),this.paragraphId=parseInt(e.data("paragraphId"));var a=t.paragraphs&&t.paragraphs[this.sectionId+"_"+this.paragraphId]?t.paragraphs[this.sectionId+"_"+this.paragraphId]:null;a.handledCollisions&&(this.handledCollisions=a.handledCollisions);var i=e.find(".wysiwyg-textarea"),s=e.find(".changedIndicator"),r=e.find(".mergeActionHolder");this.textarea=new p(i,s,r),this.initButtons(),this.initSetCollisionsAsHandled(),e.find(".amendmentStatus").each(function(e,t){l.registerParagraph($(t).data("amendment-id"),n)}),this.textarea.addChangedListener(function(){return n.hasUnsavedChanges=!0})}return e.prototype.initSetCollisionsAsHandled=function(){var i=this;this.$holder.on("click","button.hideCollision",function(e){var t=$(e.currentTarget).parents(".collidingParagraph").first(),n=parseInt(t.data("amendment-id"),10),a=t.parent();t.remove(),0===a.children().length&&i.$holder.removeClass("hasCollisions"),i.handledCollisions.push(n),i.hasUnsavedChanges=!0})},e.prototype.initButtons=function(){var a=this;this.$holder.find(".toggleAmendment").on("click",function(e){var t=$(e.currentTarget).find(".amendmentActive"),n=function(){1===parseInt(t.val(),10)?(t.val("0"),t.parents(".btn-group").find(".btn").addClass("btn-default").removeClass("btn-success")):(t.val("1"),t.parents(".btn-group").find(".btn").removeClass("btn-default").addClass("btn-success")),a.reloadText(),a.hasUnsavedChanges=!0};a.textarea.hasChanges()?bootbox.confirm(__t("merge","reloadParagraph"),function(e){e&&n()}):n()});var i=function(e){var t=parseInt(e.data("amendment-id")),n=l.getAmendmentStatus(t),a=l.getAmendmentVersion(t),i=l.getAmendmentVotingData(t);e.find(".dropdown-menu .selected").removeClass("selected"),e.find(".dropdown-menu .status"+n).addClass("selected"),e.find(".dropdown-menu .version"+a).addClass("selected"),e.find(".votesYes").val(i.votesYes),e.find(".votesNo").val(i.votesNo),e.find(".votesAbstention").val(i.votesAbstention),e.find(".votesInvalid").val(i.votesInvalid),e.find(".votesComment").val(i.comment)};this.$holder.find(".btn-group.amendmentStatus").on("show.bs.dropdown",function(e){i($(e.currentTarget))}),this.$holder.find(".btn-group .setStatus").click(function(e){e.preventDefault();var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setStatus(n,parseInt($(e.currentTarget).data("status"))),i(t),a.hasUnsavedChanges=!0}),this.$holder.find(".btn-group .setVersion").on("click",function(e){e.preventDefault();var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setVersion(n,$(e.currentTarget).data("version")),i(t),a.hasUnsavedChanges=!0}),this.$holder.find(".btn-group .votesYes").on("keyup change",function(e){var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setVotesYes(n,parseInt($(e.currentTarget).val(),10)),a.hasUnsavedChanges=!0}),this.$holder.find(".btn-group .votesNo").on("keyup change",function(e){var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setVotesNo(n,parseInt($(e.currentTarget).val(),10)),a.hasUnsavedChanges=!0}),this.$holder.find(".btn-group .votesAbstention").on("keyup change",function(e){var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setVotesAbstention(n,parseInt($(e.currentTarget).val(),10)),a.hasUnsavedChanges=!0}),this.$holder.find(".btn-group .votesInvalid").on("keyup change",function(e){var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setVotesInvalid(n,parseInt($(e.currentTarget).val(),10)),a.hasUnsavedChanges=!0}),this.$holder.find(".btn-group .votesComment").on("keyup change",function(e){var t=$(e.currentTarget).parents(".btn-group"),n=parseInt(t.data("amendment-id"));l.setVotesComment(n,$(e.currentTarget).val()),a.hasUnsavedChanges=!0}),this.$holder.find(".mergeActionHolder .acceptAll").click(function(e){e.preventDefault(),a.textarea.acceptAll(),a.hasUnsavedChanges=!0}),this.$holder.find(".mergeActionHolder .rejectAll").click(function(e){e.preventDefault(),a.textarea.rejectAll(),a.hasUnsavedChanges=!0})},e.prototype.onAmendmentVersionChanged=function(){this.textarea.hasChanges()?console.log("Skipping, as there are changes"):this.reloadText()},e.prototype.onAmendmentStatusChanged=function(e,t){if(this.textarea.hasChanges())console.log("Skipping, as there are changes");else{var n=this.$holder.find(".amendmentStatus[data-amendment-id="+e+"]"),a=n.find(".btn"),i=n.find("input.amendmentActive");-1!==[r,o,d,c,h].indexOf(t)?(i.val("1"),a.removeClass("btn-default").addClass("btn-success")):(i.val("0"),a.addClass("btn-default").removeClass("btn-success")),this.reloadText()}},e.prototype.reloadText=function(){var n=this,a=[];this.$holder.find(".amendmentActive[value='1']").each(function(e,t){var n=parseInt($(t).data("amendment-id"));a.push({id:n,version:l.getAmendmentVersion(n)})});var e=this.$holder.data("reload-url").replace("DUMMY",JSON.stringify(a));$.get(e,function(e){n.textarea.setText(e.text);var t="";e.collisions.forEach(function(e){t+=e}),n.$holder.find(".collisionsHolder").html(t),0<e.collisions.length?n.$holder.addClass("hasCollisions"):n.$holder.removeClass("hasCollisions"),n.handledCollisions=[],n.hasUnsavedChanges=!0})},e.prototype.getDraftData=function(){var a=[];return this.$holder.find(".amendmentStatus").each(function(e,t){var n=$(t);0<n.find(".btn-success").length&&a.push(n.data("amendment-id"))}),{amendmentToggles:a,text:this.textarea.getContent(),unchanged:this.textarea.getUnchangedContent(),handledCollisions:this.handledCollisions}},e.prototype.onDraftChanged=function(){this.hasUnsavedChanges=!1},e}(),f=function(){function s(e){var a=this;this.paragraphs=[],this.hasUnsavedChanges=!1,s.$form=e;var i=JSON.parse(document.getElementById("mergeDraft").getAttribute("value"));l.init(i.amendmentStatuses,i.amendmentVersions,i.amendmentVotingData),$(".paragraphWrapper").each(function(e,t){var n=$(t);n.find(".wysiwyg-textarea").on("mousemove",function(e){s.currMouseX=e.offsetX}),a.paragraphs.push(new g(n,i))}),s.$form.on("submit",function(){a.hasUnsavedChanges=!0,a.saveDraft(!0),$(window).off("beforeunload",s.onLeavePage)}),$(window).on("beforeunload",s.onLeavePage),this.initDraftSaving()}return s.onLeavePage=function(){return __t("std","leave_changed_page")},s.prototype.setDraftDate=function(e){this.$draftSavingPanel.find(".lastSaved .none").hide();var t=$("html").attr("lang"),n=new Intl.DateTimeFormat(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1}).format(e);this.$draftSavingPanel.find(".lastSaved .value").text(n)},s.prototype.saveDraft=function(e){var t=this;if(void 0===e&&(e=!1),0!==this.paragraphs.filter(function(e){return e.hasUnsavedChanges}).length||this.hasUnsavedChanges){var i={amendmentStatuses:l.getAllStatuses(),amendmentVersions:l.getAllVersions(),amendmentVotingData:l.getAllVotingData(),paragraphs:{},sections:{}};$(".sectionType0").each(function(e,t){var n=$(t),a=n.data("section-id");i.sections[a]=n.find(".form-control").val()}),this.paragraphs.forEach(function(e){i.paragraphs[e.sectionId+"_"+e.paragraphId]=e.getDraftData()});var n=this.$draftSavingPanel.find("input[name=public]").prop("checked"),a=JSON.stringify(i);document.getElementById("mergeDraft").setAttribute("value",a),e||$.ajax({type:"POST",url:s.$form.data("draftSaving"),data:{public:n?1:0,data:a,_csrf:s.$form.find("> input[name=_csrf]").val()},success:function(e){e.success?(t.$draftSavingPanel.find(".savingError").addClass("hidden"),t.setDraftDate(new Date(e.date)),n?s.$form.find(".publicLink").removeClass("hidden"):s.$form.find(".publicLink").addClass("hidden")):(t.$draftSavingPanel.find(".savingError").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorNetwork").addClass("hidden"),t.$draftSavingPanel.find(".savingError .errorHolder").text(e.error).removeClass("hidden")),t.paragraphs.forEach(function(e){return e.onDraftChanged()}),t.hasUnsavedChanges=!1},error:function(){t.$draftSavingPanel.find(".savingError").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorNetwork").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorHolder").text("").addClass("hidden")}})}else console.log("Has no unsaved changes")},s.prototype.initAutosavingDraft=function(){var e=this,t=this.$draftSavingPanel.find("input[name=autosave]");if(window.setInterval(function(){t.prop("checked")&&e.saveDraft(!1)},5e3),localStorage){var n=localStorage.getItem("merging-draft-auto-save");null!==n&&t.prop("checked","1"==n)}t.on("change",function(){var e=t.prop("checked");localStorage&&localStorage.setItem("merging-draft-auto-save",e?"1":"0")}).trigger("change")},s.prototype.initDraftSaving=function(){var e=this;if(this.$draftSavingPanel=s.$form.find("#draftSavingPanel"),this.$draftSavingPanel.find(".saveDraft").on("click",function(){e.hasUnsavedChanges=!0,e.saveDraft(!1)}),this.$draftSavingPanel.find("input[name=public]").on("change",function(){e.hasUnsavedChanges=!0,e.saveDraft(!1)}),this.initAutosavingDraft(),this.$draftSavingPanel.data("resumed-date")){var t=new Date(this.$draftSavingPanel.data("resumed-date"));this.setDraftDate(t)}$(".sectionType0").on("change",function(){return e.hasUnsavedChanges=!0}),$("#yii-debug-toolbar").remove()},s.activePopup=null,s.currMouseX=null,s}();t.MotionMergeAmendments=f});
//# sourceMappingURL=MotionMergeAmendments.js.map
