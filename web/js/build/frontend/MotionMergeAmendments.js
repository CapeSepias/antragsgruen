define(["require","exports","../shared/AntragsgruenEditor"],function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function i(){}return i.removeEmptyParagraphs=function(){$(".paragraphHolder").each(function(e,t){0==t.childNodes.length&&$(t).remove()})},i.accept=function(e,t){void 0===t&&(t=null);var n=$(e);n.hasClass("ice-ins")&&i.insertAccept(e,t),n.hasClass("ice-del")&&i.deleteAccept(e,t)},i.reject=function(e,t){void 0===t&&(t=null);var n=$(e);n.hasClass("ice-ins")&&i.insertReject(n,t),n.hasClass("ice-del")&&i.deleteReject(n,t)},i.insertReject=function(e,t){void 0===t&&(t=null);var n,a=e[0].nodeName.toLowerCase();n="li"==a?e.parent():e,"ul"==a||"ol"==a||"li"==a||"blockquote"==a||"pre"==a||"p"==a?(n.css("overflow","hidden").height(n.height()),n.animate({height:"0"},250,function(){n.remove(),$(".collidingParagraph:empty").remove(),i.removeEmptyParagraphs(),t&&t()})):(n.remove(),t&&t())},i.insertAccept=function(e,t){void 0===t&&(t=null);var n=$(e);n.removeClass("ice-cts ice-ins appendHint moved"),n.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg"),"ul"!=e.nodeName.toLowerCase()&&"ol"!=e.nodeName.toLowerCase()||n.children().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"li"==e.nodeName.toLowerCase()&&n.parent().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"ins"==e.nodeName.toLowerCase()&&n.replaceWith(n.html()),t&&t()},i.deleteReject=function(e,t){void 0===t&&(t=null),e.removeClass("ice-cts ice-del appendHint"),e.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg");var n=e[0].nodeName.toLowerCase();"ul"!=n&&"ol"!=n||e.children().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"li"==n&&e.parent().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"del"==n&&e.replaceWith(e.html()),t&&t()},i.deleteAccept=function(e,t){void 0===t&&(t=null);var n,a=e.nodeName.toLowerCase();n="li"==a?$(e).parent():$(e),"ul"==a||"ol"==a||"li"==a||"blockquote"==a||"pre"==a||"p"==a?(n.css("overflow","hidden").height(n.height()),n.animate({height:"0"},250,function(){n.remove(),$(".collidingParagraph:empty").remove(),i.removeEmptyParagraphs(),t&&t()})):(n.remove(),t&&t())},i}();t.MotionMergeChangeActions=a;var n=function(){function e(i,r,o,e){this.$element=i,this.parent=e;var s=null,d=null;i.popover({container:"body",animation:!1,trigger:"manual",placement:function(e){var a=$(e);return window.setTimeout(function(){var e=a.width(),t=i.offset().top,n=i.height();null===s&&0<e&&(s=r-e/2,(d=o+10)<t+19&&(d=t+19),t+n<d&&(d=t+n)),a.css("left",s+"px"),a.css("top",d+"px")},1),"bottom"},html:!0,content:this.getContent.bind(this)}),i.popover("show"),i.find("> .popover").on("mousemove",function(e){e.stopPropagation()}),window.setTimeout(this.removePopupIfInactive.bind(this),1e3)}return e.prototype.getContent=function(){var e=this.$element,t=e.data("cid");null==t&&(t=e.parent().data("cid")),e.parents(".texteditor").first().find("[data-cid="+t+"]").addClass("hover");var n=$('<div><button type="button" class="accept btn btn-sm btn-default"></button><button type="button" class="reject btn btn-sm btn-default"></button><a href="#" class="btn btn-small btn-default opener" target="_blank"><span class="glyphicon glyphicon-new-window"></span></a><div class="initiator" style="font-size: 0.8em;"></div></div>');if(n.find(".opener").attr("href",e.data("link")).attr("title",__t("merge","title_open_in_blank")),n.find(".initiator").text(__t("merge","initiated_by")+": "+e.data("username")),e.hasClass("ice-ins"))n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this));else if(e.hasClass("ice-del"))n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this));else if("li"==e[0].nodeName.toLowerCase()){var a=e.parent();a.hasClass("ice-ins")?(n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this))):a.hasClass("ice-del")?(n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this))):console.log("unknown",a)}else console.log("unknown",e),alert("unknown");return n},e.prototype.removePopupIfInactive=function(){return this.$element.is(":hover")?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):0<$("body").find(".popover:hover").length?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):void this.destroy()},e.prototype.affectedChangesets=function(){var e=this.$element.data("cid");return null==e&&(e=this.$element.parent().data("cid")),this.$element.parents(".texteditor").find("[data-cid="+e+"]")},e.prototype.performActionWithUI=function(e){var t=window.scrollX,n=window.scrollY;this.parent.saveEditorSnapshot(),this.destroy(),e.call(this),this.parent.focusTextarea(),window.scrollTo(t,n)},e.prototype.accept=function(){var n=this;this.performActionWithUI(function(){n.affectedChangesets().each(function(e,t){a.accept(t,function(){n.parent.onChanged()})})})},e.prototype.reject=function(){var n=this;this.performActionWithUI(function(){n.affectedChangesets().each(function(e,t){a.reject(t,function(){n.parent.onChanged()})})})},e.prototype.destroy=function(){this.$element.popover("hide").popover("destroy");var e=this.$element.data("cid");null==e&&(e=this.$element.parent().data("cid")),this.$element.parents(".texteditor").first().find("[data-cid="+e+"]").removeClass("hover");try{var t=$(".popover");t.popover("hide").popover("destroy"),t.remove()}catch(e){}},e}(),s=function(){function e(e,t,n){var a=this;this.$holder=e,this.$changedIndicator=t,this.rootObject=n,this.unchangedText=null,this.hasChanged=!1;var i=e.find(".texteditor"),r=new o.AntragsgruenEditor(i.attr("id"));this.texteditor=r.getEditor(),this.rootObject.addSubmitListener(function(){e.find("textarea.raw").val(a.texteditor.getData()),e.find("textarea.consolidated").val(a.texteditor.getData())}),this.setText(this.texteditor.getData()),this.$holder.find(".acceptAllChanges").click(this.acceptAll.bind(this)),this.$holder.find(".rejectAllChanges").click(this.rejectAll.bind(this)),this.texteditor.on("change",this.onChanged.bind(this))}return e.prototype.prepareText=function(e){var t=$("<div>"+e+"</div>");t.find("ul.appendHint, ol.appendHint").each(function(e,t){var n=$(t),a=n.data("append-hint");n.find("> li").addClass("appendHint").attr("data-append-hint",a).attr("data-link",n.data("link")).attr("data-username",n.data("username")),n.removeClass("appendHint").removeData("append-hint")}),t.find(".moved .moved").removeClass("moved"),t.find(".moved").each(this.markupMovedParagraph.bind(this)),t.find(".hasCollisions").attr("data-collision-start-msg",__t("merge","colliding_start")).attr("data-collision-end-msg",__t("merge","colliding_end"));var n=t.html();this.texteditor.setData(n),this.unchangedText=this.normalizeHtml(this.texteditor.getData()),this.texteditor.fire("saveSnapshot"),this.onChanged()},e.prototype.markupMovedParagraph=function(e,t){var n,a=$(t),i=a.data("moving-partner-paragraph");n=(n=a.hasClass("inserted")?__t("std","moved_paragraph_from"):__t("std","moved_paragraph_to")).replace(/##PARA##/,i+1),"LI"===a[0].nodeName&&(a=a.parent()),a.attr("data-moving-msg",n)},e.prototype.initializeTooltips=function(){var t=this;this.$holder.on("mouseover",".appendHint",function(e){i.activePopup&&i.activePopup.destroy(),i.activePopup=new n($(e.currentTarget),e.pageX,e.pageY,t)})},e.prototype.acceptAll=function(){this.texteditor.fire("saveSnapshot"),this.$holder.find(".collidingParagraph").each(function(e,t){var n=$(t);n.find(".collidingParagraphHead").remove(),n.replaceWith(n.children())}),this.$holder.find(".ice-ins").each(function(e,t){a.insertAccept(t)}),this.$holder.find(".ice-del").each(function(e,t){a.deleteAccept(t)})},e.prototype.rejectAll=function(){this.texteditor.fire("saveSnapshot"),this.$holder.find(".collidingParagraph").each(function(e,t){$(t).remove()}),this.$holder.find(".ice-ins").each(function(e,t){a.insertReject($(t))}),this.$holder.find(".ice-del").each(function(e,t){a.deleteReject($(t))})},e.prototype.saveEditorSnapshot=function(){this.texteditor.fire("saveSnapshot")},e.prototype.focusTextarea=function(){},e.prototype.getContent=function(){return this.texteditor.getData()},e.prototype.setText=function(e){this.prepareText(e),this.initializeTooltips()},e.prototype.normalizeHtml=function(t){var n={"&nbsp;":" ","&ndash;":"-","&auml;":"ä","&ouml;":"ö","&uuml;":"ü","&Auml;":"Ä","&Ouml;":"Ö","&Uuml;":"Ü","&szlig;":"ß","&bdquo;":"„","&ldquo;":"“","&bull;":"•","&sect;":"§","&eacute;":"é","&rsquo;":"’","&euro;":"€"};return Object.keys(n).forEach(function(e){t=t.replace(new RegExp(e,"g"),n[e])}),t.replace(/\s+</g,"<").replace(/>\s+/g,">").replace(/<[^>]*>/g,"")},e.prototype.onChanged=function(){this.normalizeHtml(this.texteditor.getData())===this.unchangedText?(this.$changedIndicator.addClass("hidden"),this.hasChanged=!1):(this.$changedIndicator.removeClass("hidden"),this.hasChanged=!0)},e.prototype.hasChanges=function(){return this.hasChanged},e}(),d=function(){function e(e,t,n){this.$holder=e,this.textarea=t,this.amendmentStatuses=n,this.sectionId=parseInt(e.data("sectionId")),this.paragraphId=parseInt(e.data("paragraphId")),this.initButtons()}return e.prototype.initButtons=function(){var a=this;this.$holder.find(".toggleAmendment").click(function(e){var t=$(e.currentTarget).find(".amendmentActive"),n=function(){1===parseInt(t.val())?(t.val("0"),t.parents(".btn-group").find(".btn").addClass("btn-default").removeClass("btn-success")):(t.val("1"),t.parents(".btn-group").find(".btn").removeClass("btn-default").addClass("btn-success")),a.reloadText()};a.textarea.hasChanges()?bootbox.confirm(__t("merge","reloadParagraph"),function(e){e&&n()}):n()}),this.$holder.find(".btn-group.amendmentStatus").on("show.bs.dropdown",function(e,t){console.log("onShow",e,t)})},e.prototype.reloadText=function(){var n=this,a=[];this.$holder.find(".amendmentActive[value='1']").each(function(e,t){a.push(parseInt($(t).data("amendment-id")))});var e=this.$holder.data("reload-url").replace("DUMMY",a.join(","));$.get(e,function(e){n.textarea.setText(e.text);var t="";e.collisions.forEach(function(e){t+=e}),n.$holder.find(".collisionsHolder").html(t),0<e.collisions.length?n.$holder.addClass("hasCollisions"):n.$holder.removeClass("hasCollisions")})},e}(),i=function(){function o(e){var r=this;this.$form=e,this.textareas={},this.amendmentStatuses=e.data("amendment-statuses"),console.log(this.amendmentStatuses),$(".paragraphWrapper").each(function(e,t){var n=$(t),a=n.find(".wysiwyg-textarea"),i=n.find(".changedIndicator");r.textareas[a.attr("id")]=new s(a,i,r),a.on("mousemove",function(e){o.currMouseX=e.offsetX}),new d(n,r.textareas[a.attr("id")],r.amendmentStatuses)}),this.$form.on("submit",function(){$(window).off("beforeunload",o.onLeavePage)}),$(window).on("beforeunload",o.onLeavePage),this.initDraftSaving()}return o.onLeavePage=function(){return __t("std","leave_changed_page")},o.prototype.addSubmitListener=function(e){this.$form.submit(e)},o.prototype.setDraftDate=function(e){this.$draftSavingPanel.find(".lastSaved .none").hide();var t=$("html").attr("lang"),n=new Intl.DateTimeFormat(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1}).format(e);this.$draftSavingPanel.find(".lastSaved .value").text(n)},o.prototype.saveDraft=function(){for(var t=this,e={},n=0,a=Object.getOwnPropertyNames(this.textareas);n<a.length;n++){var i=a[n];e[i.replace("section_holder_","")]=this.textareas[i].getContent()}var r=this.$draftSavingPanel.find("input[name=public]").prop("checked");$.ajax({type:"POST",url:this.$form.data("draftSaving"),data:{public:r?1:0,sections:e,_csrf:this.$form.find("> input[name=_csrf]").val()},success:function(e){e.success?(t.$draftSavingPanel.find(".savingError").addClass("hidden"),t.setDraftDate(new Date(e.date)),r?t.$form.find(".publicLink").removeClass("hidden"):t.$form.find(".publicLink").addClass("hidden")):(t.$draftSavingPanel.find(".savingError").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorNetwork").addClass("hidden"),t.$draftSavingPanel.find(".savingError .errorHolder").text(e.error).removeClass("hidden"))},error:function(){t.$draftSavingPanel.find(".savingError").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorNetwork").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorHolder").text("").addClass("hidden")}})},o.prototype.initAutosavingDraft=function(){var e=this,t=this.$draftSavingPanel.find("input[name=autosave]");if(window.setInterval(function(){t.prop("checked")&&e.saveDraft()},5e3),localStorage){var n=localStorage.getItem("merging-draft-auto-save");null!==n&&t.prop("checked","1"==n)}t.change(function(){var e=t.prop("checked");localStorage&&localStorage.setItem("merging-draft-auto-save",e?"1":"0")}).trigger("change")},o.prototype.initDraftSaving=function(){if(this.$draftSavingPanel=this.$form.find("#draftSavingPanel"),this.$draftSavingPanel.find(".saveDraft").on("click",this.saveDraft.bind(this)),this.$draftSavingPanel.find("input[name=public]").on("change",this.saveDraft.bind(this)),this.initAutosavingDraft(),this.$draftSavingPanel.data("resumed-date")){var e=new Date(this.$draftSavingPanel.data("resumed-date"));this.setDraftDate(e)}$("#yii-debug-toolbar").remove()},o.activePopup=null,o.currMouseX=null,o}();t.MotionMergeAmendments=i});
//# sourceMappingURL=MotionMergeAmendments.js.map
