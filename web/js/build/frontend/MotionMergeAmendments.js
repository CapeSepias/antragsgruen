define(["require","exports","../shared/AntragsgruenEditor"],function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){}return t.accept=function(e){$(e).hasClass("ice-ins")&&t.insertAccept(e),$(e).hasClass("ice-del")&&t.deleteAccept(e)},t.reject=function(e){$(e).hasClass("ice-ins")&&t.insertReject(e),$(e).hasClass("ice-del")&&t.deleteReject(e)},t.insertReject=function(t){var e,i=t.nodeName.toLowerCase();e="li"==i?$(t).parent():$(t),"ul"==i||"ol"==i||"li"==i||"blockquote"==i||"pre"==i||"p"==i?(e.css("overflow","hidden").height(e.height()),e.animate({height:"0"},250,function(){e.remove(),$(".collidingParagraph:empty").remove()})):e.remove()},t.insertAccept=function(t){var e=$(t);e.removeClass("ice-cts ice-ins appendHint moved"),e.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg"),"ul"!=t.nodeName.toLowerCase()&&"ol"!=t.nodeName.toLowerCase()||e.children().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"li"==t.nodeName.toLowerCase()&&e.parent().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"ins"==t.nodeName.toLowerCase()&&e.replaceWith(e.html())},t.deleteReject=function(t){var e=$(t);e.removeClass("ice-cts ice-del appendHint"),e.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg"),"ul"!=t.nodeName.toLowerCase()&&"ol"!=t.nodeName.toLowerCase()||e.children().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"li"==t.nodeName.toLowerCase()&&e.parent().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"del"==t.nodeName.toLowerCase()&&e.replaceWith(e.html())},t.deleteAccept=function(t){var e,i=t.nodeName.toLowerCase();e="li"==i?$(t).parent():$(t),"ul"==i||"ol"==i||"li"==i||"blockquote"==i||"pre"==i||"p"==i?(e.css("overflow","hidden").height(e.height()),e.animate({height:"0"},250,function(){e.remove(),$(".collidingParagraph:empty").remove()})):e.remove()},t}(),a=function(){function t(t,e,i,n){this.$element=t,this.parent=n;var a=null,o=null;t.popover({container:"body",animation:!1,trigger:"manual",placement:function(n){var r=$(n);return window.setTimeout(function(){var n=r.width(),s=t.offset().top,c=t.height();null===a&&n>0&&(a=e-n/2,o=i+10,o<s+19&&(o=s+19),o>s+c&&(o=s+c)),r.css("left",a+"px"),r.css("top",o+"px")},1),"bottom"},html:!0,content:this.getContent.bind(this)}),t.popover("show"),t.find("> .popover").on("mousemove",function(t){t.stopPropagation()}),window.setTimeout(this.removePopupIfInactive.bind(this),1e3)}return t.prototype.getContent=function(){var t,e=this.$element,i=e.data("cid");void 0==i&&(i=e.parent().data("cid")),e.parents(".texteditor").first().find("[data-cid="+i+"]").addClass("hover"),t="<div>",t+='<button type="button" class="accept btn btn-sm btn-default"></button>',t+='<button type="button" class="reject btn btn-sm btn-default"></button>',t+='<a href="#" class="btn btn-small btn-default opener" target="_blank"><span class="glyphicon glyphicon-new-window"></span></a>',t+='<div class="initiator" style="font-size: 0.8em;"></div>',t+="</div>";var n=$(t);if(n.find(".opener").attr("href",e.data("link")).attr("title",__t("merge","title_open_in_blank")),n.find(".initiator").text(__t("merge","initiated_by")+": "+e.data("username")),e.hasClass("ice-ins"))n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this));else if(e.hasClass("ice-del"))n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this));else if("li"==e[0].nodeName.toLowerCase()){var a=e.parent();a.hasClass("ice-ins")?(n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this))):a.hasClass("ice-del")?(n.find("button.accept").text(__t("merge","change_accept")).click(this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).click(this.reject.bind(this))):console.log("unknown",a)}else console.log("unknown",e),alert("unknown");return n},t.prototype.removePopupIfInactive=function(){return this.$element.is(":hover")?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):$("body").find(".popover:hover").length>0?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):void this.destroy()},t.prototype.affectedChangesets=function(){var t=this.$element.data("cid");return void 0==t&&(t=this.$element.parent().data("cid")),this.$element.parents(".texteditor").find("[data-cid="+t+"]")},t.prototype.performActionWithUI=function(t){var e=window.scrollX,i=window.scrollY;this.parent.saveEditorSnapshot(),this.destroy(),t.call(this),$(".collidingParagraph:empty").remove(),this.parent.focusTextarea(),window.scrollTo(e,i)},t.prototype.accept=function(){var t=this;this.performActionWithUI(function(){t.affectedChangesets().each(function(t,e){n.accept(e)})})},t.prototype.reject=function(){var t=this;this.performActionWithUI(function(){t.affectedChangesets().each(function(t,e){n.reject(e)})})},t.prototype.destroy=function(){this.$element.popover("hide").popover("destroy");var t=this.$element.data("cid");void 0==t&&(t=this.$element.parent().data("cid")),this.$element.parents(".texteditor").first().find("[data-cid="+t+"]").removeClass("hover")},t}(),o=function(){function t(t,e,i){this.$element=t,this.parent=i,t.popover({container:"body",animation:!1,trigger:"manual",placement:"bottom",html:!0,title:__t("merge","colliding_title"),content:this.getContent.bind(this)}),t.popover("show");var n=$("body > .popover"),a=n.width();n.css("left",Math.floor(t.offset().left+e-a/2+20)+"px"),n.on("mousemove",function(t){t.stopPropagation()}),window.setTimeout(this.removePopupIfInactive.bind(this),500)}return t.prototype.removePopupIfInactive=function(){return this.$element.is(":hover")?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):$("body").find(".popover:hover").length>0?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):void this.destroy()},t.prototype.performActionWithUI=function(t){this.parent.saveEditorSnapshot(),this.destroy(),t.call(this),$(".collidingParagraph:empty").remove(),this.parent.focusTextarea()},t.prototype.getContent=function(){var t=this,e=this.$element,i='<div style="white-space: nowrap;"><button type="button" class="btn btn-small btn-default delTitle"><span style="text-decoration: line-through">'+__t("merge","title")+"</span></button>";i+='<button type="button" class="reject btn btn-small btn-default"><span class="glyphicon glyphicon-trash"></span></button>',i+='<a href="#" class="btn btn-small btn-default opener" target="_blank"><span class="glyphicon glyphicon-new-window"></span></a>',i+='<div class="initiator" style="font-size: 0.8em;"></div>',i+="</div>";var n=$(i);return n.find(".delTitle").attr("title",__t("merge","title_del_title")),n.find(".reject").attr("title",__t("merge","title_del_colliding")),n.find("a.opener").attr("href",e.find("a").attr("href")).attr("title",__t("merge","title_open_in_blank")),n.find(".initiator").text(__t("merge","initiated_by")+": "+e.parents(".collidingParagraph").data("username")),n.find(".reject").click(function(){t.performActionWithUI.call(t,function(){var t=e.parents(".collidingParagraph");t.css({overflow:"hidden"}).height(t.height()),t.animate({height:"0"},250,function(){var e=t.parents(".paragraphHolder");t.remove(),0==e.find(".collidingParagraph").length&&e.removeClass("hasCollissions")})})}),n.find(".delTitle").click(function(){t.performActionWithUI.call(t,function(){var t=e.parents(".collidingParagraph");e.remove(),t.removeClass("collidingParagraph");var i=t.parents(".paragraphHolder");0==i.find(".collidingParagraph").length&&i.removeClass("hasCollissions")})}),n},t.prototype.destroy=function(){var t=this.$element.data("cid");void 0==t&&(t=this.$element.parent().data("cid")),this.$element.parents(".texteditor").first().find("[data-cid="+t+"]").removeClass("hover"),this.$element.popover("hide").popover("destroy")},t}(),r=function(){function t(t,e){var n=this;this.$holder=t,this.rootObject=e;var a=t.find(".texteditor"),o=new i.AntragsgruenEditor(a.attr("id"));this.texteditor=o.getEditor(),this.rootObject.addSubmitListener(function(){t.find("textarea.raw").val(n.texteditor.getData()),t.find("textarea.consolidated").val(n.texteditor.getData())}),this.prepareText(),this.initializeTooltips(),this.$holder.find(".acceptAllChanges").click(this.acceptAll.bind(this)),this.$holder.find(".rejectAllChanges").click(this.rejectAll.bind(this))}return t.prototype.prepareText=function(){var t=$("<div>"+this.texteditor.getData()+"</div>");t.find("ul.appendHint, ol.appendHint").each(function(t,e){var i=$(e),n=i.data("append-hint");i.find("> li").addClass("appendHint").attr("data-append-hint",n).attr("data-link",i.data("link")).attr("data-username",i.data("username")),i.removeClass("appendHint").removeData("append-hint")}),t.find(".moved .moved").removeClass("moved"),t.find(".moved").each(this.markupMovedParagraph.bind(this)),t.find(".hasCollissions").attr("data-collission-start-msg",__t("merge","colliding_start")).attr("data-collission-end-msg",__t("merge","colliding_end"));var e=t.html();this.texteditor.setData(e)},t.prototype.markupMovedParagraph=function(t,e){var i,n=$(e),a=n.data("moving-partner-paragraph");i=n.hasClass("inserted")?__t("std","moved_paragraph_from"):__t("std","moved_paragraph_to"),i=i.replace(/##PARA##/,a+1),"LI"===n[0].nodeName&&(n=n.parent()),n.attr("data-moving-msg",i)},t.prototype.initializeTooltips=function(){var t=this;this.$holder.on("mouseover",".collidingParagraphHead",function(e){$(e.target).parents(".collidingParagraph").addClass("hovered"),s.activePopup&&s.activePopup.destroy(),s.activePopup=new o($(e.currentTarget),s.currMouseX,t)}).on("mouseout",".collidingParagraphHead",function(t){$(t.target).parents(".collidingParagraph").removeClass("hovered")}),this.$holder.on("mouseover",".appendHint",function(e){s.activePopup&&s.activePopup.destroy(),s.activePopup=new a($(e.currentTarget),e.pageX,e.pageY,t)})},t.prototype.acceptAll=function(){this.texteditor.fire("saveSnapshot"),this.$holder.find(".collidingParagraph").each(function(t,e){var i=$(e);i.find(".collidingParagraphHead").remove(),i.replaceWith(i.children())}),this.$holder.find(".ice-ins").each(function(t,e){n.insertAccept(e)}),this.$holder.find(".ice-del").each(function(t,e){n.deleteAccept(e)})},t.prototype.rejectAll=function(){this.texteditor.fire("saveSnapshot"),this.$holder.find(".collidingParagraph").each(function(t,e){$(e).remove()}),this.$holder.find(".ice-ins").each(function(t,e){n.insertReject(e)}),this.$holder.find(".ice-del").each(function(t,e){n.deleteReject(e)})},t.prototype.saveEditorSnapshot=function(){this.texteditor.fire("saveSnapshot")},t.prototype.focusTextarea=function(){},t.prototype.getContent=function(){return this.texteditor.getData()},t}(),s=function(){function t(e){var i=this;this.$form=e,this.textareas={},$(".wysiwyg-textarea").each(function(e,n){var a=$(n);i.textareas[a.attr("id")]=new r(a,i),a.on("mousemove",function(e){t.currMouseX=e.offsetX})}),this.$form.on("submit",function(){$(window).off("beforeunload",t.onLeavePage)}),$(window).on("beforeunload",t.onLeavePage),this.initDraftSaving()}return t.onLeavePage=function(){return __t("std","leave_changed_page")},t.prototype.addSubmitListener=function(t){this.$form.submit(t)},t.prototype.setDraftDate=function(t){this.$draftSavingPanel.find(".lastSaved .none").hide();var e={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1},i=$("html").attr("lang"),n=new Intl.DateTimeFormat(i,e).format(t);this.$draftSavingPanel.find(".lastSaved .value").text(n)},t.prototype.saveDraft=function(){for(var t=this,e={},i=0,n=Object.getOwnPropertyNames(this.textareas);i<n.length;i++){var a=n[i];e[a.replace("section_holder_","")]=this.textareas[a].getContent()}var o=this.$draftSavingPanel.find("input[name=public]").prop("checked");$.post(this.$form.data("draftSaving"),{public:o?1:0,sections:e,_csrf:this.$form.find("> input[name=_csrf]").val()},function(e){e.success?(t.setDraftDate(new Date(e.date)),o?t.$form.find(".publicLink").removeClass("hidden"):t.$form.find(".publicLink").addClass("hidden")):alert(e.error)})},t.prototype.initDraftSaving=function(){if(this.$draftSavingPanel=this.$form.find("#draftSavingPanel"),this.$draftSavingPanel.find(".saveDraft").on("click",this.saveDraft.bind(this)),this.$draftSavingPanel.find("input[name=public]").on("change",this.saveDraft.bind(this)),this.$draftSavingPanel.data("resumed-date")){var t=new Date(this.$draftSavingPanel.data("resumed-date"));this.setDraftDate(t)}$("#yii-debug-toolbar").length>0&&this.$draftSavingPanel.addClass("withDebugBar")},t}();s.activePopup=null,s.currMouseX=null,e.MotionMergeAmendments=s});
//# sourceMappingURL=MotionMergeAmendments.js.map
