{"version":3,"sources":["frontend/MotionShow.ts"],"names":["MotionShow","MotionInitiatorShow","LineNumberHighlighting_1","LineNumberHighlighting","$paragraphs","$","find","click","this","showComment","bind","hideComment","filter","each","initParagraph","ev","preventDefault","addClass","removeClass","s","location","hash","split","length","scrollintoview","top_offset","submit","delSubmit","shareLinkClicked","markMovedParagraphs","initPrivateComments","initCmdEnterSubmit","prototype","msg","$node","paragraphNew","data","sectionId","parents","first","attr","paragraphNewFirstline","hasClass","__t","replace","nodeName","parent","$msg","text","insertBefore","remove","focus","currentTarget","$form","$target","form","target","bootbox","confirm","result","window","open","$commentHolder","isOnScreen","$this","i","el","$paragraph","$paraFirstLine","lineHeight","height","amends","sort","el1","el2","append","$amendment","targetOffset","$prevBookmark","prevAll","delta","$pre","parseInt","css","mouseover","mouseout","document","on","originalEvent","trigger"],"mappings":"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","file":"MotionShow.js","sourcesContent":["/// <reference path=\"../typings/jquery-typings.d.ts\" />\n\nimport '../shared/MotionInitiatorShow';\nimport {LineNumberHighlighting} from \"./LineNumberHighlighting\";\n\nclass MotionShow {\n\n    constructor() {\n        new MotionInitiatorShow();\n        new LineNumberHighlighting();\n\n        let $paragraphs = $('.motionTextHolder .paragraph');\n        $paragraphs.find('.comment .shower').click(this.showComment.bind(this));\n        $paragraphs.find('.comment .hider').click(this.hideComment.bind(this));\n\n        $paragraphs.filter('.commentsOpened').find('.comment .shower').click();\n        $paragraphs.filter(':not(.commentsOpened)').find('.comment .hider').click();\n\n        $paragraphs.each(this.initParagraph.bind(this));\n\n\n        $('.tagAdderHolder').click(function (ev) {\n            ev.preventDefault();\n            $(this).addClass(\"hidden\");\n            $('#tagAdderForm').removeClass(\"hidden\");\n        });\n\n        let s = location.hash.split('#comm');\n        if (s.length == 2) {\n            $('#comment' + s[1]).scrollintoview({top_offset: -100});\n        }\n\n        $(\"form.delLink\").submit(this.delSubmit.bind(this));\n        $(\".share_buttons a\").click(this.shareLinkClicked.bind(this));\n\n        this.markMovedParagraphs();\n        this.initPrivateComments();\n        this.initCmdEnterSubmit();\n    }\n\n    private markMovedParagraphs() {\n        // Remove double markup\n        $(\".motionTextHolder .moved .moved\").removeClass('moved');\n\n        $(\".motionTextHolder .moved\").each(function () {\n            let $node = $(this),\n                paragraphNew = $node.data('moving-partner-paragraph'),\n                sectionId = $node.parents('.paragraph').first().attr('id').split('_')[1],\n                paragraphNewFirstline = $('#section_' + sectionId + '_' + paragraphNew).find('.lineNumber').first().data('line-number'),\n                msg: string;\n\n            if ($node.hasClass('inserted')) {\n                msg = __t('std', 'moved_paragraph_from_line');\n            } else {\n                msg = __t('std', 'moved_paragraph_to_line');\n            }\n            msg = msg.replace(/##LINE##/, paragraphNewFirstline).replace(/##PARA##/, (paragraphNew + 1));\n\n            if ($node[0].nodeName === 'LI') {\n                $node = $node.parent();\n            }\n            let $msg = $('<div class=\"movedParagraphHint\"></div>');\n            $msg.text(msg);\n            $msg.insertBefore($node);\n        });\n    }\n\n    private initPrivateComments()\n    {\n        if ($('.privateParagraph, .privateNote').length > 0) {\n            $('.privateParagraphNoteOpener').removeClass('hidden');\n        }\n        $('.privateNoteOpener').click(() => {\n            $('.privateNoteOpener').remove();\n            $('.motionData .privateNotes').removeClass('hidden');\n            $('.motionData .privateNotes textarea').focus();\n            $('.privateParagraphNoteOpener').removeClass('hidden');\n        });\n        $('.privateParagraphNoteOpener').click((ev) => {\n            $(ev.currentTarget).addClass('hidden');\n            const $form = $(ev.currentTarget).parents('.privateParagraphNoteHolder').find('form');\n            $form.removeClass('hidden');\n            $form.find('textarea').focus();\n        });\n        $('.privateNotes blockquote').click(() => {\n            $('.privateNotes blockquote').addClass('hidden');\n            $('.privateNotes form').removeClass('hidden');\n            $('.privateNotes textarea').focus();\n        });\n        $('.privateParagraphNoteHolder blockquote').click((ev) => {\n            const $target = $(ev.currentTarget).parents('.privateParagraphNoteHolder');\n            $target.find('blockquote').addClass('hidden');\n            $target.find('form').removeClass('hidden');\n            $target.find('textarea').focus();\n        });\n    }\n\n    private delSubmit(ev) {\n        ev.preventDefault();\n        let form = ev.target;\n        bootbox.confirm(__t(\"std\", \"del_confirm\"), function (result) {\n            if (result) {\n                form.submit();\n            }\n        });\n    }\n\n    private shareLinkClicked(ev) {\n        let target = $(ev.currentTarget).attr(\"href\");\n        if (window.open(target, '_blank', 'width=600,height=460')) {\n            ev.preventDefault();\n        }\n    }\n\n    private showComment(ev) {\n        ev.preventDefault();\n        let $node = $(ev.currentTarget),\n            $commentHolder = $node.parents('.paragraph').first().find('.commentHolder');\n        $node.addClass('hidden');\n        $node.parent().find('.hider').removeClass('hidden');\n        $commentHolder.removeClass('hidden');\n        if (!$commentHolder.isOnScreen(0.1, 0.1)) {\n            $commentHolder.scrollintoview({top_offset: -100});\n        }\n    }\n\n    private hideComment(ev) {\n        let $this = $(ev.currentTarget);\n        $this.addClass('hidden');\n        $this.parent().find('.shower').removeClass('hidden');\n\n        $this.parents('.paragraph').first().find('.commentHolder').addClass('hidden');\n        ev.preventDefault();\n    }\n\n    private initParagraph(i, el) {\n        let $paragraph = $(el),\n            $paraFirstLine = $paragraph.find(\".lineNumber\").first(),\n            lineHeight = $paraFirstLine.height();\n\n        let amends = $paragraph.find(\".bookmarks > .amendment\");\n        amends = amends.sort(function (el1, el2) {\n            return $(el1).data(\"first-line\") - $(el2).data(\"first-line\");\n        });\n        $paragraph.find(\".bookmarks\").append(amends);\n\n        $paragraph.find('ul.bookmarks li.amendment').each(function () {\n            let $amendment = $(this),\n                firstLine = $amendment.data(\"first-line\"),\n                targetOffset = (firstLine - $paraFirstLine.data(\"line-number\")) * lineHeight,\n                $prevBookmark = $amendment.prevAll(),\n                delta = targetOffset;\n            $prevBookmark.each(function () {\n                let $pre = $(this);\n                delta -= $pre.height();\n                delta -= parseInt($pre.css(\"margin-top\"));\n                delta -= 7;\n            });\n            if (delta < 0) {\n                delta = 0;\n            }\n            $amendment.css('margin-top', delta + \"px\");\n\n            $amendment.mouseover(function () {\n                $paragraph.find(\"> .textOrig\").addClass(\"hidden\");\n                $paragraph.find(\"> .textAmendment\").addClass(\"hidden\");\n                $paragraph.find(\"> .textAmendment.amendment\" + $amendment.find(\"a\").data(\"id\")).removeClass(\"hidden\");\n            }).mouseout(function () {\n                $paragraph.find(\"> .textOrig\").removeClass(\"hidden\");\n                $paragraph.find(\"> .textAmendment\").addClass(\"hidden\");\n            });\n        });\n    }\n\n    private initCmdEnterSubmit() {\n        $(document).on('keypress', 'form textarea', (ev) => {\n            if (ev.originalEvent['metaKey'] && ev.originalEvent['keyCode'] === 13) {\n                let $textarea = $(ev.currentTarget);\n                $textarea.parents(\"form\").first().find(\"button[type=submit]\").trigger(\"click\");\n            }\n        });\n    }\n}\n\nnew MotionShow();\n"]}