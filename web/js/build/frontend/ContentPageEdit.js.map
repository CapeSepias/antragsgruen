{"version":3,"sources":["frontend/ContentPageEdit.ts"],"names":["ContentPageEdit","$form","this","$textSaver","find","$textHolder","$editCaller","$contentSettings","$downloadableFiles","on","editCalled","bind","addClass","save","length","initContentSettings","initDownloadableFiles","$","onSubmitDeleteForm","prototype","ev","_this","preventDefault","attr","editor","CKEDITOR","inline","scayt_sLang","removePlugins","extraPlugins","uploadUrl","data","filebrowserBrowseUrl","toolbarGroups","name","groups","evt","val","trigger","removeClass","showDownloadableFiles","$input","currentTarget","replace","$uploadLabel","path","split","filename","text","addUploadedFileCb","li","document","createElement","a","appendChild","setAttribute","innerText","append","remove","hideDownloadableFiles","readUploadableFile","input","Promise","resolve","reject","reader","FileReader","onload","x","result","alert","console","log","files","readAsDataURL","getData","_csrf","prop","uploadedFile","_a","sent","post","ret","window","setTimeout","destroy","title","children","last","location","href","confirmed","bootbox","confirm","__t","exports"],"mappings":"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","file":"ContentPageEdit.js","sourcesContent":["import editor = CKEDITOR.editor;\n\nexport class ContentPageEdit {\n    private $editCaller: JQuery;\n    private $textHolder: JQuery;\n    private $textSaver: JQuery;\n    private $contentSettings: JQuery;\n    private $downloadableFiles: JQuery;\n    private editor: editor;\n\n    constructor(private $form: JQuery) {\n        this.$textSaver = $form.find('.textSaver');\n        this.$textHolder = $form.find('.textHolder');\n        this.$editCaller = $form.find('.editCaller');\n        this.$contentSettings = $form.find('.contentSettingsToolbar');\n        this.$downloadableFiles = $form.find('.downloadableFiles');\n\n        this.$editCaller.on(\"click\", this.editCalled.bind(this));\n        this.$textSaver.addClass('hidden');\n        this.$textSaver.find('button').on(\"click\", this.save.bind(this));\n\n        if (this.$contentSettings.length > 0) {\n            this.initContentSettings();\n        }\n        if (this.$downloadableFiles.length > 0) {\n            this.initDownloadableFiles();\n        }\n\n        $(\".deletePageForm\").on(\"submit\", this.onSubmitDeleteForm.bind(this));\n    }\n\n    private editCalled(ev) {\n        ev.preventDefault();\n        this.$editCaller.addClass('hidden');\n        this.$textHolder.attr('contenteditable', \"true\");\n\n        this.editor = CKEDITOR.inline(this.$textHolder.attr('id'), {\n            scayt_sLang: 'de_DE',\n            removePlugins: 'lite,showbloks,about,selectall,forms',\n            extraPlugins: 'uploadimage',\n            uploadUrl: this.$form.data('upload-url'),\n            filebrowserBrowseUrl: this.$form.data('image-browse-url'),\n            //filebrowserUploadUrl: '/uploader/upload.php?type=Files',\n            toolbarGroups: [\n                {name: 'basicstyles', groups: ['basicstyles', 'cleanup']},\n                {name: 'colors'},\n                {name: 'links'},\n                {name: 'insert'},\n                {name: 'others'},\n                {name: 'tools'},\n                '/',\n                {name: 'styles'},\n                {name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi']}\n            ]\n        });\n        this.editor.on('fileUploadRequest', (evt) => {\n            evt.data['requestData']['_csrf'] = this.$form.find('> input[name=_csrf]').val();\n        });\n\n        this.$textHolder.trigger(\"focus\");\n        this.$textSaver.removeClass('hidden');\n        this.$contentSettings.removeClass('hidden');\n        this.showDownloadableFiles();\n    }\n\n    private initContentSettings() {\n        this.$contentSettings.find('input[name=url]').on('keyup change keypress', (ev) => {\n            let $input = $(ev.currentTarget);\n            $input.val(($input.val() as string).replace(/[^\\w_\\-,\\.äöüß]/, ''));\n        });\n    }\n\n    private initDownloadableFiles() {\n        const $uploadLabel = this.$downloadableFiles.find(\".uploadCol .text\");\n        this.$downloadableFiles.find(\"input[type=file]\").on(\"change\", () => {\n            const path = (this.$downloadableFiles.find(\"input[type=file]\").val() as string).split('\\\\');\n            const filename = path[path.length - 1];\n            $uploadLabel.text(filename);\n        });\n    }\n\n    private addUploadedFileCb(data) {\n        const li = document.createElement('li'),\n            a = document.createElement('a');\n        li.appendChild(a);\n        a.setAttribute('href', data['url']);\n        a.innerText = data['title'];\n        this.$downloadableFiles.find(\"ul\").append(li);\n        this.$downloadableFiles.find(\".none\").remove();\n    }\n\n    private hideDownloadableFiles() {\n        const hasFiles = (this.$downloadableFiles.find('ul li').length > 0);\n        if (!hasFiles) {\n            this.$downloadableFiles.addClass('hidden');\n        }\n        this.$downloadableFiles.find('.downloadableFilesUpload').addClass('hidden');\n    }\n\n    private showDownloadableFiles() {\n        this.$downloadableFiles.removeClass('hidden');\n        this.$downloadableFiles.find('.downloadableFilesUpload').removeClass('hidden');\n    }\n\n    private async readUploadableFile(input: HTMLInputElement): Promise<string> {\n        return new Promise((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onload = function () {\n                const data = reader.result as string;\n                const x = data.split(\";base64,\");\n                if (x.length === 2) {\n                    resolve(x[1]);\n                } else {\n                    alert(\"Could not read the given file\");\n                    resolve(null);\n                }\n            };\n            console.log(input.files);\n            if (input.files.length > 0) {\n                reader.readAsDataURL(input.files[0]);\n            } else {\n                resolve(null);\n            }\n        });\n    }\n\n    private async save(ev) {\n        ev.preventDefault();\n        let data = {\n            'data': this.editor.getData(),\n            '_csrf': this.$form.find('> input[name=_csrf]').val()\n        };\n        if (this.$contentSettings.length > 0) {\n            data['url'] = this.$contentSettings.find('input[name=url]').val();\n            data['title'] = this.$contentSettings.find('input[name=title]').val();\n            data['allConsultations'] = (this.$contentSettings.find('input[name=allConsultations]').prop('checked') ? 1 : 0);\n            data['inMenu'] = (this.$contentSettings.find('input[name=inMenu]').prop('checked') ? 1 : 0);\n        }\n        if (this.$downloadableFiles.length > 0) {\n            const input = this.$downloadableFiles.find(\"input[type=file]\")[0] as HTMLInputElement;\n            const uploadedFile = await this.readUploadableFile(input);\n\n            if (uploadedFile) {\n                const path = (this.$downloadableFiles.find(\"input[type=file]\").val() as string).split('\\\\');\n                const filename = path[path.length - 1];\n                data['uploadDownloadableFile'] = uploadedFile;\n                data['uploadDownloadableTitle'] = this.$downloadableFiles.find(\"#downloadableFileTitle\").val();\n                data['uploadDownloadableFilename'] = filename;\n            }\n        }\n\n        $.post(this.$form.attr('action'), data, (ret) => {\n            if (ret['success']) {\n                window.setTimeout(() => {\n                    this.editor.destroy();\n                }, 100);\n                this.$textSaver.addClass('hidden');\n                this.$textHolder.attr('contenteditable', 'false');\n                this.$editCaller.removeClass('hidden');\n                this.$contentSettings.addClass('hidden');\n\n                if (ret['title'] !== null) {\n                    $(\".pageTitle\").text(ret['title']);\n                    document.title = ret['title'];\n                    $(\"#mainmenu .page\" + ret['id']).text(ret['title']);\n                    $(\".breadcrumb\").children().last().text(ret['title']);\n                }\n\n                if (ret['uploadedFile']) {\n                    this.addUploadedFileCb(ret['uploadedFile']);\n                }\n                this.hideDownloadableFiles();\n\n                if (ret['message']) {\n                    alert(ret['message']);\n                }\n\n                if (ret['redirectTo']) {\n                    window.location.href = ret['redirectTo'];\n                }\n            } else {\n                alert('Something went wrong...');\n            }\n        })\n    }\n\n    private onSubmitDeleteForm(ev, data) {\n        if (data && typeof (data.confirmed) && data.confirmed === true) {\n            return;\n        }\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"delPageConfirm\"), function (result) {\n            if (result) {\n                $(\".deletePageForm\").trigger(\"submit\", {'confirmed': true});\n            }\n        });\n    }\n}\n"]}