{"version":3,"sources":["frontend/ContentPageEdit.ts"],"names":["ContentPageEdit","$form","this","$textSaver","find","$textHolder","$editCaller","$contentSettings","$downloadableFiles","on","editCalled","bind","addClass","save","length","initContentSettings","initDownloadableFiles","$","onSubmitDeleteForm","prototype","ev","_this","preventDefault","attr","editor","CKEDITOR","inline","scayt_sLang","removePlugins","extraPlugins","uploadUrl","data","filebrowserBrowseUrl","toolbarGroups","name","groups","evt","val","trigger","removeClass","showDownloadableFiles","$input","currentTarget","replace","$uploadLabel","path","split","filename","text","id","parents","first","delConfirm","bootbox","confirm","result","deleteDownloadableFile","deleteUrl","params","_csrf","post","ret","remove","children","alert","addUploadedFileCb","$el","append","hideDownloadableFiles","readUploadableFile","input","Promise","resolve","reject","reader","FileReader","onload","x","files","readAsDataURL","getData","prop","uploadedFile","_a","sent","window","setTimeout","destroy","document","title","last","location","href","confirmed","__t","exports"],"mappings":"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","file":"ContentPageEdit.js","sourcesContent":["import editor = CKEDITOR.editor;\n\nexport class ContentPageEdit {\n    private $editCaller: JQuery;\n    private $textHolder: JQuery;\n    private $textSaver: JQuery;\n    private $contentSettings: JQuery;\n    private $downloadableFiles: JQuery;\n    private editor: editor;\n\n    constructor(private $form: JQuery) {\n        this.$textSaver = $form.find('.textSaver');\n        this.$textHolder = $form.find('.textHolder');\n        this.$editCaller = $form.find('.editCaller');\n        this.$contentSettings = $form.find('.contentSettingsToolbar');\n        this.$downloadableFiles = $form.find('.downloadableFiles');\n\n        this.$editCaller.on(\"click\", this.editCalled.bind(this));\n        this.$textSaver.addClass('hidden');\n        this.$textSaver.find('button').on(\"click\", this.save.bind(this));\n\n        if (this.$contentSettings.length > 0) {\n            this.initContentSettings();\n        }\n        if (this.$downloadableFiles.length > 0) {\n            this.initDownloadableFiles();\n        }\n\n        $(\".deletePageForm\").on(\"submit\", this.onSubmitDeleteForm.bind(this));\n    }\n\n    private editCalled(ev) {\n        ev.preventDefault();\n        this.$editCaller.addClass('hidden');\n        this.$textHolder.attr('contenteditable', \"true\");\n\n        this.editor = CKEDITOR.inline(this.$textHolder.attr('id'), {\n            scayt_sLang: 'de_DE',\n            removePlugins: 'lite,showbloks,about,selectall,forms',\n            extraPlugins: 'uploadimage',\n            uploadUrl: this.$form.data('upload-url'),\n            filebrowserBrowseUrl: this.$form.data('image-browse-url'),\n            //filebrowserUploadUrl: '/uploader/upload.php?type=Files',\n            toolbarGroups: [\n                {name: 'basicstyles', groups: ['basicstyles', 'cleanup']},\n                {name: 'colors'},\n                {name: 'links'},\n                {name: 'insert'},\n                {name: 'others'},\n                {name: 'tools'},\n                '/',\n                {name: 'styles'},\n                {name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi']}\n            ]\n        });\n        this.editor.on('fileUploadRequest', (evt) => {\n            evt.data['requestData']['_csrf'] = this.$form.find('> input[name=_csrf]').val();\n        });\n\n        this.$textHolder.trigger(\"focus\");\n        this.$textSaver.removeClass('hidden');\n        this.$contentSettings.removeClass('hidden');\n        this.showDownloadableFiles();\n    }\n\n    private initContentSettings() {\n        this.$contentSettings.find('input[name=url]').on('keyup change keypress', (ev) => {\n            let $input = $(ev.currentTarget);\n            $input.val(($input.val() as string).replace(/[^\\w_\\-,\\.äöüß]/, ''));\n        });\n    }\n\n    private initDownloadableFiles() {\n        const $uploadLabel = this.$downloadableFiles.find(\".uploadCol .text\");\n        this.$downloadableFiles.find(\"input[type=file]\").on(\"change\", () => {\n            const path = (this.$downloadableFiles.find(\"input[type=file]\").val() as string).split('\\\\');\n            const filename = path[path.length - 1];\n            $uploadLabel.text(filename);\n        });\n\n        this.$downloadableFiles.find(\".fileList\").on(\"click\", \".deleteFile\", (ev) => {\n            const id = $(ev.currentTarget).parents(\"li\").first().data(\"id\");\n            const delConfirm = this.$form.data(\"del-confirmation\");\n\n            bootbox.confirm(delConfirm, result => {\n                if (result) {\n                    this.deleteDownloadableFile(id);\n                }\n            });\n        });\n    }\n\n    private deleteDownloadableFile(id: string) {\n        const deleteUrl = this.$form.data(\"file-delete-url\");\n        const params = {\n\n            \"id\": id,\n            \"_csrf\": this.$form.find('> input[name=_csrf]').val(),\n        };\n\n        $.post(deleteUrl, params, (ret) => {\n            if (ret['success']) {\n                this.$downloadableFiles.find(\".fileList li[data-id=\" + id + \"]\").remove();\n\n                if (this.$downloadableFiles.find(\".fileList\").children().length === 0) {\n                    this.$downloadableFiles.find(\".none\").removeClass(\"hidden\");\n                }\n            } else {\n                alert(ret['message']);\n            }\n        });\n    }\n\n    private addUploadedFileCb(data) {\n        const $el = $('<li><a><span class=\"glyphicon glyphicon-download-alt\"></span> <span class=\"title\"></span></a>' +\n            '<button type=\"button\" class=\"btn btn-link deleteFile\"><span class=\"glyphicon glyphicon-trash\"></span></button></li>');\n        $el.find(\"a\").attr(\"href\", data['url']);\n        $el.find(\"a .title\").text(data['title']);\n        $el.attr(\"data-id\", data['id']);\n\n        this.$downloadableFiles.find(\"ul\").append($el);\n        this.$downloadableFiles.find(\".none\").addClass('hidden');\n    }\n\n    private hideDownloadableFiles() {\n        const hasFiles = (this.$downloadableFiles.find('ul li').length > 0);\n        if (!hasFiles) {\n            this.$downloadableFiles.addClass('hidden');\n        }\n        this.$downloadableFiles.find('.downloadableFilesUpload').addClass('hidden');\n        this.$downloadableFiles.find('#downloadableFileNew').val(\"\");\n        this.$downloadableFiles.find('#downloadableFileTitle').val(\"\");\n        this.$downloadableFiles.find(\".uploadCol .text\").text(this.$downloadableFiles.find(\".uploadCol .text\").data(\"title\"));\n    }\n\n    private showDownloadableFiles() {\n        this.$downloadableFiles.removeClass('hidden');\n        this.$downloadableFiles.find('.downloadableFilesUpload').removeClass('hidden');\n    }\n\n    private async readUploadableFile(input: HTMLInputElement): Promise<string> {\n        return new Promise((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onload = function () {\n                const data = reader.result as string;\n                const x = data.split(\";base64,\");\n                if (x.length === 2) {\n                    resolve(x[1]);\n                } else {\n                    alert(\"Could not read the given file\");\n                    resolve(null);\n                }\n            };\n            if (input.files.length > 0) {\n                reader.readAsDataURL(input.files[0]);\n            } else {\n                resolve(null);\n            }\n        });\n    }\n\n    private async save(ev) {\n        ev.preventDefault();\n        let data = {\n            'data': this.editor.getData(),\n            '_csrf': this.$form.find('> input[name=_csrf]').val()\n        };\n        if (this.$contentSettings.length > 0) {\n            data['url'] = this.$contentSettings.find('input[name=url]').val();\n            data['title'] = this.$contentSettings.find('input[name=title]').val();\n            data['allConsultations'] = (this.$contentSettings.find('input[name=allConsultations]').prop('checked') ? 1 : 0);\n            data['inMenu'] = (this.$contentSettings.find('input[name=inMenu]').prop('checked') ? 1 : 0);\n        }\n        if (this.$downloadableFiles.length > 0) {\n            const input = this.$downloadableFiles.find(\"input[type=file]\")[0] as HTMLInputElement;\n            const uploadedFile = await this.readUploadableFile(input);\n\n            if (uploadedFile) {\n                const path = (this.$downloadableFiles.find(\"input[type=file]\").val() as string).split('\\\\');\n                const filename = path[path.length - 1];\n                data['uploadDownloadableFile'] = uploadedFile;\n                data['uploadDownloadableTitle'] = this.$downloadableFiles.find(\"#downloadableFileTitle\").val();\n                data['uploadDownloadableFilename'] = filename;\n            }\n        }\n\n        $.post(this.$form.attr('action'), data, (ret) => {\n            if (ret['success']) {\n                window.setTimeout(() => {\n                    this.editor.destroy();\n                }, 100);\n                this.$textSaver.addClass('hidden');\n                this.$textHolder.attr('contenteditable', 'false');\n                this.$editCaller.removeClass('hidden');\n                this.$contentSettings.addClass('hidden');\n\n                if (ret['title'] !== null) {\n                    $(\".pageTitle\").text(ret['title']);\n                    document.title = ret['title'];\n                    $(\"#mainmenu .page\" + ret['id']).text(ret['title']);\n                    $(\".breadcrumb\").children().last().text(ret['title']);\n                }\n\n                if (ret['uploadedFile']) {\n                    this.addUploadedFileCb(ret['uploadedFile']);\n                }\n                this.hideDownloadableFiles();\n\n                if (ret['message']) {\n                    alert(ret['message']);\n                }\n\n                if (ret['redirectTo']) {\n                    window.location.href = ret['redirectTo'];\n                }\n            } else {\n                alert('Something went wrong...');\n            }\n        })\n    }\n\n    private onSubmitDeleteForm(ev, data) {\n        if (data && typeof (data.confirmed) && data.confirmed === true) {\n            return;\n        }\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"delPageConfirm\"), function (result) {\n            if (result) {\n                $(\".deletePageForm\").trigger(\"submit\", {'confirmed': true});\n            }\n        });\n    }\n}\n"]}