{"version":3,"sources":["frontend/MotionMergeAmendments.ts"],"names":["AMENDMENT_VERSION","STATUS_ACCEPTED","STATUS_MODIFIED_ACCEPTED","STATUS_PROCESSED","STATUS_ADOPTED","STATUS_COMPLETED","AmendmentStatuses","init","versions","statuses","document","querySelectorAll","forEach","el","amendmentId","parseInt","getAttribute","split","inputs","statusListeners","getAmendmentStatus","getAmendmentVersion","registerParagraph","paragraph","push","setStatus","status","onAmendmentStatusChanged","setAttribute","toString","setVersion","version","onAmendmentVersionChanged","getAllStatuses","getAllVersions","MotionMergeChangeActions","removeEmptyParagraphs","$","each","i","childNodes","length","remove","accept","node","onFinished","$node","hasClass","insertAccept","deleteAccept","reject","insertReject","deleteReject","$removeEl","name","nodeName","toLowerCase","parent","css","height","animate","$this","removeClass","removeAttr","children","replaceWith","html","exports","MotionMergeChangeTooltip","$element","mouseX","mouseY","this","positionX","positionY","popover","container","animation","trigger","placement","$popover","data","window","setTimeout","width","elTop","offset","top","elHeight","content","getContent","bind","find","on","ev","stopPropagation","removePopupIfInactive","prototype","$myEl","cid","undefined","parents","first","addClass","$el","attr","__t","text","click","$list","console","log","alert","is","destroy","affectedChangesets","performActionWithUI","action","scrollX","scrollY","saveEditorSnapshot","call","focusTextarea","scrollTo","_this","onChanged","focusAtSameCid","stale","$stale","warn","e","MotionMergeAmendmentsTextarea","$holder","$changedIndicator","$mergeActionHolder","unchangedText","hasChanged","$textarea","edit","AntragsgruenEditor_1","AntragsgruenEditor","texteditor","getEditor","MotionMergeAmendments","addSubmitListener","val","getData","setText","prepareText","$text","appendHint","removeData","markupMovedParagraph","newText","setData","normalizeHtml","fire","msg","paragraphNew","replace","initializeTooltips","$target","currentTarget","activePopup","pageX","pageY","acceptAll","rejectAll","getUnchangedContent","entities","&nbsp;","&ndash;","&auml;","&ouml;","&uuml;","&Auml;","&Ouml;","&Uuml;","&szlig;","&bdquo;","&ldquo;","&bull;","&sect;","&eacute;","&rsquo;","&euro;","Object","keys","ent","RegExp","hasChanges","MotionMergeAmendmentsParagraph","sectionId","paragraphId","$changed","textarea","initButtons","element","$input","doToggle","reloadText","bootbox","confirm","result","initTooltip","currentStatus","currentVersion","preventDefault","$btn","indexOf","amendments","id","url","JSON","stringify","get","collisions","str","getDraftData","amendmentToggles","unchanged","$form","paragraphs","$para","currMouseX","offsetX","off","onLeavePage","initDraftSaving","cb","submit","setDraftDate","date","$draftSavingPanel","hide","lang","formatted","Intl","DateTimeFormat","year","month","day","hour","minute","hour12","format","saveDraft","amendmentStatuses","amendmentVersions","sections","$section","para","isPublic","prop","ajax","type","public","_csrf","success","ret","Date","error","initAutosavingDraft","$toggle","setInterval","localStorage","state","getItem","change","active","setItem"],"mappings":"0IAGA,IAMKA,EAAAA,EANCC,EAAkB,EAClBC,EAA2B,EAC3BC,EAAmB,GACnBC,EAAiB,EACjBC,EAAmB,GAEpBL,EAAAA,IAAAA,EAAiB,KAClB,SAAA,OACAA,EAAA,mBAAA,OAGJ,IAAAM,EAAA,WAAA,SAAAA,KAqDA,OA/CkBA,EAAAC,KAAd,SAAmBC,GACfF,EAAkBG,SAAW,GAE7BC,SAASC,iBAAiB,sCAAsCC,QAAQ,SAACC,GACrE,IAAMC,EAAcC,SAASF,EAAGG,aAAa,QAAQC,MAAM,KAAK,IAChEX,EAAkBG,SAASK,GAAeC,SAASF,EAAGG,aAAa,UACnEV,EAAkBY,OAAOJ,GAAeD,EACxCP,EAAkBa,gBAAgBL,GAAe,KAGrDR,EAAkBE,SAAWA,GAGnBF,EAAAc,mBAAd,SAAiCN,GAC7B,OAAOR,EAAkBG,SAASK,IAGxBR,EAAAe,oBAAd,SAAkCP,GAC9B,OAAOR,EAAkBE,SAASM,IAGxBR,EAAAgB,kBAAd,SAAgCR,EAAqBS,GACjDjB,EAAkBa,gBAAgBL,GAAaU,KAAKD,IAG1CjB,EAAAmB,UAAd,SAAwBX,EAAqBY,GACzCpB,EAAkBG,SAASK,GAAeY,EAC1CpB,EAAkBa,gBAAgBL,GAAaF,QAAQ,SAAAW,GACnDA,EAAUI,yBAAyBb,EAAaY,KAEpDpB,EAAkBY,OAAOJ,GAAac,aAAa,QAASF,EAAOG,SAAS,MAGlEvB,EAAAwB,WAAd,SAAyBhB,EAAqBiB,GAC1CzB,EAAkBE,SAASM,GAAeiB,EAC1CzB,EAAkBa,gBAAgBL,GAAaF,QAAQ,SAAAW,GACnDA,EAAUS,+BAIJ1B,EAAA2B,eAAd,WACI,OAAO3B,EAAkBG,UAGfH,EAAA4B,eAAd,WACI,OAAO5B,EAAkBE,UAhDdF,EAAAa,gBAA+E,GAC/Eb,EAAAY,OAAiD,GAiDpEZ,EArDA,GAuDA6B,EAAA,WAAA,SAAAA,KAyGA,OAxGkBA,EAAAC,sBAAd,WACIC,EAAE,oBAAoBC,KAAK,SAACC,EAAG1B,GACC,GAAxBA,EAAG2B,WAAWC,QACdJ,EAAExB,GAAI6B,YAKJP,EAAAQ,OAAd,SAAqBC,EAAeC,QAAA,IAAAA,IAAAA,EAAA,MAChC,IAAIC,EAAQT,EAAEO,GACVE,EAAMC,SAAS,YACfZ,EAAyBa,aAAaJ,EAAMC,GAE5CC,EAAMC,SAAS,YACfZ,EAAyBc,aAAaL,EAAMC,IAItCV,EAAAe,OAAd,SAAqBN,EAAeC,QAAA,IAAAA,IAAAA,EAAA,MAChC,IAAIC,EAAQT,EAAEO,GACVE,EAAMC,SAAS,YACfZ,EAAyBgB,aAAaL,EAAOD,GAE7CC,EAAMC,SAAS,YACfZ,EAAyBiB,aAAaN,EAAOD,IAIvCV,EAAAgB,aAAd,SAA2BL,EAAeD,QAAA,IAAAA,IAAAA,EAAA,MACtC,IAAIQ,EACAC,EAAOR,EAAM,GAAGS,SAASC,cAEzBH,EADQ,MAARC,EACYR,EAAMW,SAENX,EAEJ,MAARQ,GAAwB,MAARA,GAAwB,MAARA,GAAwB,cAARA,GAAgC,OAARA,GAAyB,KAARA,GACzFD,EAAUK,IAAI,WAAY,UAAUC,OAAON,EAAUM,UACrDN,EAAUO,QAAQ,CAACD,OAAU,KAAM,IAAK,WACpCN,EAAUX,SACVL,EAAE,6BAA6BK,SAC/BP,EAAyBC,wBACrBS,GAAYA,QAGpBQ,EAAUX,SACNG,GAAYA,MAIVV,EAAAa,aAAd,SAA2BJ,EAAeC,QAAA,IAAAA,IAAAA,EAAA,MACtC,IAAIgB,EAAgBxB,EAAEO,GACtBiB,EAAMC,YAAY,oCAClBD,EAAME,WAAW,4FACkB,MAA/BnB,EAAKW,SAASC,eAAwD,MAA/BZ,EAAKW,SAASC,eACrDK,EAAMG,WAAWF,YAAY,WAAWA,YAAY,WAAWA,YAAY,cAE5C,MAA/BlB,EAAKW,SAASC,eACdK,EAAMJ,SAASK,YAAY,WAAWA,YAAY,WAAWA,YAAY,cAE1C,OAA/BlB,EAAKW,SAASC,eACdK,EAAMI,YAAYJ,EAAMK,QAExBrB,GAAYA,KAGNV,EAAAiB,aAAd,SAA2BN,EAAeD,QAAA,IAAAA,IAAAA,EAAA,MACtCC,EAAMgB,YAAY,8BAClBhB,EAAMiB,WAAW,4FACjB,IAAIR,EAAWT,EAAM,GAAGS,SAASC,cACjB,MAAZD,GAAgC,MAAZA,GACpBT,EAAMkB,WAAWF,YAAY,WAAWA,YAAY,WAAWA,YAAY,cAE/D,MAAZP,GACAT,EAAMW,SAASK,YAAY,WAAWA,YAAY,WAAWA,YAAY,cAE7D,OAAZP,GACAT,EAAMmB,YAAYnB,EAAMoB,QAExBrB,GAAYA,KAGNV,EAAAc,aAAd,SAA2BL,EAAeC,QAAA,IAAAA,IAAAA,EAAA,MACtC,IACIQ,EADAC,EAAOV,EAAKW,SAASC,cAGrBH,EADQ,MAARC,EACYjB,EAAEO,GAAMa,SAERpB,EAAEO,GAGN,MAARU,GAAwB,MAARA,GAAwB,MAARA,GAAwB,cAARA,GAAgC,OAARA,GAAyB,KAARA,GACzFD,EAAUK,IAAI,WAAY,UAAUC,OAAON,EAAUM,UACrDN,EAAUO,QAAQ,CAACD,OAAU,KAAM,IAAK,WACpCN,EAAUX,SACVL,EAAE,6BAA6BK,SAC/BP,EAAyBC,wBACrBS,GAAYA,QAGpBQ,EAAUX,SACNG,GAAYA,MAG5BV,EAzGA,GAAagC,EAAAhC,yBAAAA,EA4Gb,IAAAiC,EAAA,WACI,SAAAA,EAAoBC,EAAkBC,EAAgBC,EAAwBd,GAA1De,KAAAH,SAAAA,EAA0DG,KAAAf,OAAAA,EAC1E,IAAIgB,EAAoB,KACpBC,EAAoB,KACxBL,EAASM,QAAQ,CACbC,UAAa,OACbC,WAAa,EACbC,QAAW,SACXC,UAAa,SAAUJ,GACnB,IAAIK,EAAW3C,EAAOsC,GAmBtB,OAlBAK,EAASC,KAAK,UAAWZ,GACzBa,OAAOC,WAAW,WACd,IAAIC,EAAQJ,EAASI,QACjBC,EAAQhB,EAASiB,SAASC,IAC1BC,EAAWnB,EAASV,SACN,OAAdc,GAA8B,EAARW,IACtBX,EAAaH,EAASc,EAAQ,GAC9BV,EAAYH,EAAS,IACJc,EAAQ,KACrBX,EAAYW,EAAQ,IAERA,EAAQG,EAApBd,IACAA,EAAYW,EAAQG,IAG5BR,EAAStB,IAAI,OAAQe,EAAY,MACjCO,EAAStB,IAAI,MAAOgB,EAAY,OACjC,GACI,UAEXR,MAAQ,EACRuB,QAAWjB,KAAKkB,WAAWC,KAAKnB,QAGpCH,EAASM,QAAQ,QACMN,EAASuB,KAAK,cAC5BC,GAAG,YAAa,SAACC,GACtBA,EAAGC,oBAEPb,OAAOC,WAAWX,KAAKwB,sBAAsBL,KAAKnB,MAAO,KA8HjE,OA3HYJ,EAAA6B,UAAAP,WAAR,WACI,IAAIQ,EAAgB1B,KAAKH,SAErB8B,EAAMD,EAAMjB,KAAK,OACVmB,MAAPD,IACAA,EAAMD,EAAMzC,SAASwB,KAAK,QAE9BiB,EAAMG,QAAQ,eAAeC,QAAQV,KAAK,aAAeO,EAAM,KAAKI,SAAS,SAQ7E,IAAIC,EAAcnE,EADlB6B,6UAIA,GAFAsC,EAAIZ,KAAK,WAAWa,KAAK,OAAQP,EAAMjB,KAAK,SAASwB,KAAK,QAASC,IAAI,QAAS,wBAChFF,EAAIZ,KAAK,cAAce,KAAKD,IAAI,QAAS,gBAAkB,KAAOR,EAAMjB,KAAK,aACzEiB,EAAMnD,SAAS,WACfyD,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAK7B,OAAOgD,KAAKnB,OACrFgC,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAKtB,OAAOyC,KAAKnB,YAClF,GAAI0B,EAAMnD,SAAS,WACtByD,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAK7B,OAAOgD,KAAKnB,OACrFgC,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAKtB,OAAOyC,KAAKnB,YAClF,GAAuC,MAAnC0B,EAAM,GAAG3C,SAASC,cAAuB,CAChD,IAAIqD,EAAQX,EAAMzC,SACdoD,EAAM9D,SAAS,YACfyD,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAK7B,OAAOgD,KAAKnB,OACrFgC,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAKtB,OAAOyC,KAAKnB,QAC9EqC,EAAM9D,SAAS,YACtByD,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAK7B,OAAOgD,KAAKnB,OACrFgC,EAAIZ,KAAK,iBAAiBe,KAAKD,IAAI,QAAS,kBAAkBE,MAAMpC,KAAKtB,OAAOyC,KAAKnB,QAErFsC,QAAQC,IAAI,UAAWF,QAG3BC,QAAQC,IAAI,UAAWb,GACvBc,MAAM,WAEV,OAAOR,GAGHpC,EAAA6B,UAAAD,sBAAR,WACI,OAAIxB,KAAKH,SAAS4C,GAAG,UACV/B,OAAOC,WAAWX,KAAKwB,sBAAsBL,KAAKnB,MAAO,KAEtB,EAA1CnC,EAAE,QAAQuD,KAAK,kBAAkBnD,OAC1ByC,OAAOC,WAAWX,KAAKwB,sBAAsBL,KAAKnB,MAAO,UAEpEA,KAAK0C,WAGD9C,EAAA6B,UAAAkB,mBAAR,WACI,IAAIhB,EAAM3B,KAAKH,SAASY,KAAK,OAI7B,OAHWmB,MAAPD,IACAA,EAAM3B,KAAKH,SAASZ,SAASwB,KAAK,QAE/BT,KAAKH,SAASgC,QAAQ,eAAeT,KAAK,aAAeO,EAAM,MAGlE/B,EAAA6B,UAAAmB,oBAAR,SAA4BC,GACxB,IAAIC,EAAUpC,OAAOoC,QACjBC,EAAUrC,OAAOqC,QAErB/C,KAAKf,OAAO+D,qBACZhD,KAAK0C,UACLG,EAAOI,KAAKjD,MACZA,KAAKf,OAAOiE,gBAEZxC,OAAOyC,SAASL,EAASC,IAGrBnD,EAAA6B,UAAAtD,OAAR,WAAA,IAAAiF,EAAApD,KACIA,KAAK4C,oBAAoB,WACrBQ,EAAKT,qBAAqB7E,KAAK,SAACC,EAAG1B,GAC/BsB,EAAyBQ,OAAO9B,EAAI,WAChC+G,EAAKnE,OAAOoE,mBAMpBzD,EAAA6B,UAAA/C,OAAR,WAAA,IAAA0E,EAAApD,KACIA,KAAK4C,oBAAoB,WACrBQ,EAAKT,qBAAqB7E,KAAK,SAACC,EAAG1B,GAC/BsB,EAAyBe,OAAOrC,EAAI,WAChC+G,EAAKnE,OAAOoE,mBAMrBzD,EAAA6B,UAAAiB,QAAP,WACI1C,KAAKH,SAASM,QAAQ,QAAQA,QAAQ,WAEtC,IAAIwB,EAAM3B,KAAKH,SAASY,KAAK,OAClBmB,MAAPD,IACAA,EAAM3B,KAAKH,SAASZ,SAASwB,KAAK,QAGtC,IAAI6C,GAAiB,EACrBtD,KAAKH,SAASgC,QAAQ,eAAeC,QAAQV,KAAK,aAAeO,EAAM,KAAK7D,KAAK,SAACC,EAAG1B,GAC7EwB,EAAExB,GAAIoG,GAAG,YACTa,GAAiB,KAGpBA,GACDtD,KAAKH,SAASgC,QAAQ,eAAeC,QAAQV,KAAK,aAAeO,EAAM,KAAKrC,YAAY,SAG5F,IAEIzB,EAAE,YAAYC,KAAK,SAACC,EAAGwF,GACnB,IAAMC,EAAS3F,EAAE0F,GACZC,EAAO/C,KAAK,WAAWgC,GAAG,YAC3Be,EAAOrD,QAAQ,QAAQA,QAAQ,WAC/BqD,EAAOtF,SACPoE,QAAQmB,KAAK,yBAA0BD,MAGjD,MAAOE,MAGjB9D,EArKA,GAuKA+D,EAAA,WAsKI,SAAAA,EAAoBC,EAAyBC,EAAmCC,GAAhF,IAAAV,EAAApD,KAAoBA,KAAA4D,QAAAA,EAAyB5D,KAAA6D,kBAAAA,EAAmC7D,KAAA8D,mBAAAA,EApKxE9D,KAAA+D,cAAwB,KACxB/D,KAAAgE,YAAsB,EAoK1B,IAAIC,EAAYL,EAAQxC,KAAK,eACzB8C,EAAO,IAAIC,EAAAC,mBAAmBH,EAAUhC,KAAK,OACjDjC,KAAKqE,WAAaH,EAAKI,YACvBC,EAAsBC,kBAAkB,WACpCZ,EAAQxC,KAAK,gBAAgBqD,IAAIrB,EAAKiB,WAAWK,WACjDd,EAAQxC,KAAK,yBAAyBqD,IAAIrB,EAAKiB,WAAWK,aAG9D1E,KAAK2E,QAAQ3E,KAAKqE,WAAWK,WAEzBd,EAAQnD,KAAK,eACbT,KAAK+D,cAAgBH,EAAQnD,KAAK,aAClCT,KAAKqD,aAGTrD,KAAKqE,WAAWhD,GAAG,SAAUrB,KAAKqD,UAAUlC,KAAKnB,OAEzD,OAnLY2D,EAAAlC,UAAAmD,YAAR,SAAoBlF,GAChB,IAAImF,EAAgBhH,EAAE,QAAU6B,EAAO,UAGvCmF,EAAMzD,KAAK,gCAAgCtD,KAAK,SAACC,EAAG1B,GAChD,IAAIgD,EAAgBxB,EAAExB,GAClByI,EAAazF,EAAMoB,KAAK,eAC5BpB,EAAM+B,KAAK,QAAQW,SAAS,cAAcE,KAAK,mBAAoB6C,GAC9D7C,KAAK,YAAa5C,EAAMoB,KAAK,SAC7BwB,KAAK,gBAAiB5C,EAAMoB,KAAK,aACtCpB,EAAMC,YAAY,cAAcyF,WAAW,iBAI/CF,EAAMzD,KAAK,iBAAiB9B,YAAY,SACxCuF,EAAMzD,KAAK,UAAUtD,KAAKkC,KAAKgF,qBAAqB7D,KAAKnB,OAGzD6E,EAAMzD,KAAK,kBACNa,KAAK,2BAA4BC,IAAI,QAAS,oBAC9CD,KAAK,yBAA0BC,IAAI,QAAS,kBAEjD,IAAI+C,EAAUJ,EAAMnF,OACpBM,KAAKqE,WAAWa,QAAQD,GACxBjF,KAAK+D,cAAgB/D,KAAKmF,cAAcnF,KAAKqE,WAAWK,WACxD1E,KAAKqE,WAAWe,KAAK,gBACrBpF,KAAKqD,aAGDM,EAAAlC,UAAAuD,qBAAR,SAA6BjH,EAAG1B,GAC5B,IAEIgJ,EAFA/G,EAAQT,EAAExB,GACViJ,EAAehH,EAAMmC,KAAK,4BAQ9B4E,GAJIA,EADA/G,EAAMC,SAAS,YACT2D,IAAI,MAAO,wBAEXA,IAAI,MAAO,uBAEXqD,QAAQ,WAAaD,EAAe,GAEpB,OAAtBhH,EAAM,GAAGS,WACTT,EAAQA,EAAMW,UAGlBX,EAAM2D,KAAK,kBAAmBoD,IAG1B1B,EAAAlC,UAAA+D,mBAAR,WAAA,IAAApC,EAAApD,KACIA,KAAK4D,QAAQvC,GAAG,YAAa,cAAe,SAACC,GACzC,IAAMmE,EAAU5H,EAAEyD,EAAGoE,eACmE,EAApFD,EAAQ5D,QAAQ,qBAAqBC,QAAQV,KAAK,yBAAyBnD,SAG3EsG,EAAsBoB,aACtBpB,EAAsBoB,YAAYjD,UAEtC6B,EAAsBoB,YAAc,IAAI/F,EAAyB6F,EAASnE,EAAGsE,MAAOtE,EAAGuE,MAAOzC,OAK/FO,EAAAlC,UAAAqE,UAAP,WAAA,IAAA1C,EAAApD,KACIA,KAAKgD,qBACLhD,KAAK4D,QAAQxC,KAAK,YAAYtD,KAAK,SAACC,EAAG1B,GACnCsB,EAAyBa,aAAanC,KAE1C2D,KAAK4D,QAAQxC,KAAK,YAAYtD,KAAK,SAACC,EAAG1B,GACnCsB,EAAyBc,aAAapC,KAE1C2D,KAAKqD,YACL3C,OAAOC,WAAW,WAEdyC,EAAKC,YACLD,EAAKJ,sBACN,MAGAW,EAAAlC,UAAAsE,UAAP,WAAA,IAAA3C,EAAApD,KACIA,KAAKgD,qBACLhD,KAAK4D,QAAQxC,KAAK,YAAYtD,KAAK,SAACC,EAAG1B,GACnCsB,EAAyBgB,aAAad,EAAExB,MAE5C2D,KAAK4D,QAAQxC,KAAK,YAAYtD,KAAK,SAACC,EAAG1B,GACnCsB,EAAyBiB,aAAaf,EAAExB,MAE5C2D,KAAKqD,YACL3C,OAAOC,WAAW,WAEdyC,EAAKC,YACLD,EAAKJ,sBACN,MAGAW,EAAAlC,UAAAuB,mBAAP,WACIhD,KAAKqE,WAAWe,KAAK,iBAGlBzB,EAAAlC,UAAAyB,cAAP,aAKOS,EAAAlC,UAAAP,WAAP,WACI,OAAOlB,KAAKqE,WAAWK,WAGpBf,EAAAlC,UAAAuE,oBAAP,WACI,OAAOhG,KAAK+D,eAGTJ,EAAAlC,UAAAkD,QAAP,SAAejF,GACXM,KAAK4E,YAAYlF,GACjBM,KAAKwF,sBAGD7B,EAAAlC,UAAA0D,cAAR,SAAsBzF,GAClB,IAAMuG,EAAW,CACbC,SAAU,IACVC,UAAW,IACXC,SAAU,IACVC,SAAU,IACVC,SAAU,IACVC,SAAU,IACVC,SAAU,IACVC,SAAU,IACVC,UAAW,IACXC,UAAW,IACXC,UAAW,IACXC,SAAU,IACVC,SAAU,IACVC,WAAY,IACZC,UAAW,IACXC,SAAU,KAMd,OAJAC,OAAOC,KAAKlB,GAAU7J,QAAQ,SAAAgL,GAC1B1H,EAAOA,EAAK6F,QAAQ,IAAI8B,OAAOD,EAAK,KAAMnB,EAASmB,MAGhD1H,EAAK6F,QAAQ,QAAS,KAAKA,QAAQ,QAAS,KAAKA,QAAQ,WAAY,KAGzE5B,EAAAlC,UAAA4B,UAAP,WACQrD,KAAKmF,cAAcnF,KAAKqE,WAAWK,aAAe1E,KAAK+D,eACvD/D,KAAK6D,kBAAkB9B,SAAS,aAChC/B,KAAKgE,YAAa,IAElBhE,KAAK6D,kBAAkBvE,YAAY,aACnCU,KAAKgE,YAAa,GAEqB,EAAvChE,KAAK4D,QAAQxC,KAAK,YAAYnD,QAAqD,EAAvC+B,KAAK4D,QAAQxC,KAAK,YAAYnD,OAC1E+B,KAAK8D,mBAAmBxE,YAAY,UAEpCU,KAAK8D,mBAAmB/B,SAAS,WAIlC4B,EAAAlC,UAAA6F,WAAP,WACI,OAAOtH,KAAKgE,YAqBpBL,EAxLA,GA0LA4D,EAAA,WAKI,SAAAA,EAAoB3D,GAApB,IAAAR,EAAApD,KAAoBA,KAAA4D,QAAAA,EAChB5D,KAAKwH,UAAYjL,SAASqH,EAAQnD,KAAK,cACvCT,KAAKyH,YAAclL,SAASqH,EAAQnD,KAAK,gBAEzC,IAAMwD,EAAYL,EAAQxC,KAAK,qBACzBsG,EAAW9D,EAAQxC,KAAK,qBACxB0C,EAAqBF,EAAQxC,KAAK,sBACxCpB,KAAK2H,SAAW,IAAIhE,EAA8BM,EAAWyD,EAAU5D,GAEvE9D,KAAK4H,cACLhE,EAAQxC,KAAK,oBAAoBtD,KAAK,SAACC,EAAW8J,GAC9C/L,EAAkBgB,kBAAkBe,EAAEgK,GAASpH,KAAK,gBAAiB2C,KA+IjF,OA3IYmE,EAAA9F,UAAAmG,YAAR,WAAA,IAAAxE,EAAApD,KACIA,KAAK4D,QAAQxC,KAAK,oBAAoBgB,MAAM,SAACd,GACzC,IAAMwG,EAASjK,EAAEyD,EAAGoE,eAAetE,KAAK,oBAClC2G,EAAW,WACkB,IAA3BxL,SAASuL,EAAOrD,QAChBqD,EAAOrD,IAAI,KACXqD,EAAOjG,QAAQ,cAAcT,KAAK,QAAQW,SAAS,eAAezC,YAAY,iBAE9EwI,EAAOrD,IAAI,KACXqD,EAAOjG,QAAQ,cAAcT,KAAK,QAAQ9B,YAAY,eAAeyC,SAAS,gBAElFqB,EAAK4E,cAGL5E,EAAKuE,SAASL,aACdW,QAAQC,QAAQhG,IAAI,QAAS,mBAAoB,SAACiG,GAC1CA,GACAJ,MAIRA,MAIR,IAAMK,EAAc,SAACxE,GACjB,IAAMtH,EAAcC,SAASqH,EAAQnD,KAAK,iBACpC4H,EAAgBvM,EAAkBc,mBAAmBN,GACrDgM,EAAiBxM,EAAkBe,oBAAoBP,GAE7DsH,EAAQxC,KAAK,4BAA4B9B,YAAY,YACrDsE,EAAQxC,KAAK,yBAA2BiH,GAAetG,SAAS,YAChE6B,EAAQxC,KAAK,0BAA4BkH,GAAgBvG,SAAS,aAGtE/B,KAAK4D,QAAQxC,KAAK,8BAA8BC,GAAG,mBAAoB,SAAAC,GACnE8G,EAAYvK,EAAEyD,EAAGoE,kBAGrB1F,KAAK4D,QAAQxC,KAAK,yBAAyBgB,MAAM,SAAAd,GAC7CA,EAAGiH,iBACH,IAAM3E,EAAU/F,EAAEyD,EAAGoE,eAAe7D,QAAQ,cACtCvF,EAAcC,SAASqH,EAAQnD,KAAK,iBAC1C3E,EAAkBmB,UAAUX,EAAaC,SAASsB,EAAEyD,EAAGoE,eAAejF,KAAK,YAC3E2H,EAAYxE,KAGhB5D,KAAK4D,QAAQxC,KAAK,0BAA0BgB,MAAM,SAAAd,GAC9CA,EAAGiH,iBACH,IAAM3E,EAAU/F,EAAEyD,EAAGoE,eAAe7D,QAAQ,cACtCvF,EAAcC,SAASqH,EAAQnD,KAAK,iBAC1C3E,EAAkBwB,WAAWhB,EAAauB,EAAEyD,EAAGoE,eAAejF,KAAK,YACnE2H,EAAYxE,KAGhB5D,KAAK4D,QAAQxC,KAAK,iCAAiCgB,MAAM,SAAAd,GACrDA,EAAGiH,iBACHnF,EAAKuE,SAAS7B,cAGlB9F,KAAK4D,QAAQxC,KAAK,iCAAiCgB,MAAM,SAAAd,GACrDA,EAAGiH,iBACHnF,EAAKuE,SAAS5B,eAIfwB,EAAA9F,UAAAjE,0BAAP,WACQwC,KAAK2H,SAASL,aACdhF,QAAQC,IAAI,kCAGhBvC,KAAKgI,cAGFT,EAAA9F,UAAAtE,yBAAP,SAAgCb,EAAqBY,GACjD,GAAI8C,KAAK2H,SAASL,aACdhF,QAAQC,IAAI,sCADhB,CAIA,IAAMqB,EAAU5D,KAAK4D,QAAQxC,KAAK,sCAAwC9E,EAAc,KAClFkM,EAAO5E,EAAQxC,KAAK,QACpB0G,EAASlE,EAAQxC,KAAK,0BAOL,IANnB,CACA3F,EACAC,EACAC,EACAC,EACAC,GACF4M,QAAQvL,IACN4K,EAAOrD,IAAI,KACX+D,EAAKlJ,YAAY,eAAeyC,SAAS,iBAEzC+F,EAAOrD,IAAI,KACX+D,EAAKzG,SAAS,eAAezC,YAAY,gBAE7CU,KAAKgI,eAGDT,EAAA9F,UAAAuG,WAAR,WAAA,IAAA5E,EAAApD,KACU0I,EAAa,GACnB1I,KAAK4D,QAAQxC,KAAK,+BAA+BtD,KAAK,SAACC,EAAG1B,GACtD,IAAMC,EAAcC,SAASsB,EAAExB,GAAIoE,KAAK,iBACxCiI,EAAW1L,KAAK,CACZ2L,GAAIrM,EACJiB,QAASzB,EAAkBe,oBAAoBP,OAGvD,IAAMsM,EAAM5I,KAAK4D,QAAQnD,KAAK,cAAc8E,QAAQ,QAASsD,KAAKC,UAAUJ,IAC5E7K,EAAEkL,IAAIH,EAAK,SAACnI,GACR2C,EAAKuE,SAAShD,QAAQlE,EAAK0B,MAE3B,IAAI6G,EAAa,GACjBvI,EAAKuI,WAAW5M,QAAQ,SAAA6M,GACpBD,GAAcC,IAGlB7F,EAAKQ,QAAQxC,KAAK,qBAAqB1B,KAAKsJ,GACf,EAAzBvI,EAAKuI,WAAW/K,OAChBmF,EAAKQ,QAAQ7B,SAAS,iBAEtBqB,EAAKQ,QAAQtE,YAAY,oBAK9BiI,EAAA9F,UAAAyH,aAAP,WACI,IAAMC,EAAmB,GAOzB,OANAnJ,KAAK4D,QAAQxC,KAAK,oBAAoBtD,KAAK,SAAC6K,EAAItM,GAC5C,IAAM2F,EAAMnE,EAAExB,GACwB,EAAlC2F,EAAIZ,KAAK,gBAAgBnD,QACzBkL,EAAiBnM,KAAKgF,EAAIvB,KAAK,mBAGhC,CACH0I,iBAAgBA,EAChBhH,KAAMnC,KAAK2H,SAASzG,aACpBkI,UAAWpJ,KAAK2H,SAAS3B,wBAGrCuB,EA/JA,GAoKAhD,EAAA,WAQI,SAAAA,EAAY8E,GAAZ,IAAAjG,EAAApD,KAFQA,KAAAsJ,WAA+C,GAGnD/E,EAAsB8E,MAAQA,EAC9BvN,EAAkBC,KAAKsN,EAAM5I,KAAK,uBAElC5C,EAAE,qBAAqBC,KAAK,SAACC,EAAG1B,GAC5B,IAAMkN,EAAQ1L,EAAExB,GAChBkN,EAAMnI,KAAK,qBAAqBC,GAAG,YAAa,SAACC,GAC7CiD,EAAsBiF,WAAalI,EAAGmI,UAG1CrG,EAAKkG,WAAWtM,KAAK,IAAIuK,EAA+BgC,MAG5DhF,EAAsB8E,MAAMhI,GAAG,SAAU,WACrCxD,EAAE6C,QAAQgJ,IAAI,eAAgBnF,EAAsBoF,eAExD9L,EAAE6C,QAAQW,GAAG,eAAgBkD,EAAsBoF,aAEnD3J,KAAK4J,kBA8Gb,OA3GkBrF,EAAAoF,YAAd,WACI,OAAOzH,IAAI,MAAO,uBAGRqC,EAAAC,kBAAd,SAAgCqF,GAC5B7J,KAAKqJ,MAAMS,OAAOD,IAGdtF,EAAA9C,UAAAsI,aAAR,SAAqBC,GACjBhK,KAAKiK,kBAAkB7I,KAAK,oBAAoB8I,OAEhD,IAKIC,EAAetM,EAAE,QAAQoE,KAAK,QAC9BmI,EAAY,IAAIC,KAAKC,eAAeH,EAN1B,CACNI,KAAM,UAAWC,MAAO,UAAWC,IAAK,UACxCC,KAAM,UAAWC,OAAQ,UACzBC,QAAQ,IAGuCC,OAAOb,GAE9DhK,KAAKiK,kBAAkB7I,KAAK,qBAAqBe,KAAKiI,IAGlD7F,EAAA9C,UAAAqJ,UAAR,WAAA,IAAA1H,EAAApD,KACUS,EAAO,CACTsK,kBAAqBjP,EAAkB2B,iBACvCuN,kBAAqBlP,EAAkB4B,iBACvC4L,WAAc,GACd2B,SAAY,IAEhBpN,EAAE,iBAAiBC,KAAK,SAACC,EAAG1B,GACxB,IAAM6O,EAAWrN,EAAExB,GACfmL,EAAY0D,EAASzK,KAAK,cAC9BA,EAAKwK,SAASzD,GAAa0D,EAAS9J,KAAK,iBAAiBqD,QAG9DzE,KAAKsJ,WAAWlN,QAAQ,SAAA+O,GACpB1K,EAAK6I,WAAW6B,EAAK3D,UAAY,IAAM2D,EAAK1D,aAAe0D,EAAKjC,iBAEpE,IAAIkC,EAAoBpL,KAAKiK,kBAAkB7I,KAAK,sBAAsBiK,KAAK,WAE/ExN,EAAEyN,KAAK,CACHC,KAAM,OACN3C,IAAKrE,EAAsB8E,MAAM5I,KAAK,eACtCA,KAAM,CACF+K,OAAWJ,EAAW,EAAI,EAC1B3K,KAAQoI,KAAKC,UAAUrI,GACvBgL,MAASlH,EAAsB8E,MAAMjI,KAAK,uBAAuBqD,OAErEiH,QAAS,SAACC,GACFA,EAAa,SACbvI,EAAK6G,kBAAkB7I,KAAK,gBAAgBW,SAAS,UACrDqB,EAAK2G,aAAa,IAAI6B,KAAKD,EAAU,OACjCP,EACA7G,EAAsB8E,MAAMjI,KAAK,eAAe9B,YAAY,UAE5DiF,EAAsB8E,MAAMjI,KAAK,eAAeW,SAAS,YAG7DqB,EAAK6G,kBAAkB7I,KAAK,gBAAgB9B,YAAY,UACxD8D,EAAK6G,kBAAkB7I,KAAK,8BAA8BW,SAAS,UACnEqB,EAAK6G,kBAAkB7I,KAAK,6BAA6Be,KAAKwJ,EAAW,OAAGrM,YAAY,YAGhGuM,MAAO,WACHzI,EAAK6G,kBAAkB7I,KAAK,gBAAgB9B,YAAY,UACxD8D,EAAK6G,kBAAkB7I,KAAK,8BAA8B9B,YAAY,UACtE8D,EAAK6G,kBAAkB7I,KAAK,6BAA6Be,KAAK,IAAIJ,SAAS,cAK/EwC,EAAA9C,UAAAqK,oBAAR,WAAA,IAAA1I,EAAApD,KACQ+L,EAAkB/L,KAAKiK,kBAAkB7I,KAAK,wBAQlD,GANAV,OAAOsL,YAAY,WACXD,EAAQV,KAAK,YACbjI,EAAK0H,aAEV,KAECmB,aAAc,CACd,IAAIC,EAAQD,aAAaE,QAAQ,2BACnB,OAAVD,GACAH,EAAQV,KAAK,UAAqB,KAATa,GAGjCH,EAAQK,OAAO,WACX,IAAIC,EAAkBN,EAAQV,KAAK,WAC/BY,cACAA,aAAaK,QAAQ,0BAA4BD,EAAS,IAAM,OAErE/L,QAAQ,WAGPiE,EAAA9C,UAAAmI,gBAAR,WAMI,GALA5J,KAAKiK,kBAAoB1F,EAAsB8E,MAAMjI,KAAK,qBAC1DpB,KAAKiK,kBAAkB7I,KAAK,cAAcC,GAAG,QAASrB,KAAK8K,UAAU3J,KAAKnB,OAC1EA,KAAKiK,kBAAkB7I,KAAK,sBAAsBC,GAAG,SAAUrB,KAAK8K,UAAU3J,KAAKnB,OACnFA,KAAK8L,sBAED9L,KAAKiK,kBAAkBxJ,KAAK,gBAAiB,CAC7C,IAAIuJ,EAAO,IAAI4B,KAAK5L,KAAKiK,kBAAkBxJ,KAAK,iBAChDT,KAAK+J,aAAaC,GAGtBnM,EAAE,sBAAsBK,UArIdqG,EAAAoB,YAAwC,KACxCpB,EAAAiF,WAAqB,KAsIvCjF,EAxIA,GAAa5E,EAAA4E,sBAAAA","file":"MotionMergeAmendments.js","sourcesContent":["import { AntragsgruenEditor } from \"../shared/AntragsgruenEditor\";\nimport editor = CKEDITOR.editor;\n\nconst STATUS_ACCEPTED = 4;\nconst STATUS_MODIFIED_ACCEPTED = 6;\nconst STATUS_PROCESSED = 17;\nconst STATUS_ADOPTED = 8;\nconst STATUS_COMPLETED = 9;\n\nenum AMENDMENT_VERSION {\n    ORIGINAL = 'orig',\n    PROPOSED_PROCEDURE = 'prop',\n}\n\nclass AmendmentStatuses {\n    private static statuses: { [amendmentId: number]: number };\n    private static versions: { [amendmentId: number]: AMENDMENT_VERSION };\n    private static statusListeners: { [amendmentId: number]: MotionMergeAmendmentsParagraph[] } = {};\n    private static inputs: { [amendmentId: number]: HTMLElement } = {};\n\n    public static init(versions: { [amendmentId: number]: AMENDMENT_VERSION }) {\n        AmendmentStatuses.statuses = {};\n\n        document.querySelectorAll(\"input.amendmentStatus[type=hidden]\").forEach((el: HTMLElement) => {\n            const amendmentId = parseInt(el.getAttribute(\"name\").split(\"[\")[1]);\n            AmendmentStatuses.statuses[amendmentId] = parseInt(el.getAttribute(\"value\"));\n            AmendmentStatuses.inputs[amendmentId] = el;\n            AmendmentStatuses.statusListeners[amendmentId] = [];\n        });\n\n        AmendmentStatuses.versions = versions;\n    }\n\n    public static getAmendmentStatus(amendmentId: number): number {\n        return AmendmentStatuses.statuses[amendmentId];\n    }\n\n    public static getAmendmentVersion(amendmentId: number): AMENDMENT_VERSION {\n        return AmendmentStatuses.versions[amendmentId];\n    }\n\n    public static registerParagraph(amendmentId: number, paragraph: MotionMergeAmendmentsParagraph) {\n        AmendmentStatuses.statusListeners[amendmentId].push(paragraph);\n    }\n\n    public static setStatus(amendmentId: number, status: number) {\n        AmendmentStatuses.statuses[amendmentId] = status;\n        AmendmentStatuses.statusListeners[amendmentId].forEach(paragraph => {\n            paragraph.onAmendmentStatusChanged(amendmentId, status);\n        });\n        AmendmentStatuses.inputs[amendmentId].setAttribute(\"value\", status.toString(10));\n    }\n\n    public static setVersion(amendmentId: number, version: AMENDMENT_VERSION) {\n        AmendmentStatuses.versions[amendmentId] = version;\n        AmendmentStatuses.statusListeners[amendmentId].forEach(paragraph => {\n            paragraph.onAmendmentVersionChanged();\n        });\n    }\n\n    public static getAllStatuses(): { [amendmentId: number]: number } {\n        return AmendmentStatuses.statuses;\n    }\n\n    public static getAllVersions(): { [amendmentId: number]: AMENDMENT_VERSION } {\n        return AmendmentStatuses.versions;\n    }\n}\n\nexport class MotionMergeChangeActions {\n    public static removeEmptyParagraphs() {\n        $('.paragraphHolder').each((i, el) => {\n            if (el.childNodes.length == 0) {\n                $(el).remove();\n            }\n        });\n    }\n\n    public static accept(node: Element, onFinished: () => void = null) {\n        let $node = $(node);\n        if ($node.hasClass(\"ice-ins\")) {\n            MotionMergeChangeActions.insertAccept(node, onFinished);\n        }\n        if ($node.hasClass(\"ice-del\")) {\n            MotionMergeChangeActions.deleteAccept(node, onFinished);\n        }\n    }\n\n    public static reject(node: Element, onFinished: () => void = null) {\n        let $node = $(node);\n        if ($node.hasClass(\"ice-ins\")) {\n            MotionMergeChangeActions.insertReject($node, onFinished);\n        }\n        if ($node.hasClass(\"ice-del\")) {\n            MotionMergeChangeActions.deleteReject($node, onFinished);\n        }\n    }\n\n    public static insertReject($node: JQuery, onFinished: () => void = null) {\n        let $removeEl: JQuery,\n            name = $node[0].nodeName.toLowerCase();\n        if (name == 'li') {\n            $removeEl = $node.parent();\n        } else {\n            $removeEl = $node;\n        }\n        if (name == 'ul' || name == 'ol' || name == 'li' || name == 'blockquote' || name == 'pre' || name == 'p') {\n            $removeEl.css(\"overflow\", \"hidden\").height($removeEl.height());\n            $removeEl.animate({\"height\": \"0\"}, 250, () => {\n                $removeEl.remove();\n                $(\".collidingParagraph:empty\").remove();\n                MotionMergeChangeActions.removeEmptyParagraphs();\n                if (onFinished) onFinished();\n            });\n        } else {\n            $removeEl.remove();\n            if (onFinished) onFinished();\n        }\n    }\n\n    public static insertAccept(node: Element, onFinished: () => void = null) {\n        let $this: JQuery = $(node);\n        $this.removeClass(\"ice-cts ice-ins appendHint moved\");\n        $this.removeAttr(\"data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg\");\n        if (node.nodeName.toLowerCase() == 'ul' || node.nodeName.toLowerCase() == 'ol') {\n            $this.children().removeClass(\"ice-cts\").removeClass(\"ice-ins\").removeClass(\"appendHint\");\n        }\n        if (node.nodeName.toLowerCase() == 'li') {\n            $this.parent().removeClass(\"ice-cts\").removeClass(\"ice-ins\").removeClass(\"appendHint\");\n        }\n        if (node.nodeName.toLowerCase() == 'ins') {\n            $this.replaceWith($this.html());\n        }\n        if (onFinished) onFinished();\n    }\n\n    public static deleteReject($node: JQuery, onFinished: () => void = null) {\n        $node.removeClass(\"ice-cts ice-del appendHint\");\n        $node.removeAttr(\"data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg\");\n        let nodeName = $node[0].nodeName.toLowerCase();\n        if (nodeName == 'ul' || nodeName == 'ol') {\n            $node.children().removeClass(\"ice-cts\").removeClass(\"ice-del\").removeClass(\"appendHint\");\n        }\n        if (nodeName == 'li') {\n            $node.parent().removeClass(\"ice-cts\").removeClass(\"ice-del\").removeClass(\"appendHint\");\n        }\n        if (nodeName == 'del') {\n            $node.replaceWith($node.html());\n        }\n        if (onFinished) onFinished();\n    }\n\n    public static deleteAccept(node: Element, onFinished: () => void = null) {\n        let name = node.nodeName.toLowerCase(),\n            $removeEl: JQuery;\n        if (name == 'li') {\n            $removeEl = $(node).parent();\n        } else {\n            $removeEl = $(node);\n        }\n\n        if (name == 'ul' || name == 'ol' || name == 'li' || name == 'blockquote' || name == 'pre' || name == 'p') {\n            $removeEl.css(\"overflow\", \"hidden\").height($removeEl.height());\n            $removeEl.animate({\"height\": \"0\"}, 250, () => {\n                $removeEl.remove();\n                $(\".collidingParagraph:empty\").remove();\n                MotionMergeChangeActions.removeEmptyParagraphs();\n                if (onFinished) onFinished();\n            });\n        } else {\n            $removeEl.remove();\n            if (onFinished) onFinished();\n        }\n    }\n}\n\n\nclass MotionMergeChangeTooltip {\n    constructor(private $element: JQuery, mouseX: number, mouseY: number, private parent: MotionMergeAmendmentsTextarea) {\n        let positionX: number = null,\n            positionY: number = null;\n        $element.popover({\n            'container': 'body',\n            'animation': false,\n            'trigger': 'manual',\n            'placement': function (popover) {\n                let $popover = $(<any>popover);\n                $popover.data(\"element\", $element);\n                window.setTimeout(() => {\n                    let width = $popover.width(),\n                        elTop = $element.offset().top,\n                        elHeight = $element.height();\n                    if (positionX === null && width > 0) {\n                        positionX = (mouseX - width / 2);\n                        positionY = mouseY + 10;\n                        if (positionY < (elTop + 19)) {\n                            positionY = elTop + 19;\n                        }\n                        if (positionY > elTop + elHeight) {\n                            positionY = elTop + elHeight;\n                        }\n                    }\n                    $popover.css(\"left\", positionX + \"px\");\n                    $popover.css(\"top\", positionY + \"px\");\n                }, 1);\n                return \"bottom\";\n            },\n            'html': true,\n            'content': this.getContent.bind(this)\n        });\n\n        $element.popover('show');\n        let $popover: JQuery = $element.find(\"> .popover\");\n        $popover.on(\"mousemove\", (ev) => {\n            ev.stopPropagation();\n        });\n        window.setTimeout(this.removePopupIfInactive.bind(this), 1000);\n    }\n\n    private getContent() {\n        let $myEl: JQuery = this.$element,\n            html,\n            cid = $myEl.data(\"cid\");\n        if (cid == undefined) {\n            cid = $myEl.parent().data(\"cid\");\n        }\n        $myEl.parents(\".texteditor\").first().find(\"[data-cid=\" + cid + \"]\").addClass(\"hover\");\n\n        html = '<div>';\n        html += '<button type=\"button\" class=\"accept btn btn-sm btn-default\"></button>';\n        html += '<button type=\"button\" class=\"reject btn btn-sm btn-default\"></button>';\n        html += '<a href=\"#\" class=\"btn btn-small btn-default opener\" target=\"_blank\"><span class=\"glyphicon glyphicon-new-window\"></span></a>';\n        html += '<div class=\"initiator\" style=\"font-size: 0.8em;\"></div>';\n        html += '</div>';\n        let $el: JQuery = $(html);\n        $el.find(\".opener\").attr(\"href\", $myEl.data(\"link\")).attr(\"title\", __t(\"merge\", \"title_open_in_blank\"));\n        $el.find(\".initiator\").text(__t(\"merge\", \"initiated_by\") + \": \" + $myEl.data(\"username\"));\n        if ($myEl.hasClass(\"ice-ins\")) {\n            $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).click(this.accept.bind(this));\n            $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).click(this.reject.bind(this));\n        } else if ($myEl.hasClass(\"ice-del\")) {\n            $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).click(this.accept.bind(this));\n            $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).click(this.reject.bind(this));\n        } else if ($myEl[0].nodeName.toLowerCase() == 'li') {\n            let $list = $myEl.parent();\n            if ($list.hasClass(\"ice-ins\")) {\n                $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).click(this.accept.bind(this));\n                $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).click(this.reject.bind(this));\n            } else if ($list.hasClass(\"ice-del\")) {\n                $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).click(this.accept.bind(this));\n                $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).click(this.reject.bind(this));\n            } else {\n                console.log(\"unknown\", $list);\n            }\n        } else {\n            console.log(\"unknown\", $myEl);\n            alert(\"unknown\");\n        }\n        return $el;\n    }\n\n    private removePopupIfInactive() {\n        if (this.$element.is(\":hover\")) {\n            return window.setTimeout(this.removePopupIfInactive.bind(this), 1000);\n        }\n        if ($(\"body\").find(\".popover:hover\").length > 0) {\n            return window.setTimeout(this.removePopupIfInactive.bind(this), 1000);\n        }\n        this.destroy();\n    }\n\n    private affectedChangesets() {\n        let cid = this.$element.data(\"cid\");\n        if (cid == undefined) {\n            cid = this.$element.parent().data(\"cid\");\n        }\n        return this.$element.parents(\".texteditor\").find(\"[data-cid=\" + cid + \"]\");\n    }\n\n    private performActionWithUI(action) {\n        let scrollX = window.scrollX,\n            scrollY = window.scrollY;\n\n        this.parent.saveEditorSnapshot();\n        this.destroy();\n        action.call(this);\n        this.parent.focusTextarea();\n\n        window.scrollTo(scrollX, scrollY);\n    }\n\n    private accept() {\n        this.performActionWithUI(() => {\n            this.affectedChangesets().each((i, el) => {\n                MotionMergeChangeActions.accept(el, () => {\n                    this.parent.onChanged();\n                });\n            });\n        });\n    }\n\n    private reject() {\n        this.performActionWithUI(() => {\n            this.affectedChangesets().each((i, el) => {\n                MotionMergeChangeActions.reject(el, () => {\n                    this.parent.onChanged();\n                });\n            });\n        });\n    }\n\n    public destroy() {\n        this.$element.popover(\"hide\").popover(\"destroy\");\n\n        let cid = this.$element.data(\"cid\");\n        if (cid == undefined) {\n            cid = this.$element.parent().data(\"cid\");\n        }\n\n        let focusAtSameCid = false;\n        this.$element.parents(\".texteditor\").first().find(\"[data-cid=\" + cid + \"]\").each((i, el) => {\n            if ($(el).is(\":hover\")) {\n                focusAtSameCid = true;\n            }\n        });\n        if (!focusAtSameCid) {\n            this.$element.parents(\".texteditor\").first().find(\"[data-cid=\" + cid + \"]\").removeClass(\"hover\");\n        }\n\n        try {\n            // Remove stale objects that were not removed correctly previously\n            $(\".popover\").each((i, stale) => {\n                const $stale = $(stale);\n                if (!$stale.data(\"element\").is(\":hover\")) {\n                    $stale.popover(\"hide\").popover(\"destroy\");\n                    $stale.remove();\n                    console.warn(\"Removed stale window: \", $stale);\n                }\n            });\n        } catch (e) {\n        }\n    }\n}\n\nclass MotionMergeAmendmentsTextarea {\n    private texteditor: editor;\n    private unchangedText: string = null;\n    private hasChanged: boolean = false;\n\n    private prepareText(html: string) {\n        let $text: JQuery = $('<div>' + html + '</div>');\n\n        // Move the amendment-Data from OL's and UL's to their list items\n        $text.find(\"ul.appendHint, ol.appendHint\").each((i, el) => {\n            let $this: JQuery = $(el),\n                appendHint = $this.data(\"append-hint\");\n            $this.find(\"> li\").addClass(\"appendHint\").attr(\"data-append-hint\", appendHint)\n                .attr(\"data-link\", $this.data(\"link\"))\n                .attr(\"data-username\", $this.data(\"username\"));\n            $this.removeClass(\"appendHint\").removeData(\"append-hint\");\n        });\n\n        // Remove double markup\n        $text.find(\".moved .moved\").removeClass('moved');\n        $text.find(\".moved\").each(this.markupMovedParagraph.bind(this));\n\n        // Add hints about starting / ending collisions\n        $text.find(\".hasCollisions\")\n            .attr(\"data-collision-start-msg\", __t('merge', 'colliding_start'))\n            .attr(\"data-collision-end-msg\", __t('merge', 'colliding_end'));\n\n        let newText = $text.html();\n        this.texteditor.setData(newText);\n        this.unchangedText = this.normalizeHtml(this.texteditor.getData());\n        this.texteditor.fire('saveSnapshot');\n        this.onChanged();\n    }\n\n    private markupMovedParagraph(i, el) {\n        let $node = $(el),\n            paragraphNew = $node.data('moving-partner-paragraph'),\n            msg: string;\n\n        if ($node.hasClass('inserted')) {\n            msg = __t('std', 'moved_paragraph_from');\n        } else {\n            msg = __t('std', 'moved_paragraph_to');\n        }\n        msg = msg.replace(/##PARA##/, (paragraphNew + 1));\n\n        if ($node[0].nodeName === 'LI') {\n            $node = $node.parent();\n        }\n\n        $node.attr(\"data-moving-msg\", msg);\n    }\n\n    private initializeTooltips() {\n        this.$holder.on(\"mouseover\", \".appendHint\", (ev) => {\n            const $target = $(ev.currentTarget);\n            if ($target.parents('.paragraphWrapper').first().find('.amendmentStatus.open').length > 0) {\n                return;\n            }\n            if (MotionMergeAmendments.activePopup) {\n                MotionMergeAmendments.activePopup.destroy();\n            }\n            MotionMergeAmendments.activePopup = new MotionMergeChangeTooltip($target, ev.pageX, ev.pageY, this);\n        });\n    }\n\n\n    public acceptAll() {\n        this.saveEditorSnapshot();\n        this.$holder.find(\".ice-ins\").each((i, el) => {\n            MotionMergeChangeActions.insertAccept(el);\n        });\n        this.$holder.find(\".ice-del\").each((i, el) => {\n            MotionMergeChangeActions.deleteAccept(el);\n        });\n        this.onChanged();\n        window.setTimeout(() => {\n            // Wait for animation -> remove \"all dropdown\"\n            this.onChanged();\n            this.saveEditorSnapshot();\n        }, 1000);\n    }\n\n    public rejectAll() {\n        this.saveEditorSnapshot();\n        this.$holder.find(\".ice-ins\").each((i, el) => {\n            MotionMergeChangeActions.insertReject($(el));\n        });\n        this.$holder.find(\".ice-del\").each((i, el) => {\n            MotionMergeChangeActions.deleteReject($(el));\n        });\n        this.onChanged();\n        window.setTimeout(() => {\n            // Wait for animation -> remove \"all dropdown\"\n            this.onChanged();\n            this.saveEditorSnapshot();\n        }, 1000);\n    }\n\n    public saveEditorSnapshot() {\n        this.texteditor.fire('saveSnapshot');\n    }\n\n    public focusTextarea() {\n        //this.$holder.find(\".texteditor\").focus();\n        // This lead to strange cursor behavior, e.g. when removing a colliding paragraph\n    }\n\n    public getContent(): string {\n        return this.texteditor.getData();\n    }\n\n    public getUnchangedContent(): string {\n        return this.unchangedText;\n    }\n\n    public setText(html: string) {\n        this.prepareText(html);\n        this.initializeTooltips();\n    }\n\n    private normalizeHtml(html: string) {\n        const entities = {\n            '&nbsp;': ' ',\n            '&ndash;': '-',\n            '&auml;': 'ä',\n            '&ouml;': 'ö',\n            '&uuml;': 'ü',\n            '&Auml;': 'Ä',\n            '&Ouml;': 'Ö',\n            '&Uuml;': 'Ü',\n            '&szlig;': 'ß',\n            '&bdquo;': '„',\n            '&ldquo;': '“',\n            '&bull;': '•',\n            '&sect;': '§',\n            '&eacute;': 'é',\n            '&rsquo;': '’',\n            '&euro;': '€'\n        };\n        Object.keys(entities).forEach(ent => {\n            html = html.replace(new RegExp(ent, 'g'), entities[ent]);\n        });\n\n        return html.replace(/\\s+</g, '<').replace(/>\\s+/g, '>').replace(/<[^>]*>/g, '');\n    }\n\n    public onChanged() {\n        if (this.normalizeHtml(this.texteditor.getData()) === this.unchangedText) {\n            this.$changedIndicator.addClass(\"unchanged\");\n            this.hasChanged = false;\n        } else {\n            this.$changedIndicator.removeClass(\"unchanged\");\n            this.hasChanged = true;\n        }\n        if (this.$holder.find(\".ice-ins\").length > 0 || this.$holder.find(\".ice-del\").length > 0) {\n            this.$mergeActionHolder.removeClass(\"hidden\");\n        } else {\n            this.$mergeActionHolder.addClass(\"hidden\");\n        }\n    }\n\n    public hasChanges(): boolean {\n        return this.hasChanged;\n    }\n\n    constructor(private $holder: JQuery, private $changedIndicator: JQuery, private $mergeActionHolder: JQuery) {\n        let $textarea = $holder.find(\".texteditor\");\n        let edit = new AntragsgruenEditor($textarea.attr(\"id\"));\n        this.texteditor = edit.getEditor();\n        MotionMergeAmendments.addSubmitListener(() => {\n            $holder.find(\"textarea.raw\").val(this.texteditor.getData());\n            $holder.find(\"textarea.consolidated\").val(this.texteditor.getData());\n        });\n\n        this.setText(this.texteditor.getData());\n\n        if ($holder.data(\"unchanged\")) {\n            this.unchangedText = $holder.data(\"unchanged\");\n            this.onChanged();\n        }\n\n        this.texteditor.on('change', this.onChanged.bind(this));\n    }\n}\n\nclass MotionMergeAmendmentsParagraph {\n    public sectionId: number;\n    public paragraphId: number;\n    public textarea: MotionMergeAmendmentsTextarea;\n\n    constructor(private $holder: JQuery) {\n        this.sectionId = parseInt($holder.data('sectionId'));\n        this.paragraphId = parseInt($holder.data('paragraphId'));\n\n        const $textarea = $holder.find(\".wysiwyg-textarea\");\n        const $changed = $holder.find(\".changedIndicator\");\n        const $mergeActionHolder = $holder.find(\".mergeActionHolder\");\n        this.textarea = new MotionMergeAmendmentsTextarea($textarea, $changed, $mergeActionHolder);\n\n        this.initButtons();\n        $holder.find(\".amendmentStatus\").each((i: number, element) => {\n            AmendmentStatuses.registerParagraph($(element).data(\"amendment-id\"), this);\n        });\n    }\n\n    private initButtons() {\n        this.$holder.find('.toggleAmendment').click((ev) => {\n            const $input = $(ev.currentTarget).find(\".amendmentActive\");\n            const doToggle = () => {\n                if (parseInt($input.val()) === 1) {\n                    $input.val(\"0\");\n                    $input.parents(\".btn-group\").find(\".btn\").addClass(\"btn-default\").removeClass(\"btn-success\");\n                } else {\n                    $input.val(\"1\");\n                    $input.parents(\".btn-group\").find(\".btn\").removeClass(\"btn-default\").addClass(\"btn-success\");\n                }\n                this.reloadText();\n            };\n\n            if (this.textarea.hasChanges()) {\n                bootbox.confirm(__t('merge', 'reloadParagraph'), (result) => {\n                    if (result) {\n                        doToggle();\n                    }\n                });\n            } else {\n                doToggle();\n            }\n        });\n\n        const initTooltip = ($holder: JQuery) => {\n            const amendmentId = parseInt($holder.data(\"amendment-id\"));\n            const currentStatus = AmendmentStatuses.getAmendmentStatus(amendmentId);\n            const currentVersion = AmendmentStatuses.getAmendmentVersion(amendmentId);\n\n            $holder.find(\".dropdown-menu .selected\").removeClass(\"selected\");\n            $holder.find(\".dropdown-menu .status\" + currentStatus).addClass(\"selected\");\n            $holder.find(\".dropdown-menu .version\" + currentVersion).addClass(\"selected\");\n        };\n\n        this.$holder.find('.btn-group.amendmentStatus').on('show.bs.dropdown', ev => {\n            initTooltip($(ev.currentTarget))\n        });\n\n        this.$holder.find(\".btn-group .setStatus\").click(ev => {\n            ev.preventDefault();\n            const $holder = $(ev.currentTarget).parents(\".btn-group\");\n            const amendmentId = parseInt($holder.data(\"amendment-id\"));\n            AmendmentStatuses.setStatus(amendmentId, parseInt($(ev.currentTarget).data(\"status\")));\n            initTooltip($holder);\n        });\n\n        this.$holder.find(\".btn-group .setVersion\").click(ev => {\n            ev.preventDefault();\n            const $holder = $(ev.currentTarget).parents(\".btn-group\");\n            const amendmentId = parseInt($holder.data(\"amendment-id\"));\n            AmendmentStatuses.setVersion(amendmentId, $(ev.currentTarget).data(\"version\"));\n            initTooltip($holder);\n        });\n\n        this.$holder.find(\".mergeActionHolder .acceptAll\").click(ev => {\n            ev.preventDefault();\n            this.textarea.acceptAll();\n        });\n\n        this.$holder.find(\".mergeActionHolder .rejectAll\").click(ev => {\n            ev.preventDefault();\n            this.textarea.rejectAll();\n        });\n    }\n\n    public onAmendmentVersionChanged() {\n        if (this.textarea.hasChanges()) {\n            console.log(\"Skipping, as there are changes\");\n            return;\n        }\n        this.reloadText();\n    }\n\n    public onAmendmentStatusChanged(amendmentId: number, status: number) {\n        if (this.textarea.hasChanges()) {\n            console.log(\"Skipping, as there are changes\");\n            return;\n        }\n        const $holder = this.$holder.find(\".amendmentStatus[data-amendment-id=\" + amendmentId + \"]\");\n        const $btn = $holder.find(\".btn\");\n        const $input = $holder.find(\"input.amendmentActive\");\n        if ([\n            STATUS_ACCEPTED,\n            STATUS_MODIFIED_ACCEPTED,\n            STATUS_PROCESSED,\n            STATUS_ADOPTED,\n            STATUS_COMPLETED\n        ].indexOf(status) !== -1) {\n            $input.val(\"1\");\n            $btn.removeClass(\"btn-default\").addClass(\"btn-success\");\n        } else {\n            $input.val(\"0\");\n            $btn.addClass(\"btn-default\").removeClass(\"btn-success\");\n        }\n        this.reloadText();\n    }\n\n    private reloadText() {\n        const amendments = [];\n        this.$holder.find(\".amendmentActive[value='1']\").each((i, el) => {\n            const amendmentId = parseInt($(el).data('amendment-id'));\n            amendments.push({\n                id: amendmentId,\n                version: AmendmentStatuses.getAmendmentVersion(amendmentId),\n            });\n        });\n        const url = this.$holder.data(\"reload-url\").replace('DUMMY', JSON.stringify(amendments));\n        $.get(url, (data) => {\n            this.textarea.setText(data.text);\n\n            let collisions = '';\n            data.collisions.forEach(str => {\n                collisions += str;\n            });\n\n            this.$holder.find(\".collisionsHolder\").html(collisions);\n            if (data.collisions.length > 0) {\n                this.$holder.addClass(\"hasCollisions\");\n            } else {\n                this.$holder.removeClass(\"hasCollisions\");\n            }\n        });\n    }\n\n    public getDraftData() {\n        const amendmentToggles = [];\n        this.$holder.find(\".amendmentStatus\").each((id, el) => {\n            const $el = $(el);\n            if ($el.find(\".btn-success\").length > 0) {\n                amendmentToggles.push($el.data(\"amendment-id\"));\n            }\n        });\n        return {\n            amendmentToggles,\n            text: this.textarea.getContent(),\n            unchanged: this.textarea.getUnchangedContent(),\n        };\n    }\n}\n\n/**\n * Singleton object\n */\nexport class MotionMergeAmendments {\n    public static activePopup: MotionMergeChangeTooltip = null;\n    public static currMouseX: number = null;\n    public static $form;\n\n    public $draftSavingPanel: JQuery;\n    private paragraphs: MotionMergeAmendmentsParagraph[] = [];\n\n    constructor($form: JQuery) {\n        MotionMergeAmendments.$form = $form;\n        AmendmentStatuses.init($form.data(\"amendment-versions\"));\n\n        $(\".paragraphWrapper\").each((i, el) => {\n            const $para = $(el);\n            $para.find(\".wysiwyg-textarea\").on(\"mousemove\", (ev) => {\n                MotionMergeAmendments.currMouseX = ev.offsetX;\n            });\n\n            this.paragraphs.push(new MotionMergeAmendmentsParagraph($para));\n        });\n\n        MotionMergeAmendments.$form.on(\"submit\", () => {\n            $(window).off(\"beforeunload\", MotionMergeAmendments.onLeavePage);\n        });\n        $(window).on(\"beforeunload\", MotionMergeAmendments.onLeavePage);\n\n        this.initDraftSaving();\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    public static addSubmitListener(cb) {\n        this.$form.submit(cb);\n    }\n\n    private setDraftDate(date: Date) {\n        this.$draftSavingPanel.find(\".lastSaved .none\").hide();\n\n        let options = {\n                year: 'numeric', month: 'numeric', day: 'numeric',\n                hour: 'numeric', minute: 'numeric',\n                hour12: false\n            },\n            lang: string = $(\"html\").attr(\"lang\"),\n            formatted = new Intl.DateTimeFormat(lang, options).format(date);\n\n        this.$draftSavingPanel.find(\".lastSaved .value\").text(formatted);\n    }\n\n    private saveDraft() {\n        const data = {\n            \"amendmentStatuses\": AmendmentStatuses.getAllStatuses(),\n            \"amendmentVersions\": AmendmentStatuses.getAllVersions(),\n            \"paragraphs\": {},\n            \"sections\": {},\n        };\n        $(\".sectionType0\").each((i, el) => {\n            const $section = $(el),\n                sectionId = $section.data(\"section-id\");\n            data.sections[sectionId] = $section.find(\".form-control\").val();\n        });\n\n        this.paragraphs.forEach(para => {\n            data.paragraphs[para.sectionId + '_' + para.paragraphId] = para.getDraftData();\n        });\n        let isPublic: boolean = this.$draftSavingPanel.find('input[name=public]').prop('checked');\n\n        $.ajax({\n            type: \"POST\",\n            url: MotionMergeAmendments.$form.data('draftSaving'),\n            data: {\n                'public': (isPublic ? 1 : 0),\n                'data': JSON.stringify(data),\n                '_csrf': MotionMergeAmendments.$form.find('> input[name=_csrf]').val()\n            },\n            success: (ret) => {\n                if (ret['success']) {\n                    this.$draftSavingPanel.find('.savingError').addClass('hidden');\n                    this.setDraftDate(new Date(ret['date']));\n                    if (isPublic) {\n                        MotionMergeAmendments.$form.find('.publicLink').removeClass('hidden');\n                    } else {\n                        MotionMergeAmendments.$form.find('.publicLink').addClass('hidden');\n                    }\n                } else {\n                    this.$draftSavingPanel.find('.savingError').removeClass('hidden');\n                    this.$draftSavingPanel.find('.savingError .errorNetwork').addClass('hidden');\n                    this.$draftSavingPanel.find('.savingError .errorHolder').text(ret['error']).removeClass('hidden');\n                }\n            },\n            error: () => {\n                this.$draftSavingPanel.find('.savingError').removeClass('hidden');\n                this.$draftSavingPanel.find('.savingError .errorNetwork').removeClass('hidden');\n                this.$draftSavingPanel.find('.savingError .errorHolder').text('').addClass('hidden');\n            }\n        });\n    }\n\n    private initAutosavingDraft() {\n        let $toggle: JQuery = this.$draftSavingPanel.find('input[name=autosave]');\n\n        window.setInterval(() => {\n            if ($toggle.prop('checked')) {\n                this.saveDraft();\n            }\n        }, 5000);\n\n        if (localStorage) {\n            let state = localStorage.getItem('merging-draft-auto-save');\n            if (state !== null) {\n                $toggle.prop('checked', (state == '1'));\n            }\n        }\n        $toggle.change(() => {\n            let active: boolean = $toggle.prop('checked');\n            if (localStorage) {\n                localStorage.setItem('merging-draft-auto-save', (active ? '1' : '0'));\n            }\n        }).trigger('change');\n    }\n\n    private initDraftSaving() {\n        this.$draftSavingPanel = MotionMergeAmendments.$form.find('#draftSavingPanel');\n        this.$draftSavingPanel.find('.saveDraft').on('click', this.saveDraft.bind(this));\n        this.$draftSavingPanel.find('input[name=public]').on('change', this.saveDraft.bind(this));\n        this.initAutosavingDraft();\n\n        if (this.$draftSavingPanel.data(\"resumed-date\")) {\n            let date = new Date(this.$draftSavingPanel.data(\"resumed-date\"));\n            this.setDraftDate(date);\n        }\n\n        $(\"#yii-debug-toolbar\").remove();\n    }\n}\n"]}