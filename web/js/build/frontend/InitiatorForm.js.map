{"version":3,"sources":["frontend/InitiatorForm.ts"],"names":["InitiatorForm","$widget","this","otherInitiator","wasPerson","$editforms","parents","first","$supporterData","find","$initiatorData","$initiatorAdderRow","$fullTextHolder","$","$supporterAdderRow","userData","data","settings","$otherInitiator","change","onChangeOtherInitiator","bind","trigger","on","onChangePersonType","click","initiatorAddRow","initiatorDelRow","supporterAddRow","supporterDelRow","onKeyOnTextfield","fullTextAdderOpen","fullTextAdd","length","initMinSupporters","submit","prototype","val","prop","setFieldsVisibilityOrganization","setFieldsReadonlyOrganization","setFieldsVisibilityPerson","setFieldsReadonlyPerson","addClass","removeClass","contactName","fixed","person_name","person_organization","ev","preventDefault","$newEl","before","target","remove","_this","found","each","i","el","trim","bootbox","alert","__t","replace","parent","lines","split","template","getNewElement","$rows","$row","eq","$firstAffectedRow","parts","select","focus","scrollintoview","keyCode","stopPropagation","next","hasClass","prev","last","exports"],"mappings":"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","file":"InitiatorForm.js","sourcesContent":["const CONTACT_NONE = 0;\nconst CONTACT_OPTIONAL = 1;\nconst CONTACT_REQUIRED = 2;\n\ninterface UserData {\n    fixed: boolean;\n    person_name: string;\n    person_organization: string;\n}\n\ninterface InitiatorFormSettings {\n    minSupporters: number;\n    hasOrganizations: boolean;\n    allowMoreSupporters: boolean;\n    skipForOrganizations: boolean;\n    hasResolutionDate: number;\n    contactName: number;\n    contactPhone: number;\n    contactEmail: number;\n    contactGender: number;\n}\n\nexport class InitiatorForm {\n    private $supporterAdderRow: JQuery;\n    private $fullTextHolder: JQuery;\n    private $initiatorData: JQuery;\n    private $initiatorAdderRow: JQuery;\n    private $supporterData: JQuery;\n    private $editforms: JQuery;\n\n    private $otherInitiator: JQuery;\n    private otherInitiator: boolean = false;\n    private userData: UserData;\n    private settings: InitiatorFormSettings;\n\n    private wasPerson: boolean = false;\n\n    constructor($widget: JQuery) {\n        this.$editforms = $widget.parents('form').first();\n        this.$supporterData = $widget.find('.supporterData');\n        this.$initiatorData = $widget.find('.initiatorData');\n        this.$initiatorAdderRow = this.$initiatorData.find('.adderRow');\n        this.$fullTextHolder = $('#fullTextHolder');\n        this.$supporterAdderRow = this.$supporterData.find('.adderRow');\n\n        this.userData = $widget.data('user-data');\n        this.settings = $widget.data('settings');\n\n        this.$otherInitiator = $widget.find('input[name=otherInitiator]');\n        this.$otherInitiator.change(this.onChangeOtherInitiator.bind(this)).trigger('change');\n\n        $widget.find('#personTypeNatural, #personTypeOrga').on('click change', this.onChangePersonType.bind(this)).first().trigger('change');\n\n        this.$initiatorAdderRow.find('a').click(this.initiatorAddRow.bind(this));\n        this.$initiatorData.on('click', '.initiatorRow .rowDeleter', this.initiatorDelRow.bind(this));\n        this.$supporterAdderRow.find('a').click(this.supporterAddRow.bind(this));\n        this.$supporterData.on('click', '.supporterRow .rowDeleter', this.supporterDelRow.bind(this));\n        this.$supporterData.on('keydown', ' .supporterRow input[type=text]', this.onKeyOnTextfield.bind(this));\n\n        $('.fullTextAdder a').click(this.fullTextAdderOpen.bind(this));\n        $('.fullTextAdd').click(this.fullTextAdd.bind(this));\n\n        if (this.$supporterData.length > 0 && this.$supporterData.data('min-supporters') > 0) {\n            this.initMinSupporters();\n        }\n\n        this.$editforms.submit(this.submit.bind(this));\n    }\n\n    private onChangeOtherInitiator() {\n        this.otherInitiator = (this.$otherInitiator.val() == 1 || this.$otherInitiator.prop(\"checked\"));\n        this.onChangePersonType();\n    }\n\n    private onChangePersonType() {\n        if ($('#personTypeOrga').prop('checked')) {\n            this.setFieldsVisibilityOrganization();\n            this.setFieldsReadonlyOrganization();\n            if (this.wasPerson) {\n                this.$initiatorData.find('#initiatorPrimaryName').val('');\n            }\n            this.wasPerson = false;\n        } else {\n            this.setFieldsVisibilityPerson();\n            this.setFieldsReadonlyPerson();\n            this.wasPerson = true;\n        }\n    }\n\n    private setFieldsVisibilityOrganization() {\n        this.$initiatorData.addClass('type-organization').removeClass('type-person');\n        this.$initiatorData.find('.organizationRow').addClass('hidden');\n        this.$initiatorData.find('.contactNameRow').removeClass('hidden');\n        this.$initiatorData.find('.resolutionRow').removeClass('hidden');\n        this.$initiatorData.find('.genderRow').addClass('hidden');\n        this.$initiatorData.find('.adderRow').addClass('hidden');\n        $('.supporterData, .supporterDataHead').addClass('hidden');\n    }\n\n    private setFieldsReadonlyOrganization() {\n        this.$initiatorData.find('#initiatorPrimaryName').prop('readonly', false);\n        this.$initiatorData.find('#initiatorOrga').prop('readonly', false);\n    }\n\n    private setFieldsVisibilityPerson() {\n        this.$initiatorData.removeClass('type-organization').addClass('type-person');\n        this.$initiatorData.find('.organizationRow').removeClass('hidden');\n        if (this.settings.contactName == CONTACT_REQUIRED) {\n            this.$initiatorData.find('.contactNameRow').removeClass('hidden');\n            this.$initiatorData.find('.contactNameRow input').prop('required', true);\n        } else if (this.settings.contactName == CONTACT_OPTIONAL) {\n            this.$initiatorData.find('.contactNameRow').removeClass('hidden');\n            this.$initiatorData.find('.contactNameRow input').prop('required', false);\n        } else {\n            this.$initiatorData.find('.contactNameRow').addClass('hidden');\n            this.$initiatorData.find('.contactNameRow input').prop('required', false);\n        }\n        this.$initiatorData.find('.genderRow').removeClass('hidden');\n        this.$initiatorData.find('.resolutionRow').addClass('hidden');\n        this.$initiatorData.find('.adderRow').removeClass('hidden');\n        $('.supporterData, .supporterDataHead').removeClass('hidden');\n    }\n\n    private setFieldsReadonlyPerson() {\n        if (!this.userData.fixed || this.otherInitiator) {\n            this.$initiatorData.find('#initiatorPrimaryName').prop('readonly', false);\n            this.$initiatorData.find('#initiatorOrga').prop('readonly', false);\n        } else {\n            this.$initiatorData.find('#initiatorPrimaryName').prop('readonly', true).val(this.userData.person_name);\n            this.$initiatorData.find('#initiatorOrga').prop('readonly', true).val(this.userData.person_organization);\n        }\n    }\n\n    private initiatorAddRow(ev) {\n        ev.preventDefault();\n        let $newEl = $($('#newInitiatorTemplate').data('html'));\n        this.$initiatorAdderRow.before($newEl);\n    }\n\n    private initiatorDelRow(ev) {\n        ev.preventDefault();\n        $(ev.target).parents('.initiatorRow').remove();\n    }\n\n    private supporterAddRow(ev) {\n        ev.preventDefault();\n        let $newEl = $($('#newSupporterTemplate').data('html'));\n        this.$supporterAdderRow.before($newEl);\n    }\n\n    private supporterDelRow(ev) {\n        ev.preventDefault();\n        $(ev.target).parents('.supporterRow').remove();\n    }\n\n    private initMinSupporters() {\n        this.$editforms.submit((ev) => {\n            if ($('#personTypeOrga').prop('checked')) {\n                return;\n            }\n            let found = 0;\n            this.$supporterData.find('.supporterRow').each((i, el) => {\n                if ($(el).find('input.name').val().trim() != '') {\n                    found++;\n                }\n            });\n            if (found < this.$supporterData.data('min-supporters')) {\n                ev.preventDefault();\n                bootbox.alert(__t(\"std\", \"min_x_supporter\").replace(/%NUM%/, this.$supporterData.data('min-supporters')));\n            }\n        });\n    }\n\n    private fullTextAdderOpen(ev) {\n        ev.preventDefault();\n        $(ev.target).parent().addClass(\"hidden\");\n        $('#fullTextHolder').removeClass(\"hidden\");\n    }\n\n    private fullTextAdd() {\n        let lines = this.$fullTextHolder.find('textarea').val().split(\";\"),\n            template = $('#newSupporterTemplate').data('html'),\n            getNewElement = () => {\n                let $rows = this.$supporterData.find('.supporterRow');\n                for (let i = 0; i < $rows.length; i++) {\n                    let $row = $rows.eq(i);\n                    if ($row.find(\".name\").val() == '' && $row.find(\".organization\").val() == '') return $row;\n                }\n                // No empty row found\n                let $newEl = $(template);\n                if (this.$supporterAdderRow.length > 0) {\n                    this.$supporterAdderRow.before($newEl);\n                } else {\n                    $('.fullTextAdder').before($newEl);\n                }\n                return $newEl;\n            };\n        let $firstAffectedRow = null;\n        for (let i = 0; i < lines.length; i++) {\n            if (lines[i] == '') {\n                continue;\n            }\n            let $newEl = getNewElement();\n            if ($firstAffectedRow == null) $firstAffectedRow = $newEl;\n            if ($newEl.find('input.organization').length > 0) {\n                let parts = lines[i].split(',');\n                $newEl.find('input.name').val(parts[0].trim());\n                if (parts.length > 1) {\n                    $newEl.find('input.organization').val(parts[1].trim());\n                }\n            } else {\n                $newEl.find('input.name').val(lines[i]);\n            }\n        }\n        this.$fullTextHolder.find('textarea').select().focus();\n        $firstAffectedRow.scrollintoview();\n    }\n\n    private onKeyOnTextfield(ev) {\n        let $row;\n        if (ev.keyCode == 13) { // Enter\n            ev.preventDefault();\n            ev.stopPropagation();\n            $row = $(ev.target).parents('.supporterRow');\n            if ($row.next().hasClass('adderRow')) {\n                let $newEl = $($('#newSupporterTemplate').data('html'));\n                this.$supporterAdderRow.before($newEl);\n                $newEl.find('input[type=text]').first().focus();\n            } else {\n                $row.next().find('input[type=text]').first().focus();\n            }\n        } else if (ev.keyCode == 8) { // Backspace\n            $row = $(ev.target).parents('.supporterRow');\n            if ($row.find('input.name').val() != '') {\n                return;\n            }\n            if ($row.find('input.organization').val() != '') {\n                return;\n            }\n            $row.remove();\n            this.$supporterAdderRow.prev().find('input.name, input.organization').last().focus();\n        }\n    }\n\n    private submit(ev) {\n        if ($('#personTypeOrga').prop('checked')) {\n            if ($('#resolutionDate').val() == '') {\n                ev.preventDefault();\n                bootbox.alert(__t('std', 'missing_resolution_date'));\n            }\n        }\n    }\n}\n"]}