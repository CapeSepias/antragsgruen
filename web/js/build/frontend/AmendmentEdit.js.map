{"version":3,"sources":["frontend/AmendmentEdit.ts"],"names":["AmendmentEdit","$form","this","hasChanged","multiParagraphMode","data","lang","$","attr","initEditorialOpener","initMultiParagraphMode","spmInit","on","window","off","onLeavePage","prototype","_this","$opener","datetimepicker","locale","format","click","ev","preventDefault","$textarea","find","target","addClass","removeClass","editor","AntragsgruenEditor_1","AntragsgruenEditor","parents","submit","parent","val","getEditor","getData","onContentChanged","bind","each","i","el","ckeditor","plugins","lite","findPlugin","acceptAll","spmSetModifyable","$modified","$spmParagraphs","filter","length","spmOnParaClick","$para","currentTarget","hasClass","CKEDITOR","instances","focus","spmRevert","stopPropagation","destroyInstanceById","html","spmInitNonSingleParas","$holder","$this","sectionId","paraNo","__t","exports"],"mappings":"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","file":"AmendmentEdit.js","sourcesContent":["import {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\n\nexport class AmendmentEdit {\n    private lang: string;\n    private $spmParagraphs: JQuery;\n    private hasChanged: boolean = false;\n\n    constructor(private $form: JQuery) {\n        let multiParagraphMode = $form.data(\"multi-paragraph-mode\");\n        if (typeof(multiParagraphMode) == \"undefined\") {\n            throw \"data-multi-paragraph-mode needs to be set\";\n        }\n\n        this.lang = $(\"html\").attr('lang');\n        this.initEditorialOpener();\n\n        if (multiParagraphMode) {\n            this.initMultiParagraphMode();\n        } else {\n            this.spmInit();\n        }\n\n        $form.on(\"submit\", () => {\n            $(window).off(\"beforeunload\", AmendmentEdit.onLeavePage);\n        });\n    }\n\n    private initEditorialOpener() {\n        let $opener = $(\".editorialChange .opener\");\n\n        $(\".input-group.date\").datetimepicker({\n            locale: this.lang,\n            format: 'L'\n        });\n        $opener.click((ev) => {\n            ev.preventDefault();\n            let $holder = $(\".editorialChange\"),\n                $textarea = $holder.find(\".texteditor\");\n            $(ev.target).addClass(\"hidden\");\n            $(\"#section_holder_editorial\").removeClass(\"hidden\");\n            let editor: AntragsgruenEditor = new AntragsgruenEditor(\"amendmentEditorial_wysiwyg\");\n            $textarea.parents(\"form\").submit(() => {\n                $textarea.parent().find(\"textarea.raw\").val(editor.getEditor().getData());\n            });\n            $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n        });\n\n        if ($(\"#amendmentEditorial\").val() != '') {\n            $opener.click();\n        }\n    }\n\n    /* Multi paragraph mode */\n\n    private initMultiParagraphMode() {\n        $(\".wysiwyg-textarea:not(#section_holder_editorial)\").each((i, el) => {\n            let $holder = $(el),\n                $textarea = $holder.find(\".texteditor\");\n\n            let editor: AntragsgruenEditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                ckeditor: editor = editor.getEditor();\n\n            $textarea.parents(\"form\").submit(() => {\n                $textarea.parent().find(\"textarea.raw\").val(ckeditor.getData());\n                if (typeof(ckeditor.plugins.lite) != 'undefined') {\n                    ckeditor.plugins.lite.findPlugin(ckeditor).acceptAll();\n                    $textarea.parent().find(\"textarea.consolidated\").val(ckeditor.getData());\n                }\n            });\n\n            // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n            $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n        });\n    }\n\n    /* Single paragraph mode */\n\n    private spmSetModifyable() {\n        let $modified = this.$spmParagraphs.filter(\".modified\");\n        if ($modified.length == 0) {\n            this.$spmParagraphs.addClass('modifyable');\n        } else {\n            this.$spmParagraphs.removeClass('modifyable');\n            $('input[name=modifiedParagraphNo]').val($modified.data(\"paragraph-no\"));\n            $('input[name=modifiedSectionId]').val($modified.parents(\".texteditorBox\").data(\"section-id\"));\n        }\n    }\n\n    private spmOnParaClick(ev) {\n        let $para = $(ev.currentTarget);\n        if (!$para.hasClass('modifyable')) {\n            return;\n        }\n        $para.addClass('modified');\n        this.spmSetModifyable();\n\n        let $textarea = $para.find(\".texteditor\"),\n            editor;\n        if (typeof(CKEDITOR.instances[$textarea.attr(\"id\")]) !== \"undefined\") {\n            editor = CKEDITOR.instances[$textarea.attr(\"id\")];\n        } else {\n            editor = (new AntragsgruenEditor($textarea.attr(\"id\"))).getEditor();\n        }\n        $textarea.attr(\"contenteditable\", \"true\");\n        $textarea.parents(\"form\").submit(() => {\n            $textarea.parent().find(\"textarea.raw\").val(editor.getData());\n            if (typeof(editor.plugins.lite) != 'undefined') {\n                editor.plugins.lite.findPlugin(editor).acceptAll();\n                $textarea.parent().find(\"textarea.consolidated\").val(editor.getData());\n            }\n        });\n\n        // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n        $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n\n        $textarea.focus();\n    }\n\n    private spmRevert(ev) {\n        ev.preventDefault();\n        ev.stopPropagation();\n        let $para = $(ev.target).parents(\".wysiwyg-textarea\"),\n            $textarea = $para.find(\".texteditor\"),\n            id = $textarea.attr(\"id\");\n\n        if (typeof(CKEDITOR.instances[$textarea.attr(\"id\")]) !== \"undefined\") {\n            AntragsgruenEditor.destroyInstanceById($textarea.attr(\"id\"));\n        }\n\n        $textarea.html($para.data(\"original\"));\n        $para.removeClass(\"modified\");\n        this.spmSetModifyable();\n    }\n\n    private spmInitNonSingleParas(i, el) {\n        let $holder = $(el),\n            $textarea = $holder.find(\".texteditor\");\n        if ($holder.hasClass(\"hidden\")) {\n            return;\n        }\n        let editor: editor = (new AntragsgruenEditor($textarea.attr(\"id\"))).getEditor();\n        $textarea.parents(\"form\").submit(() => {\n            $textarea.parent().find(\"textarea.raw\").val(editor.getData());\n            if (typeof(editor.plugins.lite) != 'undefined') {\n                editor.plugins.lite.findPlugin(editor).acceptAll();\n                $textarea.parent().find(\"textarea.consolidated\").val(editor.getData());\n            }\n        });\n\n        // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n        $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n    }\n\n    private spmInit() {\n        this.$spmParagraphs = $(\".wysiwyg-textarea.single-paragraph\");\n        this.$spmParagraphs.click(this.spmOnParaClick.bind(this));\n        this.$spmParagraphs.find(\".modifiedActions .revert\").click(this.spmRevert.bind(this));\n        this.spmSetModifyable();\n\n        // Amendment Reason\n        $(\".wysiwyg-textarea\").filter(\":not(.single-paragraph)\").each(this.spmInitNonSingleParas.bind(this));\n\n        $(\".texteditorBox\").each((i, el) => {\n            let $this = $(el),\n                sectionId = $this.data(\"section-id\"),\n                paraNo = $this.data(\"changed-para-no\");\n            if (paraNo > -1) {\n                $(\"#section_holder_\" + sectionId + \"_\" + paraNo).click();\n            }\n        });\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    public onContentChanged() {\n        if (!this.hasChanged) {\n            this.hasChanged = true;\n            if (!$(\"body\").hasClass('testing')) {\n                $(window).on(\"beforeunload\", AmendmentEdit.onLeavePage);\n            }\n        }\n    }\n}\n"]}