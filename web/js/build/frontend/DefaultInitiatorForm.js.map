{"version":3,"sources":["frontend/DefaultInitiatorForm.ts"],"names":["DefaultInitiatorForm","$widget","this","otherInitiator","$editforms","parents","first","$supporterData","find","$initiatorData","$initiatorAdderRow","$fullTextHolder","$","$supporterAdderRow","userData","data","$otherInitiator","change","onChangeOtherInitiator","bind","trigger","on","onChangePersonType","click","initiatorAddRow","initiatorDelRow","supporterAddRow","supporterDelRow","onKeyOnTextfield","fullTextAdderOpen","fullTextAdd","length","initMinSupporters","submit","prototype","val","prop","setFieldsVisibilityOrganization","setFieldsReadonlyOrganization","setFieldsVisibilityPerson","setFieldsReadonlyPerson","addClass","removeClass","fixed","person_name","person_organization","ev","preventDefault","$newEl","before","target","remove","_this","found","each","i","el","trim","bootbox","alert","__t","replace","parent","lines","split","template","getNewElement","$rows","$row","eq","$firstAffectedRow","parts","select","focus","scrollintoview","keyCode","stopPropagation","next","hasClass","prev","last","exports"],"mappings":"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","file":"DefaultInitiatorForm.js","sourcesContent":["interface UserData {\n    fixed: boolean;\n    person_name: string;\n    person_organization: string;\n}\n\nexport class DefaultInitiatorForm {\n    private $supporterAdderRow: JQuery;\n    private $fullTextHolder: JQuery;\n    private $initiatorData: JQuery;\n    private $initiatorAdderRow: JQuery;\n    private $supporterData: JQuery;\n    private $editforms: JQuery;\n\n    private $otherInitiator: JQuery;\n    private otherInitiator: boolean = false;\n    private userData: UserData;\n\n    constructor($widget: JQuery) {\n        this.$editforms = $widget.parents('form').first();\n        this.$supporterData = $widget.find('.supporterData');\n        this.$initiatorData = $widget.find('.initiatorData');\n        this.$initiatorAdderRow = this.$initiatorData.find('.adderRow');\n        this.$fullTextHolder = $('#fullTextHolder');\n        this.$supporterAdderRow = this.$supporterData.find('.adderRow');\n\n        this.userData = $widget.data(\"user-data\");\n\n        this.$otherInitiator = $widget.find(\"input[name=otherInitiator]\");\n        this.$otherInitiator.change(this.onChangeOtherInitiator.bind(this)).trigger('change');\n\n        $widget.find('#personTypeNatural, #personTypeOrga').on('click change', this.onChangePersonType.bind(this)).first().trigger('change');\n\n        this.$initiatorAdderRow.find('a').click(this.initiatorAddRow.bind(this));\n        this.$initiatorData.on('click', '.initiatorRow .rowDeleter', this.initiatorDelRow.bind(this));\n        this.$supporterAdderRow.find('a').click(this.supporterAddRow.bind(this));\n        this.$supporterData.on('click', '.supporterRow .rowDeleter', this.supporterDelRow.bind(this));\n        this.$supporterData.on('keydown', ' .supporterRow input[type=text]', this.onKeyOnTextfield.bind(this));\n\n        $('.fullTextAdder a').click(this.fullTextAdderOpen.bind(this));\n        $('.fullTextAdd').click(this.fullTextAdd.bind(this));\n\n        if (this.$supporterData.length > 0 && this.$supporterData.data('min-supporters') > 0) {\n            this.initMinSupporters();\n        }\n\n        this.$editforms.submit(this.submit.bind(this));\n    }\n\n    private onChangeOtherInitiator() {\n        this.otherInitiator = (this.$otherInitiator.val() == 1 || this.$otherInitiator.prop(\"checked\"));\n        this.onChangePersonType();\n    }\n\n    private onChangePersonType() {\n        if ($('#personTypeOrga').prop('checked')) {\n            this.setFieldsVisibilityOrganization();\n            this.setFieldsReadonlyOrganization();\n        } else {\n            this.setFieldsVisibilityPerson();\n            this.setFieldsReadonlyPerson();\n        }\n    }\n\n    private setFieldsVisibilityOrganization() {\n        this.$initiatorData.find('.organizationRow').addClass(\"hidden\");\n        this.$initiatorData.find('.contactNameRow').removeClass(\"hidden\");\n        this.$initiatorData.find('.resolutionRow').removeClass(\"hidden\");\n        this.$initiatorData.find('.adderRow').addClass(\"hidden\");\n        $('.supporterData, .supporterDataHead').addClass(\"hidden\");\n    }\n\n    private setFieldsReadonlyOrganization() {\n        this.$initiatorData.find('#initiatorPrimaryName').prop(\"readonly\", false);\n        this.$initiatorData.find('#initiatorOrga').prop(\"readonly\", false);\n    }\n\n    private setFieldsVisibilityPerson() {\n        this.$initiatorData.find('.organizationRow').removeClass(\"hidden\");\n        this.$initiatorData.find('.contactNameRow').addClass(\"hidden\");\n        this.$initiatorData.find('.resolutionRow').addClass(\"hidden\");\n        this.$initiatorData.find('.adderRow').removeClass(\"hidden\");\n        $('.supporterData, .supporterDataHead').removeClass(\"hidden\");\n    }\n\n    private setFieldsReadonlyPerson() {\n        if (!this.userData.fixed || this.otherInitiator) {\n            this.$initiatorData.find('#initiatorPrimaryName').prop(\"readonly\", false);\n            this.$initiatorData.find('#initiatorOrga').prop(\"readonly\", false);\n        } else {\n            this.$initiatorData.find('#initiatorPrimaryName').prop(\"readonly\", true).val(this.userData.person_name);\n            this.$initiatorData.find('#initiatorOrga').prop(\"readonly\", true).val(this.userData.person_organization);\n        }\n    }\n\n    private initiatorAddRow(ev) {\n        ev.preventDefault();\n        let $newEl = $($('#newInitiatorTemplate').data('html'));\n        this.$initiatorAdderRow.before($newEl);\n    }\n\n    private initiatorDelRow(ev) {\n        ev.preventDefault();\n        $(ev.target).parents('.initiatorRow').remove();\n    }\n\n    private supporterAddRow(ev) {\n        ev.preventDefault();\n        let $newEl = $($('#newSupporterTemplate').data('html'));\n        this.$supporterAdderRow.before($newEl);\n    }\n\n    private supporterDelRow(ev) {\n        ev.preventDefault();\n        $(ev.target).parents('.supporterRow').remove();\n    }\n\n    private initMinSupporters() {\n        this.$editforms.submit((ev) => {\n            if ($('#personTypeOrga').prop('checked')) {\n                return;\n            }\n            let found = 0;\n            this.$supporterData.find('.supporterRow').each((i, el) => {\n                if ($(el).find('input.name').val().trim() != '') {\n                    found++;\n                }\n            });\n            if (found < this.$supporterData.data('min-supporters')) {\n                ev.preventDefault();\n                bootbox.alert(__t(\"std\", \"min_x_supporter\").replace(/%NUM%/, this.$supporterData.data('min-supporters')));\n            }\n        });\n    }\n\n    private fullTextAdderOpen(ev) {\n        ev.preventDefault();\n        $(ev.target).parent().addClass(\"hidden\");\n        $('#fullTextHolder').removeClass(\"hidden\");\n    }\n\n    private fullTextAdd() {\n        let lines = this.$fullTextHolder.find('textarea').val().split(\";\"),\n            template = $('#newSupporterTemplate').data('html'),\n            getNewElement = () => {\n                let $rows = this.$supporterData.find(\".supporterRow\");\n                for (let i = 0; i < $rows.length; i++) {\n                    let $row = $rows.eq(i);\n                    if ($row.find(\".name\").val() == '' && $row.find(\".organization\").val() == '') return $row;\n                }\n                // No empty row found\n                let $newEl = $(template);\n                if (this.$supporterAdderRow.length > 0) {\n                    this.$supporterAdderRow.before($newEl);\n                } else {\n                    $('.fullTextAdder').before($newEl);\n                }\n                return $newEl;\n            };\n        let $firstAffectedRow = null;\n        for (let i = 0; i < lines.length; i++) {\n            if (lines[i] == '') {\n                continue;\n            }\n            let $newEl = getNewElement();\n            if ($firstAffectedRow == null) $firstAffectedRow = $newEl;\n            if ($newEl.find('input.organization').length > 0) {\n                let parts = lines[i].split(',');\n                $newEl.find('input.name').val(parts[0].trim());\n                if (parts.length > 1) {\n                    $newEl.find('input.organization').val(parts[1].trim());\n                }\n            } else {\n                $newEl.find('input.name').val(lines[i]);\n            }\n        }\n        this.$fullTextHolder.find('textarea').select().focus();\n        $firstAffectedRow.scrollintoview();\n    }\n\n    private onKeyOnTextfield(ev) {\n        let $row;\n        if (ev.keyCode == 13) { // Enter\n            ev.preventDefault();\n            ev.stopPropagation();\n            $row = $(ev.target).parents('.supporterRow');\n            if ($row.next().hasClass('adderRow')) {\n                let $newEl = $($('#newSupporterTemplate').data('html'));\n                this.$supporterAdderRow.before($newEl);\n                $newEl.find('input[type=text]').first().focus();\n            } else {\n                $row.next().find('input[type=text]').first().focus();\n            }\n        } else if (ev.keyCode == 8) { // Backspace\n            $row = $(ev.target).parents('.supporterRow');\n            if ($row.find('input.name').val() != '') {\n                return;\n            }\n            if ($row.find('input.organization').val() != '') {\n                return;\n            }\n            $row.remove();\n            this.$supporterAdderRow.prev().find('input.name, input.organization').last().focus();\n        }\n    }\n\n    private submit(ev) {\n        if ($('#personTypeOrga').prop('checked')) {\n            if ($('#resolutionDate').val() == '') {\n                ev.preventDefault();\n                bootbox.alert(__t(\"std\", \"missing_resolution_date\"));\n            }\n        }\n    }\n}\n"]}