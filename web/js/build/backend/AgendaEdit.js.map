{"version":3,"sources":["backend/AgendaEdit.ts"],"names":["AgendaEdit","$widget","_this","this","delAgendaItemStr","$agenda","$","locale","attr","addClass","nestedSortable","handle","items","toleranceElement","placeholder","tolerance","forcePlaceholderSize","helper","axis","update","trigger","saveNewOrder","find","each","i","el","prepareAgendaItem","prepareAgendaList","on","agendaItemAdd","bind","agendaDateAdd","showTimesChanges","delAgendaItem","editAgendaItem","submitSingleItemForm","prototype","buildAgendaStruct","$ol","children","$li","length","push","type","id","parseInt","data","saveUrl","structure","console","log","post","_csrf","val","JSON","stringify","ret","alert","ev","preventDefault","target","parents","first","$parentLi","position","prevAll","parentId","$form","saveData","title","hasClass","date","datetimepicker","format","prop","$newItem","replaceWith","delUrl","bootbox","confirm","__t","result","remove","$newElement","before","removeClass","$item","prepend","append","stopPropagation","preDate","moment","defaultDate","$list","full","str","$el","exports"],"mappings":"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","file":"AgendaEdit.js","sourcesContent":["/// <reference path=\"../typings/nestedSortable/index.d.ts\" />\n\ndeclare let moment: any;\n\nexport class AgendaEdit {\n    private readonly $agenda: JQuery;\n    private readonly locale: string;\n\n    private delAgendaItemStr = '<a href=\"#\" class=\"delAgendaItem\"><span class=\"glyphicon glyphicon-minus-sign\"></span></a>';\n\n    constructor(private $widget: JQuery) {\n        this.$agenda = $('.motionListWithinAgenda');\n        this.locale = $(\"html\").attr('lang');\n\n        this.$agenda.addClass('agendaListEditing');\n        this.$agenda.nestedSortable({\n            handle: '.moveHandle',\n            items: 'li.agendaItem',\n            toleranceElement: '> div',\n            placeholder: 'movePlaceholder',\n            tolerance: 'pointer',\n            forcePlaceholderSize: true,\n            helper: 'clone',\n            axis: 'y',\n            update: () => {\n                $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n                this.saveNewOrder();\n            }\n        });\n        this.$agenda.find('.agendaItem').each((i, el) => {\n            this.prepareAgendaItem($(el));\n        });\n\n        this.prepareAgendaList(this.$agenda, true);\n\n\n        this.$agenda.on('click', '.agendaItemAdder .addEntry', this.agendaItemAdd.bind(this));\n        this.$agenda.on('click', '.agendaItemAdder .addDate', this.agendaDateAdd.bind(this));\n        this.$agenda.on('change', '.agendaItemAdder .showTimes input', this.showTimesChanges.bind(this));\n        this.$agenda.on('click', '.delAgendaItem', this.delAgendaItem.bind(this));\n        this.$agenda.on('click', '.editAgendaItem', this.editAgendaItem.bind(this));\n        this.$agenda.on('submit', '.agendaItemEditForm', this.submitSingleItemForm.bind(this));\n        this.$agenda.on('submit', '.agendaDateEditForm', this.submitSingleItemForm.bind(this));\n    }\n\n    buildAgendaStruct($ol) {\n        let items = [];\n        $ol.children('.agendaItem').each((i, el) => {\n            const $li = $(el);\n            if ($li.find('> div > .agendaDateEditForm').length > 0) {\n                items.push({\n                    'type': 'date',\n                    'id': parseInt($li.data(\"id\")),\n                    'children': this.buildAgendaStruct($li.find('> ol'))\n                });\n            } else {\n                items.push({\n                    'type': 'std',\n                    'id': parseInt($li.data(\"id\")),\n                    'children': this.buildAgendaStruct($li.find('> ol'))\n                });\n            }\n        });\n        return items;\n    }\n\n    private saveNewOrder() {\n        const saveUrl = this.$widget.data(\"save-order\") as string,\n            structure = this.buildAgendaStruct(this.$widget.find(\"> ol\"));\n\n\n        console.log(\"Save new order: \" + saveUrl, structure);\n\n        $.post(saveUrl, {\n            '_csrf': $('input[name=_csrf]').val(),\n            'data': JSON.stringify(structure),\n        }, ret => {\n            if (!ret['success']) {\n                alert(\"Could not save: \" + ret['message']);\n                return;\n            }\n        });\n    }\n\n    submitSingleItemForm(ev: Event) {\n        ev.preventDefault();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            $parentLi = $li.parents('li').first(),\n            position = $li.prevAll().length,\n            parentId = ($parentLi.length > 0 ? $parentLi.data('id') : null),\n            $form = $(ev.target),\n            saveUrl = $li.data('save-url') as string;\n\n        const saveData = {\n            'parentId': parentId,\n            'position': position,\n            'title': $form.find('input[name=title]').val() as string,\n        };\n\n        if ($li.hasClass('agendaItemDate')) {\n            saveData['type'] = 'date';\n            const date = ($form.find(\".date\") as any).datetimepicker(\"date\");\n            if (date) {\n                saveData['date'] = date.format(\"YYYY-MM-DD\");\n            } else {\n                saveData['date'] = null;\n            }\n        } else {\n            saveData['type'] = 'agendaItem';\n            saveData['inProposedProcedures'] = $form.find('input[name=inProposedProcedures]').prop('checked');\n            saveData['motionType'] = parseInt($form.find('select[name=motionType]').val() as string);\n            saveData['time'] = $form.find('input[name=time]').val() as string;\n            saveData['code'] = $form.find('input[name=code]').val() as string;\n        }\n\n        $.post(saveUrl, {\n            '_csrf': $('input[name=_csrf]').val(),\n            'data': JSON.stringify(saveData),\n        }, ret => {\n            if (!ret['success']) {\n                alert(\"Could not save: \" + ret['message']);\n                return;\n            }\n            const $newItem = $(ret['html']);\n            $li.replaceWith($newItem);\n            this.prepareAgendaItem($newItem);\n            $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n        });\n    }\n\n    delAgendaItem(ev: Event) {\n        ev.preventDefault();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            delUrl = $li.data('del-url') as string;\n        bootbox.confirm(__t(\"admin\", \"agendaDelEntryConfirm\"), (result) => {\n            if (result) {\n                $.post(delUrl, {\n                    '_csrf': $('input[name=_csrf]').val(),\n                }, ret => {\n                    if (!ret['success']) {\n                        alert(\"Could not delete: \" + ret['message']);\n                        return;\n                    }\n                    $li.remove();\n                    $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n                });\n            }\n        });\n    }\n\n    editAgendaItem(ev: Event) {\n        ev.preventDefault();\n        let $li = $(ev.target).parents('li.agendaItem').first();\n        $li.addClass('editing');\n        $li.find('> div > .agendaItemEditForm input[name=code]').trigger(\"focus\").trigger(\"select\");\n    }\n\n    agendaItemAdd(ev: Event) {\n        ev.preventDefault();\n        let $newElement = $($('#agendaNewElementTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find('.agendaItemEditForm input.code').trigger(\"focus\");\n    }\n\n    agendaDateAdd(ev: Event) {\n        ev.preventDefault();\n        let $newElement = $($('#agendaNewDateTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        $newElement.find('.editAgendaItem').trigger('click');\n    }\n\n    showTimesChanges() {\n        if (this.$widget.find('.agendaItemAdder .showTimes input').prop(\"checked\")) {\n            this.$agenda.addClass('showTimes').removeClass('noShowTimes');\n        } else {\n            this.$agenda.removeClass('showTimes').addClass('noShowTimes');\n        }\n    }\n\n    prepareAgendaItem($item) {\n        $item.find('> div').prepend('<span class=\"glyphicon glyphicon-resize-vertical moveHandle\"></span>');\n        $item.find('> div > h3').append('<a href=\"#\" class=\"editAgendaItem\"><span class=\"glyphicon glyphicon-pencil\"></span></a>');\n        $item.find('> div > h3').append(this.delAgendaItemStr);\n        $item.find('> div li.checkbox').on('click', (ev) => {\n            ev.stopPropagation();\n        });\n\n        $item.find('> ol.agenda').each((i, el) => {\n            this.prepareAgendaList($(el), false);\n        });\n\n        $item.find(\"> div .input-group.time\").datetimepicker({\n            locale: this.locale,\n            format: 'LT'\n        });\n\n        $item.find(\"> div .input-group.date\").each((i, el) => {\n            let preDate = null;\n            if ($(el).data(\"date\")) {\n                preDate = moment($(el).data(\"date\"), \"YYYY-MM-DD\", this.locale);\n            }\n            $(el).datetimepicker({\n                locale: this.locale,\n                format: 'dddd, Do MMMM YYYY',\n                defaultDate: preDate\n            });\n        });\n    }\n\n    prepareAgendaList($list, full: boolean) {\n        let str = '<li class=\"agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled\">' +\n            '<a href=\"#\" class=\"addEntry\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddEntry') + '</a>';\n        if (full) {\n            str += '<a href=\"#\" class=\"addDate\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddDate') + '</a>' +\n                '<span class=\"spacer\"></span>' +\n            '<label class=\"showTimes\"><input type=\"checkbox\" class=\"showTimes\"> ' + __t('admin', 'agendaShowTimes') + '</label>';\n        }\n        str += '</li>';\n        const $el = $(str);\n        if (this.$agenda.hasClass('showTimes')) {\n            $el.find(\".showTimes input\").prop(\"checked\", true);\n        }\n        $list.append($el);\n    }\n}\n"]}