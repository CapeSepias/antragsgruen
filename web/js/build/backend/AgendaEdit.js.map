{"version":3,"sources":["backend/AgendaEdit.ts"],"names":["AgendaEdit","_this","this","hasChanged","delAgendaItemStr","$agendaform","$","$agenda","addClass","nestedSortable","handle","items","toleranceElement","placeholder","tolerance","forcePlaceholderSize","helper","axis","update","showSaver","trigger","find","each","i","el","prepareAgendaItem","prepareAgendaList","datetimepicker","locale","attr","format","on","agendaItemAdd","bind","agendaDateAdd","showTimesChanges","delAgendaItem","editAgendaItem","submitSingleItemForm","submitCompleteForm","prototype","buildAgendaStruct","$ol","children","$li","id","split","push","code","val","title","motionTypeId","ev","preventDefault","target","parents","first","$form","newTitle","newCode","removeClass","data","text","JSON","stringify","window","off","onLeavePage","$this","bootbox","confirm","__t","result","remove","$newElement","before","prop","$item","prepend","append","$list","full","str","hasClass"],"mappings":"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","file":"AgendaEdit.js","sourcesContent":["/// <reference path=\"../typings/nestedSortable/index.d.ts\" />\n\nclass AgendaEdit {\n    private hasChanged: boolean = false;\n    private $agendaform: JQuery;\n    private readonly $agenda: JQuery;\n\n    private delAgendaItemStr = '<a href=\"#\" class=\"delAgendaItem\"><span class=\"glyphicon glyphicon-minus-sign\"></span></a>';\n\n    constructor() {\n        this.$agendaform = $('#agendaEditSavingHolder');\n        this.$agenda = $('.motionListWithinAgenda');\n\n        this.$agenda.addClass('agendaListEditing');\n        this.$agenda.nestedSortable({\n            handle: '.moveHandle',\n            items: 'li.agendaItem',\n            toleranceElement: '> div',\n            placeholder: 'movePlaceholder',\n            tolerance: 'pointer',\n            forcePlaceholderSize: true,\n            helper: 'clone',\n            axis: 'y',\n            update: () => {\n                this.showSaver();\n                $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n            }\n        });\n        this.$agenda.find('.agendaItem').each((i, el) => {\n            this.prepareAgendaItem($(el));\n        });\n        this.prepareAgendaList(this.$agenda, true);\n        this.$agenda.find('ol.agenda').each((i, el) => {\n            this.prepareAgendaList($(el), false);\n        });\n\n        this.$agenda.find(\".input-group.time\").datetimepicker({\n            locale: $(\"html\").attr('lang'),\n            format: 'LT'\n        });\n\n\n        this.$agenda.on('click', '.agendaItemAdder .addEntry', this.agendaItemAdd.bind(this));\n        this.$agenda.on('click', '.agendaItemAdder .addDate', this.agendaDateAdd.bind(this));\n        this.$agenda.on('change', '.agendaItemAdder .showTimes', this.showTimesChanges.bind(this));\n        this.$agenda.on('click', '.delAgendaItem', this.delAgendaItem.bind(this));\n        this.$agenda.on('click', '.editAgendaItem', this.editAgendaItem.bind(this));\n        this.$agenda.on('submit', '.agendaItemEditForm', this.submitSingleItemForm.bind(this));\n        this.$agendaform.on(\"submit\", this.submitCompleteForm.bind(this));\n    }\n\n    buildAgendaStruct($ol) {\n        let items = [];\n        $ol.children('.agendaItem').each((i, el) => {\n            let $li = $(el),\n                id = $li.attr('id').split('_');\n            items.push({\n                'id': id[1],\n                'code': $li.find('> div > .agendaItemEditForm input[name=code]').val(),\n                'title': $li.find('> div > .agendaItemEditForm input[name=title]').val(),\n                'motionTypeId': $li.find('> div > .agendaItemEditForm select[name=motionType]').val(),\n                'children': this.buildAgendaStruct($li.find('> ol'))\n            });\n        });\n        return items;\n    }\n\n    submitSingleItemForm(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            $form = $(ev.target),\n            newTitle = $form.find('input[name=title]').val() as string,\n            newCode = $form.find('input[name=code]').val() as string;\n        $li.removeClass('editing');\n        $li.data('code', newCode);\n        $li.find('> div > h3 .code').text(newCode);\n        $li.find('> div > h3 .title').text(newTitle);\n        $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n    }\n\n    submitCompleteForm() {\n        let data = this.buildAgendaStruct($('.motionListWithinAgenda'));\n        this.$agendaform.find('input[name=data]').val(JSON.stringify(data));\n        $(window).off(\"beforeunload\", AgendaEdit.onLeavePage);\n    }\n\n    delAgendaItem(ev: Event) {\n        let $this = $(ev.target);\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"agendaDelEntryConfirm\"), (result) => {\n            if (result) {\n                this.showSaver();\n                $this.parents('li.agendaItem').first().remove();\n                $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n            }\n        });\n    }\n\n    editAgendaItem(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $li = $(ev.target).parents('li.agendaItem').first();\n        $li.addClass('editing');\n        $li.find('> div > .agendaItemEditForm input[name=code]').trigger(\"focus\").trigger(\"select\");\n    }\n\n    agendaItemAdd(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $newElement = $($('#agendaNewElementTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        this.prepareAgendaList($newElement.find('ol.agenda'), false);\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find('.agendaItemEditForm input.code').trigger(\"focus\");\n    }\n\n    agendaDateAdd(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $newElement = $($('#agendaNewDateTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        this.prepareAgendaList($newElement.find('ol.agenda'), false);\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find('.agendaItemEditForm input.title').trigger(\"focus\");\n    }\n\n    showTimesChanges() {\n        if (this.$agenda.find('.agendaItemAdder .showTimes input').prop(\"checked\")) {\n            this.$agenda.addClass('showTimes').removeClass('noShowTimes');\n        } else {\n            this.$agenda.removeClass('showTimes').addClass('noShowTimes');\n        }\n    }\n\n    prepareAgendaItem($item) {\n        $item.find('> div').prepend('<span class=\"glyphicon glyphicon-resize-vertical moveHandle\"></span>');\n        $item.find('> div > h3').append('<a href=\"#\" class=\"editAgendaItem\"><span class=\"glyphicon glyphicon-pencil\"></span></a>');\n        $item.find('> div > h3').append(this.delAgendaItemStr);\n    }\n\n    prepareAgendaList($list, full: boolean) {\n        let str = '<li class=\"agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled\">' +\n            '<a href=\"#\" class=\"addEntry\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddEntry') + '</a>';\n        if (full) {\n            str += '<a href=\"#\" class=\"addDate\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddDate') + '</a>' +\n            '<label class=\"showTimes\"><input type=\"checkbox\" class=\"showTimes\"> ' + __t('admin', 'agendaShowTimes') + '</label>';\n        }\n        str += '</li>';\n        $list.append(str);\n    }\n\n    showSaver() {\n        $('#agendaEditSavingHolder').removeClass(\"hidden\");\n        this.hasChanged = true;\n        if (!$(\"body\").hasClass('testing')) {\n            $(window).on(\"beforeunload\", AgendaEdit.onLeavePage);\n        }\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n}\n\nnew AgendaEdit();\n"]}