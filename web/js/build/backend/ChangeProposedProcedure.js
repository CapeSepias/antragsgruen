define(["require","exports"],function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t){this.$widget=t,this.savingComment=!1,this.initElements(),this.initOpener(),this.initStatusSetter(),this.initCommentForm(),this.initVotingBlock(),this.initExplanation(),t.submit(function(t){return t.preventDefault()})}return t.prototype.initElements=function(){this.$statusDetails=this.$widget.find(".statusDetails"),this.$visibilityInput=this.$widget.find("input[name=proposalVisible]"),this.$votingStatusInput=this.$widget.find("input[name=votingStatus]"),this.$votingBlockId=this.$widget.find("input[name=votingBlockId]"),this.$openerBtn=$(".proposedChangesOpener button"),this.context=this.$widget.data("context"),this.saveUrl=this.$widget.attr("action"),this.csrf=this.$widget.find("input[name=_csrf]").val()},t.prototype.initOpener=function(){var t=this;this.$openerBtn.click(function(){t.$widget.removeClass("hidden"),t.$openerBtn.addClass("hidden"),localStorage.setItem("proposed_procedure_enabled","1")}),this.$widget.on("click",".closeBtn",function(){t.$widget.addClass("hidden"),t.$openerBtn.removeClass("hidden"),localStorage.setItem("proposed_procedure_enabled","0")}),"1"===localStorage.getItem("proposed_procedure_enabled")?(this.$widget.removeClass("hidden"),this.$openerBtn.addClass("hidden")):this.$widget.addClass("hidden")},t.prototype.reinitAfterReload=function(){this.initElements(),this.statusChanged(),this.commentsScrollBottom(),this.initExplanation(),this.$widget.find(".newBlock").addClass("hidden"),this.$widget.find(".selectlist").selectlist()},t.prototype.setGlobalProposedStr=function(t){$(".motionData .proposedStatusRow .str").html(t)},t.prototype.performCallWithReload=function(t){var e=this;t._csrf=this.csrf,$.post(this.saveUrl,t,function(t){if(t.success){var i=$(t.html);e.$widget.children().remove(),e.$widget.append(i.children()),e.reinitAfterReload(),e.$widget.addClass("showSaved").removeClass("isChanged"),t.proposalStr&&e.setGlobalProposedStr(t.proposalStr),window.setTimeout(function(){return e.$widget.removeClass("showSaved")},2e3)}else t.error?alert(t.error):alert("An error occurred")}).fail(function(){alert("Could not save")})},t.prototype.notifyProposer=function(){this.performCallWithReload({notifyProposer:"1"})},t.prototype.saveStatus=function(){var t=this.$widget.find(".statusForm input[type=radio]:checked").val(),e={setStatus:t,visible:this.$visibilityInput.prop("checked")?1:0,votingBlockId:this.$votingBlockId.val()};10==t&&(e.proposalComment=this.$widget.find("input[name=referredTo]").val()),22==t&&(e.proposalComment=this.$widget.find("input[name=obsoletedByAmendment]").val()),23==t&&(e.proposalComment=this.$widget.find("input[name=statusCustomStr]").val()),11==t&&(e.votingStatus=this.$votingStatusInput.filter(":checked").val()),"NEW"==e.votingBlockId&&(e.votingBlockTitle=this.$widget.find("input[name=newBlockTitle]").val()),this.$widget.find("input[name=setPublicExplanation]").prop("checked")&&(e.proposalExplanation=this.$widget.find("textarea[name=proposalExplanation]").val()),this.performCallWithReload(e)},t.prototype.statusChanged=function(){var t=this.$widget.find(".statusForm input[type=radio]:checked").val();this.$statusDetails.addClass("hidden"),this.$statusDetails.filter(".status_"+t).removeClass("hidden"),0==t?this.$widget.addClass("noStatus"):this.$widget.removeClass("noStatus")},t.prototype.initStatusSetter=function(){var t=this;this.$widget.on("change",".statusForm input[type=radio]",function(e,i){$(e.currentTarget).prop("checked")&&(t.statusChanged(),i&&!0===i.init||t.$widget.addClass("isChanged"))}),this.$widget.find(".statusForm input[type=radio]").trigger("change",{init:!0}),this.$widget.on("change keyup","input, textarea",function(e){$(e.currentTarget).parents(".proposalCommentForm").length>0||t.$widget.addClass("isChanged")}),this.$widget.on("changed.fu.selectlist","#obsoletedByAmendment",function(){t.$widget.addClass("isChanged")}),this.$widget.on("click",".saving button",this.saveStatus.bind(this)),this.$widget.on("click",".notifyProposer",this.notifyProposer.bind(this))},t.prototype.initVotingBlock=function(){var t=this;this.$widget.on("changed.fu.selectlist","#votingBlockId",function(){t.$widget.addClass("isChanged"),"NEW"==t.$votingBlockId.val()?t.$widget.find(".newBlock").removeClass("hidden"):t.$widget.find(".newBlock").addClass("hidden")}),this.$widget.find(".newBlock").addClass("hidden")},t.prototype.initExplanation=function(){var t=this;this.$widget.find("input[name=setPublicExplanation]").change(function(e){$(e.target).prop("checked")?t.$widget.find("section.publicExplanation").removeClass("hidden"):t.$widget.find("section.publicExplanation").addClass("hidden")}),this.$widget.find("input[name=setPublicExplanation]").prop("checked")?this.$widget.find("section.publicExplanation").removeClass("hidden"):this.$widget.find("section.publicExplanation").addClass("hidden")},t.prototype.commentsScrollBottom=function(){var t=this.$widget.find(".proposalCommentForm .commentList");t[0].scrollTop=t[0].scrollHeight},t.prototype.doSaveComment=function(){var t=this,e=this.$widget.find(".proposalCommentForm"),i=e.find(".commentList"),n=e.find("textarea").val();""==n||this.savingComment||(this.savingComment=!0,$.post(this.saveUrl,{writeComment:n,_csrf:this.csrf},function(n){if(n.success){var o="";n.comment.delLink&&(o='<button type="button" data-url="'+n.comment.delLink+'" class="btn-link delComment">',o+='<span class="glyphicon glyphicon-trash"></span></button>');var s=$('<li class="comment"><div class="header"><div class="date"></div>'+o+'<div class="name"></div></div><div class="comment"></div></li>');s.find(".date").text(n.comment.dateFormatted),s.find(".name").text(n.comment.username),s.find(".comment").text(n.comment.text),s.data("id",n.comment.id),i.append(s),e.find("textarea").val(""),i[0].scrollTop=i[0].scrollHeight}else alert("Could not save: "+JSON.stringify(n));t.savingComment=!1}).fail(function(){alert("Could not save"),t.savingComment=!1}))},t.prototype.delComment=function(t){$.post(t.find(".delComment").data("url"),{_csrf:this.csrf,id:t.data("id")},function(e){e.success?t.remove():alert("Error: "+e.error)}).catch(function(){alert("An error occurred")})},t.prototype.initCommentForm=function(){var t=this;this.$widget.on("click",".proposalCommentForm button",function(){t.doSaveComment()}),this.commentsScrollBottom(),this.$widget.on("keypress",".proposalCommentForm textarea",function(e){e.originalEvent.metaKey&&13===e.originalEvent.keyCode&&t.doSaveComment()}),this.$widget.on("click",".delComment",function(e){t.delComment($(e.currentTarget).parents(".comment").first())})},t}();e.ChangeProposedProcedure=i});
//# sourceMappingURL=ChangeProposedProcedure.js.map
