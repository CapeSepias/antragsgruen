define(["require","exports"],(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VotingAdmin=void 0;e.VotingAdmin=class{constructor(t){this.element=t[0],this.createVueWidget(),this.initVotingCreater(),$('[data-toggle="tooltip"]').tooltip()}createVueWidget(){const t=this.element.querySelector(".votingAdmin"),e=this.element.getAttribute("data-url-vote-settings"),i=this.element.getAttribute("data-vote-create"),n=JSON.parse(this.element.getAttribute("data-addable-motions")),s=this.element.getAttribute("data-url-poll"),o=this.element.getAttribute("data-voting");this.widget=new Vue({el:t,template:'<div class="adminVotings">\n                <voting-admin-widget v-for="voting in votings"\n                                     :voting="voting"\n                                     :addableMotions="addableMotions"\n                                     :alreadyAddedItems="alreadyAddedItems"\n                                     @set-status="setStatus"\n                                     @save-settings="saveSettings"\n                                     @remove-item="removeItem"\n                                     @delete-voting="deleteVoting"\n                                     @add-imotion="addIMotion"\n                                     @add-question="addQuestion"\n                ></voting-admin-widget>\n            </div>',data:()=>({votingsJson:null,votings:null,addableMotions:n,csrf:document.querySelector("head meta[name=csrf-token]").getAttribute("content"),pollingId:null}),computed:{alreadyAddedItems:function(){const t=[],e=[];return this.votings.forEach((i=>{i.items.forEach((i=>{"motion"===i.type&&t.push(i.id),"amendment"===i.type&&e.push(i.id)}))})),{motions:t,amendments:e}}},methods:{_performOperation:function(t,i){let n={_csrf:this.csrf};i&&(n=Object.assign(n,i));const s=this,o=e.replace(/VOTINGBLOCKID/,t);$.post(o,n,(function(t){void 0===t.success||t.success?s.votings=t:alert(t.message)})).catch((function(t){alert(t.responseText)}))},setVotingFromJson(t){t!==this.votingsJson&&(this.votings=JSON.parse(t),this.votingsJson=t)},setVotingFromObject(t){this.votings=t,this.votingsJson=null},setStatus(t,e,i){this._performOperation(t,{op:"update-status",status:e,organizations:i.map((t=>({id:t.id,members_present:t.members_present})))})},saveSettings(t,e,i,n,s,o,r){this._performOperation(t,{op:"save-settings",title:e,answerTemplate:i,majorityType:n,resultsPublic:s,votesPublic:o,assignedMotion:r})},deleteVoting(t){this._performOperation(t,{op:"delete-voting"})},createVoting:function(t,e,n,s,o,r,a,d){let l={_csrf:this.csrf,type:t,answers:e,title:n,specificQuestion:s,assignedMotion:o,majorityType:r,resultsPublic:a,votesPublic:d};const c=this;$.post(i,l,(function(t){void 0===t.success||t.success?(c.votings=t.votings,window.setTimeout((()=>{$("#voting"+t.created_voting).scrollintoview({top_offset:-100})}),200)):alert(t.message)})).catch((function(t){alert(t.responseText)}))},removeItem(t,e,i){this._performOperation(t,{op:"remove-item",itemType:e,itemId:i})},addIMotion(t,e){this._performOperation(t,{op:"add-imotion",itemDefinition:e})},addQuestion(t,e){this._performOperation(t,{op:"add-question",question:e})},reloadData:function(){const t=this;$.get(s,(function(e){t.setVotingFromJson(e)}),"text").catch((function(t){console.error("Could not load voting data from backend",t)}))},startPolling:function(){const t=this;this.pollingId=window.setInterval((function(){t.reloadData()}),3e3)}},beforeDestroy(){window.clearInterval(this.pollingId)},created(){this.setVotingFromJson(o),this.startPolling()}})}initVotingCreater(){const t=this.element.querySelector(".createVotingOpener"),e=this.element.querySelector(".createVotingHolder"),i=this.element.querySelector(".specificQuestion"),n=this.element.querySelector(".majorityTypeSettings");t.addEventListener("click",(()=>{e.classList.remove("hidden"),t.classList.add("hidden")}));const s=(t,i)=>{let n=i;return e.querySelectorAll(t).forEach((t=>{const e=t;e.checked&&(n=e.value)})),n},o=()=>{"question"===s(".votingType input","question")?i.classList.remove("hidden"):i.classList.add("hidden")};e.querySelectorAll(".votingType input").forEach((t=>{t.addEventListener("change",o)})),o();const r=()=>{"2"===s(".answerTemplate input","0")?n.classList.add("hidden"):n.classList.remove("hidden")};e.querySelectorAll(".answerTemplate input").forEach((t=>{t.addEventListener("change",r)})),r(),e.querySelector("form").addEventListener("submit",(i=>{i.stopPropagation(),i.preventDefault();const n=s(".votingType input","question"),o=parseInt(s(".answerTemplate input","0"),10),r=e.querySelector(".settingsTitle"),a=e.querySelector(".settingsQuestion"),d=e.querySelector(".settingsAssignedMotion"),l=parseInt(s(".majorityTypeSettings input","1"),10),c=parseInt(s(".resultsPublicSettings input","1"),10),u=parseInt(s(".votesPublicSettings input","0"),10);this.widget.createVoting(n,o,r.value,a.value,d.value,l,c,u),e.classList.add("hidden"),t.classList.remove("hidden")}))}}}));
//# sourceMappingURL=VotingAdmin.js.map
