{"version":3,"sources":["backend/VotingAdmin.js","backend/VotingAdmin.ts"],"names":["define","require","exports","Object","defineProperty","value","VotingAdmin","[object Object]","$element","this","createVueWidget","initVotingCreater","$vueEl","find","voteSettingsUrl","data","voteCreateUrl","addableMotions","pollUrl","votingInitJson","getAttribute","widget","Vue","el","template","votingsJson","votings","csrf","$","attr","pollingId","computed","alreadyAddedItems","motions","amendments","forEach","voting","items","item","type","push","id","methods","_performOperation","votingBlockId","additionalProps","postData","_csrf","assign","url","replace","post","undefined","success","alert","message","catch","err","responseText","JSON","parse","newStatus","organizations","op","status","map","orga","members_present","title","assignedMotion","createVoting","window","setTimeout","scrollintoview","top_offset","itemType","itemId","itemDefinition","reloadData","get","setVotingFromJson","console","error","startPolling","setInterval","clearInterval","$opener","$form","on","removeClass","addClass","ev","stopPropagation","preventDefault","val"],"mappings":"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","file":"VotingAdmin.js","sourcesContent":[null,"import { VueConstructor } from 'vue';\n\ndeclare var Vue: VueConstructor;\n\nexport class VotingAdmin {\n    private widget;\n\n    constructor(private $element: JQuery) {\n        this.createVueWidget();\n        this.initVotingCreater();\n    }\n\n    private createVueWidget() {\n        const $vueEl = this.$element.find(\".votingAdmin\")[0];\n        const voteSettingsUrl = this.$element.data('url-vote-settings');\n        const voteCreateUrl = this.$element.data('vote-create');\n        const addableMotions = this.$element.data('addable-motions');\n        const pollUrl = this.$element.data('url-poll');\n        const votingInitJson = this.$element[0].getAttribute('data-voting');\n\n        this.widget = new Vue({\n            el: $vueEl,\n            template: `<div class=\"adminVotings\">\n                <voting-admin-widget v-for=\"voting in votings\"\n                                     :voting=\"voting\"\n                                     :addableMotions=\"addableMotions\"\n                                     :alreadyAddedItems=\"alreadyAddedItems\"\n                                     @set-status=\"setStatus\"\n                                     @save-settings=\"saveSettings\"\n                                     @remove-item=\"removeItem\"\n                                     @delete-voting=\"deleteVoting\"\n                                     @add-item=\"addItem\"\n                ></voting-admin-widget>\n            </div>`,\n            data() {\n                return {\n                    votingsJson: null,\n                    votings: null,\n                    addableMotions,\n                    csrf: $(\"head\").find(\"meta[name=csrf-token]\").attr(\"content\") as string,\n                    pollingId: null\n                };\n            },\n            computed: {\n                alreadyAddedItems: function () {\n                    const motions = [];\n                    const amendments = [];\n                    this.votings.forEach(voting => {\n                        voting.items.forEach(item => {\n                            if (item.type === 'motion') {\n                                motions.push(item.id);\n                            }\n                            if (item.type === 'amendment') {\n                                amendments.push(item.id);\n                            }\n                        });\n                    });\n                    return {motions, amendments};\n                }\n            },\n            methods: {\n                _performOperation: function (votingBlockId, additionalProps) {\n                    let postData = {\n                        _csrf: this.csrf,\n                    };\n                    if (additionalProps) {\n                        postData = Object.assign(postData, additionalProps);\n                    }\n                    const widget = this;\n                    const url = voteSettingsUrl.replace(/VOTINGBLOCKID/, votingBlockId);\n                    $.post(url, postData, function (data) {\n                        if (data.success !== undefined && !data.success) {\n                            alert(data.message);\n                            return;\n                        }\n                        widget.votings = data;\n                    }).catch(function (err) {\n                        alert(err.responseText);\n                    });\n                },\n                setVotingFromJson(data) {\n                    if (data === this.votingsJson) {\n                        return;\n                    }\n                    this.votings = JSON.parse(data);\n                    this.votingsJson = data;\n                },\n                setVotingFromObject(data) {\n                    this.votings = data;\n                    this.votingsJson = null;\n                },\n                setStatus(votingBlockId, newStatus, organizations) {\n                    this._performOperation(votingBlockId, {\n                        op: 'update-status',\n                        status: newStatus,\n                        organizations: organizations.map(orga => { return {\n                            id: orga.id,\n                            members_present: orga.members_present,\n                        }}),\n                    });\n                },\n                saveSettings(votingBlockId, title, assignedMotion) {\n                    this._performOperation(votingBlockId, {\n                        op: 'save-settings',\n                        title,\n                        assignedMotion,\n                    });\n                },\n                deleteVoting(votingBlockId) {\n                    this._performOperation(votingBlockId, {\n                        op: 'delete-voting',\n                    });\n                },\n                createVoting: function (title, assignedMotion) {\n                    let postData = {\n                        _csrf: this.csrf,\n                        title,\n                        assignedMotion\n                    };\n                    const widget = this;\n                    $.post(voteCreateUrl, postData, function (data) {\n                        if (data.success !== undefined && !data.success) {\n                            alert(data.message);\n                            return;\n                        }\n                        widget.votings = data['votings'];\n\n                        window.setTimeout(() => {\n                            $(\"#voting\" + data['created_voting']).scrollintoview({top_offset: -100});\n                        }, 200);\n                    }).catch(function (err) {\n                        alert(err.responseText);\n                    });\n                },\n                removeItem(votingBlockId, itemType, itemId) {\n                    this._performOperation(votingBlockId, {\n                        op: 'remove-item',\n                        itemType,\n                        itemId\n                    });\n                },\n                addItem(votingBlockId, itemDefinition) {\n                    this._performOperation(votingBlockId, {\n                        op: 'add-item',\n                        itemDefinition\n                    });\n                },\n                reloadData: function () {\n                    const widget = this;\n                    $.get(pollUrl, function (data) {\n                        widget.setVotingFromJson(data);\n                    }, 'text').catch(function (err) {\n                        console.error(\"Could not load voting data from backend\", err);\n                    });\n                },\n                startPolling: function () {\n                    const widget = this;\n                    this.pollingId = window.setInterval(function () {\n                        widget.reloadData();\n                    }, 3000);\n                }\n            },\n            beforeDestroy() {\n                window.clearInterval(this.pollingId)\n            },\n            created() {\n                this.setVotingFromJson(votingInitJson);\n                this.startPolling()\n            }\n        });\n    }\n\n    private initVotingCreater() {\n        const $opener = this.$element.find('.createVotingOpener'),\n            $form = this.$element.find('.createVotingHolder');\n        $opener.on('click', () => {\n            $form.removeClass('hidden');\n            $opener.addClass('hidden');\n        });\n        $form.find('form').on('submit', (ev) => {\n            ev.stopPropagation();\n            ev.preventDefault();\n            this.widget.createVoting($form.find('.settingsTitle').val(), $form.find('.settingsAssignedMotion').val());\n\n            $form.addClass('hidden');\n            $opener.removeClass('hidden');\n        });\n    }\n}\n"]}