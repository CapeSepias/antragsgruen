{"version":3,"sources":["backend/AmendmentChangeProposal.ts"],"names":["AmendmentChangeProposal","$widget","this","$statusDetails","find","$visibilityInput","initStatusSetter","initCommentForm","saveUrl","attr","csrf","val","submit","ev","preventDefault","prototype","saveStatus","_this","newVal","data","setStatus","visible","prop","_csrf","$","post","addClass","removeClass","window","setTimeout","fail","alert","change","currentTarget","filter","trigger","on","click","bind","$commentWidget","saving","$commentList","text","writeComment","success","$comment","comment","dateFormatted","username","append","scrollTop","scrollHeight","JSON","stringify","exports"],"mappings":"yGAAA,IAEAA,EAAA,WAMI,SAAAA,EAAoBC,GAAAC,KAAAD,QAAAA,EAChBC,KAAKC,eAAiBF,EAAQG,KAAK,kBACnCF,KAAKG,iBAAmBJ,EAAQG,KAAK,+BACrCF,KAAKI,mBACLJ,KAAKK,kBACLL,KAAKM,QAAUP,EAAQQ,KAAK,UAC5BP,KAAKQ,KAAOT,EAAQG,KAAK,qBAAqBO,MAC9CV,EAAQW,OAAO,SAAAC,GAAM,OAAAA,EAAGC,mBAkFhC,OA/EYd,EAAAe,UAAAC,WAAR,WAAA,IAAAC,EAAAf,KACQgB,EAAShB,KAAKD,QAAQG,KAAK,yCAAyCO,MACpEQ,GACAC,UAAWF,EACXG,QAAUnB,KAAKG,iBAAiBiB,KAAK,WAAa,EAAI,EACtDC,MAAOrB,KAAKQ,MAvBA,IAyBZQ,IACAC,EAAsB,gBAAIjB,KAAKD,QAAQG,KAAK,0BAA0BO,OAE1Ea,EAAEC,KAAKvB,KAAKM,QAASW,EAAM,SAACN,GACxBI,EAAKhB,QAAQG,KAAK,WAAWsB,SAAS,UACtCT,EAAKhB,QAAQG,KAAK,UAAUuB,YAAY,UACxCC,OAAOC,WAAW,WAAM,OAAAZ,EAAKhB,QAAQG,KAAK,UAAUsB,SAAS,WAAW,OACzEI,KAAK,WACJC,MAAM,qBAIN/B,EAAAe,UAAAT,iBAAR,WAAA,IAAAW,EAAAf,KACIA,KAAKD,QAAQG,KAAK,iCAAiC4B,OAAO,SAACnB,GACvD,GAAKW,EAAEX,EAAGoB,eAAeX,KAAK,WAA9B,CAGA,IAAIJ,EAASD,EAAKhB,QAAQG,KAAK,yCAAyCO,MACxEM,EAAKd,eAAeuB,SAAS,UAC7BT,EAAKd,eAAe+B,OAAO,WAAahB,GAAQS,YAAY,UAC5DV,EAAKhB,QAAQG,KAAK,WAAWuB,YAAY,aAC1CQ,QAAQ,UAEXjC,KAAKG,iBAAiB2B,OAAO,WACzBf,EAAKhB,QAAQG,KAAK,WAAWuB,YAAY,YAG7CzB,KAAKD,QAAQG,KAAK,0BAA0BgC,GAAG,QAAS,WACpDnB,EAAKhB,QAAQG,KAAK,WAAWuB,YAAY,YAK7CzB,KAAKD,QAAQG,KAAK,WAAWsB,SAAS,UACtCxB,KAAKD,QAAQG,KAAK,kBAAkBiC,MAAMnC,KAAKc,WAAWsB,KAAKpC,QAG3DF,EAAAe,UAAAR,gBAAR,WAAA,IAAAU,EAAAf,KACQqC,EAAiBrC,KAAKD,QAAQG,KAAK,wBACnCoC,GAAS,EACTC,EAAeF,EAAenC,KAAK,gBAEvCmC,EAAenC,KAAK,UAAUiC,MAAM,WAChC,IAAIK,EAAOH,EAAenC,KAAK,YAAYO,MAC/B,IAAR+B,GAAcF,IAIlBA,GAAS,EACThB,EAAEC,KAAKR,EAAKT,SACRmC,aAAcD,EACdnB,MAAON,EAAKP,MACb,SAACG,GACA,GAAIA,EAAG+B,QAAS,CACZ,IAAIC,EAAWrB,EAAE,kHACjBqB,EAASzC,KAAK,SAASsC,KAAK7B,EAAGiC,QAAQC,eACvCF,EAASzC,KAAK,SAASsC,KAAK7B,EAAGiC,QAAQE,UACvCH,EAASzC,KAAK,YAAYsC,KAAK7B,EAAGiC,QAAQJ,MAC1CD,EAAaQ,OAAOJ,GACpBN,EAAenC,KAAK,YAAYO,IAAI,IACpC8B,EAAa,GAAGS,UAAYT,EAAa,GAAGU,kBAE5CpB,MAAM,mBAAqBqB,KAAKC,UAAUxC,IAE9C2B,GAAS,IACVV,KAAK,WACJC,MAAM,kBACNS,GAAS,OAGjBC,EAAa,GAAGS,UAAYT,EAAa,GAAGU,cAEpDnD,KA/FasD,EAAAtD,wBAAAA","file":"AmendmentChangeProposal.js","sourcesContent":["const STATUS_REFERRED = 10;\n\nexport class AmendmentChangeProposal {\n    private $statusDetails: JQuery;\n    private $visibilityInput: JQuery;\n    private saveUrl: string;\n    private csrf: string;\n\n    constructor(private $widget: JQuery) {\n        this.$statusDetails = $widget.find('.statusDetails');\n        this.$visibilityInput = $widget.find('input[name=proposalVisible]');\n        this.initStatusSetter();\n        this.initCommentForm();\n        this.saveUrl = $widget.attr('action');\n        this.csrf = $widget.find('input[name=_csrf]').val();\n        $widget.submit(ev => ev.preventDefault());\n    }\n\n    private saveStatus() {\n        let newVal = this.$widget.find('.statusForm input[type=radio]:checked').val();\n        let data = {\n            setStatus: newVal,\n            visible: (this.$visibilityInput.prop('checked') ? 1 : 0),\n            _csrf: this.csrf\n        };\n        if (newVal == STATUS_REFERRED) {\n            data['proposalComment'] = this.$widget.find('input[name=referredTo]').val();\n        }\n        $.post(this.saveUrl, data, (ev) => {\n            this.$widget.find('.saving').addClass('hidden');\n            this.$widget.find('.saved').removeClass('hidden');\n            window.setTimeout(() => this.$widget.find('.saved').addClass('hidden'), 2000);\n        }).fail(() => {\n            alert(\"Could not save\");\n        });\n    }\n\n    private initStatusSetter() {\n        this.$widget.find(\".statusForm input[type=radio]\").change((ev) => {\n            if (!$(ev.currentTarget).prop('checked')) {\n                return;\n            }\n            let newVal = this.$widget.find('.statusForm input[type=radio]:checked').val();\n            this.$statusDetails.addClass('hidden');\n            this.$statusDetails.filter('.status_' + newVal).removeClass('hidden');\n            this.$widget.find('.saving').removeClass('hidden');\n        }).trigger('change');\n\n        this.$visibilityInput.change(() => {\n            this.$widget.find('.saving').removeClass('hidden');\n        });\n\n        this.$widget.find('input[name=referredTo]').on('keyup', () => {\n            this.$widget.find('.saving').removeClass('hidden');\n        });\n\n\n\n        this.$widget.find('.saving').addClass('hidden');\n        this.$widget.find('.saving button').click(this.saveStatus.bind(this));\n    }\n\n    private initCommentForm() {\n        let $commentWidget = this.$widget.find('.proposalCommentForm'),\n            saving = false,\n            $commentList = $commentWidget.find('.commentList');\n\n        $commentWidget.find('button').click(() => {\n            let text = $commentWidget.find('textarea').val();\n            if (text == '' || saving) {\n                return;\n            }\n\n            saving = true;\n            $.post(this.saveUrl, {\n                writeComment: text,\n                _csrf: this.csrf\n            }, (ev) => {\n                if (ev.success) {\n                    let $comment = $('<li><div class=\"header\"><div class=\"date\"></div><div class=\"name\"></div></div><div class=\"comment\"></div></li>');\n                    $comment.find('.date').text(ev.comment.dateFormatted);\n                    $comment.find('.name').text(ev.comment.username);\n                    $comment.find('.comment').text(ev.comment.text);\n                    $commentList.append($comment);\n                    $commentWidget.find('textarea').val('');\n                    $commentList[0].scrollTop = $commentList[0].scrollHeight;\n                } else {\n                    alert('Could not save: ' + JSON.stringify(ev));\n                }\n                saving = false;\n            }).fail(() => {\n                alert(\"Could not save\");\n                saving = false;\n            });\n        });\n        $commentList[0].scrollTop = $commentList[0].scrollHeight;\n    }\n}\n"]}