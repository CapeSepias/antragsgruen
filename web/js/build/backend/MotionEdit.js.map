{"version":3,"sources":["backend/MotionEdit.ts"],"names":["MotionEdit","_this","this","lang","$","attr","datetimepicker","locale","data","format","find","click","initMotionTextEdit","ev","preventDefault","loadAmendmentCollisions","on","each","text","CKEDITOR","instances","getData","parents","val","onSubmitDeleteForm","initVotingFunctions","initSlug","MotionSupporterEdit_1","MotionSupporterEdit","prototype","addClass","removeClass","$closer","$opener","$inputRows","confirmed","bootbox","confirm","__t","result","trigger","$textarea","editor","AntragsgruenEditor_1","AntragsgruenEditor","getEditor","parent","append","length","show","prop","hide","url","sections","$holder","children","$this","hasClass","sectionId","replace","post","newSections","_csrf","html","scrollintoview","top_offset","exports"],"mappings":"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","file":"MotionEdit.js","sourcesContent":["/// <reference path=\"../typings/scrollintoview/index.d.ts\" />\n\nimport {MotionSupporterEdit} from \"./MotionSupporterEdit\";\nimport {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\n\nexport class MotionEdit {\n    constructor() {\n        let lang = $(\"html\").attr(\"lang\");\n        $(\"#motionDateCreationHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDatePublicationHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDateResolutionHolder\").datetimepicker({\n            locale: lang\n        });\n        $('#resolutionDateHolder').datetimepicker({\n            locale: $('#resolutionDate').data('locale'),\n            format: 'L'\n        });\n        $(\"#motionTextEditCaller\").find(\"button\").click(() => {\n            this.initMotionTextEdit();\n        });\n\n        $(\".checkAmendmentCollisions\").click((ev) => {\n            ev.preventDefault();\n            this.loadAmendmentCollisions();\n        });\n\n        $(\"#motionUpdateForm\").on(\"submit\", function () {\n            $(\".amendmentCollisionsHolder .amendmentOverrideBlock > .texteditor\").each(function () {\n                let text = CKEDITOR.instances[$(this).attr(\"id\")].getData();\n                $(this).parents(\".amendmentOverrideBlock\").find(\"> textarea\").val(text);\n            });\n        });\n\n        $(\".motionDeleteForm\").on(\"submit\", (ev, data) => {\n            this.onSubmitDeleteForm(ev, data);\n        });\n\n        this.initVotingFunctions();\n        this.initSlug();\n\n        new MotionSupporterEdit($(\"#motionSupporterHolder\"));\n    }\n\n    private initSlug() {\n        $('.urlSlugHolder .shower a').on(\"click\", (ev) => {\n            ev.preventDefault();\n            $('.urlSlugHolder .shower').addClass('hidden');\n            $('.urlSlugHolder .holder').removeClass('hidden');\n        });\n    }\n\n    private initVotingFunctions() {\n        const $closer = $(\".votingResultCloser\"),\n            $opener = $(\".votingResultOpener\"),\n            $inputRows = $(\".contentVotingResult, .contentVotingResultComment\");\n        $opener.on(\"click\", () => {\n            $closer.removeClass(\"hidden\");\n            $opener.addClass(\"hidden\");\n            $inputRows.removeClass(\"hidden\");\n        });\n        $closer.on(\"click\", () => {\n            $closer.addClass(\"hidden\");\n            $opener.removeClass(\"hidden\");\n            $inputRows.addClass(\"hidden\");\n        });\n    }\n\n    private onSubmitDeleteForm(ev, data) {\n        if (data && typeof(data.confirmed) && data.confirmed === true) {\n            return;\n        }\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"delMotionConfirm\"), function (result) {\n            if (result) {\n                $(\".motionDeleteForm\").trigger(\"submit\", {'confirmed': true});\n            }\n        });\n    }\n\n    private initMotionTextEdit() {\n        $(\"#motionTextEditCaller\").addClass(\"hidden\");\n        $(\"#motionTextEditHolder\").removeClass(\"hidden\");\n        $(\".wysiwyg-textarea\").each(function () {\n            let $holder = $(this),\n                $textarea = $holder.find(\".texteditor\"),\n                ckeditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                editor = ckeditor.getEditor();\n\n            $textarea.parents(\"form\").on(\"submit\", () => {\n                $textarea.parent().find(\"textarea\").val(editor.getData());\n            });\n        });\n        $(\"#motionUpdateForm\").append(\"<input type='hidden' name='edittext' value='1'>\");\n\n        if ($(\".checkAmendmentCollisions\").length > 0) {\n            $(\".wysiwyg-textarea .texteditor\").on(\"focus\", function () {\n                $(\".checkAmendmentCollisions\").show();\n                $(\".saveholder .save\").prop(\"disabled\", true).hide();\n            });\n            $(\".checkAmendmentCollisions\").show();\n            $(\".saveholder .save\").prop(\"disabled\", true).hide();\n        }\n    }\n\n    private loadAmendmentCollisions() {\n        let url = $(\".checkAmendmentCollisions\").data(\"url\"),\n            sections = {},\n            $holder = $(\".amendmentCollisionsHolder\");\n\n        $(\"#motionTextEditHolder\").children().each(function () {\n            let $this = $(this);\n            if ($this.hasClass(\"wysiwyg-textarea\")) {\n                let sectionId = $this.attr(\"id\").replace(\"section_holder_\", \"\");\n                sections[sectionId] = CKEDITOR.instances[$this.find(\".texteditor\").attr(\"id\")].getData();\n            }\n        });\n        $.post(url, {\n            'newSections': sections,\n            '_csrf': $(\"#motionUpdateForm\").find('> input[name=_csrf]').val()\n        }, function (html) {\n            $holder.html(html);\n\n            if ($holder.find(\".amendmentOverrideBlock > .texteditor\").length > 0) {\n                $holder.find(\".amendmentOverrideBlock > .texteditor\").each(function () {\n                    new AntragsgruenEditor($(this).attr(\"id\"));\n                });\n                $(\".amendmentCollisionsHolder\").scrollintoview({top_offset: -50});\n            }\n\n            $(\".checkAmendmentCollisions\").hide();\n            $(\".saveholder .save\").prop(\"disabled\", false).show();\n\n        });\n    }\n}\n"]}