{"version":3,"sources":["backend/MotionEdit.js","backend/MotionEdit.ts"],"names":["define","require","exports","MotionSupporterEdit_1","AntragsgruenEditor_1","Object","defineProperty","value","MotionEdit","[object Object]","lang","$","attr","this","$updateForm","$status","datetimepicker","locale","data","format","find","on","initMotionTextEdit","ev","preventDefault","loadAmendmentCollisions","each","text","CKEDITOR","instances","getData","parents","val","onSubmitDeleteForm","initVotingFunctions","initSlug","MotionSupporterEdit","addClass","removeClass","$classHolders","$closer","$opener","$votingBlockId","parseInt","trigger","confirmed","bootbox","confirm","__t","result","$textarea","editor","AntragsgruenEditor","getEditor","parent","append","length","show","prop","hide","url","sections","$holder","children","$this","hasClass","sectionId","replace","post","newSections","_csrf","html","scrollintoview","top_offset"],"mappings":"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","file":"MotionEdit.js","sourcesContent":[null,"/// <reference path=\"../typings/scrollintoview/index.d.ts\" />\n\nimport {MotionSupporterEdit} from \"./MotionSupporterEdit\";\nimport {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\n\nconst STATUS_VOTE = 11;\n\nexport class MotionEdit {\n    private $updateForm: JQuery;\n    private $status: JQuery;\n\n    constructor() {\n        let lang = $(\"html\").attr(\"lang\");\n        this.$updateForm = $(\"#motionUpdateForm\");\n        this.$status = $(\"#motionStatus\");\n        $(\"#motionDateCreationHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDatePublicationHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDateResolutionHolder\").datetimepicker({\n            locale: lang\n        });\n        $('#resolutionDateHolder').datetimepicker({\n            locale: $('#resolutionDate').data('locale'),\n            format: 'L'\n        });\n        $(\"#motionTextEditCaller\").find(\"button\").on('click', () => {\n            this.initMotionTextEdit();\n        });\n\n        $(\".checkAmendmentCollisions\").on('click', ev => {\n            ev.preventDefault();\n            this.loadAmendmentCollisions();\n        });\n\n        this.$updateForm.on(\"submit\", function () {\n            $(\".amendmentCollisionsHolder .amendmentOverrideBlock > .texteditor\").each(function () {\n                let text = CKEDITOR.instances[$(this).attr(\"id\")].getData();\n                $(this).parents(\".amendmentOverrideBlock\").find(\"> textarea\").val(text);\n            });\n        });\n\n        $(\".motionDeleteForm\").on(\"submit\", (ev, data) => {\n            this.onSubmitDeleteForm(ev, data);\n        });\n\n        this.initVotingFunctions();\n        this.initSlug();\n\n        new MotionSupporterEdit($(\"#motionSupporterHolder\"));\n    }\n\n    private initSlug() {\n        $('.urlSlugHolder .shower a').on(\"click\", (ev) => {\n            ev.preventDefault();\n            $('.urlSlugHolder .shower').addClass('hidden');\n            $('.urlSlugHolder .holder').removeClass('hidden');\n        });\n    }\n\n    private initVotingFunctions() {\n        const $classHolders = $(\".contentVotingResultCaller, .votingDataHolder\"),\n            $closer = $(\".votingDataCloser\"),\n            $opener = $(\".votingDataOpener\"),\n            $votingBlockId = $('select[name=votingBlockId]');\n\n        $opener.on(\"click\", () => {\n            $classHolders.addClass('explicitlyOpened');\n        });\n        $closer.on(\"click\", () => {\n            $classHolders.removeClass('explicitlyOpened');\n        });\n\n        this.$status.on('change', () => {\n            if (parseInt(this.$status.val() as string, 10) === STATUS_VOTE) {\n                $classHolders.addClass('hasVotingStatus');\n            } else {\n                $classHolders.removeClass('hasVotingStatus');\n            }\n        }).trigger('change');\n\n        $votingBlockId.on('change', () => {\n            if ($votingBlockId.val() === 'NEW') {\n                $(\".votingBlockRow .newBlock\").removeClass('hidden');\n                $(\".votingItemBlockRow\").addClass('hidden');\n            } else {\n                $(\".votingBlockRow .newBlock\").addClass('hidden');\n                $(\".votingItemBlockRow\").addClass('hidden');\n                $(\".votingItemBlockRow\" + $votingBlockId.val()).removeClass('hidden');\n            }\n        }).trigger('change');\n    }\n\n    private onSubmitDeleteForm(ev, data) {\n        if (data && typeof(data.confirmed) && data.confirmed === true) {\n            return;\n        }\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"delMotionConfirm\"), function (result) {\n            if (result) {\n                $(\".motionDeleteForm\").trigger(\"submit\", {'confirmed': true});\n            }\n        });\n    }\n\n    private initMotionTextEdit() {\n        $(\"#motionTextEditCaller\").addClass(\"hidden\");\n        $(\"#motionTextEditHolder\").removeClass(\"hidden\");\n        $(\".wysiwyg-textarea\").each(function () {\n            let $holder = $(this),\n                $textarea = $holder.find(\".texteditor\"),\n                ckeditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                editor = ckeditor.getEditor();\n\n            $textarea.parents(\"form\").on(\"submit\", () => {\n                $textarea.parent().find(\"textarea\").val(editor.getData());\n            });\n        });\n        this.$updateForm.append(\"<input type='hidden' name='edittext' value='1'>\");\n\n        if ($(\".checkAmendmentCollisions\").length > 0) {\n            $(\".wysiwyg-textarea .texteditor\").on(\"focus\", function () {\n                $(\".checkAmendmentCollisions\").show();\n                $(\".saveholder .save\").prop(\"disabled\", true).hide();\n            });\n            $(\".checkAmendmentCollisions\").show();\n            $(\".saveholder .save\").prop(\"disabled\", true).hide();\n        }\n    }\n\n    private loadAmendmentCollisions() {\n        let url = $(\".checkAmendmentCollisions\").data(\"url\"),\n            sections = {},\n            $holder = $(\".amendmentCollisionsHolder\");\n\n        $(\"#motionTextEditHolder\").children().each(function () {\n            let $this = $(this);\n            if ($this.hasClass(\"wysiwyg-textarea\")) {\n                let sectionId = $this.attr(\"id\").replace(\"section_holder_\", \"\");\n                sections[sectionId] = CKEDITOR.instances[$this.find(\".texteditor\").attr(\"id\")].getData();\n            }\n        });\n        $.post(url, {\n            'newSections': sections,\n            '_csrf': this.$updateForm.find('> input[name=_csrf]').val()\n        }, function (html) {\n            $holder.html(html);\n\n            if ($holder.find(\".amendmentOverrideBlock > .texteditor\").length > 0) {\n                $holder.find(\".amendmentOverrideBlock > .texteditor\").each(function () {\n                    new AntragsgruenEditor($(this).attr(\"id\"));\n                });\n                $(\".amendmentCollisionsHolder\").scrollintoview({top_offset: -50});\n            }\n\n            $(\".checkAmendmentCollisions\").hide();\n            $(\".saveholder .save\").prop(\"disabled\", false).show();\n\n        });\n    }\n}\n"]}