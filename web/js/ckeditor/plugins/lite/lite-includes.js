(function(f){f.ice={}})(this||window);
(function(f){function l(a,b){var e=typeof a[b];return"function"==e||!("object"!=e||!a[b])||"unknown"==e}function x(a,b){return!("object"!=typeof a[b]||!a[b])}function v(a,b){return"undefined"!=typeof a[b]}function p(a){return function(b,e){for(var d=e.length;d--;)if(!a(b,e[d]))return!1;return!0}}function n(a){return a&&t(a,h)&&D(a,d)}function c(a){return x(a,"body")?a.body:a.getElementsByTagName("body")[0]}function q(a){x(window,"console")&&l(window.console,"log")&&window.console.log(a)}function A(a){m.initialized=
!0;m.supported=!1;a="Rangy is not supported on this page in your browser. Reason: "+a;m.config.alertOnFail?window.alert(a):q(a)}function B(){if(!m.initialized){var b,d=!1,h=!1;l(document,"createRange")&&(b=document.createRange(),t(b,e)&&D(b,a)&&(d=!0));if((b=c(document))&&"body"==b.nodeName.toLowerCase())if(b&&l(b,"createTextRange")&&(b=b.createTextRange(),n(b)&&(h=!0)),d||h){m.initialized=!0;m.features={implementsDomRange:d,implementsTextRange:h};var g,f;for(f in w)(g=w[f])instanceof E&&g.init(g,
m);h=0;for(g=F.length;h<g;++h)try{F[h](m)}catch(z){d="Rangy init listener threw an exception. Continuing. Detail: "+(z.message||z.description||String(z)),q(d)}}else A("Neither Range nor TextRange are available");else A("No body element found")}}function E(a,b,e){this.name=a;this.dependencies=b;this.supported=this.initialized=!1;this.initializer=e}function b(a,b,e,d){a=new E(b,e,function(a){if(!a.initialized){a.initialized=!0;try{d(m,a),a.supported=!0}catch(e){q("Module '"+b+"' failed to load: "+(e.message||
e.description||String(e)))}}});w[b]=a}function g(){}var k="function"==typeof f.define&&f.define.amd,a="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" "),e="setStart setStartBefore setStartAfter setEnd setEndBefore setEndAfter collapse selectNode selectNodeContents compareBoundaryPoints deleteContents extractContents cloneContents insertNode surroundContents cloneRange toString detach".split(" "),d="boundingHeight boundingLeft boundingTop boundingWidth htmlText text".split(" "),
h="collapse compareEndPoints duplicate moveToElementText parentElement select setEndPoint getBoundingClientRect".split(" "),t=p(l),z=p(x),D=p(v),w={},m={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:l,isHostObject:x,isHostProperty:v,areHostMethods:t,areHostObjects:z,areHostProperties:D,isTextRange:n,getBody:c},features:{},modules:w,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};m.fail=A;m.warn=function(a){a="Rangy warning: "+a;m.config.alertOnWarn?window.alert(a):
q(a)};({}).hasOwnProperty?m.util.extend=function(a,b,e){var d,h,c;for(c in b)b.hasOwnProperty(c)&&(d=a[c],h=b[c],e&&null!==d&&"object"==typeof d&&null!==h&&"object"==typeof h&&m.util.extend(d,h,!0),a[c]=h);b.hasOwnProperty("toString")&&(a.toString=b.toString);return a}:A("hasOwnProperty not supported");(function(){var a=document.createElement("div");a.appendChild(document.createElement("span"));var b=[].slice,e;try{1==b.call(a.childNodes,0)[0].nodeType&&(e=function(a){return b.call(a,0)})}catch(d){}e||
(e=function(a){for(var b=[],e=0,d=a.length;e<d;++e)b[e]=a[e];return b});m.util.toArray=e})();var H;l(document,"addEventListener")?H=function(a,b,e){a.addEventListener(b,e,!1)}:l(document,"attachEvent")?H=function(a,b,e){a.attachEvent("on"+b,e)}:A("Document does not have required addEventListener or attachEvent method");m.util.addListener=H;var F=[];m.init=B;m.addInitListener=function(a){m.initialized?a(m):F.push(a)};var N=[];m.addCreateMissingNativeApiListener=function(a){N.push(a)};m.createMissingNativeApi=
function(a){a=a||window;B();for(var b=0,e=N.length;b<e;++b)N[b](a)};E.prototype={init:function(a){a=this.dependencies||[];for(var b=0,e=a.length,d,h;b<e;++b){h=a[b];d=w[h];if(!(d&&d instanceof E))throw Error("required module '"+h+"' not found");d.init();if(!d.supported)throw Error("required module '"+h+"' not supported");}this.initializer(this)},fail:function(a){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+a);},warn:function(a){m.warn("Module "+this.name+
": "+a)},deprecationNotice:function(a,b){m.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return Error("Error in Rangy "+this.name+" module: "+a)}};m.createModule=function(a){var e,d;2==arguments.length?(e=arguments[1],d=[]):(e=arguments[2],d=arguments[1]);b(!1,a,d,e)};m.createCoreModule=function(a,e,d){b(!0,a,e,d)};m.RangePrototype=g;m.rangePrototype=new g;m.selectionPrototype=new function(){};var P=!1,z=function(a){P||(P=!0,m.initialized||
B())};"undefined"==typeof window?A("No window found"):"undefined"==typeof document?A("No document found"):(l(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",z,!1),H(window,"load",z),k&&function(a){a(function(){m.amd=!0;return m})}(f.define),f.rangy=m,f.rangy.createCoreModule("DomUtil",[],function(a,b){function e(a){for(var b=0;a=a.previousSibling;)++b;return b}function d(a,b){var e=[],h;for(h=a;h;h=h.parentNode)e.push(h);for(h=b;h;h=h.parentNode)if(A(e,h))return h;return null}
function h(a,b,e){for(b=e?b:b.parentNode;b;){if(b===a)return!0;b=b.parentNode}return!1}function c(a,b,e){for(e=e?a:a.parentNode;e;){a=e.parentNode;if(a===b)return e;e=a}return null}function g(a){a=a.nodeType;return 3==a||4==a||8==a}function f(a,b){var e=b.nextSibling,d=b.parentNode;e?d.insertBefore(a,e):d.appendChild(a);return a}function t(a){if(9==a.nodeType)return a;if("undefined"!=typeof a.ownerDocument)return a.ownerDocument;if("undefined"!=typeof a.document)return a.document;if(a.parentNode)return t(a.parentNode);
throw b.createError("getDocument: no document found for node");}function z(a){a=t(a);if("undefined"!=typeof a.defaultView)return a.defaultView;if("undefined"!=typeof a.parentWindow)return a.parentWindow;throw b.createError("Cannot get a window object for node");}function k(a){if("undefined"!=typeof a.contentDocument)return a.contentDocument;if("undefined"!=typeof a.contentWindow)return a.contentWindow.document;throw b.createError("getIframeDocument: No Document object found for iframe element");}
function m(a){return a&&q.isHostMethod(a,"setTimeout")&&q.isHostObject(a,"document")}function n(a){return a?g(a)?'"'+a.data+'"':1==a.nodeType?"\x3c"+a.nodeName+(a.id?' id\x3d"'+a.id+'"':"")+"\x3e[index:"+e(a)+",length:"+a.childNodes.length+"]["+(a.innerHTML||"[innerHTML not supported]").slice(0,25)+"]":a.nodeName:"[No node]"}function w(a){this._next=this.root=a}function l(a,b){this.node=a;this.offset=b}function D(a){this.code=this[a];this.codeName=a;this.message="DOMException: "+this.codeName}var q=
a.util;q.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method");q.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var H=document.createElement("div");q.areHostMethods(H,["insertBefore","appendChild","cloneNode"])||b.fail("Incomplete Element implementation");q.isHostProperty(H,"innerHTML")||b.fail("Element is missing innerHTML property");H=document.createTextNode("test");
q.areHostMethods(H,["splitText","deleteData","insertData","appendData","cloneNode"])||b.fail("Incomplete Text Node implementation");var A=function(a,b){for(var e=a.length;e--;)if(a[e]===b)return!0;return!1},p=!1;(function(){var b=document.createElement("b");b.innerHTML="1";b.innerHTML="\x3cbr\x3e";p=!1;a.features.crashyTextNodes=p})();var v;"undefined"!=typeof window.getComputedStyle?v=function(a,b){return z(a).getComputedStyle(a,null)[b]}:"undefined"!=typeof document.documentElement.currentStyle?
v=function(a,b){return a.currentStyle[b]}:b.fail("No means of obtaining computed style properties found");w.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b;if(this._current){b=a.firstChild;if(!b)for(b=null;a!==this.root&&!(b=a.nextSibling);)a=a.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}};l.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},
inspect:function(){return"[DomPosition("+n(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};D.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24};D.prototype.toString=function(){return this.message};a.dom={arrayContains:A,isHtmlNamespace:function(a){var b;return"undefined"==typeof a.namespaceURI||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==
b},parentElement:function(a){a=a.parentNode;return 1==a.nodeType?a:null},getNodeIndex:e,getNodeLength:function(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}},getCommonAncestor:d,isAncestorOf:h,isOrIsAncestorOf:function(a,b){return h(a,b,!0)},getClosestAncestorIn:c,isCharacterDataNode:g,isTextOrCommentNode:function(a){if(!a)return!1;a=a.nodeType;return 3==a||8==a},insertAfter:f,splitDataNode:function(a,b,d){var h=a.cloneNode(!1);h.deleteData(0,
b);a.deleteData(b,a.length-b);f(h,a);if(d)for(var c=0,g;g=d[c++];)g.node==a&&g.offset>b?(g.node=h,g.offset-=b):g.node==a.parentNode&&g.offset>e(a)&&++g.offset;return h},getDocument:t,getWindow:z,getIframeWindow:function(a){if("undefined"!=typeof a.contentWindow)return a.contentWindow;if("undefined"!=typeof a.contentDocument)return a.contentDocument.defaultView;throw b.createError("getIframeWindow: No Window object found for iframe element");},getIframeDocument:k,getBody:q.getBody,isWindow:m,getContentDocument:function(a,
b,e){var d;a?q.isHostProperty(a,"nodeType")?d=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?k(a):t(a):m(a)&&(d=a.document):d=document;if(!d)throw b.createError(e+"(): Parameter must be a Window object or DOM node");return d},getRootContainer:function(a){for(var b;b=a.parentNode;)a=b;return a},comparePoints:function(a,h,g,f){var t;if(a==g)return h===f?0:h<f?-1:1;if(t=c(g,a,!0))return h<=e(t)?-1:1;if(t=c(a,g,!0))return e(t)<f?-1:1;h=d(a,g);if(!h)throw Error("comparePoints error: nodes have no common ancestor");
a=a===h?h:c(a,h,!0);g=g===h?h:c(g,h,!0);if(a===g)throw b.createError("comparePoints got to case 4 and childA and childB are the same!");for(h=h.firstChild;h;){if(h===a)return-1;if(h===g)return 1;h=h.nextSibling}},isBrokenNode:function(a){return!1},inspectNode:n,getComputedStyleProperty:v,fragmentFromNodeChildren:function(a){for(var b=t(a).createDocumentFragment(),e;e=a.firstChild;)b.appendChild(e);return b},createIterator:function(a){return new w(a)},DomPosition:l};a.DOMException=D}),f.rangy.createCoreModule("DomRange",
["DomUtil"],function(a,b){function e(a,b){return 3!=a.nodeType&&(Q(a,b.startContainer)||Q(a,b.endContainer))}function d(a){return a.document||X(a.startContainer)}function h(a){return new U(a.parentNode,K(a))}function c(a){return new U(a.parentNode,K(a)+1)}function g(a,b,e){var d=11==a.nodeType?a.firstChild:a;r(b)?e==b.length?y.insertAfter(a,b):b.parentNode.insertBefore(a,0==e?b:aa(b,e)):e>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[e]);return d}function f(a,b,e){C(a);C(b);
if(d(b)!=d(a))throw new I("WRONG_DOCUMENT_ERR");var h=G(a.startContainer,a.startOffset,b.endContainer,b.endOffset);a=G(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return e?0>=h&&0<=a:0>h&&0<a}function t(a){for(var b,e,h=d(a.range).createDocumentFragment();e=a.next();){b=a.isPartiallySelectedSubtree();e=e.cloneNode(!b);b&&(b=a.getSubtreeIterator(),e.appendChild(t(b)),b.detach());if(10==e.nodeType)throw new I("HIERARCHY_REQUEST_ERR");h.appendChild(e)}return h}function z(a,b,e){var d,
h;for(e=e||{stop:!1};d=a.next();)if(a.isPartiallySelectedSubtree())if(!1===b(d)){e.stop=!0;break}else{if(d=a.getSubtreeIterator(),z(d,b,e),d.detach(),e.stop)break}else for(d=y.createIterator(d);h=d.next();)if(!1===b(h)){e.stop=!0;return}}function k(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),k(b),b.detach()):a.remove()}function m(a){for(var b,e=d(a.range).createDocumentFragment(),h;b=a.next();){a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),h=a.getSubtreeIterator(),
b.appendChild(m(h)),h.detach()):a.remove();if(10==b.nodeType)throw new I("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function n(a,b,e){var d=!(!b||!b.length),h,u=!!e;d&&(h=new RegExp("^("+b.join("|")+")$"));var c=[];z(new l(a,!1),function(b){if(!d||h.test(b.nodeType))if(!u||e(b)){var g=a.startContainer;b==g&&r(g)&&a.startOffset==g.length||(g=a.endContainer,b==g&&r(g)&&0==a.endOffset||c.push(b))}});return c}function w(a){return"["+("undefined"==typeof a.getName?"Range":a.getName())+"("+y.inspectNode(a.startContainer)+
":"+a.startOffset+", "+y.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function l(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer;this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var e=a.commonAncestorContainer;this.sc===this.ec&&r(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==e||r(this.sc)?V(this.sc,e,!0):this.sc.childNodes[this.so],this._last=this.ec!==
e||r(this.ec)?V(this.ec,e,!0):this.ec.childNodes[this.eo-1])}}function D(a){return function(b,e){for(var d,h=e?b:b.parentNode;h;){d=h.nodeType;if(W(a,d))return h;h=h.parentNode}return null}}function q(a,b){if(ma(a,b))throw new I("INVALID_NODE_TYPE_ERR");}function H(a,b){if(!W(b,a.nodeType))throw new I("INVALID_NODE_TYPE_ERR");}function A(a,b){if(0>b||b>(r(a)?a.length:a.childNodes.length))throw new I("INDEX_SIZE_ERR");}function p(a,b){if(fa(a,!0)!==fa(b,!0))throw new I("WRONG_DOCUMENT_ERR");}function v(a){if(na(a,
!0))throw new I("NO_MODIFICATION_ALLOWED_ERR");}function F(a,b){if(!a)throw new I(b);}function x(a){return ba&&y.isBrokenNode(a)||!W(ca,a.nodeType)&&!fa(a,!0)}function ia(a,b){return b<=(r(a)?a.length:a.childNodes.length)}function ja(a){return!!a.startContainer&&!!a.endContainer&&!x(a.startContainer)&&!x(a.endContainer)&&ia(a.startContainer,a.startOffset)&&ia(a.endContainer,a.endOffset)}function C(a){if(!ja(a))throw Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")");
}function B(a,b){C(a);var e=a.startContainer,d=a.startOffset,h=a.endContainer,c=a.endOffset,u=e===h;r(h)&&0<c&&c<h.length&&aa(h,c,b);r(e)&&0<d&&d<e.length&&(e=aa(e,d,b),u?(c-=d,h=e):h==e.parentNode&&c>=K(e)&&c++,d=0);a.setStartAndEnd(e,d,h,c)}function N(a){a.START_TO_START=0;a.START_TO_END=1;a.END_TO_END=2;a.END_TO_START=3;a.NODE_BEFORE=0;a.NODE_AFTER=1;a.NODE_BEFORE_AND_AFTER=2;a.NODE_INSIDE=3}function P(a){N(a);N(a.prototype)}function E(a,b){return function(){C(this);var e=this.startContainer,d=
this.startOffset,h=this.commonAncestorContainer,u=new l(this,!0);e!==h&&(e=V(e,h,!0),d=c(e),e=d.node,d=d.offset);z(u,v);u.reset();h=a(u);u.detach();b(this,e,d,e,d);return h}}function J(b,d){function u(a,b){return function(e){H(e,Y);H(O(e),ca);e=(a?h:c)(e);(b?g:f)(this,e.node,e.offset)}}function g(a,b,e){var h=a.endContainer,u=a.endOffset;if(b!==a.startContainer||e!==a.startOffset){if(O(b)!=O(h)||1==G(b,e,h,u))h=b,u=e;d(a,b,e,h,u)}}function f(a,b,e){var h=a.startContainer,u=a.startOffset;if(b!==a.endContainer||
e!==a.endOffset){if(O(b)!=O(h)||-1==G(b,e,h,u))h=b,u=e;d(a,h,u,b,e)}}var t=function(){};t.prototype=a.rangePrototype;b.prototype=new t;T.extend(b.prototype,{setStart:function(a,b){q(a,!0);A(a,b);g(this,a,b)},setEnd:function(a,b){q(a,!0);A(a,b);f(this,a,b)},setStartAndEnd:function(){var a=arguments,b=a[0],e=a[1],h=b,u=e;switch(a.length){case 3:u=a[2];break;case 4:h=a[2],u=a[3]}d(this,b,e,h,u)},setBoundary:function(a,b,e){this["set"+(e?"Start":"End")](a,b)},setStartBefore:u(!0,!0),setStartAfter:u(!1,
!0),setEndBefore:u(!0,!1),setEndAfter:u(!1,!1),collapse:function(a){C(this);a?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){q(a,!0);d(this,a,0,a,L(a))},selectNode:function(a){q(a,!1);H(a,Y);var b=h(a);a=c(a);d(this,b.node,b.offset,a.node,a.offset)},extractContents:E(m,d),deleteContents:E(k,d),canSurroundContents:function(){C(this);v(this.startContainer);v(this.endContainer);
var a=new l(this,!0),b=a._first&&e(a._first,this)||a._last&&e(a._last,this);a.detach();return!b},splitBoundaries:function(){B(this)},splitBoundariesPreservingPositions:function(a){B(this,a)},normalizeBoundaries:function(){C(this);var a=this.startContainer,b=this.startOffset,e=this.endContainer,h=this.endOffset,u=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(e=a,h=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},c=function(d){var u=d.previousSibling;if(u&&u.nodeType==d.nodeType){a=
d;var c=d.length;b=u.length;d.insertData(0,u.data);u.parentNode.removeChild(u);a==e?(h+=b,e=a):e==d.parentNode&&(u=K(d),h==u?(e=d,h=c):h>u&&h--)}},g=!0;r(e)?e.length==h&&u(e):(0<h&&(g=e.childNodes[h-1])&&r(g)&&u(g),g=!this.collapsed);g?r(a)?0==b&&c(a):b<a.childNodes.length&&(u=a.childNodes[b])&&r(u)&&c(u):(a=e,b=h);d(this,a,b,e,h)},collapseToPoint:function(a,b){q(a,!0);A(a,b);this.setStartAndEnd(a,b)}});P(b)}function M(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset;
a.commonAncestorContainer=a.collapsed?a.startContainer:y.getCommonAncestor(a.startContainer,a.endContainer)}function R(a,b,e,d,h){a.startContainer=b;a.startOffset=e;a.endContainer=d;a.endOffset=h;a.document=y.getDocument(b);M(a)}function S(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this.document=a;M(this)}var y=a.dom,T=a.util,U=y.DomPosition,I=a.DOMException,r=y.isCharacterDataNode,K=y.getNodeIndex,Q=y.isOrIsAncestorOf,X=y.getDocument,G=y.comparePoints,aa=y.splitDataNode,
V=y.getClosestAncestorIn,L=y.getNodeLength,W=y.arrayContains,O=y.getRootContainer,ba=a.features.crashyTextNodes;l.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;a&&(this._next=a!==this._last?a.nextSibling:null,r(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-
this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so)));return a},remove:function(){var a=this._current,b,e;!r(a)||a!==this.sc&&a!==this.ec?a.parentNode&&a.parentNode.removeChild(a):(b=a===this.sc?this.so:0,e=a===this.ec?this.eo:a.length,b!=e&&a.deleteData(b,e-b))},isPartiallySelectedSubtree:function(){return e(this._current,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new S(d(this.range));
var b=this._current,e=b,h=0,u=b,c=L(b);Q(b,this.sc)&&(e=this.sc,h=this.so);Q(b,this.ec)&&(u=this.ec,c=this.eo);R(a,e,h,u,c)}return new l(a,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Y=[1,3,4,5,7,8,10],ca=[2,9,11],Z=[1,3,4,5,7,8,10,11],u=[1,3,4,5,7,8],fa=D([9,11]),na=D([5,6,10,12]),ma=D([6,10,12]),ka=document.createElement("style"),ga=!1;try{ka.innerHTML="\x3cb\x3ex\x3c/b\x3e",ga=3==
ka.firstChild.nodeType}catch(oa){}a.features.htmlParsingConforms=ga;var ha="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" ");T.extend(a.rangePrototype,{compareBoundaryPoints:function(a,b){C(this);p(this.startContainer,b.startContainer);var e=3==a||0==a?"start":"end",d=1==a||0==a?"start":"end";return G(this[e+"Container"],this[e+"Offset"],b[d+"Container"],b[d+"Offset"])},insertNode:function(a){C(this);H(a,Z);v(this.startContainer);if(Q(a,this.startContainer))throw new I("HIERARCHY_REQUEST_ERR");
a=g(a,this.startContainer,this.startOffset);this.setStartBefore(a)},cloneContents:function(){C(this);var a,b;if(this.collapsed)return d(this).createDocumentFragment();if(this.startContainer===this.endContainer&&r(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=d(this).createDocumentFragment(),b.appendChild(a),b;b=new l(this,!0);a=t(b);b.detach();return a},canSurroundContents:function(){C(this);v(this.startContainer);v(this.endContainer);
var a=new l(this,!0),b=a._first&&e(a._first,this)||a._last&&e(a._last,this);a.detach();return!b},surroundContents:function(a){H(a,u);if(!this.canSurroundContents())throw new I("INVALID_STATE_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);g(a,this.startContainer,this.startOffset);a.appendChild(b);this.selectNode(a)},cloneRange:function(){C(this);for(var a=new S(d(this)),b=ha.length,e;b--;)e=ha[b],a[e]=this[e];return a},toString:function(){C(this);
var a=this.startContainer;if(a===this.endContainer&&r(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],a=new l(this,!0);z(a,function(a){3!=a.nodeType&&4!=a.nodeType||b.push(a.data)});a.detach();return b.join("")},compareNode:function(a){C(this);var b=a.parentNode,e=K(a);if(!b)throw new I("NOT_FOUND_ERR");a=this.comparePoint(b,e);b=this.comparePoint(b,e+1);return 0>a?0<b?2:0:0<b?1:3},comparePoint:function(a,b){C(this);F(a,"HIERARCHY_REQUEST_ERR");p(a,
this.startContainer);return 0>G(a,b,this.startContainer,this.startOffset)?-1:0<G(a,b,this.endContainer,this.endOffset)?1:0},createContextualFragment:ga?function(a){var b=this.startContainer,e=X(b);if(!b)throw new I("INVALID_STATE_ERR");var d=null;1==b.nodeType?d=b:r(b)&&(d=y.parentElement(b));d=null===d||"HTML"==d.nodeName&&y.isHtmlNamespace(X(d).documentElement)&&y.isHtmlNamespace(d)?e.createElement("body"):d.cloneNode(!1);d.innerHTML=a;return y.fragmentFromNodeChildren(d)}:function(a){var b=d(this).createElement("body");
b.innerHTML=a;return y.fragmentFromNodeChildren(b)},toHtml:function(){C(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);a.appendChild(this.cloneContents());return a.innerHTML},intersectsNode:function(a,b){C(this);F(a,"NOT_FOUND_ERR");if(X(a)!==d(this))return!1;var e=a.parentNode,h=K(a);F(e,"NOT_FOUND_ERR");var u=G(e,h,this.endContainer,this.endOffset),e=G(e,h+1,this.startContainer,this.startOffset);return b?0>=u&&0<=e:0>u&&0<e},isPointInRange:function(a,b){C(this);F(a,"HIERARCHY_REQUEST_ERR");
p(a,this.startContainer);return 0<=G(a,b,this.startContainer,this.startOffset)&&0>=G(a,b,this.endContainer,this.endOffset)},intersectsRange:function(a){return f(this,a,!1)},intersectsOrTouchesRange:function(a){return f(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=G(this.startContainer,this.startOffset,a.startContainer,a.startOffset),e=G(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();-1==b&&d.setStart(a.startContainer,a.startOffset);1==e&&
d.setEnd(a.endContainer,a.endOffset);return d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();-1==G(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset);1==G(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset);return b}throw new I("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):3==this.compareNode(a)},containsNodeContents:function(a){return 0<=
this.comparePoint(a,0)&&0>=this.comparePoint(a,L(a))},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var e=b.getNodes([3]);return 0<e.length?(b.setStart(e[0],0),a=e.pop(),b.setEnd(a,a.length),this.containsRange(b)):this.containsNodeContents(a)},getNodes:function(a,b){C(this);return n(this,a,b)},getDocument:function(){return d(this)},collapseBefore:function(a){this.setEndBefore(a);this.collapse(!1)},
collapseAfter:function(a){this.setStartAfter(a);this.collapse(!0)},getBookmark:function(b){var e=d(this),h=a.createRange(e);b=b||y.getBody(e);h.selectNodeContents(b);var e=this.intersection(h),u=0,c=0;e&&(h.setEnd(e.startContainer,e.startOffset),u=h.toString().length,c=u+e.toString().length);return{start:u,end:c,containerNode:b}},moveToBookmark:function(a){var b=a.containerNode,e=0;this.setStart(b,0);this.collapse(!0);for(var b=[b],d,h=!1,u=!1,c,g;!u&&(d=b.pop());)if(3==d.nodeType)c=e+d.length,!h&&
a.start>=e&&a.start<=c&&(this.setStart(d,a.start-e),h=!0),h&&a.end>=e&&a.end<=c&&(this.setEnd(d,a.end-e),u=!0),e=c;else for(g=d.childNodes,c=g.length;c--;)b.push(g[c])},getName:function(){return"DomRange"},equals:function(a){return S.rangesEqual(this,a)},isValid:function(){return ja(this)},inspect:function(){return w(this)},detach:function(){}});J(S,R);T.extend(S,{rangeProperties:ha,RangeIterator:l,copyComparisonConstants:P,createPrototypeRange:J,inspect:w,getRangeDocument:d,rangesEqual:function(a,
b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}});a.DomRange=S}),f.rangy.createCoreModule("WrappedRange",["DomRange"],function(a,b){var e,d,h=a.dom,c=a.util,g=h.DomPosition,f=a.DomRange,t=h.getBody,z=h.getContentDocument,k=h.isCharacterDataNode;a.features.implementsDomRange&&function(){function d(a){for(var b=k.length,e;b--;)e=k[b],a[e]=a.nativeRange[e];a.collapsed=a.startContainer===a.endContainer&&a.startOffset===
a.endOffset}var g,k=f.rangeProperties,m;e=function(a){if(!a)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=a;d(this)};f.createPrototypeRange(e,function(a,b,e,d,h){var g=a.startContainer!==b||a.startOffset!=e,c=a.endContainer!==d||a.endOffset!=h,f=!a.equals(a.nativeRange);if(g||c||f)a.setEnd(d,h),a.setStart(b,e)});g=e.prototype;g.selectNode=function(a){this.nativeRange.selectNode(a);d(this)};g.cloneContents=function(){return this.nativeRange.cloneContents()};g.surroundContents=
function(a){this.nativeRange.surroundContents(a);d(this)};g.collapse=function(a){this.nativeRange.collapse(a);d(this)};g.cloneRange=function(){return new e(this.nativeRange.cloneRange())};g.refresh=function(){d(this)};g.toString=function(){return this.nativeRange.toString()};var n=document.createTextNode("test");t(document).appendChild(n);var w=document.createRange();w.setStart(n,0);w.setEnd(n,0);try{w.setStart(n,1),g.setStart=function(a,b){this.nativeRange.setStart(a,b);d(this)},g.setEnd=function(a,
b){this.nativeRange.setEnd(a,b);d(this)},m=function(a){return function(b){this.nativeRange[a](b);d(this)}}}catch(l){g.setStart=function(a,b){try{this.nativeRange.setStart(a,b)}catch(e){this.nativeRange.setEnd(a,b),this.nativeRange.setStart(a,b)}d(this)},g.setEnd=function(a,b){try{this.nativeRange.setEnd(a,b)}catch(e){this.nativeRange.setStart(a,b),this.nativeRange.setEnd(a,b)}d(this)},m=function(a,b){return function(e){try{this.nativeRange[a](e)}catch(h){this.nativeRange[b](e),this.nativeRange[a](e)}d(this)}}}g.setStartBefore=
m("setStartBefore","setEndBefore");g.setStartAfter=m("setStartAfter","setEndAfter");g.setEndBefore=m("setEndBefore","setStartBefore");g.setEndAfter=m("setEndAfter","setStartAfter");g.selectNodeContents=function(a){this.setStartAndEnd(a,0,h.getNodeLength(a))};w.selectNodeContents(n);w.setEnd(n,3);m=document.createRange();m.selectNodeContents(n);m.setEnd(n,4);m.setStart(n,2);-1==w.compareBoundaryPoints(w.START_TO_END,m)&&1==w.compareBoundaryPoints(w.END_TO_START,m)?g.compareBoundaryPoints=function(a,
b){b=b.nativeRange||b;a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END);return this.nativeRange.compareBoundaryPoints(a,b)}:g.compareBoundaryPoints=function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};m=document.createElement("div");m.innerHTML="123";var D=m.firstChild,q=t(document);q.appendChild(m);w.setStart(D,1);w.setEnd(D,2);w.deleteContents();"13"==D.data&&(g.deleteContents=function(){this.nativeRange.deleteContents();d(this)},g.extractContents=
function(){var a=this.nativeRange.extractContents();d(this);return a});q.removeChild(m);q=null;c.isHostMethod(w,"createContextualFragment")&&(g.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)});t(document).removeChild(n);g.getName=function(){return"WrappedRange"};a.WrappedRange=e;a.createNativeRange=function(a){a=z(a,b,"createNativeRange");return a.createRange()}}();if(a.features.implementsTextRange){var m=function(a,b,e,d,c){var f=a.duplicate();f.collapse(e);
var t=f.parentElement();h.isOrIsAncestorOf(b,t)||(t=b);if(!t.canHaveHTML)return t=new g(t.parentNode,h.getNodeIndex(t)),{boundaryPosition:t,nodeInfo:{nodeIndex:t.offset,containerElement:t.node}};b=h.getDocument(t).createElement("span");b.parentNode&&b.parentNode.removeChild(b);var z,m=e?"StartToStart":"StartToEnd",n=c&&c.containerElement==t?c.nodeIndex:0,w=t.childNodes.length,l=w;for(c=l;;){c==w?t.appendChild(b):t.insertBefore(b,t.childNodes[c]);f.moveToElementText(b);z=f.compareEndPoints(m,a);if(0==
z||n==l)break;else if(-1==z)if(l==n+1)break;else n=c;else l=l==n+1?n:c;c=Math.floor((n+l)/2);t.removeChild(b)}m=b.nextSibling;if(-1==z&&m&&k(m)){f.setEndPoint(e?"EndToStart":"EndToEnd",a);if(/[\r\n]/.test(m.data))for(e=f.duplicate(),d=e.text.replace(/\r\n/g,"\r").length,d=e.moveStart("character",d);-1==e.compareEndPoints("StartToEnd",e);)d++,e.moveStart("character",1);else d=f.text.length;e=new g(m,d)}else a=(d||!e)&&b.previousSibling,e=(e=(d||e)&&b.nextSibling)&&k(e)?new g(e,0):a&&k(a)?new g(a,a.data.length):
new g(t,h.getNodeIndex(b));b.parentNode.removeChild(b);return{boundaryPosition:e,nodeInfo:{nodeIndex:c,containerElement:t}}},n=function(a,b){var e,d,g=a.offset,c=h.getDocument(a.node),f=t(c).createTextRange(),z=k(a.node);z?(e=a.node,d=e.parentNode):(e=a.node.childNodes,e=g<e.length?e[g]:null,d=a.node);c=c.createElement("span");c.innerHTML="\x26#feff;";e?d.insertBefore(c,e):d.appendChild(c);f.moveToElementText(c);f.collapse(!b);d.removeChild(c);if(z)f[b?"moveStart":"moveEnd"]("character",g);return f};
d=function(a){this.textRange=a;this.refresh()};d.prototype=new f(document);d.prototype.refresh=function(){var a,b,e;e=this.textRange;a=e.parentElement();var d=e.duplicate();d.collapse(!0);b=d.parentElement();d=e.duplicate();d.collapse(!1);e=d.parentElement();b=b==e?b:h.getCommonAncestor(b,e);b=b==a?b:h.getCommonAncestor(a,b);a=this.textRange;0==a.compareEndPoints("StartToEnd",a)?b=a=m(this.textRange,b,!0,!0).boundaryPosition:(e=m(this.textRange,b,!0,!1),a=e.boundaryPosition,b=m(this.textRange,b,!1,
!1,e.nodeInfo).boundaryPosition);this.setStart(a.node,a.offset);this.setEnd(b.node,b.offset)};d.prototype.getName=function(){return"WrappedTextRange"};f.copyComparisonConstants(d);d.rangeToTextRange=function(a){if(a.collapsed)return n(new g(a.startContainer,a.startOffset),!0);var b=n(new g(a.startContainer,a.startOffset),!0),e=n(new g(a.endContainer,a.endOffset),!1);a=t(f.getRangeDocument(a)).createTextRange();a.setEndPoint("StartToStart",b);a.setEndPoint("EndToEnd",e);return a};a.WrappedTextRange=
d;if(!a.features.implementsDomRange||a.config.preferTextRange){var w=function(){return this}();"undefined"==typeof w.Range&&(w.Range=d);a.createNativeRange=function(a){a=z(a,b,"createNativeRange");return t(a).createTextRange()};a.WrappedRange=d}}a.createRange=function(e){e=z(e,b,"createRange");return new a.WrappedRange(a.createNativeRange(e))};a.createRangyRange=function(a){a=z(a,b,"createRangyRange");return new f(a)};a.createIframeRange=function(e){b.deprecationNotice("createIframeRange()","createRange(iframeEl)");
return a.createRange(e)};a.createIframeRangyRange=function(e){b.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)");return a.createRangyRange(e)};a.addCreateMissingNativeApiListener(function(b){var e=b.document;"undefined"==typeof e.createRange&&(e.createRange=function(){return a.createRange(e)});e=b=null})}),f.rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(a,b){function e(a){return"string"==typeof a?/^backward(s)?$/i.test(a):!!a}function d(a,
e){if(a){if(F.isWindow(a))return a;if(a instanceof l)return a.win;var h=F.getContentDocument(a,b,e);return F.getWindow(h)}return window}function h(a){return d(a,"getWinSelection").getSelection()}function c(a){return d(a,"getDocSelection").document.selection}function g(a){var b=!1;a.anchorNode&&(b=1==F.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset));return b}function f(a,b,e){var d=e?"end":"start";e=e?"start":"end";a.anchorNode=b[d+"Container"];a.anchorOffset=b[d+"Offset"];a.focusNode=
b[e+"Container"];a.focusOffset=b[e+"Offset"]}function t(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function z(b){var e;b instanceof N?(e=a.createNativeRange(b.getDocument()),e.setEnd(b.endContainer,b.endOffset),e.setStart(b.startContainer,b.startOffset)):b instanceof C?e=b.nativeRange:J.implementsDomRange&&b instanceof F.getWindow(b.startContainer).Range&&(e=b);return e}function k(a){var e=a.getNodes(),d;a:if(e.length&&1==e[0].nodeType){d=
1;for(var h=e.length;d<h;++d)if(!F.isAncestorOf(e[0],e[d])){d=!1;break a}d=!0}else d=!1;if(!d)throw b.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return e[0]}function m(a,b){var e=new C(b);a._ranges=[e];f(a,e,!1);a.rangeCount=1;a.isCollapsed=e.collapsed}function n(b){b._ranges.length=0;if("None"==b.docSelection.type)t(b);else{var e=b.docSelection.createRange();if(e&&"undefined"!=typeof e.text)m(b,e);else{b.rangeCount=e.length;for(var d,h=M(e.item(0)),
c=0;c<b.rangeCount;++c)d=a.createRange(h),d.selectNode(e.item(c)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed;f(b,b._ranges[b.rangeCount-1],!1)}}}function w(a,e){for(var d=a.docSelection.createRange(),h=k(e),c=M(d.item(0)),c=R(c).createControlRange(),g=0,f=d.length;g<f;++g)c.add(d.item(g));try{c.add(h)}catch(t){throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");}c.select();n(a)}function l(a,
b,e){this.nativeSelection=a;this.docSelection=b;this._ranges=[];this.win=e;this.refresh()}function D(a){a.win=a.anchorNode=a.focusNode=a._ranges=null;a.rangeCount=a.anchorOffset=a.focusOffset=0;a.detached=!0}function q(a,b){for(var e=O.length,d,h;e--;)if(d=O[e],h=d.selection,"deleteAll"==b)D(h);else if(d.win==a)return"delete"==b?(O.splice(e,1),!0):h;"deleteAll"==b&&(O.length=0);return null}function H(a,e){for(var d=M(e[0].startContainer),d=R(d).createControlRange(),h=0,c,g=e.length;h<g;++h){c=k(e[h]);
try{d.add(c)}catch(f){throw b.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)");}}d.select();n(a)}function v(a,b){if(a.win.document!=M(b))throw new P("WRONG_DOCUMENT_ERR");}function A(b){return function(e,d){var h;this.rangeCount?(h=this.getRangeAt(0),h["set"+(b?"Start":"End")](e,d)):(h=a.createRange(this.win.document),h.setStartAndEnd(e,d));this.setSingleRange(h,this.isBackward())}}function p(a){var b=[],e=new E(a.anchorNode,
a.anchorOffset),d=new E(a.focusNode,a.focusOffset),h="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var c=0,g=a.rangeCount;c<g;++c)b[c]=N.inspect(a.getRangeAt(c));return"["+h+"(Ranges: "+b.join(", ")+")(anchor: "+e.inspect()+", focus: "+d.inspect()+"]"}a.config.checkSelectionRanges=!0;var F=a.dom,x=a.util,B=x.isHostMethod,N=a.DomRange,C=a.WrappedRange,P=a.DOMException,E=F.DomPosition,da,ea,J=a.features,M=F.getDocument,R=F.getBody,S=N.rangesEqual,y=B(window,
"getSelection"),T=x.isHostObject(document,"selection");J.implementsWinGetSelection=y;var U=(J.implementsDocSelection=T)&&(!y||a.config.preferTextRange);U?(da=c,a.isSelectionValid=function(a){a=d(a,"isSelectionValid").document;var b=a.selection;return"None"!=b.type||M(b.createRange().parentElement())==a}):y?(da=h,a.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected.");a.getNativeSelection=da;var y=da(),I=a.createNativeRange(document),r=R(document),
K=x.areHostProperties(y,["anchorNode","focusNode","anchorOffset","focusOffset"]);J.selectionHasAnchorAndFocus=K;var Q=B(y,"extend");J.selectionHasExtend=Q;var X="number"==typeof y.rangeCount;J.selectionHasRangeCount=X;var G=!1,aa=!0,V=Q?function(b,e){var d=N.getRangeDocument(e),d=a.createRange(d);d.collapseToPoint(e.endContainer,e.endOffset);b.addRange(z(d));b.extend(e.startContainer,e.startOffset)}:null;x.areHostMethods(y,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof y.rangeCount&&
J.implementsDomRange&&function(){var b=window.getSelection();if(b){for(var e=b.rangeCount,d=1<e,h=[],c=g(b),f=0;f<e;++f)h[f]=b.getRangeAt(f);var f=R(document),t=f.appendChild(document.createElement("div"));t.contentEditable="false";var z=t.appendChild(document.createTextNode("   ")),k=document.createRange();k.setStart(z,1);k.collapse(!0);b.addRange(k);aa=1==b.rangeCount;b.removeAllRanges();d||(d=k.cloneRange(),k.setStart(z,0),d.setEnd(z,3),d.setStart(z,2),b.addRange(k),b.addRange(d),G=2==b.rangeCount,
d.detach());f.removeChild(t);b.removeAllRanges();for(f=0;f<e;++f)0==f&&c?V?V(b,h[f]):(a.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),b.addRange(h[f])):b.addRange(h[f])}}();J.selectionSupportsMultipleRanges=G;J.collapsedNonEditableSelectionsSupported=aa;var L=!1;r&&B(r,"createControlRange")&&(r=r.createControlRange(),x.areHostProperties(r,["item","add"])&&(L=!0));J.implementsControlRange=
L;ea=K?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var W;B(y,"getRangeAt")?W=function(a,b){try{return a.getRangeAt(b)}catch(e){return null}}:K&&(W=function(b){var e=M(b.anchorNode),e=a.createRange(e);e.setStartAndEnd(b.anchorNode,b.anchorOffset,b.focusNode,b.focusOffset);e.collapsed!==this.isCollapsed&&e.setStartAndEnd(b.focusNode,b.focusOffset,b.anchorNode,b.anchorOffset);return e});l.prototype=
a.selectionPrototype;var O=[],ba=function(a){if(a&&a instanceof l)return a.refresh(),a;a=d(a,"getNativeSelection");var b=q(a),e=da(a),h=T?c(a):null;b?(b.nativeSelection=e,b.docSelection=h,b.refresh()):(b=new l(e,h,a),O.push({win:a,selection:b}));return b};a.getSelection=ba;a.getIframeSelection=function(e){b.deprecationNotice("getIframeSelection()","getSelection(iframeEl)");return a.getSelection(F.getIframeWindow(e))};r=l.prototype;if(!U&&K&&x.areHostMethods(y,["removeAllRanges","addRange"]))r.removeAllRanges=
function(){this.nativeSelection.removeAllRanges();t(this)},r.addRange=X?function(b,d){if(L&&T&&"Control"==this.docSelection.type)w(this,b);else if(e(d)&&Q)V(this.nativeSelection,b),this.refresh();else{var h;G?h=this.rangeCount:(this.removeAllRanges(),h=0);this.nativeSelection.addRange(z(b).cloneRange());this.rangeCount=this.nativeSelection.rangeCount;this.rangeCount==h+1?(a.config.checkSelectionRanges&&(h=W(this.nativeSelection,this.rangeCount-1))&&!S(h,b)&&(b=new C(h)),this._ranges[this.rangeCount-
1]=b,f(this,b,Z(this.nativeSelection)),this.isCollapsed=ea(this)):this.refresh()}}:function(a,b){e(b)&&Q?V(this.nativeSelection,a):this.nativeSelection.addRange(z(a));this.refresh()},r.setRanges=function(a){if(L&&1<a.length)H(this,a);else{this.removeAllRanges();for(var b=0,e=a.length;b<e;++b)this.addRange(a[b])}};else if(B(y,"empty")&&B(I,"select")&&L&&U)r.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=M(this.anchorNode);else if("Control"==
this.docSelection.type){var b=this.docSelection.createRange();b.length&&(a=M(b.item(0)))}a&&(R(a).createTextRange().select(),this.docSelection.empty())}}catch(e){}t(this)},r.addRange=function(b){"Control"==this.docSelection.type?w(this,b):(a.WrappedTextRange.rangeToTextRange(b).select(),this._ranges[0]=b,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,f(this,b,!1))},r.setRanges=function(a){this.removeAllRanges();var b=a.length;1<b?H(this,a):b&&this.addRange(a[0])};else return b.fail("No means of selecting a Range or TextRange was found"),
!1;r.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new P("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var Y;if(U)Y=function(b){var e;a.isSelectionValid(b.win)?e=b.docSelection.createRange():(e=R(b.win.document).createTextRange(),e.collapse(!0));"Control"==b.docSelection.type?n(b):e&&"undefined"!=typeof e.text?m(b,e):t(b)};else if(B(y,"getRangeAt")&&"number"==typeof y.rangeCount)Y=function(b){if(L&&T&&"Control"==b.docSelection.type)n(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,
b.rangeCount){for(var e=0,d=b.rangeCount;e<d;++e)b._ranges[e]=new a.WrappedRange(b.nativeSelection.getRangeAt(e));f(b,b._ranges[b.rangeCount-1],Z(b.nativeSelection));b.isCollapsed=ea(b)}else t(b)};else if(K&&"boolean"==typeof y.isCollapsed&&"boolean"==typeof I.collapsed&&J.implementsDomRange)Y=function(a){var b;b=a.nativeSelection;b.anchorNode?(b=W(b,0),a._ranges=[b],a.rangeCount=1,b=a.nativeSelection,a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset,
a.isCollapsed=ea(a)):t(a)};else return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;r.refresh=function(a){var b=a?this._ranges.slice(0):null,e=this.anchorNode,d=this.anchorOffset;Y(this);if(a){a=b.length;if(a!=this._ranges.length||this.anchorNode!=e||this.anchorOffset!=d)return!0;for(;a--;)if(!S(b[a],this._ranges[a]))return!0;return!1}};var ca=function(a,b){var e=a.getAllRanges();a.removeAllRanges();for(var d=0,h=e.length;d<h;++d)S(b,e[d])||a.addRange(e[d]);
a.rangeCount||t(a)};r.removeRange=L?function(a){if("Control"==this.docSelection.type){var b=this.docSelection.createRange();a=k(a);for(var e=M(b.item(0)),e=R(e).createControlRange(),d,h=!1,c=0,g=b.length;c<g;++c)d=b.item(c),d!==a||h?e.add(b.item(c)):h=!0;e.select();n(this)}else ca(this,a)}:function(a){ca(this,a)};var Z;!U&&K&&J.implementsDomRange?(Z=g,r.isBackward=function(){return Z(this)}):Z=r.isBackward=function(){return!1};r.isBackwards=r.isBackward;r.toString=function(){for(var a=[],b=0,e=this.rangeCount;b<
e;++b)a[b]=""+this._ranges[b];return a.join("")};r.collapse=function(b,e){v(this,b);var d=a.createRange(b);d.collapseToPoint(b,e);this.setSingleRange(d);this.isCollapsed=!0};r.collapseToStart=function(){if(this.rangeCount){var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new P("INVALID_STATE_ERR");};r.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)}else throw new P("INVALID_STATE_ERR");};r.selectAllChildren=
function(b){v(this,b);var e=a.createRange(b);e.selectNodeContents(b);this.setSingleRange(e)};r.deleteFromDocument=function(){if(L&&T&&"Control"==this.docSelection.type){for(var a=this.docSelection.createRange(),b;a.length;)b=a.item(0),a.remove(b),b.parentNode.removeChild(b);this.refresh()}else if(this.rangeCount&&(a=this.getAllRanges(),a.length)){this.removeAllRanges();b=0;for(var e=a.length;b<e;++b)a[b].deleteContents();this.addRange(a[e-1])}};r.eachRange=function(a,b){for(var e=0,d=this._ranges.length;e<
d;++e)if(a(this.getRangeAt(e)))return b};r.getAllRanges=function(){var a=[];this.eachRange(function(b){a.push(b)});return a};r.setSingleRange=function(a,b){this.removeAllRanges();this.addRange(a,b)};r.callMethodOnEachRange=function(a,b){var e=[];this.eachRange(function(d){e.push(d[a].apply(d,b))});return e};r.setStart=A(!0);r.setEnd=A(!1);a.rangePrototype.select=function(a){ba(this.getDocument()).setSingleRange(this,a)};r.changeEachRange=function(a){var b=[],e=this.isBackward();this.eachRange(function(e){a(e);
b.push(e)});this.removeAllRanges();e&&1==b.length?this.addRange(b[0],"backward"):this.setRanges(b)};r.containsNode=function(a,b){return this.eachRange(function(e){return e.containsNode(a,b)},!0)};r.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}};r.moveToBookmark=function(b){for(var e=[],d=0,h,c;h=b.rangeBookmarks[d++];)c=a.createRange(this.win),c.moveToBookmark(h),e.push(c);b.backward?this.setSingleRange(e[0],"backward"):this.setRanges(e)};
r.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")};r.getName=function(){return"WrappedSelection"};r.inspect=function(){return p(this)};r.detach=function(){q(this.win,"delete");D(this)};l.detachAll=function(){q(null,"deleteAll")};l.inspect=p;l.isDirectionBackward=e;a.Selection=l;a.selectionPrototype=r;a.addCreateMissingNativeApiListener(function(a){"undefined"==typeof a.getSelection&&(a.getSelection=function(){return ba(a)});a=null})}))})(this.ice||window.ice);
(function(f,l){function x(a){return a}function v(a){var b=l.map(a.attributes,function(a){return a.name});l(a).removeClass();l.each(b,function(b,e){a.removeAttribute(e)})}function p(a){return"br"==f.dom.getTagName(a)}function n(a){a=f.dom.getTagName(a);return"br"===a||"p"===a}function c(a,b,d){var h=a.length;if(0>b||b>=h)return a;b+d>=h&&(d=h-b);if(d===h)return a;a=0<b?a.splitText(b):a;a.length>d&&a.splitText(d);return a}function q(a,b,d,h){h?b.collapsed&&b.startContainer&&b.startContainer.nodeType===
f.dom.TEXT_NODE&&b.startContainer.length||(d=d.createTextNode("﻿"),a?a.appendChild(d):b.insertNode(d),b.selectNode(d)):a&&b.selectNodeContents(a)}var A=f.rangy,B,E,b=[{start:0,end:31},{start:33,end:40},{start:45,end:45},{start:91,end:93},{start:112,end:123},{start:144,end:145}];B={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",sessionId:"data-session-id",time:"data-time",lastTime:"data-last-change-time",changeData:"data-changedata"},attrValuePrefix:"",blockEl:"p",blockEls:"div p ol ul li h1 h2 h3 h4 h5 h6 blockquote".split(" "),
stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"ins",alias:"ins",action:"Inserted"},deleteType:{tag:"del",alias:"del",action:"Deleted"}},contentEditable:void 0,_isTracking:!0,tooltips:!1,tooltipsDelay:1,_isVisible:!0,_changeData:null,_handleSelectAll:!1,_sessionId:null};E=function(a){a||(a={});if(!a.element)throw Error("options.element must be defined for ice construction.");this._changes={};this._userStyles={};this.currentUser={name:"",id:""};this._styles={};this._savedNodesMap=
{};this.$this=l(this);this._browser=f.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);f.dom.extend(!0,this,B,a);if(a.tooltips&&(!l.isFunction(a.hostMethods.showTooltip)||!l.isFunction(a.hostMethods.hideTooltip)))throw Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true");var b=a.userStyles||{},d;for(d in b)if(b.hasOwnProperty(d)){var h=b[d];isNaN(h)||(this._userStyles[d]=this.stylePrefix+
"-"+h,this._uniqueStyleIndex=Math.max(h,this._uniqueStyleIndex),this._styles[h]=!0)}k=a.hostMethods.logError||function(){};this._insertSelector="."+this._getIceNodeClass("insertType");this._deleteSelector="."+this._getIceNodeClass("deleteType");this._iceSelector=this._insertSelector+","+this._deleteSelector};E.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(a){"boolean"==typeof this.contentEditable&&
this.element.setAttribute("contentEditable",this.contentEditable);this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(a){this._isTracking=!1;try{this.element&&this.unlistenToEvents(),a||"undefined"===typeof this.contentEditable||this.element.setAttribute("contentEditable",!this.contentEditable)}catch(b){k(b,"While trying to stop tracking")}this._updateTooltipsState();return this},listenToEvents:function(){this.element&&
!this._boundEventHandler&&(this.unlistenToEvents(),this._boundEventHandler=this.handleEvent.bind(this),this.element.addEventListener("keydown",this._boundEventHandler,!0))},unlistenToEvents:function(){this.element&&this._boundEventHandler&&this.element.removeEventListener("keydown",this._boundEventHandler,!0);this._boundEventHandler=null},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||
this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new f.Selection(this.env)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=!0},disableChangeTracking:function(){this._isTracking=!1},toggleChangeTracking:function(a){this._isTracking=a=void 0===a?!this._isTracking:Boolean(a)},getCurrentUser:function(){var a=
this.currentUser||{};return{name:a.name||"",id:null===a.id||void 0===a.id?"":String(a.id)}},setCurrentUser:function(a){var b={};a=a||{};b.name=a.name?String(a.name):"";b.id=void 0!==a.id&&null!==a.id?String(a.id):"";this.currentUser=b;for(var d in this._changes)a=this._changes[d],a.userid==b.id&&(a.username=b.name);d=this.getIceNodes();var h,c=this.attributes.userId;d.each(function(a,d){h=d.getAttribute(c);null!==h&&h!==b.id||d.setAttribute(this.attributes.userName,b.name)}.bind(this))},setSessionId:function(a){this._sessionId=
a},toggleTooltips:function(a){this.tooltips=a=void 0===a?!this.tooltips:Boolean(a);this._updateTooltipsState()},visible:function(a){a.nodeType===f.dom.TEXT_NODE&&(a=a.parentNode);a=a.getBoundingClientRect();return 0<a.top&&0<a.left},_createIceNode:function(a,b,d){var h=this.env.document.createElement(this.changeTypes[a].tag);h.setAttribute("class",this._getIceNodeClass(a));b&&h.appendChild(b);this._addChange(a,[h],d);return h},insert:function(a){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();
var b=this.getCurrentRange(),d=(b=this._isRangeInElement(b,this.element))?null:this.hostMethods.getHostRange(),h=this._startBatchChange(),c=Boolean(b&&!b.collapsed),g=!1;a=a||{};try{if(c&&(this._deleteContents(!1,b),b=this.getCurrentRange()),b||d){var f=a.nodes;f&&!l.isArray(f)&&(f=[f]);this._moveRangeToValidTrackingPos(b,d);g=this._insertNodes(b,d,{nodes:f,text:a.text,insertStubText:!1!==a.insertStubText})}}catch(n){k(n,"while trying to insert nodes")}finally{this._endBatchChange(h,f||a.text||!g)}return g},
_deleteContents:function(a,b){var d=!0,h=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete();b?this.selection.addRange(b):b=this.getCurrentRange();var c=this._startBatchChange();try{if(!1===b.collapsed)(b=this._deleteSelection(b))&&!this.visible(b.endContainer)&&(b.setEnd(b.endContainer,Math.max(0,b.endOffset-1)),b.collapse(!1));else{this._cleanupSelection(b,!1,!0);if(this._isCurrentUserIceNode(this._getIceNode(b.startContainer,"insertType")))return!1;if(a)if("mozilla"===
h.type)d=this._deleteRight(b),this.visible(b.endContainer)||(b.endContainer.parentNode.nextSibling?b.setEndBefore(b.endContainer.parentNode.nextSibling):b.setEndAfter(b.endContainer),b.collapse(!1));else{if(b.endOffset===f.dom.getNodeCharacterLength(b.endContainer)){var g=b.startContainer.nextSibling;if(f.dom.is(g,this._deleteSelector))for(;g;)if(f.dom.is(g,this._deleteSelector))g=g.nextSibling;else{b.setStart(g,0);b.collapse(!0);break}}d=this._deleteRight(b);!this.visible(b.endContainer)&&f.dom.is(b.endContainer.parentNode,
this._iceSelector)&&(b.setStartAfter(b.endContainer.parentNode),b.collapse(!0))}else if(h.mozilla)d=this._deleteLeft(b),this.visible(b.startContainer)||(b.startContainer.parentNode.previousSibling?b.setEnd(b.startContainer.parentNode.previousSibling,0):b.setEnd(b.startContainer.parentNode,0),b.moveEnd(f.dom.CHARACTER_UNIT,f.dom.getNodeCharacterLength(b.endContainer)),b.collapse(!1));else{if(!this.visible(b.startContainer)&&b.endOffset===f.dom.getNodeCharacterLength(b.endContainer)){var k=b.startContainer.previousSibling;
if(f.dom.is(k,this._deleteSelector))for(;k;)if(f.dom.is(k,this._deleteSelector))k=k.prevSibling;else{b.setEndBefore(k.nextSibling,0);b.collapse(!1);break}}d=this._deleteLeft(b)}}b&&this.selection.addRange(b)}finally{this._endBatchChange(c,d)}return d},getChanges:function(a){a=a?this._filterChanges(a):this._changes;return l.extend({},a)},getChangeUserids:function(){var a=this,b=Object.keys(this._changes);return b.map(function(d){return a._changes[b[d]].userid}).sort().filter(function(a,b,e){return b===
e.indexOf(a)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b,d){return(a=this.getCleanDOM(a,{callback:b,prepare:d,clone:!0}))&&a.innerHTML||""},getCleanDOM:function(a,b){var d="",h=this;b=b||{};f.dom.each(this.changeTypes,function(a,b){"deleteType"!==a&&(0<b&&(d+=","),d+="."+h._getIceNodeClass(a))});a?"string"===typeof a?a=f.dom.create("\x3cdiv\x3e"+a+"\x3c/div\x3e"):b.clone&&(a=f.dom.cloneNode(a,!1)[0]):a=b.clone?f.dom.cloneNode(this.element,!1)[0]:
this.element;return this._cleanBody(a,d,b)},_cleanBody:function(a,b,d){a=d.prepare?d.prepare.call(this,a):a;b=f.dom.find(a,b);f.dom.each(b,function(a,b){for(;b.firstChild;)b.parentNode.insertBefore(b.firstChild,b);b.parentNode.removeChild(b)});b=f.dom.find(a,this._deleteSelector);f.dom.remove(b);return a=d.callback?d.callback.call(this,a):a},acceptAll:function(a){if(a)return this._acceptRejectSome(a,!0);this.getCleanDOM(this.element,{clone:!1});this._changes={};this._triggerChange({isText:!0})},rejectAll:function(a){if(a)return this._acceptRejectSome(a,
!1);a=this._deleteSelector;var b,d=this;f.dom.find(this.element,this._insertSelector).each(function(a,b){d._removeNode(b)});f.dom.each(f.dom.find(this.element,a),function(a,c){b=f.dom.contents(c);f.dom.replaceWith(c,b);l.each(b,function(a,b){d._normalizeNode(b&&b.parentNode)})});this._changes={};this._triggerChange({isText:!0})},acceptChange:function(a){this.acceptRejectChange(a,{isAccept:!0})},rejectChange:function(a){this.acceptRejectChange(a,{isAccept:!1})},acceptRejectChange:function(a,b){var d,
h,c,g,k,w=f.dom,m=this,q,F,A=this._userStyles,p,x=this.attributes.userId,B=this._getIceNodeClass("deleteType"),E=this._getIceNodeClass("insertType");k=b&&b.isAccept;var la=b&&!1===b.notify;if(!a){g=this.getCurrentRange();if(!g||!g.collapsed)return;a=g.startContainer}d=c="."+B;h=g="."+E;k||(c=h,g=d);k=w.getNode(a,d+","+h);k=w.attr(k,this.attributes.changeId);c=w.find(this.element,c+"["+this.attributes.changeId+"\x3d"+k+"]");d=c.length;c.each(function(a,b){m._removeNode(b)});c=w.find(this.element,g+
"["+this.attributes.changeId+"\x3d"+k+"]");d+=c.length;w.each(c,function(a,b){if(n(b))return v(b);p=b.getAttribute(x);F=null!==p?A[p]||"":"";q=f.dom.contents(b);l(b).removeClass(E+" "+B+" "+F);w.replaceWith(b,q);l.each(q,function(a,b){var e=f.dom.TEXT_NODE==b.nodeType&&b.nodeValue;if(e){for(var d=!1;0<=e.indexOf("  ");)d=!0,e=e.replace("  ","  ");d&&(b.nodeValue=e)}m._normalizeNode(b&&b.parentNode)})});delete this._changes[k];0<d&&!la&&this._triggerChange({isText:!0})},isInsideChange:function(a,b,
d){try{return Boolean(this.currentChangeNode(a,b,d))}catch(h){return k(h,"While testing if isInsideChange"),!1}},getIceNodes:function(){var a=[],b=this;f.dom.each(this.changeTypes,function(d){a.push("."+b._getIceNodeClass(d))});a=a.join(",");return l(this.element).find(a)},_getIceNode:function(a,b){var d=this.changeTypes[b].tag+"."+this._getIceNodeClass(b);return f.dom.getNode(a&&a.$||a,d)},_isNodeOfChangeType:function(a,b){if(!a)return!1;var d="."+this._getIceNodeClass(b);return f.dom.is(a.$||a,
d)},_isInsertNode:function(a){return this._isNodeOfChangeType(a,"insertType")},_isDeleteNode:function(a){return this._isNodeOfChangeType(a,"deleteType")},_normalizeNode:function(a){return f.dom.normalizeNode(a,this._browser.msie)},_moveRangeToValidTrackingPos:function(a,b){if(a=b||a)for(var d,h,c=-1,g,n=[],w=b?this.hostMethods.getHostNode:x,m=!1;!m;){h=a.startContainer;if(!h||0<=n.indexOf(h))break;g=w(h);n.push(h);if(d=this._getVoidElement(g)){if(d!==h&&0<=n.indexOf(d))break;n.push(d)}else m=f.dom.isTextContainer(g);
if(!m){if(-1==c){c=w(a.startContainer);h=a.startOffset;if(c)var l=c.nodeType,c=f.dom.TEXT_NODE==l?h&&c.nodeValue&&h>=c.nodeValue.length-1:f.dom.ELEMENT_NODE==l?c.childNodes&&c.childNodes.length&&h>=c.childNodes.length:!1;else c=!1;c=!c}d=c?f.dom.findPrevTextContainer(d||g,this.element):f.dom.findNextTextContainer(d||g,this.element);g=d.node;b&&(g=this.hostMethods.makeHostElement(g));try{c?a.setStart(g,d.offset):a.setEnd(g,d.offset),a.collapse(c)}catch(q){k(q,"While trying to move range to valid tracking position");
break}}}},_isRangeInElement:function(a,b){for(var d=a&&a.startContainer;d;){if(d==b)return a;d=d.parentNode}return null},_getVoidElement:function(a){try{var b=this._getIceNode(a,"deleteType");return b||3!=a.nodeType||"​"!=a.nodeValue?b:a}catch(d){return k(d,"While trying to get void element of",a),null}},_cleanupSelection:function(a,b,d){var h;if(a&&a.collapsed&&(h=a.startContainer))return b&&(h=this.hostMethods.getHostNode(h)),f.dom.TEXT_NODE==h.nodeType?this._cleanupTextSelection(a,h,b,d):this._cleanupElementSelection(a,
b)},_cleanupTextSelection:function(a,b,d,h){this._cleanupAroundNode(b);if(h&&f.dom.isEmptyTextNode(b)){h=b.parentNode;var c=f.dom.getNodeIndex(b);d=d?this.hostMethods.makeHostElement:x;h.removeChild(b);c=Math.max(0,c);a.setStart(d(h),c);a.setEnd(d(h),c)}},_cleanupElementSelection:function(a,b){var d,h=!1,c=b?this.hostMethods.getHostNode(a.startContainer):a.startContainer,g=c.childNodes.length;if(!(1>g)){try{if(0<a.startOffset?d=c.childNodes[a.startOffset-1]:(d=c.firstChild,h=!0),!d)return}catch(k){return}this._cleanupAroundNode(d,
h);0!==a.startOffset&&(h=f.dom.getNodeIndex(d)+1,f.dom.isEmptyTextNode(d)&&(h=Math.max(0,h-1),c.removeChild(d)),c.childNodes.length!==g&&(d=b?this.hostMethods.makeHostElement:x,a.setStart(d(c),h),a.setEnd(d(c),h)))}},_cleanupAroundNode:function(a,b){for(var d=a.parentNode,h=a.nextSibling,c;h;)(c=f.dom.is(h,this._iceSelector)&&f.dom.hasNoTextOrStubContent(h)||f.dom.isEmptyTextNode(h))?(c=h,h=h.nextSibling,d.removeChild(c)):h=h.nextSibling;for(h=a.previousSibling;h;)(c=f.dom.is(h,this._iceSelector)&&
f.dom.hasNoTextOrStubContent(h)||f.dom.isEmptyTextNode(h))?(c=h,h=h.previousSibling,d.removeChild(c)):h=h.previousSibling;b&&f.dom.isEmptyTextNode(a)&&d.removeChild(a)},_isCurrentUserIceNode:function(a){var b=Boolean(a&&f.dom.attr(a,this.attributes.userId)===this.currentUser.id);b&&this._sessionId&&(b=f.dom.attr(a,this.attributes.sessionId)===this._sessionId);return b},_getChangeTypeFromAlias:function(a){var b,d=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==
a&&(d=b);return d},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},_getUserStyle:function(a){if(null===a||""===a||"undefined"==typeof a)return this.stylePrefix;var b=null;return b=this._userStyles[a]?this._userStyles[a]:this._setUserStyle(a,this._getNewStyleId())},_setUserStyle:function(a,b){var d=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=d},_getNewStyleId:function(){var a=++this._uniqueStyleIndex;if(this._styles[a])return this._getNewStyleId();
this._styles[a]=!0;return a},_addChange:function(a,b,d){var h=d||this._batchChangeId||this.getNewChangeId(),c=this;this._changes[h]||(d=(new Date).getTime(),this._changes[h]={type:a,time:d,lastTime:d,sessionId:this._sessionId,userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""},this._triggerChange({text:!1}));f.dom.foreach(b,function(a){c._addNodeToChange(h,b[a])});return h},_addNodeToChange:function(a,b){var d=this.getChange(a),h={};b.getAttribute(this.attributes.changeId)||
(h[this.attributes.changeId]=a);var c=b.getAttribute(this.attributes.userId);c||(c=d.userid,h[this.attributes.userId]=c);c==d.userid&&(h[this.attributes.userName]=d.username);null===b.getAttribute(this.attributes.changeData)&&(h[this.attributes.changeData]=this._changeData||"");b.getAttribute(this.attributes.time)||(h[this.attributes.time]=d.time);b.getAttribute(this.attributes.lastTime)||(h[this.attributes.lastTime]=d.lastTime);d.sessionId&&!b.getAttribute(this.attributes.sessionId)&&(h[this.attributes.sessionId]=
d.sessionId);d.style||(d.style=this._getUserStyle(d.userid));l(b).attr(h).addClass(d.style);this._updateNodeTooltip(b)},getChange:function(a){return this._changes[a]||null},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},_startBatchChange:function(){return this._batchChangeId?null:this._batchChangeId=this.getNewChangeId()},getContentElement:function(){return this.element},_endBatchChange:function(a,b){a&&a===this._batchChangeId&&(this._batchChangeId=
null,b&&this._triggerChange({isText:!0}))},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(a){return k(a,"While trying to get current range"),null}},_insertNodes:function(a,b,d){a=b||a;d=d||{};var h=a.startContainer,c=b?this.hostMethods.makeHostElement:x,g=d.nodes,k=!1!==d.insertStubText,n=d.text,m,l=this.env.document;d=!1;m=this._getIceNode(h&&h.$||h,"insertType");h=this._isCurrentUserIceNode(m);this._cleanupSelection(a,Boolean(b),!0);if(h){h=g&&g[0];n=m.getAttribute(this.attributes.changeId);
if(h){d=!0;a.insertNode(c(h));c=h.parentNode;l=h.nextSibling;m=g.length;for(k=1;k<m;++k)l?c.insertBefore(g[k],l):c.appendChild(g[k]);g=g[m-1];f.dom.TEXT_NODE==g.nodeType?a.setEnd(g,g.nodeValue&&g.nodeValue.length||0):a.setEndAfter(g);a.collapse();b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}else q(null,a,l,k);this._updateChangeTime(n)}else{h=this._createIceNode("insertType");if(m){var p=m.childNodes.length;this._normalizeNode(m);p!==m.childNodes.length&&(b?b=a=this.hostMethods.getHostRange():
a.refresh());m&&(p=b&&this.hostMethods.getHostNode(b.endContainer)||a.endContainer,3==p.nodeType&&a.endOffset<a.endContainer.length||p!==m.lastChild)&&(m=this._splitNode(m,a.endContainer,a.endOffset))}m&&(a.setStartAfter(c(m)),a.collapse(!0));a.insertNode(c(h));if(m=g&&g.length||0){d=!0;for(k=0;k<m;++k)h.appendChild(g[k]);a.setEndAfter(c(h.lastChild));a.collapse()}else n?(d=!0,g=l.createTextNode(n),h.appendChild(g),a.setEnd(g,1),a.collapse()):q(h,a,l,k);b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}return d},
_updateChangeTime:function(a){var b=this._changes[a];if(b){var d=(new Date).getTime();a=f.dom.find(this.element,"["+this.attributes.changeId+"\x3d"+a+"]");var h=this.attributes.lastTime;b.lastTime=d;a.each(function(a,b){b.setAttribute(h,d)})}},_handleVoidEl:function(a,b){var d=a&&this._getVoidElement(a);return d&&!this._getIceNode(d,"deleteType")?(b.collapse(!0),!0):!1},_deleteSelection:function(a){for(var b=new f.Bookmark(this.env,a),d=f.dom.getElementsBetween(b.start,b.end),h=[],c=[],g={deleteNodesCollection:c,
moveLeft:!0,range:null},k=0;k<d.length;k++){var n=d[k];if(n&&n.parentNode){if(f.dom.isBlockElement(n)&&(h.push(n),!f.dom.canContainTextElement(n))){for(var m=0;m<n.childNodes.length;m++)d.push(n.childNodes[m]);continue}if(f.dom.isEmptyTextNode(n))this._removeNode(n);else if(!this._getVoidElement(n))if(n.nodeType!==f.dom.TEXT_NODE)if(p(n))this._addDeleteTrackingToBreak(n,g);else if(f.dom.isStubElement(n))this._addDeleteTracking(n,g);else if(f.dom.hasNoTextOrStubContent(n))this._removeNode(n);else for(m=
0;m<n.childNodes.length;m++)d.push(n.childNodes[m]);else m=f.dom.getBlockParent(n),this._addDeleteTracking(n,g),f.dom.hasNoTextOrStubContent(m)&&f.dom.remove(m)}}if(c.length)b.remove(),this._cleanupAroundNode(c[0]),a.setStartBefore(c[0]),a.collapse(!0),this.selection.addRange(a);else if(b.selectStartAndCollapse(),a=this.getCurrentRange())this._cleanupSelection(a,!1,!1),a=this.getCurrentRange();return a},_deleteRight:function(a){var b=f.dom.isBlockElement(a.startContainer)&&a.startContainer||f.dom.getBlockParent(a.startContainer,
this.element)||null,d=b?f.dom.hasNoTextOrStubContent(b):!1,h=b&&f.dom.getNextContentNode(b,this.element),g=h?f.dom.hasNoTextOrStubContent(h):!1,k=a.endContainer,n=a.endOffset,l=a.commonAncestorContainer,m,q=!1;if(d)return!1;if(p(l))return this._addDeleteTrackingToBreak(l,{range:a}),!0;if(l.nodeType!==f.dom.TEXT_NODE){if(0===n&&f.dom.isBlockElement(l)&&!f.dom.canContainTextElement(l)&&(b=l.firstElementChild))return a.setStart(b,0),a.collapse(),this._deleteRight(a);if(l.childNodes.length>n){b=l.childNodes[n];
if(p(b))return this._addDeleteTrackingToBreak(b,{range:a}),!0;a.setStart(l.childNodes[n],0);a.collapse(!0);q=this._deleteRight(a);a.refresh();return q}if(m=f.dom.getNextContentNode(l,this.element)){if(p(m))return this._addDeleteTrackingToBreak(m,{range:a}),!0;a.setEnd(m,0)}a.collapse();return this._deleteRight(a)}try{a.moveEnd(f.dom.CHARACTER_UNIT,1),a.moveEnd(f.dom.CHARACTER_UNIT,-1)}catch(A){}if(n===k.data.length&&!f.dom.hasNoTextOrStubContent(k)){m=f.dom.getNextNode(k,this.element);if(!m)return a.selectNodeContents(k),
a.collapse(),!1;if(p(m))return this._addDeleteTrackingToBreak(m,{range:a}),!0;m.nodeType===f.dom.TEXT_NODE&&(m=m.parentNode);if(!m.isContentEditable)return q=this._addDeleteTracking(m,{range:null,moveLeft:!1,merge:!0}),b=this.env.document.createTextNode(""),m.parentNode.insertBefore(b,m.nextSibling),a.selectNode(b),a.collapse(!0),q;if(this._handleVoidEl(m,a))return!0;if(f.dom.isChildOf(m,b)&&f.dom.isStubElement(m))return this._addDeleteTracking(m,{range:a,moveLeft:!1,merge:!0})}if(this._handleVoidEl(m,
a))return!0;if(f.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(this.mergeBlocks&&f.dom.is(f.dom.getBlockParent(m,this.element),this.blockEl)){h!==f.dom.getBlockParent(a.endContainer,this.element)&&a.setEnd(h,0);l=f.dom.getElementsBetween(a.startContainer,a.endContainer);for(n=0;n<l.length;n++)f.dom.remove(l[n]);return f.dom.mergeBlockWithSibling(a,f.dom.getBlockParent(a.endContainer,this.element)||b)}if(g)return f.dom.remove(h),a.collapse(!0),!0;a.setStart(h,0);a.collapse(!0);
return!0}b=c(a.endContainer,a.endOffset,1);return this._addDeleteTracking(b,{range:a,moveLeft:!1,merge:!0})},_deleteLeft:function(a){var b=f.dom.isBlockElement(a.startContainer)&&a.startContainer||f.dom.getBlockParent(a.startContainer,this.element)||null,d=b?f.dom.hasNoTextOrStubContent(b):!1,h=b&&f.dom.getPrevContentNode(b,this.element),g=h?f.dom.hasNoTextOrStubContent(h):!1,k=a.startContainer,n=a.startOffset,l=a.commonAncestorContainer;if(d)return!1;if(p(l))return this._addDeleteTrackingToBreak(l,
{range:a,moveLeft:!0}),!0;if(0===n||l.nodeType!==f.dom.TEXT_NODE){if(f.dom.isBlockElement(l)&&!f.dom.canContainTextElement(l))if(0===n){if(d=l.firstElementChild)return a.setStart(d,0),a.collapse(),this._deleteLeft(a)}else if(d=l.lastElementChild)if(d=a.getLastSelectableChild(d))return a.setStart(d,d.data.length),a.collapse(),this._deleteLeft(a);k=0===n?f.dom.getPrevContentNode(k,this.element):l.childNodes[n-1];if(!k)return!1;f.dom.is(k,this._iceSelector)&&0<k.childNodes.length&&k.lastChild&&(k=k.lastChild);
if(p(k))return this._addDeleteTrackingToBreak(k,{range:a,moveLeft:!0}),!0;k.nodeType===f.dom.TEXT_NODE&&(k=k.parentNode);if(!k.isContentEditable)return b=this._addDeleteTracking(k,{range:null,moveLeft:!0,merge:!0}),h=document.createTextNode(""),k.parentNode.insertBefore(h,k),a.selectNode(h),a.collapse(!0),b;if(this._handleVoidEl(k,a))return!0;if(f.dom.isStubElement(k)&&f.dom.isChildOf(k,b)||!k.isContentEditable)return this._addDeleteTracking(k,{range:a,moveLeft:!0,merge:!0}),!0;if(f.dom.isStubElement(k))return f.dom.remove(k),
a.collapse(!0),!1;if(k!==b&&!f.dom.isChildOf(k,b)){f.dom.canContainTextElement(k)||(k=k.lastElementChild);if(k.lastChild&&k.lastChild.nodeType!==f.dom.TEXT_NODE&&f.dom.isStubElement(k.lastChild)&&"BR"!==k.lastChild.tagName)return a.setStartAfter(k.lastChild),a.collapse(!0),!0;if((d=a.getLastSelectableChild(k))&&!f.dom.isOnBlockBoundary(a.startContainer,d,this.element))return a.selectNodeContents(d),a.collapse(),!0}}if(1===n&&!f.dom.isBlockElement(l)&&1<a.startContainer.childNodes.length&&a.startContainer.childNodes[0].nodeType===
f.dom.TEXT_NODE&&0===a.startContainer.childNodes[0].data.length)return a.setStart(a.startContainer,0),this._deleteLeft(a);try{a.moveStart(f.dom.CHARACTER_UNIT,-1),a.moveStart(f.dom.CHARACTER_UNIT,1)}catch(m){}if(f.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(g)return f.dom.remove(h),a.collapse(),!0;if(h&&h.lastChild&&f.dom.isStubElement(h.lastChild))return a.setStartAfter(h.lastChild),a.collapse(!0),!0;(d=a.getLastSelectableChild(h))?(a.setStart(d,d.data.length),a.collapse(!0)):
h&&(a.setStart(h,h.childNodes.length),a.collapse(!0));return!0}return(b=a.startContainer)&&b.nodeType===f.dom.TEXT_NODE?(b=c(b,a.startOffset-1,1),this._addDeleteTracking(b,{range:a,moveLeft:!0,merge:!0}),!0):!1},_removeNode:function(a){var b=a&&a.parentNode;b&&(b.removeChild(a),b!==this.element&&f.dom.hasNoTextOrStubContent(b)&&this._removeNode(b))},_addDeleteTracking:function(a,b){var d=b&&b.moveLeft,h=this._getIceNode(a,"insertType"),c;b=b||{};if(h)return this._addDeletionInInsertNode(a,h,b);if((h=
b.range)&&this._getIceNode(a,"deleteType"))return this._deleteInDeleted(a,b);a.previousSibling&&f.dom.isEmptyTextNode(a.previousSibling)&&a.parentNode.removeChild(a.previousSibling);a.nextSibling&&f.dom.isEmptyTextNode(a.nextSibling)&&a.parentNode.removeChild(a.nextSibling);c=this._getIceNode(a.previousSibling,"deleteType");var g=this._getIceNode(a.nextSibling,"deleteType");if(c&&this._isCurrentUserIceNode(c)){if(c.appendChild(a),g&&this._isCurrentUserIceNode(g)){var k=f.dom.extractContent(g);f.dom.append(c,
k);g.parentNode.removeChild(g)}}else g&&this._isCurrentUserIceNode(g)?(c=g,c.insertBefore(a,c.firstChild)):(g=this.getAdjacentChangeId(a,d),c=this._createIceNode("deleteType",null,g),b.deleteNodesCollection&&b.deleteNodesCollection.push(c),a.parentNode.insertBefore(c,a),c.appendChild(a));h&&(f.dom.isStubElement(a)?h.selectNode(a):h.selectNodeContents(a),d?h.collapse(!0):h.collapse());c&&(this._normalizeNode(c),h&&h.refresh());return!0},_addDeleteTrackingToBreak:function(a,b){function d(){var d=b&&
b.range;d&&(p(a)||f.dom.hasNoTextOrStubContent(a)||c?c?(d.setStartBefore(a),d.setEndBefore(a)):(d.setStartAfter(a),d.setEndAfter(a)):a.firstChild&&(d.setStartBefore(a.firstChild),d.setEndBefore(a.firstChild)),d.collapse())}var c=Boolean(b&&b.moveLeft);if(p(a)){if(this._isDeleteNode(a))return d();v(a);f.dom.addClass(a,this._getIceNodeClass("deleteType"));var g=this.getAdjacentChangeId(a,c);this._addChange("deleteType",[a],g);d()}else k("addDeleteTracking to BR: not a break element")},_deleteInDeleted:function(a,
b){var d=b.range,c=b.moveLeft;this._normalizeNode(a);var g=!1;if(c){for(var k=f.dom.getPrevContentNode(a,this.element);!g;)(c=this._getIceNode(k,"deleteType"))?k=f.dom.getPrevContentNode(k,this.element):g=!0;k&&((g=d.getLastSelectableChild(k))&&(k=g),d.setStart(k,f.dom.getNodeCharacterLength(k)),d.collapse(!0))}else{for(k=f.dom.getNextContentNode(a,this.element);!g;)(c=this._getIceNode(k,"deleteType"))?k=f.dom.getNextContentNode(k,this.element):g=!0;k&&(d.selectNodeContents(k),d.collapse(!0))}return!0},
_addDeletionInInsertNode:function(a,b,d){var c=d&&d.range,g=d&&d.moveLeft;d=d||{};if(this._isCurrentUserIceNode(b))c&&(g?c.setStartBefore(a):c.setStartAfter(a),c.collapse(g)),a.parentNode.removeChild(a),this._browser.msie||this._normalizeNode(b),0<f.dom.find(b,".iceBookmark").length?(d=f.dom.cloneNode(b),f.dom.remove(f.dom.find(d,".iceBookmark")),d=d[0]):d=b,f.dom.hasNoTextOrStubContent(d)&&(c&&(c.setStartBefore(b),c.collapse(!0)),f.dom.replaceWith(b,f.dom.contents(b)));else{var k=A.dom.getNodeIndex(a),
n=a.parentNode,l=n.childNodes.length,m;n.removeChild(a);m=this._createIceNode("deleteType");d.deleteNodesCollection&&d.deleteNodesCollection.push(m);m.appendChild(a);0<k&&k>=l-1?f.dom.insertAfter(b,m):(0<k&&(a=this._splitNode(b,n,k),this._deleteEmptyNode(a)),b.parentNode.insertBefore(m,b));this._deleteEmptyNode(b);c&&g&&(c.setStartBefore(m),c.collapse(!0),this.selection.addRange(c));d&&d.merge&&this._mergeDeleteNode(m);c&&c.refresh()}return!0},_deleteEmptyNode:function(a){var b=a&&a.parentNode;b&&
f.dom.hasNoTextOrStubContent(a)&&b.removeChild(a)},_mergeDeleteNode:function(a){var b,d;this._isCurrentUserIceNode(b=this._getIceNode(a.previousSibling,"deleteType"))?(d=f.dom.extractContent(a),a.parentNode.removeChild(a),f.dom.append(b,d),this._mergeDeleteNode(b)):this._isCurrentUserIceNode(b=this._getIceNode(a.nextSibling,"deleteType"))&&(d=f.dom.extractContent(b),a.parentNode.removeChild(b),f.dom.append(a,d),this._mergeDeleteNode(a))},handleEvent:function(a){if(!this._isTracking)return!0;var b=
!1;"keypress"==a.type?b=this.keyPress(a):"keydown"==a.type&&(b=!this.handleKeyDown(a));b&&(a.stopImmediatePropagation(),a.preventDefault());return!b},_handleAncillaryKey:function(a){var b=this._browser,d=!1,c=this.getCurrentRange();switch(a){case f.dom.DOM_VK_DELETE:d=this._deleteContents();break;case 46:d=this._deleteContents(!0);break;case f.dom.DOM_VK_DOWN:case f.dom.DOM_VK_UP:case f.dom.DOM_VK_LEFT:"mozilla"!==b.type||this.visible(c.startContainer)||(c.startContainer.parentNode.previousSibling?
(c.setEnd(c.startContainer.parentNode.previousSibling,0),c.moveEnd(f.dom.CHARACTER_UNIT,f.dom.getNodeCharacterLength(c.endContainer))):c.setEnd(c.startContainer.parentNode.nextSibling,0),c.collapse(!1));d=!1;break;case f.dom.DOM_VK_RIGHT:"mozilla"===b.type&&!this.visible(c.startContainer)&&c.startContainer.parentNode.nextSibling&&(c.setStart(c.startContainer.parentNode.nextSibling,0),c.collapse(!0))}return d},handleKeyDown:function(a){return this._handleSpecialKey(a)?!0:!this.keyPress(a)},onKeyDown:function(a){return this._handleSpecialKey(a)?
!1:this._handleAncillaryKey(a)},keyPress:function(a){var e=null;if(a.ctrlKey||a.metaKey)return!1;var d=(e=this.getCurrentRange())&&f.dom.parents(e.startContainer,"br")[0]||null;d&&e.moveToNextEl(d);e=a.keyCode?a.keyCode:a.which;switch(e){case 32:return this.insert({text:" "});case f.dom.DOM_VK_DELETE:case 46:case f.dom.DOM_VK_DOWN:case f.dom.DOM_VK_UP:case f.dom.DOM_VK_LEFT:case f.dom.DOM_VK_RIGHT:return this._handleAncillaryKey(e);case f.dom.DOM_VK_ENTER:return this._handleEnter(),!1;default:a:if(e){for(var c=
b.length,g,d=0;d<c;++d)if(g=b[d],e>=g.start&&e<=g.end){d=!0;break a}d=!1}else d=!0;return d?!1:(e=a["char"]||String.fromCharCode(e))?(a=this._browser.msie?{text:e}:null,this.insert(a)):!1}},_handleEnter:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._deleteContents()},_handleSpecialKey:function(a){var b=a.which;null===b&&(b=a.keyCode);switch(b){case 120:case 88:if(!0===a.ctrlKey||!0===a.metaKey)return this.prepareToCut(),!0;break;case 67:case 99:if(!0===a.ctrlKey||!0===a.metaKey)return this.prepareToCopy(),
!0}return!1},currentChangeNode:function(a,b,d){var c=this._iceSelector,g=null;if(!a){g=this.getCurrentRange();if(!g)return!1;!1!==d&&g.collapsed?(this._cleanupSelection(g,!1,!1),a=g.startContainer):a=g.commonAncestorContainer}a=b?f.dom.is(a,c)&&a:f.dom.getNode(a,c);if(!a&&g&&g.collapsed){b=g.endContainer;g=g.endOffset;d=null;if(b.nodeType===f.dom.TEXT_NODE)g===b.length?d=f.dom.getNextNode(b):0===g&&(d=f.dom.getPrevNode(b,this.element));else if(b.nodeType===f.dom.ELEMENT_NODE)if(0===g)d=f.dom.getPrevNode(b,
this.element);else if(b.childNodes.length>g){b=b.childNodes[g-1];if(f.dom.is(b,c))return b;d=f.dom.getNextNode(b)}d&&(a=f.dom.is(d,c))}return a},setShowChanges:function(a){var b=l(this.element);this._isVisible=a=Boolean(a);b.toggleClass("ICE-Tracking",a);this._showTitles(a);this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var a in this._changes){var b=this._changes[a];if(b&&b.type)return!0}return!1},countChanges:function(a){return this._filterChanges(a).count},
setChangeData:function(a){if(null==a||"undefined"==typeof a)a="";this._changeData=String(a)},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},prepareToCopy:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._removeTrackingInRange(a)},prepareToCut:function(){var a=this.getCurrentRange(),b=this.hostMethods.getHostRange();if(a&&b&&a.collapsed&&!b.collapsed)try{var d=this.hostMethods.getHostRangeData(b);a.setStart(d.startContainer,d.startOffset);a.setEnd(d.endContainer,
d.endOffset)}catch(c){return}if(!a||a.collapsed)return!1;b=this.element;if(a&&b&&!a.collapsed){var g;try{for(;(g=a.endContainer)&&g!==b&&0==a.endOffset&&!a.collapsed&&(g.previousSibling?a.setEndBefore(g):g.parentNode&&g.parentNode!==b&&a.setEndBefore(g.parentNode),a.endContainer!=g););}catch(n){k(n,"fixSelection, while trying to set end")}try{for(;(g=a.startContainer)&&g!==b&&!a.collapsed&&(g=a.startContainer,g.nodeType==f.dom.TEXT_NODE?a.startOffset>=g.nodeValue.length&&a.setStartAfter(g):a.startOffset>=
g.childNodes.length&&a.setStartAfter(g),a.startContainer!=g););}catch(l){k(l,"fixSelection, while trying to set start")}}b=a.cloneContents();g=a.cloneRange();var d=b.firstChild,q=b.lastChild;this.hostMethods.beforeEdit();a.collapse(!1);a.insertNode(b);a.setStartBefore(d);a.setEndAfter(q);b=this._startBatchChange();try{this._deleteSelection(a)}catch(m){k(m,"While trying to delete selection")}finally{this._endBatchChange(b),this.selection.addRange(g),this._removeTrackingInRange(g,!1)}return!0},toString:function(){return"ICE "+
(this.element&&this.element.id||"(no element id)")},_splitNode:function(a,b,d){var c=a.parentNode,g=A.dom.getNodeIndex(a),f=b.ownerDocument.createRange();f.setStart(c,g);f.setEnd(b,d);b=f.extractContents();c.insertBefore(b,a);this.isInsideChange(a,!0)&&this._updateNodeTooltip(a.previousSibling);return a.previousSibling},_triggerChange:function(a){this._isTracking&&(this.$this.trigger("change"),a&&a.isText&&this.$this.trigger("textChange"))},_updateNodeTooltip:function(a){this.tooltips&&this._isVisible&&
this._addTooltip(a)},_acceptRejectSome:function(a,b){var d=function(a,d){this.acceptRejectChange(d,{isAccept:b,notify:!1})}.bind(this),c=this._filterChanges(a),g;for(g in c.changes)f.dom.find(this.element,"["+this.attributes.changeId+"\x3d"+g+"]").each(d);c.count&&this._triggerChange({isText:!0})},_filterChanges:function(a){var b=0,d={},c;c=a||{};a=c.filter;var g=c.exclude?l.map(c.exclude,function(a){return String(a)}):null,k=c.include?l.map(c.include,function(a){return String(a)}):null,n=c.verify,
q=null,m;for(m in this._changes)(c=this._changes[m])&&c.type&&(q=a&&!a({userid:c.userid,time:c.time,data:c.data})||g&&0<=g.indexOf(c.userid)||k&&0>k.indexOf(c.userid),q||(n&&(q=f.dom.find(this.element,"["+this.attributes.changeId+"]"),q=!q.length),q||(++b,d[m]=c)));return{count:b,changes:d}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var a=this.currentUser&&this.currentUser.id,b=this.currentUser&&this.currentUser.name||"",d=(new Date).getTime(),c,g=new RegExp(this.stylePrefix+
"-(\\d+)"),k=[],n;for(n in this.changeTypes)k.push(this._getIceNodeClass(n));n=this.getIceNodes();var l=function(n,l){var q=0,w,p="",A=l.className.split(" ");for(n=0;n<A.length;n++){if(c=g.exec(A[n]))w=c[0],q=c[1];var v=(new RegExp("("+k.join("|")+")")).exec(A[n]);v&&(p=this._getChangeTypeFromAlias(v[1]))}A=f.dom.attr(l,this.attributes.userId);a&&A==a?(v=b,l.setAttribute(this.attributes.userName,b)):v=l.getAttribute(this.attributes.userName);this._setUserStyle(A,Number(q));q=parseInt(f.dom.attr(l,
this.attributes.changeId)||"");isNaN(q)&&(q=this.getNewChangeId(),l.setAttribute(this.attributes.changeId,q));var x=parseInt(l.getAttribute(this.attributes.time)||"");isNaN(x)&&(x=d);var D=parseInt(l.getAttribute(this.attributes.lastTime)||"");isNaN(D)&&(D=x);var B=l.getAttribute(this.attributes.sessionId),E=f.dom.attr(l,this.attributes.changeData)||"";this._changes[q]={type:p,style:w,userid:String(A),username:v,time:x,lastTime:D,sessionId:B,data:E};this._updateNodeTooltip(l)}.bind(this);n.each(l);
this._triggerChange()},_showTitles:function(a){var b=this.getIceNodes();a?l(b).each(function(a,b){this._updateNodeTooltip(b)}.bind(this)):l(b).removeAttr("title")},_updateTooltipsState:function(){var a,b=this;this.tooltips&&this._isVisible?this._showingTips||(this._showingTips=!0,a=this.getIceNodes(),a.each(function(a,c){b._addTooltip(c)})):this._showingTips&&(this._showingTips=!1,a=this.getIceNodes(),a.each(function(a,b){l(b).unbind("mouseover").unbind("mouseout")}))},_addTooltip:function(a){l(a).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},
_tooltipMouseOver:function(a){var b=a.currentTarget,d=l(b),c=this;a.buttons||d.data("_tooltip_t")||(a=setTimeout(function(){var a=c.currentChangeNode(b),g=a&&a.getAttribute(c.attributes.changeId),k=g&&c.getChange(g);k&&(a=f.dom.hasClass(a,c._getIceNodeClass("insertType"))?"insert":"delete",d.removeData("_tooltip_t"),c.hostMethods.showTooltip(b,{userName:k.username,changeId:g,userId:k.userid,time:k.time,lastTime:k.lastTime,type:a}))},this.tooltipsDelay),d.data("_tooltip_t",a))},_tooltipMouseOut:function(a){a=
a.currentTarget;var b=l(a),d=b.data("_tooltip_t");b.removeData("_tooltip_t");d?clearTimeout(d):this.hostMethods.hideTooltip(a)},_removeTrackingInRangeOld:function(a){var b=this._getIceNodeClass("insertType"),d=this._getIceNodeClass("deleteType"),c="."+b+",."+d;a.getNodes(null,function(a){var b=null;a.nodeType==f.dom.TEXT_NODE?b=l(a).parents(c):(a=l(a),b=a.is(c)?a:a.parents(c));return(a=b&&b[0])?(a.setAttribute("data-ice-class",a.className),a.setAttribute("class","ice-no-decoration"),!0):!1});var g=
this.element;setTimeout(function(){l(g).find("[data-ice-class]").each(function(a,b){var d=b.getAttribute("data-ice-class");d&&(b.setAttribute("class",d),b.removeAttribute("data-ice-class"))})},10)},_removeTrackingInRange:function(a){var b=this._getIceNodeClass("insertType"),d=this._getIceNodeClass("deleteType"),c="."+b+",."+d,g=this._savedNodesMap,n=Date.now()%1E6;a.getNodes(null,function(a){var b=null;a.nodeType==f.dom.TEXT_NODE?b=l(a).parents(c):(a=l(a),b=a.is(c)?a:a.parents(c));if(a=b&&b[0]){for(var d=
a.attributes,e,k=d&&d.length,b={},q=0;q<k;++q)e=d[q],b[e.name]=e.value;e=a.className;d=String(n++);g[d]={attributes:b,className:e};a:{var b=null,p;try{for(;0<a.attributes.length;){p=a.attributes[0];if(p===b)break a;b=p;a.removeAttribute(p.name)}}catch(A){}}a.setAttribute("data-ice-class",d);a.setAttribute("class","ice-no-decoration");return!0}return!1});var q=this.element;setTimeout(function(){l(q).find("[data-ice-class]").each(function(a,b){var d=b.getAttribute("data-ice-class"),c=g[d];d?(delete g[d],
Object.keys(c.attributes).forEach(function(a){b.setAttribute(a,c.attributes[a])}),b.setAttribute("class",c.className),b.removeAttribute("data-ice-class")):k("missing save data for node")})},10)},_onDomMutation:function(a){var b,d=a.length,c,f,k;for(b=0;b<d;++b)switch(c=a[b],c.type){case "childList":for(f=c.addedNodes,c=f.length-1;0<=c;--c)k=f[c],g.log("mutation: added node",k.tagName)}},_setDomObserverTimeout:function(){var a=this;this._domObserverTimeout&&window.clearTimeout(this._domObserverTimeout);
this._domObserverTimeout=window.setTimeout(function(){a._domObserverTimeout=null;a._domObserver.disconnect()},1)},getAdjacentChangeId:function(a,b){var d=b?f.dom.getNextNode(a):f.dom.getPrevNode(a),c,g=null;(c=this._getIceNode(d,"insertType")||this._getIceNode(d,"deleteType"))||!this._isInsertNode(d)&&!this._isDeleteNode(d)||(c=d);c&&this._isCurrentUserIceNode(c)&&(g=f.dom.attr(c,this.attributes.changeId));return g}};var g=window&&window.console||{log:function(){},error:function(){},info:function(){},
assert:function(){},count:function(){}},k=null;f.printRange=function(a,b){function d(a){if(!a)return"";a=a.replace("/\n/g","\\n").replace("/\r/g","").replace("​","{filler}").replace("﻿","{filler}");return 15>=a.length?a:a.substring(0,5)+"..."+a.substring(a.length-5)}function c(a){if(3===a.nodeType)a="Text:"+d(a.nodeValue);else{var b=a.innerText;a=a.nodeName+(b?"("+d(b)+")":"")}k.push("\x3c"+a+" /\x3e")}function f(a,b,g){"number"!==typeof g&&(g=-1);if(3==a.nodeType)a=a.nodeValue,k.push(d(a.substring(0,
b))),k.push("|"),g>b?(k.push(d(a.substring(b,g))),k.push("|"),k.push(d(a.substring(g)))):k.push(d(a.substring(b)));else if(1==a.nodeType){var e=0,n=a.childNodes;c(a);for(e=0;e<b;++e)c(n[e]);k.push("|");if(g>b){for(e=b;e<g;++e)c(n[e]);k.push("|")}if(0<g&&g<n.length)for(b=n[g];b;)c(b),b=b.nextSibling}}if(a&&a.startContainer&&a.endContainer){var k=[];a.startContainer===a.endContainer?f(a.startContainer,a.startOffset,a.endOffset):(f(a.startContainer,a.startOffset),f(a.endContainer,a.endOffset));var n=
k.join(" ");b&&g.log(b+":"+n);return n}};f.InlineChangeEditor=E})(this.ice||window.ice,window.jQuery);
(function(f,l){function x(b){if(!b)return!0;for(var c=b.length-1,k;0<=c;)if(k=b[c--],"​"!==k&&"﻿"!==k)return!1;return!0}function v(b,g){for(;b;){if(c.TEXT_NODE==b.nodeType)return b;for(var k=b.firstChild;k;k=k.nextSibling){var a=v(k,g);if(a)return a}if(c.isTextContainer(b))return b;b=b.nextSibling}return null}function p(b,g){for(;b;){if(c.TEXT_NODE==b.nodeType)return b;for(var k=b.lastChild;k;k=k.previousSibling){var a=p(k,g);if(a)return a}if(c.isTextContainer(b))return b;b=b.previousSibling}return null}
function n(b){if(b)for(var c=b.firstChild;c;){if(1==c.nodeType)n(c);else if(3==c.nodeType)for(var k;(k=c.nextSibling)&&3==k.nodeType;){var a=k.nodeValue;null!=a&&a.length&&(c.nodeValue+=a);b.removeChild(k)}c=c.nextSibling}}var c={},q=null,A=/^\s*$/,B=/^\d+$/;c.DOM_VK_DELETE=8;c.DOM_VK_LEFT=37;c.DOM_VK_UP=38;c.DOM_VK_RIGHT=39;c.DOM_VK_DOWN=40;c.DOM_VK_ENTER=13;c.ELEMENT_NODE=1;c.ATTRIBUTE_NODE=2;c.TEXT_NODE=3;c.CDATA_SECTION_NODE=4;c.ENTITY_REFERENCE_NODE=5;c.ENTITY_NODE=6;c.PROCESSING_INSTRUCTION_NODE=
7;c.COMMENT_NODE=8;c.DOCUMENT_NODE=9;c.DOCUMENT_TYPE_NODE=10;c.DOCUMENT_FRAGMENT_NODE=11;c.NOTATION_NODE=12;c.CHARACTER_UNIT="character";c.WORD_UNIT="word";c.BREAK_ELEMENT="br";c.PARAGRAPH_ELEMENT="p";c.CONTENT_STUB_ELEMENTS="img hr iframe param link meta input frame col base area".split(" ");c.BLOCK_ELEMENTS="body p div pre ul ol li table tbody td th fieldset form blockquote dl dt dd dir center address h1 h2 h3 h4 h5 h6".split(" ");c.TEXT_CONTAINER_ELEMENTS="body p div pre span b strong i li td th blockquote dt dd center address h1 h2 h3 h4 h5 h6 ins del".split(" ");
c.STUB_ELEMENTS=c.CONTENT_STUB_ELEMENTS.slice();c.STUB_ELEMENTS.push(c.BREAK_ELEMENT);var E=c.CONTENT_STUB_ELEMENTS.join(", ");c.getKeyChar=function(b){return String.fromCharCode(b.which)};c.getClass=function(b,c,k){c||(c=document.body);b="."+b.split(" ").join(".");k&&(b=k+b);return l.makeArray(l(c).find(b))};c.getId=function(b,c){c||(c=document);return element=c.getElementById(b)};c.getTag=function(b,c){c||(c=document);return l.makeArray(l(c).find(b))};c.getElementWidth=function(b){return b.offsetWidth};
c.getElementHeight=function(b){return b.offsetHeight};c.getElementDimensions=function(b){return{width:c.getElementWidth(b),height:c.getElementHeight(b)}};c.empty=function(b){if(b)return l(b).empty()};c.remove=function(b){if(b)return l(b).remove()};c.prepend=function(b,c){l(b).prepend(c)};c.append=function(b,c){l(b).append(c)};c.insertBefore=function(b,c){l(b).before(c)};c.insertAfter=function(b,c){if(b&&c){var k=b.nextSibling,a=b.parentNode;return k?a.insertBefore(c,k):a.appendChild(c)}};c.getHtml=
function(b){return l(b).html()};c.setHtml=function(b,c){b&&l(b).html(c)};c.removeWhitespace=function(b){l(b).contents().filter(function(){return this.nodeType!=f.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(c.removeWhitespace(this),!1):this.nodeType!=f.dom.TEXT_NODE?!1:!/\S/.test(this.nodeValue)}).remove()};c.contents=function(b){return l.makeArray(l(b).contents())};c.extractContent=function(b){for(var c=document.createDocumentFragment(),k;k=b.firstChild;)c.appendChild(k);return c};c.getNode=
function(b,g){if(!b)return null;b=b.$||b;return b.nodeType!=c.TEXT_NODE&&c.is(b,g)?b:c.parents(b,g)[0]||null};c.getParents=function(b,c,k){b=l(b).parents(c);c=b.length;for(var a=[],e=0;e<c&&b[e]!==k;e++)a.push(b[e]);return a};c.hasBlockChildren=function(b){for(var g=b.childNodes.length,k=0;k<g;k++)if(b.childNodes[k].nodeType===c.ELEMENT_NODE&&!0===c.isBlockElement(b.childNodes[k]))return!0;return!1};c.removeTag=function(b,c){l(b).find(c).replaceWith(function(){return l(this).contents()});return b};
c.stripEnclosingTags=function(b,c){var k=l(b);k.find("*").not(c).replaceWith(function(){var a=l(),b;try{b=l(this),a=b.contents()}catch(c){}0===a.length&&b.remove();return a});return k[0]};c.getSiblings=function(b,c,k,a){if(!0===k)return"prev"===c?l(b).prevAll():l(b).nextAll();k=[];if("prev"===c)for(;b.previousSibling;){b=b.previousSibling;if(b===a)break;k.push(b)}else for(;b.nextSibling;){b=b.nextSibling;if(b===a)break;k.push(b)}return k};c.getNodeTextContent=function(b){return l(b).text()};c.getNodeStubContent=
function(b){return l(b).find(E)};c.hasNoTextOrStubContent=function(b){var g=c.getNodeTextContent(b);return x(g)?b.firstChild?0===l(b).find(E).length:!0:!1};c.isEmptyTextNode=function(b){return b&&c.TEXT_NODE===b.nodeType?0===b.length?!0:x(b.nodeValue):!1};c.getNodeCharacterLength=function(b){return c.getNodeTextContent(b).length+l(b).find(c.STUB_ELEMENTS.join(", ")).length};c.setNodeTextContent=function(b,c){return l(b).text(c)};c.getTagName=function(b){return b&&b.tagName&&b.tagName.toLowerCase()||
null};c.getIframeDocument=function(b){var c=null;b.contentDocument?c=b.contentDocument:b.contentWindow?c=b.contentWindow.document:b.document&&(c=b.document);return c};c.isBlockElement=function(b){return-1!=c.BLOCK_ELEMENTS.indexOf(b.nodeName.toLowerCase())};c.isStubElement=function(b){return-1!=c.STUB_ELEMENTS.indexOf(b.nodeName.toLowerCase())};c.removeBRFromChild=function(b){if(b&&b.hasChildNodes())for(var c=0;c<b.childNodes.length;c++){var k=b.childNodes[c];k&&f.dom.BREAK_ELEMENT==f.dom.getTagName(k)&&
k.parentNode.removeChild(k)}};c.isChildOf=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode===c)return!0;b=b.parentNode}}catch(k){}return!1};c.isChildOfTagName=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName&&b.parentNode.tagName.toLowerCase()===c)return b.parentNode;b=b.parentNode}}catch(k){}return!1};c.isChildOfTagNames=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName){tagName=b.parentNode.tagName.toLowerCase();for(var k=0;k<c.length;k++)if(tagName===
c[k])return b.parentNode}b=b.parentNode}}catch(a){}return null};c.isChildOfClassName=function(b,c){try{for(;b&&b.parentNode;){if(l(b.parentNode).hasClass(c))return b.parentNode;b=b.parentNode}}catch(k){}return null};c.cloneNode=function(b,c){void 0===c&&(c=!0);return l(b).clone(c)};c.bind=function(b,c,k){return l(b).bind(c,k)};c.unbind=function(b,c,k){return l(b).unbind(c,k)};c.attr=function(b,c,k){return k?l(b).attr(c,k):l(b).attr(c)};c.replaceWith=function(b,c){return l(b).replaceWith(c)};c.removeAttr=
function(b,c){l(b).removeAttr(c)};c.getElementsBetween=function(b,g){var k=[];if(b===g)return k;if(!0===c.isChildOf(g,b)){for(var a=b.childNodes.length,e=0;e<a&&b.childNodes[e]!==g;e++){if(!0===c.isChildOf(g,b.childNodes[e]))return c.arrayMerge(k,c.getElementsBetween(b.childNodes[e],g));k.push(b.childNodes[e])}return k}for(a=b.nextSibling;a;){if(!0===c.isChildOf(g,a))return k=c.arrayMerge(k,c.getElementsBetween(a,g));if(a===g)return k;k.push(a);a=a.nextSibling}for(var a=c.getParents(b),e=c.getParents(g),
a=c.arrayDiff(a,e,!0),e=a.length,d=0;d<e-1;d++)k=c.arrayMerge(k,c.getSiblings(a[d],"next"));return k=c.arrayMerge(k,c.getElementsBetween(a[a.length-1],g))};c.getCommonAncestor=function(b,g){for(var k=b;k;){if(!0===c.isChildOf(g,k))return k;k=k.parentNode}return null};c.getNextNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.nextSibling){if(b.nextSibling.nodeType===c.TEXT_NODE&&0===b.nextSibling.length){b=b.nextSibling;continue}return c.getFirstChild(b.nextSibling)}b=b.parentNode}return null};
c.getNextContentNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.nextSibling&&c.canContainTextElement(c.getBlockParent(b))){if(b.nextSibling.nodeType===c.TEXT_NODE&&0===b.nextSibling.length){b=b.nextSibling;continue}return b.nextSibling}if(b.nextElementSibling)return b.nextElementSibling;b=b.parentNode}return null};c.getPrevNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.previousSibling){if(b.previousSibling.nodeType===c.TEXT_NODE&&0===b.previousSibling.length){b=b.previousSibling;
continue}return c.getLastChild(b.previousSibling)}b=b.parentNode}return null};c.getPrevContentNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.previousSibling&&c.canContainTextElement(c.getBlockParent(b))){if(b.previousSibling.nodeType===c.TEXT_NODE&&0===b.previousSibling.length){b=b.previousSibling;continue}return b.previousSibling}if(b.previousElementSibling)return b.previousElementSibling;b=b.parentNode}return null};c.findPrevTextContainer=function(b,g){if(!b||b==g)return{node:g,offset:0};
if(b.parentNode&&c.isTextContainer(b.parentNode))return{node:b.parentNode,offset:c.getNodeIndex(b)};for(;b.previousSibling;){var k=p(b.previousSibling);if(k)return{node:k,offset:c.getNodeLength(k)};b=b.previousSibling}return c.findPrevTextContainer(b.parentNode&&b.parentNode.previousSibling,g)};c.findNextTextContainer=function(b,g){if(!b||b==g)return{node:g,offset:c.getNodeLength(g)};if(b.parentNode&&c.isTextContainer(b.parentNode))return{node:b.parentNode,offset:c.getNodeIndex(b)+1};for(;b.nextSibling;){var k=
v(b.nextSibling);if(k)return{node:k,offset:0};b=b.previousSibling}return c.findNextTextContainer(b.parentNode&&b.parentNode.nextSibling,g)};c.getNodeLength=function(b){return b?c.TEXT_NODE==b.nodeType?b.length:b.childNodes&&b.childNodes.length||0:0};c.isTextContainer=function(b){return b&&c.TEXT_NODE==b.nodeType||0<=c.TEXT_CONTAINER_ELEMENTS.indexOf((b.nodeName||"").toLowerCase())};c.getNodeIndex=function(b){for(var c=0;b=b.previousSibling;)++c;return c};c.canContainTextElement=function(b){return b&&
b.nodeName?-1!=c.TEXT_CONTAINER_ELEMENTS.lastIndexOf(b.nodeName.toLowerCase()):!1};c.getFirstChild=function(b){return b.firstChild?b.firstChild.nodeType===c.ELEMENT_NODE?c.getFirstChild(b.firstChild):b.firstChild:b};c.getLastChild=function(b){return b.lastChild?b.lastChild.nodeType===c.ELEMENT_NODE?c.getLastChild(b.lastChild):b.lastChild:b};c.removeEmptyNodes=function(b,g){for(var k=l(b).find(":empty"),a=k.length;0<a;)a--,!1===c.isStubElement(k[a])&&(g&&!1===g.call(this,k[a])||c.remove(k[a]))};c.create=
function(b){return l(b)[0]};c.find=function(b,c){return l(b).find(c)};c.children=function(b,c){return l(b).children(c)};c.parent=function(b,c){return l(b).parent(c)[0]};c.parents=function(b,c){return l(b).parents(c)};c.is=function(b,c){return l(b).is(c)};c.extend=function(b,c,k,a){return l.extend.apply(this,arguments)};c.walk=function(b,g,k){b&&(k||(k=0),!1!==g.call(this,b,k)&&(b.childNodes&&0<b.childNodes.length?c.walk(b.firstChild,g,k+1):b.nextSibling?c.walk(b.nextSibling,g,k):b.parentNode&&b.parentNode.nextSibling&&
c.walk(b.parentNode.nextSibling,g,k-1)))};c.revWalk=function(b,g){b&&!1!==g.call(this,b)&&(b.childNodes&&0<b.childNodes.length?c.walk(b.lastChild,g):b.previousSibling?c.walk(b.previousSibling,g):b.parentNode&&b.parentNode.previousSibling&&c.walk(b.parentNode.previousSibling,g))};c.setStyle=function(b,c,k){b&&l(b).css(c,k)};c.getStyle=function(b,c){return l(b).css(c)};c.hasClass=function(b,c){return l(b).hasClass(c)};c.addClass=function(b,c){l(b).addClass(c)};c.removeClass=function(b,c){l(b).removeClass(c)};
c.preventDefault=function(b){b.preventDefault();c.stopPropagation(b)};c.stopPropagation=function(b){b.stopPropagation()};c.each=function(b,c){l.each(b,function(b,a){c.call(this,b,a)})};c.foreach=function(b,c){var k,a;if(b instanceof Array||b instanceof NodeList||"undefined"!=typeof b.length&&"undefined"!=typeof b.item){a=b.length;for(var e=0;e<a&&(k=c.call(this,e,b[e]),!1!==k);e++);}else for(a in b)if(!0===b.hasOwnProperty(a)&&(k=c.call(this,a),!1===k))break};c.isBlank=function(b){return!b||A.test(b)};
c.isFn=function(b){return"function"===typeof b};c.isObj=function(b){return null!==b&&"object"===typeof b};c.isset=function(b){return"undefined"!==typeof b&&null!==b};c.isArray=function(b){return l.isArray(b)};c.isNumeric=function(b){return null!==b.match(B)};c.getUniqueId=function(){var b=(new Date).getTime(),c=Math.ceil(1E6*Math.random());return(b+""+c).substr(5,18).replace(/,/,"")};c.inArray=function(b,c){for(var k=c.length,a=0;a<k;a++)if(b===c[a])return!0;return!1};c.arrayDiff=function(b,g,k){var a=
b.length,e,d=[];for(e=0;e<a;e++)!1===c.inArray(b[e],g)&&d.push(b[e]);if(!0!==k)for(a=g.length,e=0;e<a;e++)!1===c.inArray(g[e],b)&&d.push(g[e]);return d};c.arrayMerge=function(b,c){var k=c.length,a;for(a=0;a<k;a++)b.push(c[a]);return b};c.stripTags=function(b,g){if("string"===typeof g){var k=l("\x3cdiv\x3e"+b+"\x3c/div\x3e");k.find("*").not(g).remove();return k.html()}for(var a=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),e=b;null!=(k=a.exec(b));)if(!1===c.isset(g)||
!0!==c.inArray(k[1],g))e=e.replace(k[0],"");return e};c.browser=function(){if(q)return l.extend({},q);var b,c,k=navigator.userAgent.toLowerCase();b=k.toLowerCase();c=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];b=c[1]||"";c=c[2]||"0";var a={type:"unknown",version:0,msie:!1};b&&(a[b]=!0,a.version=c||0,a.type=b);a.chrome?a.webkit=!0:a.webkit&&
(a.safari=!0);a.webkit&&(a.type="webkit");a.firefox=1==/firefox/.test(k);a.msie||(a.msie=Boolean(/trident/.test(k)));q=a;return l.extend({},q)};c.getBrowserType=function(){if(null===this._browserType){for(var b=["msie","firefox","chrome","safari"],c=b.length,k=0;k<c;k++)if(!0===(new RegExp(b[k],"i")).test(navigator.userAgent))return this._browserType=b[k];this._browserType="other"}return this._browserType};c.getWebkitType=function(){return"webkit"!==c.browser().type?(console.log("Not a webkit!"),
!1):0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")?"safari":"chrome"};c.isBrowser=function(b){return c.browser().type===b};c.getBlockParent=function(b,g){if(!0===c.isBlockElement(b))return b;if(b)for(;b.parentNode;){b=b.parentNode;if(!0===c.isBlockElement(b))return b;if(b===g)break}return null};c.findNodeParent=function(b,g,k){if(b)for(;b.parentNode&&b!==k;){if(!0===c.is(b,g))return b;b=b.parentNode}return null};c.onBlockBoundary=function(b,g,k){if(!b||!g)return!1;b=c.isChildOfTagNames(b,
k)||c.is(b,k.join(", "))&&b||null;g=c.isChildOfTagNames(g,k)||c.is(g,k.join(", "))&&g||null;return b!==g};c.isOnBlockBoundary=function(b,g,k){if(!b||!g)return!1;b=c.getBlockParent(b,k)||c.isBlockElement(b,k)&&b||null;g=c.getBlockParent(g,k)||c.isBlockElement(g,k)&&g||null;return b!==g};c.mergeContainers=function(b,g){if(!b||!g)return!1;if(b.nodeType===c.TEXT_NODE||c.isStubElement(b))g.appendChild(b);else if(b.nodeType===c.ELEMENT_NODE){for(;b.firstChild;)g.appendChild(b.firstChild);c.remove(b)}return!0};
c.mergeBlockWithSibling=function(b,g,k){var a=k?l(g).next().get(0):l(g).prev().get(0);k?c.mergeContainers(a,g):c.mergeContainers(g,a);b.collapse(!0);return!0};c.date=function(b,g,k){if(null===g&&k&&(g=c.tsIso8601ToTimestamp(k),!g))return;g=new Date(g);b=b.split("");k=b.length;for(var a="",e=0;e<k;e++){var d="",h=b[e];switch(h){case "D":case "l":d="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")[g.getDay()];"D"===h&&(d=d.substring(0,3));break;case "F":case "m":d=g.getMonth()+1;
10>d&&(d="0"+d);break;case "M":months="January February March April May June July August September October November December".split(" ");d=months[g.getMonth()];"M"===h&&(d=d.substring(0,3));break;case "d":d=g.getDate();break;case "S":d=c.getOrdinalSuffix(g.getDate());break;case "Y":d=g.getFullYear();break;case "y":d=g.getFullYear();d=d.toString().substring(2);break;case "H":d=g.getHours();break;case "h":d=g.getHours();0===d?d=12:12<d&&(d-=12);break;case "i":d=c.addNumberPadding(g.getMinutes());break;
case "a":d="am";12<=g.getHours()&&(d="pm");break;default:d=h}a+=d}return a};c.getOrdinalSuffix=function(b){var c="",c=b%100;if(4<=c&&20>=c)c="th";else switch(b%10){case 1:c="st";break;case 2:c="nd";break;case 3:c="rd";break;default:c="th"}return c};c.addNumberPadding=function(b){10>b&&(b="0"+b);return b};c.tsIso8601ToTimestamp=function(b){if(b=b.match(new RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/))){var c=
new Date;c.setDate(b[3]);c.setFullYear(b[1]);c.setMonth(b[2]-1);c.setHours(b[4]);c.setMinutes(b[5]);c.setSeconds(b[6]);var k=60*b[9];"+"===b[8]&&(k*=-1);k-=c.getTimezoneOffset();return c.getTime()+6E4*k}return null};c.normalizeNode=function(b,g){if(b)return c.browser().msie||!0===g||"function"!=typeof b.normalize?n(b):b.normalize()};f.dom=c})(this.ice||window.ice,window.jQuery);
(function(f){var l=f.rangy,x;x=function(f){this._selection=null;this.env=f;this._initializeRangeLibrary();this._getSelection()};x.prototype={_getSelection:function(){this._selection?this._selection.refresh():this._selection=this.env.frame?l.getSelection(this.env.frame):l.getSelection();return this._selection},createRange:function(){return l.createRange(this.env.document)},getRangeAt:function(f){try{return this._selection.refresh(),this._selection.getRangeAt(f)}catch(l){this._selection=null;try{return this._getSelection().getRangeAt(0)}catch(n){}}return null},
addRange:function(f){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(f);this._selection.ranges=[f]},_initializeRangeLibrary:function(){var f=this;l.init();l.config.checkSelectionRanges=!1;var p=function(f,c,l,p){if(0!==l){var x=f.collapsed;switch(c){case ice.dom.CHARACTER_UNIT:0<l?f.moveCharRight(p,l):f.moveCharLeft(p,-1*l)}x&&f.collapse(p)}};l.rangePrototype.moveStart=function(f,c){p(this,f,c,!0)};l.rangePrototype.moveEnd=function(f,c){p(this,f,c,!1)};l.rangePrototype.setRange=
function(f,c,l){f?this.setStart(c,l):this.setEnd(c,l)};l.rangePrototype.moveCharLeft=function(f,c){var l,p;f?(l=this.startContainer,p=this.startOffset):(l=this.endContainer,p=this.endOffset);if(l.nodeType===ice.dom.ELEMENT_NODE)if(l.hasChildNodes()&&0<p){l=l.childNodes[p-1];l=(p=this.getLastSelectableChild(l))?p:this.getPreviousTextNode(l);if(!l)return;p=l.data.length-c}else p=-1*c;else p-=c;if(0>p)for(;0>p;){l=this.getPreviousTextNode(l);if(!l)return;l.nodeType!==ice.dom.ELEMENT_NODE&&(p+=l.data.length)}this.setRange(f,
l,p)};l.rangePrototype.moveCharRight=function(f,c){var l,p;f?(l=this.startContainer,p=this.startOffset):(l=this.endContainer,p=this.endOffset);l.nodeType===ice.dom.ELEMENT_NODE?(l=(p=this.getNextTextNode(l.childNodes[Math.min(p,l.childNodes.length-1)]))?p:this.getNextTextNode(l),p=c):p+=c;if(l){var x=p-l.data.length;if(0<x){for(;0<x;){l=this.getNextContainer(l);if(!l)return;if(l.nodeType!==ice.dom.ELEMENT_NODE)if(l.data.length>=x)break;else 0<l.data.length&&(x-=l.data.length)}p=x}this.setRange(f,
l,p)}};l.rangePrototype.getNextContainer=function(f,c){if(!f)return null;for(c=c||[];f.nextSibling;)if(f=f.nextSibling,f.nodeType!==ice.dom.TEXT_NODE){var l=this.getFirstSelectableChild(f);if(null!==l)return l}else if(!0===this.isSelectable(f))return f;for(;f&&!f.nextSibling;)f=f.parentNode;if(!f)return null;f=f.nextSibling;if(!0===this.isSelectable(f))return f;!0===ice.dom.isBlockElement(f)&&c.push(f);l=this.getFirstSelectableChild(f);return null!==l?l:this.getNextContainer(f,c)};l.rangePrototype.getPreviousContainer=
function(f,c){if(!f)return null;for(c=c||[];f.previousSibling;)if(f=f.previousSibling,f.nodeType!==ice.dom.TEXT_NODE){if(!0===ice.dom.isStubElement(f))return f;var l=this.getLastSelectableChild(f);if(null!==l)return l}else if(!0===this.isSelectable(f))return f;for(;f&&!f.previousSibling;)f=f.parentNode;if(!f)return null;f=f.previousSibling;if(!0===this.isSelectable(f))return f;!0===ice.dom.isBlockElement(f)&&c.push(f);l=this.getLastSelectableChild(f);return null!==l?l:this.getPreviousContainer(f,
c)};l.rangePrototype.getNextTextNode=function(f){if(f.nodeType===ice.dom.ELEMENT_NODE&&f.firstChild){var c=this.getFirstSelectableChild(f);if(c)return c}return(f=this.getNextContainer(f))?f.nodeType===ice.dom.TEXT_NODE?f:this.getNextTextNode(f):null};l.rangePrototype.getPreviousTextNode=function(f,c){return(f=this.getPreviousContainer(f,c))?f.nodeType===ice.dom.TEXT_NODE?f:this.getPreviousTextNode(f,c):null};l.rangePrototype.getFirstSelectableChild=function(f){if(!f)return null;if(f.nodeType===ice.dom.TEXT_NODE)return f;
for(f=f.firstChild;f;){if(!0===this.isSelectable(f))return f;if(f.firstChild){var c=this.getFirstSelectableChild(f);if(null!==c)return c}f=f.nextSibling}return null};l.rangePrototype.getLastSelectableChild=function(f){if(!f)return null;if(f.nodeType==ice.dom.TEXT_NODE)return f;for(f=f.lastChild;f;){if(!0===this.isSelectable(f))return f;if(f.lastChild){var c=this.getLastSelectableChild(f);if(null!==c)return c}f=f.previousSibling}return null};l.rangePrototype.isSelectable=function(f){return Boolean(f&&
f.nodeType===ice.dom.TEXT_NODE&&0!==f.data.length)};l.rangePrototype.getHTMLContents=function(l){l||(l=this.cloneContents());var c=f.env.document.createElement("div");c.appendChild(l.cloneNode(!0));return c.innerHTML};l.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};f.Selection=x})(this.ice||window.ice);
(function(f){var l;l=function(l,v,p){this.env=l;this.element=l.element;this.selection=this.env.selection;p||this.removeBookmarks(this.element);l=v||this.selection.getRangeAt(0);v=l.cloneRange();var n=v.startContainer,c=v.startOffset,q;v.collapse(!1);p=this.env.document.createElement("span");p.style.display="none";f.dom.setHtml(p,"\x26nbsp;");f.dom.addClass(p,"iceBookmark iceBookmark_end");p.setAttribute("iceBookmark","end");v.insertNode(p);f.dom.isChildOf(p,this.element)||this.element.appendChild(p);
v.setStart(n,c);v.collapse(!0);n=this.env.document.createElement("span");n.style.display="none";f.dom.addClass(n,"iceBookmark iceBookmark_start");f.dom.setHtml(n,"\x26nbsp;");n.setAttribute("iceBookmark","start");try{v.insertNode(n),n.previousSibling===p&&(q=n,n=p,p=q)}catch(A){f.dom.insertBefore(p,n)}!1===f.dom.isChildOf(n,this.element)&&(this.element.firstChild?f.dom.insertBefore(this.element.firstChild,n):this.element.appendChild(n));p.previousSibling||(q=this.env.document.createTextNode(""),f.dom.insertBefore(p,
q));n.nextSibling||(q=this.env.document.createTextNode(""),f.dom.insertAfter(n,q));l.setStart(n.nextSibling,0);l.setEnd(p.previousSibling,p.previousSibling.length||0);this.start=n;this.end=p};l.prototype={selectStartAndCollapse:function(){if(this.start){var l=this.selection.getRangeAt(0);l.setStartBefore(this.start);l.collapse(!0);f.dom.remove([this.start,this.end]);try{this.selection.addRange(l)}catch(v){}}},remove:function(){this.start&&(f.dom.remove([this.start,this.end]),this.start=this.end=null)},
selectBookmark:function(){var l=this.selection.getRangeAt(0),v=null,p=null,n=0,c=null,q=this.start&&this.start.parentNode;this.start.nextSibling===this.end||0===f.dom.getElementsBetween(this.start,this.end).length?this.end.nextSibling?v=f.dom.getFirstChild(this.end.nextSibling):this.start.previousSibling?(v=f.dom.getFirstChild(this.start.previousSibling),v.nodeType===f.dom.TEXT_NODE&&(n=v.length)):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),v=f.dom.getFirstChild(this.end.nextSibling)):
(this.start.nextSibling?v=f.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(v=this.env.document.createTextNode(""),f.dom.insertBefore(this.start,v)),v=f.dom.getLastChild(this.start.previousSibling),n=v.length),this.end.previousSibling?p=f.dom.getLastChild(this.end.previousSibling):(p=f.dom.getFirstChild(this.end.nextSibling||this.end),c=0));f.dom.remove([this.start,this.end]);try{f.dom.normalize(q)}catch(A){}null===p?l&&(l.setEnd(v,n),l.collapse(!1)):(l.setStart(v,n),null===
c&&(c=p.length||0),l.setEnd(p,c));try{this.selection.addRange(l)}catch(B){}},getBookmark:function(l,v){return f.dom.getClass("iceBookmark_"+v,l)[0]},removeBookmarks:function(l){f.dom.remove(f.dom.getClass("iceBookmark",l,"span"))}};f.Bookmark=l})(this.ice||window.ice);
var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking",CHANGE:"lite:change",HOVER_IN:"lite:hover-in",HOVER_OUT:"lite:hover-out"},Commands:{TOGGLE_TRACKING:"lite-toggletracking",TOGGLE_SHOW:"lite-toggleshow",ACCEPT_ALL:"lite-acceptall",REJECT_ALL:"lite-rejectall",ACCEPT_ONE:"lite-acceptone",REJECT_ONE:"lite-rejectone",TOGGLE_TOOLTIPS:"lite-toggletooltips"}};