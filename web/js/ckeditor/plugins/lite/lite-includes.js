(function(e){function l(a,b){var i=typeof a[b];return i==d||!!(i==f&&a[b])||"unknown"==i}function m(a,b){return!!(typeof a[b]==f&&a[b])}function j(a,b){return typeof a[b]!=i}function k(a){return function(b,f){for(var d=f.length;d--;)if(!a(b,f[d]))return!1;return!0}}function c(a){return a&&n(a,o)&&x(a,C)}function p(a){return m(a,"body")?a.body:a.getElementsByTagName("body")[0]}function u(a){m(window,"console")&&l(window.console,"log")&&window.console.log(a)}function q(a){r.initialized=!0;r.supported=
!1;a="Rangy is not supported on this page in your browser. Reason: "+a;r.config.alertOnFail?window.alert(a):u(a)}function z(){if(!r.initialized){var a,f=!1,d=!1;l(document,"createRange")&&(a=document.createRange(),n(a,t)&&x(a,B)&&(f=!0));a=p(document);if(!a||"body"!=a.nodeName.toLowerCase())q("No body element found");else if(a&&l(a,"createTextRange")&&(a=a.createTextRange(),c(a)&&(d=!0)),!f&&!d)q("Neither Range nor TextRange are available");else{r.initialized=!0;r.features={implementsDomRange:f,implementsTextRange:d};
var i,g;for(g in J)(i=J[g])instanceof b&&i.init(i,r);d=0;for(i=O.length;d<i;++d)try{O[d](r)}catch(h){f="Rangy init listener threw an exception. Continuing. Detail: "+(h.message||h.description||""+h),u(f)}}}}function b(a,b,f){this.name=a;this.dependencies=b;this.supported=this.initialized=!1;this.initializer=f}function g(a,f,d,i){a=new b(f,d,function(a){if(!a.initialized){a.initialized=!0;try{i(r,a),a.supported=!0}catch(b){u("Module '"+f+"' failed to load: "+(b.message||b.description||""+b))}}});J[f]=
a}function h(){}var a="function"==typeof e.define&&e.define.amd,f="object",d="function",i="undefined",B="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" "),t="setStart setStartBefore setStartAfter setEnd setEndBefore setEndAfter collapse selectNode selectNodeContents compareBoundaryPoints deleteContents extractContents cloneContents insertNode surroundContents cloneRange toString detach".split(" "),C="boundingHeight boundingLeft boundingTop boundingWidth htmlText text".split(" "),
o="collapse compareEndPoints duplicate moveToElementText parentElement select setEndPoint getBoundingClientRect".split(" "),n=k(l),w=k(m),x=k(j),J={},r={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:l,isHostObject:m,isHostProperty:j,areHostMethods:n,areHostObjects:w,areHostProperties:x,isTextRange:c,getBody:p},features:{},modules:J,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};r.fail=q;r.warn=function(a){a="Rangy warning: "+a;r.config.alertOnWarn?window.alert(a):
u(a)};({}).hasOwnProperty?r.util.extend=function(a,b,f){var d,i,c;for(c in b)b.hasOwnProperty(c)&&(d=a[c],i=b[c],f&&(null!==d&&"object"==typeof d&&null!==i&&"object"==typeof i)&&r.util.extend(d,i,!0),a[c]=i);b.hasOwnProperty("toString")&&(a.toString=b.toString);return a}:q("hasOwnProperty not supported");(function(){var a=document.createElement("div");a.appendChild(document.createElement("span"));var b=[].slice,f;try{1==b.call(a.childNodes,0)[0].nodeType&&(f=function(a){return b.call(a,0)})}catch(d){}f||
(f=function(a){for(var b=[],f=0,d=a.length;f<d;++f)b[f]=a[f];return b});r.util.toArray=f})();var K;l(document,"addEventListener")?K=function(a,b,f){a.addEventListener(b,f,!1)}:l(document,"attachEvent")?K=function(a,b,f){a.attachEvent("on"+b,f)}:q("Document does not have required addEventListener or attachEvent method");r.util.addListener=K;var O=[];r.init=z;r.addInitListener=function(a){r.initialized?a(r):O.push(a)};var L=[];r.addCreateMissingNativeApiListener=function(a){L.push(a)};r.createMissingNativeApi=
function(a){a=a||window;z();for(var b=0,f=L.length;b<f;++b)L[b](a)};b.prototype={init:function(){for(var a=this.dependencies||[],f=0,d=a.length,i,c;f<d;++f){c=a[f];i=J[c];if(!i||!(i instanceof b))throw Error("required module '"+c+"' not found");i.init();if(!i.supported)throw Error("required module '"+c+"' not supported");}this.initializer(this)},fail:function(a){this.initialized=!0;this.supported=!1;throw Error("Module '"+this.name+"' failed to load: "+a);},warn:function(a){r.warn("Module "+this.name+
": "+a)},deprecationNotice:function(a,b){r.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return Error("Error in Rangy "+this.name+" module: "+a)}};r.createModule=function(a){var b,f;2==arguments.length?(b=arguments[1],f=[]):(b=arguments[2],f=arguments[1]);g(!1,a,f,b)};r.createCoreModule=function(a,b,f){g(!0,a,b,f)};r.RangePrototype=h;r.rangePrototype=new h;r.selectionPrototype=new function(){};var N=!1,w=function(){N||(N=!0,r.initialized||
z())};typeof window==i?q("No window found"):typeof document==i?q("No document found"):(l(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",w,!1),K(window,"load",w),a&&function(a){a(function(){r.amd=!0;return r})}(e.define),e.rangy=r)})(this);
rangy.createCoreModule("DomUtil",[],function(e,l){function m(a){for(var b=0;a=a.previousSibling;)++b;return b}function j(a,b){var f=[],d;for(d=a;d;d=d.parentNode)f.push(d);for(d=b;d;d=d.parentNode)if(o(f,d))return d;return null}function k(a,b,f){for(b=f?b:b.parentNode;b;){if(b===a)return!0;b=b.parentNode}return!1}function c(a,b,f){for(f=f?a:a.parentNode;f;){a=f.parentNode;if(a===b)return f;f=a}return null}function p(a){a=a.nodeType;return 3==a||4==a||8==a}function u(a,b){var f=b.nextSibling,d=b.parentNode;
f?d.insertBefore(a,f):d.appendChild(a);return a}function q(a){if(9==a.nodeType)return a;if(typeof a.ownerDocument!=B)return a.ownerDocument;if(typeof a.document!=B)return a.document;if(a.parentNode)return q(a.parentNode);throw l.createError("getDocument: no document found for node");}function z(a){a=q(a);if(typeof a.defaultView!=B)return a.defaultView;if(typeof a.parentWindow!=B)return a.parentWindow;throw l.createError("Cannot get a window object for node");}function b(a){if(typeof a.contentDocument!=
B)return a.contentDocument;if(typeof a.contentWindow!=B)return a.contentWindow.document;throw l.createError("getIframeDocument: No Document object found for iframe element");}function g(a){return a&&t.isHostMethod(a,"setTimeout")&&t.isHostObject(a,"document")}function h(){return!1}function a(a){return!a?"[No node]":n&&h(a)?"[Broken node]":p(a)?'"'+a.data+'"':1==a.nodeType?"<"+a.nodeName+(a.id?' id="'+a.id+'"':"")+">[index:"+m(a)+",length:"+a.childNodes.length+"]["+(a.innerHTML||"[innerHTML not supported]").slice(0,
25)+"]":a.nodeName}function f(a){this._next=this.root=a}function d(a,b){this.node=a;this.offset=b}function i(a){this.code=this[a];this.codeName=a;this.message="DOMException: "+this.codeName}var B="undefined",t=e.util;t.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||l.fail("document missing a Node creation method");t.isHostMethod(document,"getElementsByTagName")||l.fail("document missing getElementsByTagName method");var C=document.createElement("div");t.areHostMethods(C,
["insertBefore","appendChild","cloneNode"])||l.fail("Incomplete Element implementation");t.isHostProperty(C,"innerHTML")||l.fail("Element is missing innerHTML property");C=document.createTextNode("test");t.areHostMethods(C,["splitText","deleteData","insertData","appendData","cloneNode"])||l.fail("Incomplete Text Node implementation");var o=function(a,b){for(var f=a.length;f--;)if(a[f]===b)return!0;return!1},n=!1;(function(){var a=document.createElement("b");a.innerHTML="1";var b=a.firstChild;a.innerHTML=
"<br>";n=h(b);e.features.crashyTextNodes=n})();var w;typeof window.getComputedStyle!=B?w=function(a,b){return z(a).getComputedStyle(a,null)[b]}:typeof document.documentElement.currentStyle!=B?w=function(a,b){return a.currentStyle[b]}:l.fail("No means of obtaining computed style properties found");f.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next,b;if(this._current){b=a.firstChild;if(!b)for(b=null;a!==this.root&&!(b=a.nextSibling);)a=a.parentNode;
this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}};d.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+a(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};i.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24};i.prototype.toString=
function(){return this.message};e.dom={arrayContains:o,isHtmlNamespace:function(a){var b;return typeof a.namespaceURI==B||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b},parentElement:function(a){a=a.parentNode;return 1==a.nodeType?a:null},getNodeIndex:m,getNodeLength:function(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}},getCommonAncestor:j,isAncestorOf:k,isOrIsAncestorOf:function(a,b){return k(a,b,!0)},getClosestAncestorIn:c,
isCharacterDataNode:p,isTextOrCommentNode:function(a){if(!a)return!1;a=a.nodeType;return 3==a||8==a},insertAfter:u,splitDataNode:function(a,b,f){var d=a.cloneNode(!1);d.deleteData(0,b);a.deleteData(b,a.length-b);u(d,a);if(f)for(var i=0,c;c=f[i++];)c.node==a&&c.offset>b?(c.node=d,c.offset-=b):c.node==a.parentNode&&c.offset>m(a)&&++c.offset;return d},getDocument:q,getWindow:z,getIframeWindow:function(a){if(typeof a.contentWindow!=B)return a.contentWindow;if(typeof a.contentDocument!=B)return a.contentDocument.defaultView;
throw l.createError("getIframeWindow: No Window object found for iframe element");},getIframeDocument:b,getBody:t.getBody,isWindow:g,getContentDocument:function(a,f,d){var i;a?t.isHostProperty(a,"nodeType")?i=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?b(a):q(a):g(a)&&(i=a.document):i=document;if(!i)throw f.createError(d+"(): Parameter must be a Window object or DOM node");return i},getRootContainer:function(a){for(var b;b=a.parentNode;)a=b;return a},comparePoints:function(a,b,f,d){var i;if(a==
f)return b===d?0:b<d?-1:1;if(i=c(f,a,!0))return b<=m(i)?-1:1;if(i=c(a,f,!0))return m(i)<d?-1:1;b=j(a,f);if(!b)throw Error("comparePoints error: nodes have no common ancestor");a=a===b?b:c(a,b,!0);f=f===b?b:c(f,b,!0);if(a===f)throw l.createError("comparePoints got to case 4 and childA and childB are the same!");for(b=b.firstChild;b;){if(b===a)return-1;if(b===f)return 1;b=b.nextSibling}},isBrokenNode:h,inspectNode:a,getComputedStyleProperty:w,fragmentFromNodeChildren:function(a){for(var b=q(a).createDocumentFragment(),
f;f=a.firstChild;)b.appendChild(f);return b},createIterator:function(a){return new f(a)},DomPosition:d};e.DOMException=i});
rangy.createCoreModule("DomRange",["DomUtil"],function(e){function l(a,b){return 3!=a.nodeType&&(s(a,b.startContainer)||s(a,b.endContainer))}function m(a){return a.document||M(a.startContainer)}function j(a){return new G(a.parentNode,P(a))}function k(a){return new G(a.parentNode,P(a)+1)}function c(a,b,f){var d=11==a.nodeType?a.firstChild:a;A(b)?f==b.length?v.insertAfter(a,b):b.parentNode.insertBefore(a,0==f?b:V(b,f)):f>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[f]);return d}
function p(a,b,f){x(a);x(b);if(m(b)!=m(a))throw new D("WRONG_DOCUMENT_ERR");var d=E(a.startContainer,a.startOffset,b.endContainer,b.endOffset),a=E(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return f?0>=d&&0<=a:0>d&&0<a}function u(a){for(var b,f,d=m(a.range).createDocumentFragment();f=a.next();){b=a.isPartiallySelectedSubtree();f=f.cloneNode(!b);b&&(b=a.getSubtreeIterator(),f.appendChild(u(b)),b.detach());if(10==f.nodeType)throw new D("HIERARCHY_REQUEST_ERR");d.appendChild(f)}return d}
function q(a,b,f){for(var d,i,f=f||{stop:!1};d=a.next();)if(a.isPartiallySelectedSubtree())if(!1===b(d)){f.stop=!0;break}else{if(d=a.getSubtreeIterator(),q(d,b,f),d.detach(),f.stop)break}else for(d=v.createIterator(d);i=d.next();)if(!1===b(i)){f.stop=!0;return}}function z(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),z(b),b.detach()):a.remove()}function b(a){for(var f,d=m(a.range).createDocumentFragment(),i;f=a.next();){a.isPartiallySelectedSubtree()?(f=f.cloneNode(!1),
i=a.getSubtreeIterator(),f.appendChild(b(i)),i.detach()):a.remove();if(10==f.nodeType)throw new D("HIERARCHY_REQUEST_ERR");d.appendChild(f)}return d}function g(b,f,d){var i=!(!f||!f.length),c,y=!!d;i&&(c=RegExp("^("+f.join("|")+")$"));var g=[];q(new a(b,!1),function(a){if(!i||c.test(a.nodeType))if(!y||d(a)){var f=b.startContainer;a==f&&A(f)&&b.startOffset==f.length||(f=b.endContainer,a==f&&A(f)&&0==b.endOffset||g.push(a))}});return g}function h(a){return"["+("undefined"==typeof a.getName?"Range":
a.getName())+"("+v.inspectNode(a.startContainer)+":"+a.startOffset+", "+v.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function a(a,b){this.range=a;this.clonePartiallySelectedTextNodes=b;if(!a.collapsed){this.sc=a.startContainer;this.so=a.startOffset;this.ec=a.endContainer;this.eo=a.endOffset;var f=a.commonAncestorContainer;this.sc===this.ec&&A(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===f&&!A(this.sc)?this.sc.childNodes[this.so]:
U(this.sc,f,!0),this._last=this.ec===f&&!A(this.ec)?this.ec.childNodes[this.eo-1]:U(this.ec,f,!0))}}function f(a){return function(b,f){for(var d,i=f?b:b.parentNode;i;){d=i.nodeType;if(R(a,d))return i;i=i.parentNode}return null}}function d(a,b){if(ka(a,b))throw new D("INVALID_NODE_TYPE_ERR");}function i(a,b){if(!R(b,a.nodeType))throw new D("INVALID_NODE_TYPE_ERR");}function B(a,b){if(0>b||b>(A(a)?a.length:a.childNodes.length))throw new D("INDEX_SIZE_ERR");}function t(a,b){if(Q(a,!0)!==Q(b,!0))throw new D("WRONG_DOCUMENT_ERR");
}function C(a){if(y(a,!0))throw new D("NO_MODIFICATION_ALLOWED_ERR");}function o(a,b){if(!a)throw new D(b);}function n(a){return W&&v.isBrokenNode(a)||!R(X,a.nodeType)&&!Q(a,!0)}function w(a){return!!a.startContainer&&!!a.endContainer&&!n(a.startContainer)&&!n(a.endContainer)&&a.startOffset<=(A(a.startContainer)?a.startContainer.length:a.startContainer.childNodes.length)&&a.endOffset<=(A(a.endContainer)?a.endContainer.length:a.endContainer.childNodes.length)}function x(a){if(!w(a))throw Error("Range error: Range is no longer valid after DOM mutation ("+
a.inspect()+")");}function J(a,b){x(a);var f=a.startContainer,d=a.startOffset,i=a.endContainer,c=a.endOffset,y=f===i;A(i)&&(0<c&&c<i.length)&&V(i,c,b);A(f)&&(0<d&&d<f.length)&&(f=V(f,d,b),y?(c-=d,i=f):i==f.parentNode&&c>=P(f)&&c++,d=0);a.setStartAndEnd(f,d,i,c)}function r(a){a.START_TO_START=aa;a.START_TO_END=ea;a.END_TO_END=la;a.END_TO_START=fa;a.NODE_BEFORE=ga;a.NODE_AFTER=ha;a.NODE_BEFORE_AND_AFTER=ia;a.NODE_INSIDE=ba}function K(a){r(a);r(a.prototype)}function O(b,f){return function(){x(this);
var d=this.startContainer,i=this.startOffset,c=this.commonAncestorContainer,y=new a(this,!0);d!==c&&(d=U(d,c,!0),i=k(d),d=i.node,i=i.offset);q(y,C);y.reset();c=b(y);y.detach();f(this,d,i,d,i);return c}}function L(f,c){function y(a,b){return function(f){i(f,S);i(I(f),X);f=(a?j:k)(f);(b?g:t)(this,f.node,f.offset)}}function g(a,b,f){var d=a.endContainer,i=a.endOffset;if(b!==a.startContainer||f!==a.startOffset){if(I(b)!=I(d)||1==E(b,f,d,i))d=b,i=f;c(a,b,f,d,i)}}function t(a,b,f){var d=a.startContainer,
i=a.startOffset;if(b!==a.endContainer||f!==a.endOffset){if(I(b)!=I(d)||-1==E(b,f,d,i))d=b,i=f;c(a,d,i,b,f)}}var h=function(){};h.prototype=e.rangePrototype;f.prototype=new h;T.extend(f.prototype,{setStart:function(a,b){d(a,!0);B(a,b);g(this,a,b)},setEnd:function(a,b){d(a,!0);B(a,b);t(this,a,b)},setStartAndEnd:function(){var a=arguments,b=a[0],f=a[1],d=b,i=f;switch(a.length){case 3:i=a[2];break;case 4:d=a[2],i=a[3]}c(this,b,f,d,i)},setBoundary:function(a,b,f){this["set"+(f?"Start":"End")](a,b)},setStartBefore:y(!0,
!0),setStartAfter:y(!1,!0),setEndBefore:y(!0,!1),setEndAfter:y(!1,!1),collapse:function(a){x(this);a?c(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):c(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){d(a,!0);c(this,a,0,a,Y(a))},selectNode:function(a){d(a,!1);i(a,S);var b=j(a),a=k(a);c(this,b.node,b.offset,a.node,a.offset)},extractContents:O(b,c),deleteContents:O(z,c),canSurroundContents:function(){x(this);C(this.startContainer);
C(this.endContainer);var b=new a(this,!0),f=b._first&&l(b._first,this)||b._last&&l(b._last,this);b.detach();return!f},splitBoundaries:function(){J(this)},splitBoundariesPreservingPositions:function(a){J(this,a)},normalizeBoundaries:function(){x(this);var a=this.startContainer,b=this.startOffset,f=this.endContainer,d=this.endOffset,i=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(f=a,d=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},y=function(i){var c=i.previousSibling;if(c&&
c.nodeType==i.nodeType){a=i;var y=i.length;b=c.length;i.insertData(0,c.data);c.parentNode.removeChild(c);a==f?(d+=b,f=a):f==i.parentNode&&(c=P(i),d==c?(f=i,d=y):d>c&&d--)}},g=!0;A(f)?f.length==d&&i(f):(0<d&&(g=f.childNodes[d-1])&&A(g)&&i(g),g=!this.collapsed);g?A(a)?0==b&&y(a):b<a.childNodes.length&&(i=a.childNodes[b])&&A(i)&&y(i):(a=f,b=d);c(this,a,b,f,d)},collapseToPoint:function(a,b){d(a,!0);B(a,b);this.setStartAndEnd(a,b)}});K(f)}function N(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===
a.endOffset;a.commonAncestorContainer=a.collapsed?a.startContainer:v.getCommonAncestor(a.startContainer,a.endContainer)}function H(a,b,f,d,i){a.startContainer=b;a.startOffset=f;a.endContainer=d;a.endOffset=i;a.document=v.getDocument(b);N(a)}function F(a){this.startContainer=a;this.startOffset=0;this.endContainer=a;this.endOffset=0;this.document=a;N(this)}var v=e.dom,T=e.util,G=v.DomPosition,D=e.DOMException,A=v.isCharacterDataNode,P=v.getNodeIndex,s=v.isOrIsAncestorOf,M=v.getDocument,E=v.comparePoints,
V=v.splitDataNode,U=v.getClosestAncestorIn,Y=v.getNodeLength,R=v.arrayContains,I=v.getRootContainer,W=e.features.crashyTextNodes;a.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;a&&(this._next=a!==this._last?a.nextSibling:null,A(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,
a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so)));return a},remove:function(){var a=this._current,b,f;A(a)&&(a===this.sc||a===this.ec)?(b=a===this.sc?this.so:0,f=a===this.ec?this.eo:a.length,b!=f&&a.deleteData(b,f-b)):a.parentNode&&a.parentNode.removeChild(a)},isPartiallySelectedSubtree:function(){return l(this._current,this.range)},getSubtreeIterator:function(){var b;if(this.isSingleCharacterDataNode)b=this.range.cloneRange(),b.collapse(!1);else{b=new F(m(this.range));
var f=this._current,d=f,i=0,c=f,y=Y(f);s(f,this.sc)&&(d=this.sc,i=this.so);s(f,this.ec)&&(c=this.ec,y=this.eo);H(b,d,i,c,y)}return new a(b,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var S=[1,3,4,5,7,8,10],X=[2,9,11],Z=[1,3,4,5,7,8,10,11],$=[1,3,4,5,7,8],Q=f([9,11]),y=f([5,6,10,12]),ka=f([6,10,12]),ja=document.createElement("style"),ca=!1;try{ja.innerHTML="<b>x</b>",ca=3==ja.firstChild.nodeType}catch(ma){}e.features.htmlParsingConforms=
ca;var da="startContainer startOffset endContainer endOffset collapsed commonAncestorContainer".split(" "),aa=0,ea=1,la=2,fa=3,ga=0,ha=1,ia=2,ba=3;T.extend(e.rangePrototype,{compareBoundaryPoints:function(a,b){x(this);t(this.startContainer,b.startContainer);var f=a==fa||a==aa?"start":"end",d=a==ea||a==aa?"start":"end";return E(this[f+"Container"],this[f+"Offset"],b[d+"Container"],b[d+"Offset"])},insertNode:function(a){x(this);i(a,Z);C(this.startContainer);if(s(a,this.startContainer))throw new D("HIERARCHY_REQUEST_ERR");
this.setStartBefore(c(a,this.startContainer,this.startOffset))},cloneContents:function(){x(this);var b,f;if(this.collapsed)return m(this).createDocumentFragment();if(this.startContainer===this.endContainer&&A(this.startContainer))return b=this.startContainer.cloneNode(!0),b.data=b.data.slice(this.startOffset,this.endOffset),f=m(this).createDocumentFragment(),f.appendChild(b),f;f=new a(this,!0);b=u(f);f.detach();return b},canSurroundContents:function(){x(this);C(this.startContainer);C(this.endContainer);
var b=new a(this,!0),f=b._first&&l(b._first,this)||b._last&&l(b._last,this);b.detach();return!f},surroundContents:function(a){i(a,$);if(!this.canSurroundContents())throw new D("INVALID_STATE_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);c(a,this.startContainer,this.startOffset);a.appendChild(b);this.selectNode(a)},cloneRange:function(){x(this);for(var a=new F(m(this)),b=da.length,f;b--;)f=da[b],a[f]=this[f];return a},toString:function(){x(this);
var b=this.startContainer;if(b===this.endContainer&&A(b))return 3==b.nodeType||4==b.nodeType?b.data.slice(this.startOffset,this.endOffset):"";var f=[],b=new a(this,!0);q(b,function(a){(3==a.nodeType||4==a.nodeType)&&f.push(a.data)});b.detach();return f.join("")},compareNode:function(a){x(this);var b=a.parentNode,f=P(a);if(!b)throw new D("NOT_FOUND_ERR");a=this.comparePoint(b,f);b=this.comparePoint(b,f+1);return 0>a?0<b?ia:ga:0<b?ha:ba},comparePoint:function(a,b){x(this);o(a,"HIERARCHY_REQUEST_ERR");
t(a,this.startContainer);return 0>E(a,b,this.startContainer,this.startOffset)?-1:0<E(a,b,this.endContainer,this.endOffset)?1:0},createContextualFragment:ca?function(a){var b=this.startContainer,f=M(b);if(!b)throw new D("INVALID_STATE_ERR");var d=null;1==b.nodeType?d=b:A(b)&&(d=v.parentElement(b));d=null===d||"HTML"==d.nodeName&&v.isHtmlNamespace(M(d).documentElement)&&v.isHtmlNamespace(d)?f.createElement("body"):d.cloneNode(!1);d.innerHTML=a;return v.fragmentFromNodeChildren(d)}:function(a){var b=
m(this).createElement("body");b.innerHTML=a;return v.fragmentFromNodeChildren(b)},toHtml:function(){x(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);a.appendChild(this.cloneContents());return a.innerHTML},intersectsNode:function(a,b){x(this);o(a,"NOT_FOUND_ERR");if(M(a)!==m(this))return!1;var f=a.parentNode,d=P(a);o(f,"NOT_FOUND_ERR");var i=E(f,d,this.endContainer,this.endOffset),f=E(f,d+1,this.startContainer,this.startOffset);return b?0>=i&&0<=f:0>i&&0<f},isPointInRange:function(a,
b){x(this);o(a,"HIERARCHY_REQUEST_ERR");t(a,this.startContainer);return 0<=E(a,b,this.startContainer,this.startOffset)&&0>=E(a,b,this.endContainer,this.endOffset)},intersectsRange:function(a){return p(this,a,!1)},intersectsOrTouchesRange:function(a){return p(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=E(this.startContainer,this.startOffset,a.startContainer,a.startOffset),f=E(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();-1==b&&d.setStart(a.startContainer,
a.startOffset);1==f&&d.setEnd(a.endContainer,a.endOffset);return d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();-1==E(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset);1==E(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset);return b}throw new D("Ranges do not intersect");},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==
ba},containsNodeContents:function(a){return 0<=this.comparePoint(a,0)&&0>=this.comparePoint(a,Y(a))},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var f=b.getNodes([3]);return 0<f.length?(b.setStart(f[0],0),a=f.pop(),b.setEnd(a,a.length),this.containsRange(b)):this.containsNodeContents(a)},getNodes:function(a,b){x(this);return g(this,a,b)},getDocument:function(){return m(this)},collapseBefore:function(a){this.setEndBefore(a);
this.collapse(!1)},collapseAfter:function(a){this.setStartAfter(a);this.collapse(!0)},getBookmark:function(a){var b=m(this),f=e.createRange(b),a=a||v.getBody(b);f.selectNodeContents(a);var b=this.intersection(f),d=0,i=0;b&&(f.setEnd(b.startContainer,b.startOffset),d=f.toString().length,i=d+b.toString().length);return{start:d,end:i,containerNode:a}},moveToBookmark:function(a){var b=a.containerNode,f=0;this.setStart(b,0);this.collapse(!0);for(var b=[b],d,i=!1,c=!1,y,g;!c&&(d=b.pop());)if(3==d.nodeType)y=
f+d.length,!i&&(a.start>=f&&a.start<=y)&&(this.setStart(d,a.start-f),i=!0),i&&(a.end>=f&&a.end<=y)&&(this.setEnd(d,a.end-f),c=!0),f=y;else{g=d.childNodes;for(y=g.length;y--;)b.push(g[y])}},getName:function(){return"DomRange"},equals:function(a){return F.rangesEqual(this,a)},isValid:function(){return w(this)},inspect:function(){return h(this)},detach:function(){}});L(F,H);T.extend(F,{rangeProperties:da,RangeIterator:a,copyComparisonConstants:K,createPrototypeRange:L,inspect:h,getRangeDocument:m,rangesEqual:function(a,
b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}});e.DomRange=F});
rangy.createCoreModule("WrappedRange",["DomRange"],function(e,l){var m,j,k=e.dom,c=e.util,p=k.DomPosition,u=e.DomRange,q=k.getBody,z=k.getContentDocument,b=k.isCharacterDataNode;e.features.implementsDomRange&&function(){function a(b){for(var f=i.length,d;f--;)d=i[f],b[d]=b.nativeRange[d];b.collapsed=b.startContainer===b.endContainer&&b.startOffset===b.endOffset}var b,i=u.rangeProperties,g;m=function(b){if(!b)throw l.createError("WrappedRange: Range must be specified");this.nativeRange=b;a(this)};
u.createPrototypeRange(m,function(a,b,f,d,i){var c=a.startContainer!==b||a.startOffset!=f,g=a.endContainer!==d||a.endOffset!=i,t=!a.equals(a.nativeRange);if(c||g||t)a.setEnd(d,i),a.setStart(b,f)});b=m.prototype;b.selectNode=function(b){this.nativeRange.selectNode(b);a(this)};b.cloneContents=function(){return this.nativeRange.cloneContents()};b.surroundContents=function(b){this.nativeRange.surroundContents(b);a(this)};b.collapse=function(b){this.nativeRange.collapse(b);a(this)};b.cloneRange=function(){return new m(this.nativeRange.cloneRange())};
b.refresh=function(){a(this)};b.toString=function(){return this.nativeRange.toString()};var t=document.createTextNode("test");q(document).appendChild(t);var h=document.createRange();h.setStart(t,0);h.setEnd(t,0);try{h.setStart(t,1),b.setStart=function(b,d){this.nativeRange.setStart(b,d);a(this)},b.setEnd=function(b,d){this.nativeRange.setEnd(b,d);a(this)},g=function(b){return function(d){this.nativeRange[b](d);a(this)}}}catch(j){b.setStart=function(b,d){try{this.nativeRange.setStart(b,d)}catch(i){this.nativeRange.setEnd(b,
d),this.nativeRange.setStart(b,d)}a(this)},b.setEnd=function(b,d){try{this.nativeRange.setEnd(b,d)}catch(i){this.nativeRange.setStart(b,d),this.nativeRange.setEnd(b,d)}a(this)},g=function(b,d){return function(i){try{this.nativeRange[b](i)}catch(c){this.nativeRange[d](i),this.nativeRange[b](i)}a(this)}}}b.setStartBefore=g("setStartBefore","setEndBefore");b.setStartAfter=g("setStartAfter","setEndAfter");b.setEndBefore=g("setEndBefore","setStartBefore");b.setEndAfter=g("setEndAfter","setStartAfter");
b.selectNodeContents=function(a){this.setStartAndEnd(a,0,k.getNodeLength(a))};h.selectNodeContents(t);h.setEnd(t,3);g=document.createRange();g.selectNodeContents(t);g.setEnd(t,4);g.setStart(t,2);b.compareBoundaryPoints=-1==h.compareBoundaryPoints(h.START_TO_END,g)&&1==h.compareBoundaryPoints(h.END_TO_START,g)?function(a,b){b=b.nativeRange||b;a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END);return this.nativeRange.compareBoundaryPoints(a,b)}:function(a,b){return this.nativeRange.compareBoundaryPoints(a,
b.nativeRange||b)};g=document.createElement("div");g.innerHTML="123";var n=g.firstChild,w=q(document);w.appendChild(g);h.setStart(n,1);h.setEnd(n,2);h.deleteContents();"13"==n.data&&(b.deleteContents=function(){this.nativeRange.deleteContents();a(this)},b.extractContents=function(){var b=this.nativeRange.extractContents();a(this);return b});w.removeChild(g);w=null;c.isHostMethod(h,"createContextualFragment")&&(b.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)});
q(document).removeChild(t);b.getName=function(){return"WrappedRange"};e.WrappedRange=m;e.createNativeRange=function(a){a=z(a,l,"createNativeRange");return a.createRange()}}();if(e.features.implementsTextRange){var g=function(a,d,i,c,g){var h=a.duplicate();h.collapse(i);var j=h.parentElement();k.isOrIsAncestorOf(d,j)||(j=d);if(!j.canHaveHTML)return j=new p(j.parentNode,k.getNodeIndex(j)),{boundaryPosition:j,nodeInfo:{nodeIndex:j.offset,containerElement:j.node}};d=k.getDocument(j).createElement("span");
d.parentNode&&d.parentNode.removeChild(d);for(var e,w=i?"StartToStart":"StartToEnd",l=g&&g.containerElement==j?g.nodeIndex:0,m=j.childNodes.length,r=m,g=r;;){g==m?j.appendChild(d):j.insertBefore(d,j.childNodes[g]);h.moveToElementText(d);e=h.compareEndPoints(w,a);if(0==e||l==r)break;else if(-1==e)if(r==l+1)break;else l=g;else r=r==l+1?l:g;g=Math.floor((l+r)/2);j.removeChild(d)}w=d.nextSibling;if(-1==e&&w&&b(w)){h.setEndPoint(i?"EndToStart":"EndToEnd",a);if(/[\r\n]/.test(w.data)){i=h.duplicate();c=
i.text.replace(/\r\n/g,"\r").length;for(c=i.moveStart("character",c);-1==i.compareEndPoints("StartToEnd",i);)c++,i.moveStart("character",1)}else c=h.text.length;i=new p(w,c)}else a=(c||!i)&&d.previousSibling,i=(i=(c||i)&&d.nextSibling)&&b(i)?new p(i,0):a&&b(a)?new p(a,a.data.length):new p(j,k.getNodeIndex(d));d.parentNode.removeChild(d);return{boundaryPosition:i,nodeInfo:{nodeIndex:g,containerElement:j}}},h=function(a,d){var i,c,g=a.offset,h=k.getDocument(a.node),j=q(h).createTextRange(),e=b(a.node);
e?(i=a.node,c=i.parentNode):(i=a.node.childNodes,i=g<i.length?i[g]:null,c=a.node);h=h.createElement("span");h.innerHTML="&#feff;";i?c.insertBefore(h,i):c.appendChild(h);j.moveToElementText(h);j.collapse(!d);c.removeChild(h);if(e)j[d?"moveStart":"moveEnd"]("character",g);return j};j=function(a){this.textRange=a;this.refresh()};j.prototype=new u(document);j.prototype.refresh=function(){var a,b,i;i=this.textRange;a=i.parentElement();var c=i.duplicate();c.collapse(!0);b=c.parentElement();c=i.duplicate();
c.collapse(!1);i=c.parentElement();b=b==i?b:k.getCommonAncestor(b,i);i=b==a?b:k.getCommonAncestor(a,b);0==this.textRange.compareEndPoints("StartToEnd",this.textRange)?b=a=g(this.textRange,i,!0,!0).boundaryPosition:(b=g(this.textRange,i,!0,!1),a=b.boundaryPosition,b=g(this.textRange,i,!1,!1,b.nodeInfo).boundaryPosition);this.setStart(a.node,a.offset);this.setEnd(b.node,b.offset)};j.prototype.getName=function(){return"WrappedTextRange"};u.copyComparisonConstants(j);j.rangeToTextRange=function(a){if(a.collapsed)return h(new p(a.startContainer,
a.startOffset),!0);var b=h(new p(a.startContainer,a.startOffset),!0),i=h(new p(a.endContainer,a.endOffset),!1),a=q(u.getRangeDocument(a)).createTextRange();a.setEndPoint("StartToStart",b);a.setEndPoint("EndToEnd",i);return a};e.WrappedTextRange=j;if(!e.features.implementsDomRange||e.config.preferTextRange){var a=function(){return this}();"undefined"==typeof a.Range&&(a.Range=j);e.createNativeRange=function(a){a=z(a,l,"createNativeRange");return q(a).createTextRange()};e.WrappedRange=j}}e.createRange=
function(a){a=z(a,l,"createRange");return new e.WrappedRange(e.createNativeRange(a))};e.createRangyRange=function(a){a=z(a,l,"createRangyRange");return new u(a)};e.createIframeRange=function(a){l.deprecationNotice("createIframeRange()","createRange(iframeEl)");return e.createRange(a)};e.createIframeRangyRange=function(a){l.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)");return e.createRangyRange(a)};e.addCreateMissingNativeApiListener(function(a){var b=a.document;"undefined"==
typeof b.createRange&&(b.createRange=function(){return e.createRange(b)});b=a=null})});
rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,l){function m(a){return"string"==typeof a?/^backward(s)?$/i.test(a):!!a}function j(a,b){if(a){if(n.isWindow(a))return a;if(a instanceof f)return a.win;var d=n.getContentDocument(a,l,b);return n.getWindow(d)}return window}function k(a){return j(a,"getWinSelection").getSelection()}function c(a){return j(a,"getDocSelection").document.selection}function p(a){var b=!1;a.anchorNode&&(b=1==n.comparePoints(a.anchorNode,a.anchorOffset,
a.focusNode,a.focusOffset));return b}function u(a,b,f){var d=f?"end":"start",f=f?"start":"end";a.anchorNode=b[d+"Container"];a.anchorOffset=b[d+"Offset"];a.focusNode=b[f+"Container"];a.focusOffset=b[f+"Offset"]}function q(a){a.anchorNode=a.focusNode=null;a.anchorOffset=a.focusOffset=0;a.rangeCount=0;a.isCollapsed=!0;a._ranges.length=0}function z(a){var b;a instanceof J?(b=e.createNativeRange(a.getDocument()),b.setEnd(a.endContainer,a.endOffset),b.setStart(a.startContainer,a.startOffset)):a instanceof
r?b=a.nativeRange:H.implementsDomRange&&a instanceof n.getWindow(a.startContainer).Range&&(b=a);return b}function b(a){var b=a.getNodes(),f;a:if(!b.length||1!=b[0].nodeType)f=!1;else{f=1;for(var d=b.length;f<d;++f)if(!n.isAncestorOf(b[0],b[f])){f=!1;break a}f=!0}if(!f)throw l.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return b[0]}function g(a,b){var f=new r(b);a._ranges=[f];u(a,f,!1);a.rangeCount=1;a.isCollapsed=f.collapsed}function h(a){a._ranges.length=
0;if("None"==a.docSelection.type)q(a);else{var b=a.docSelection.createRange();if(b&&"undefined"!=typeof b.text)g(a,b);else{a.rangeCount=b.length;for(var f,d=F(b.item(0)),i=0;i<a.rangeCount;++i)f=e.createRange(d),f.selectNode(b.item(i)),a._ranges.push(f);a.isCollapsed=1==a.rangeCount&&a._ranges[0].collapsed;u(a,a._ranges[a.rangeCount-1],!1)}}}function a(a,f){for(var d=a.docSelection.createRange(),i=b(f),c=F(d.item(0)),c=v(c).createControlRange(),g=0,t=d.length;g<t;++g)c.add(d.item(g));try{c.add(i)}catch(B){throw l.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)");
}c.select();h(a)}function f(a,b,f){this.nativeSelection=a;this.docSelection=b;this._ranges=[];this.win=f;this.refresh()}function d(a){a.win=a.anchorNode=a.focusNode=a._ranges=null;a.rangeCount=a.anchorOffset=a.focusOffset=0;a.detached=!0}function i(a,b){for(var f=S.length,i,c;f--;)if(i=S[f],c=i.selection,"deleteAll"==b)d(c);else if(i.win==a)return"delete"==b?(S.splice(f,1),!0):c;"deleteAll"==b&&(S.length=0);return null}function B(a,f){for(var d=F(f[0].startContainer),d=v(d).createControlRange(),i=
0,c,g=f.length;i<g;++i){c=b(f[i]);try{d.add(c)}catch(t){throw l.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)");}}d.select();h(a)}function t(a,b){if(a.win.document!=F(b))throw new K("WRONG_DOCUMENT_ERR");}function C(a){return function(b,f){var d;this.rangeCount?(d=this.getRangeAt(0),d["set"+(a?"Start":"End")](b,f)):(d=e.createRange(this.win.document),d.setStartAndEnd(b,f));this.setSingleRange(d,this.isBackward())}}
function o(a){var b=[],f=new O(a.anchorNode,a.anchorOffset),d=new O(a.focusNode,a.focusOffset),i="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var c=0,g=a.rangeCount;c<g;++c)b[c]=J.inspect(a.getRangeAt(c));return"["+i+"(Ranges: "+b.join(", ")+")(anchor: "+f.inspect()+", focus: "+d.inspect()+"]"}e.config.checkSelectionRanges=!0;var n=e.dom,w=e.util,x=w.isHostMethod,J=e.DomRange,r=e.WrappedRange,K=e.DOMException,O=n.DomPosition,L,N,H=e.features,F=n.getDocument,
v=n.getBody,T=J.rangesEqual,G=x(window,"getSelection"),D=w.isHostObject(document,"selection");H.implementsWinGetSelection=G;var A=(H.implementsDocSelection=D)&&(!G||e.config.preferTextRange);A?(L=c,e.isSelectionValid=function(a){var a=j(a,"isSelectionValid").document,b=a.selection;return"None"!=b.type||F(b.createRange().parentElement())==a}):G?(L=k,e.isSelectionValid=function(){return!0}):l.fail("Neither document.selection or window.getSelection() detected.");e.getNativeSelection=L;var G=L(),P=e.createNativeRange(document),
s=v(document),M=w.areHostProperties(G,["anchorNode","focusNode","anchorOffset","focusOffset"]);H.selectionHasAnchorAndFocus=M;var E=x(G,"extend");H.selectionHasExtend=E;var V="number"==typeof G.rangeCount;H.selectionHasRangeCount=V;var U=!1,Y=!0,R=E?function(a,b){var f=J.getRangeDocument(b),f=e.createRange(f);f.collapseToPoint(b.endContainer,b.endOffset);a.addRange(z(f));a.extend(b.startContainer,b.startOffset)}:null;w.areHostMethods(G,["addRange","getRangeAt","removeAllRanges"])&&("number"==typeof G.rangeCount&&
H.implementsDomRange)&&function(){var a=window.getSelection();if(a){for(var b=a.rangeCount,f=b>1,d=[],i=p(a),c=0;c<b;++c)d[c]=a.getRangeAt(c);var c=v(document),g=c.appendChild(document.createElement("div"));g.contentEditable="false";var t=g.appendChild(document.createTextNode("   ")),h=document.createRange();h.setStart(t,1);h.collapse(true);a.addRange(h);Y=a.rangeCount==1;a.removeAllRanges();if(!f){f=h.cloneRange();h.setStart(t,0);f.setEnd(t,3);f.setStart(t,2);a.addRange(h);a.addRange(f);U=a.rangeCount==
2;f.detach()}c.removeChild(g);a.removeAllRanges();for(c=0;c<b;++c)if(c==0&&i)if(R)R(a,d[c]);else{e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend");a.addRange(d[c])}else a.addRange(d[c])}}();H.selectionSupportsMultipleRanges=U;H.collapsedNonEditableSelectionsSupported=Y;var I=!1;s&&x(s,"createControlRange")&&(s=s.createControlRange(),w.areHostProperties(s,["item","add"])&&(I=!0));H.implementsControlRange=
I;N=M?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:false};var W;x(G,"getRangeAt")?W=function(a,b){try{return a.getRangeAt(b)}catch(f){return null}}:M&&(W=function(a){var b=F(a.anchorNode),b=e.createRange(b);b.setStartAndEnd(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset);b.collapsed!==this.isCollapsed&&b.setStartAndEnd(a.focusNode,a.focusOffset,a.anchorNode,a.anchorOffset);return b});f.prototype=
e.selectionPrototype;var S=[],X=function(a){if(a&&a instanceof f){a.refresh();return a}var a=j(a,"getNativeSelection"),b=i(a),d=L(a),g=D?c(a):null;if(b){b.nativeSelection=d;b.docSelection=g;b.refresh()}else{b=new f(d,g,a);S.push({win:a,selection:b})}return b};e.getSelection=X;e.getIframeSelection=function(a){l.deprecationNotice("getIframeSelection()","getSelection(iframeEl)");return e.getSelection(n.getIframeWindow(a))};s=f.prototype;if(!A&&M&&w.areHostMethods(G,["removeAllRanges","addRange"]))s.removeAllRanges=
function(){this.nativeSelection.removeAllRanges();q(this)},s.addRange=V?function(b,f){if(I&&D&&this.docSelection.type=="Control")a(this,b);else if(m(f)&&E){R(this.nativeSelection,b);this.refresh()}else{var d;if(U)d=this.rangeCount;else{this.removeAllRanges();d=0}this.nativeSelection.addRange(z(b).cloneRange());this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==d+1){if(e.config.checkSelectionRanges)(d=W(this.nativeSelection,this.rangeCount-1))&&!T(d,b)&&(b=new r(d));this._ranges[this.rangeCount-
1]=b;u(this,b,Q(this.nativeSelection));this.isCollapsed=N(this)}else this.refresh()}}:function(a,b){m(b)&&E?R(this.nativeSelection,a):this.nativeSelection.addRange(z(a));this.refresh()},s.setRanges=function(a){if(I&&a.length>1)B(this,a);else{this.removeAllRanges();for(var b=0,f=a.length;b<f;++b)this.addRange(a[b])}};else if(x(G,"empty")&&x(P,"select")&&I&&A)s.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var a;if(this.anchorNode)a=F(this.anchorNode);else if(this.docSelection.type==
"Control"){var b=this.docSelection.createRange();b.length&&(a=F(b.item(0)))}if(a){v(a).createTextRange().select();this.docSelection.empty()}}}catch(f){}q(this)},s.addRange=function(b){if(this.docSelection.type=="Control")a(this,b);else{e.WrappedTextRange.rangeToTextRange(b).select();this._ranges[0]=b;this.rangeCount=1;this.isCollapsed=this._ranges[0].collapsed;u(this,b,false)}},s.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?B(this,a):b&&this.addRange(a[0])};else return l.fail("No means of selecting a Range or TextRange was found"),
!1;s.getRangeAt=function(a){if(a<0||a>=this.rangeCount)throw new K("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var Z;if(A)Z=function(a){var b;if(e.isSelectionValid(a.win))b=a.docSelection.createRange();else{b=v(a.win.document).createTextRange();b.collapse(true)}a.docSelection.type=="Control"?h(a):b&&typeof b.text!="undefined"?g(a,b):q(a)};else if(x(G,"getRangeAt")&&"number"==typeof G.rangeCount)Z=function(a){if(I&&D&&a.docSelection.type=="Control")h(a);else{a._ranges.length=a.rangeCount=
a.nativeSelection.rangeCount;if(a.rangeCount){for(var b=0,f=a.rangeCount;b<f;++b)a._ranges[b]=new e.WrappedRange(a.nativeSelection.getRangeAt(b));u(a,a._ranges[a.rangeCount-1],Q(a.nativeSelection));a.isCollapsed=N(a)}else q(a)}};else if(M&&"boolean"==typeof G.isCollapsed&&"boolean"==typeof P.collapsed&&H.implementsDomRange)Z=function(a){var b;b=a.nativeSelection;if(b.anchorNode){b=W(b,0);a._ranges=[b];a.rangeCount=1;b=a.nativeSelection;a.anchorNode=b.anchorNode;a.anchorOffset=b.anchorOffset;a.focusNode=
b.focusNode;a.focusOffset=b.focusOffset;a.isCollapsed=N(a)}else q(a)};else return l.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;s.refresh=function(a){var b=a?this._ranges.slice(0):null,f=this.anchorNode,d=this.anchorOffset;Z(this);if(a){a=b.length;if(a!=this._ranges.length||this.anchorNode!=f||this.anchorOffset!=d)return true;for(;a--;)if(!T(b[a],this._ranges[a]))return true;return false}};var $=function(a,b){var f=a.getAllRanges();a.removeAllRanges();
for(var d=0,i=f.length;d<i;++d)T(b,f[d])||a.addRange(f[d]);a.rangeCount||q(a)};s.removeRange=I?function(a){if(this.docSelection.type=="Control"){for(var f=this.docSelection.createRange(),a=b(a),d=F(f.item(0)),d=v(d).createControlRange(),i,c=false,g=0,t=f.length;g<t;++g){i=f.item(g);i!==a||c?d.add(f.item(g)):c=true}d.select();h(this)}else $(this,a)}:function(a){$(this,a)};var Q;!A&&M&&H.implementsDomRange?(Q=p,s.isBackward=function(){return Q(this)}):Q=s.isBackward=function(){return false};s.isBackwards=
s.isBackward;s.toString=function(){for(var a=[],b=0,f=this.rangeCount;b<f;++b)a[b]=""+this._ranges[b];return a.join("")};s.collapse=function(a,b){t(this,a);var f=e.createRange(a);f.collapseToPoint(a,b);this.setSingleRange(f);this.isCollapsed=true};s.collapseToStart=function(){if(this.rangeCount){var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)}else throw new K("INVALID_STATE_ERR");};s.collapseToEnd=function(){if(this.rangeCount){var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,
a.endOffset)}else throw new K("INVALID_STATE_ERR");};s.selectAllChildren=function(a){t(this,a);var b=e.createRange(a);b.selectNodeContents(a);this.setSingleRange(b)};s.deleteFromDocument=function(){if(I&&D&&this.docSelection.type=="Control"){for(var a=this.docSelection.createRange(),b;a.length;){b=a.item(0);a.remove(b);b.parentNode.removeChild(b)}this.refresh()}else if(this.rangeCount){a=this.getAllRanges();if(a.length){this.removeAllRanges();b=0;for(var f=a.length;b<f;++b)a[b].deleteContents();this.addRange(a[f-
1])}}};s.eachRange=function(a,b){for(var f=0,d=this._ranges.length;f<d;++f)if(a(this.getRangeAt(f)))return b};s.getAllRanges=function(){var a=[];this.eachRange(function(b){a.push(b)});return a};s.setSingleRange=function(a,b){this.removeAllRanges();this.addRange(a,b)};s.callMethodOnEachRange=function(a,b){var f=[];this.eachRange(function(d){f.push(d[a].apply(d,b))});return f};s.setStart=C(!0);s.setEnd=C(!1);e.rangePrototype.select=function(a){X(this.getDocument()).setSingleRange(this,a)};s.changeEachRange=
function(a){var b=[],f=this.isBackward();this.eachRange(function(f){a(f);b.push(f)});this.removeAllRanges();f&&b.length==1?this.addRange(b[0],"backward"):this.setRanges(b)};s.containsNode=function(a,b){return this.eachRange(function(f){return f.containsNode(a,b)},true)};s.getBookmark=function(a){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[a])}};s.moveToBookmark=function(a){for(var b=[],f=0,d,i;d=a.rangeBookmarks[f++];){i=e.createRange(this.win);i.moveToBookmark(d);
b.push(i)}a.backward?this.setSingleRange(b[0],"backward"):this.setRanges(b)};s.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")};s.getName=function(){return"WrappedSelection"};s.inspect=function(){return o(this)};s.detach=function(){i(this.win,"delete");d(this)};f.detachAll=function(){i(null,"deleteAll")};f.inspect=o;f.isDirectionBackward=m;e.Selection=f;e.selectionPrototype=s;e.addCreateMissingNativeApiListener(function(a){if(typeof a.getSelection=="undefined")a.getSelection=
function(){return X(a)};a=null})});
(function(e){function l(a){return a}function m(a){var b=e.map(a.attributes,function(a){return a.name});e(a).removeClass();e.each(b,function(b,f){a.removeAttribute(f)})}function j(a){return z==ice.dom.getTagName(a)}function k(a){a=ice.dom.getTagName(a);return z===a||b===a}function c(a,b,d){var i=a.length;if(0>b||b>=i)return a;b+d>=i&&(d=i-b);if(d===i)return a;a=0<b?a.splitText(b):a;a.length>d&&a.splitText(d);return a}function p(a,b,d,i){i?(d=d.createTextNode("﻿"),a?a.appendChild(d):b.insertNode(d),
b.selectNode(d)):a&&b.selectNodeContents(a)}var u,q,z="br",b="p";u={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",sessionId:"data-session-id",time:"data-time",lastTime:"data-last-change-time",changeData:"data-changedata"},attrValuePrefix:"",blockEl:"p",blockEls:"div p ol ul li h1 h2 h3 h4 h5 h6 blockquote".split(" "),stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",
action:"Deleted"}},contentEditable:void 0,_isTracking:!0,tooltips:!1,tooltipsDelay:1,_isVisible:!0,_changeData:null,_handleSelectAll:!1,_sessionId:null};q=function(a){a||(a={});if(!a.element)throw Error("options.element must be defined for ice construction.");this._changes={};this._userStyles={};this._styles={};this._savedNodesMap={};this.$this=e(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);this._boundEventHandler=
this.handleEvent.bind(this);ice.dom.extend(!0,this,u,a);if(a.tooltips&&(!e.isFunction(a.hostMethods.showTooltip)||!e.isFunction(a.hostMethods.hideTooltip)))throw Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true");var b=a.userStyles||{},d;for(d in b)if(b.hasOwnProperty(d)){var i=b[d];isNaN(i)||(this._userStyles[d]=this.stylePrefix+"-"+i,this._uniqueStyleIndex=Math.max(i,this._uniqueStyleIndex),this._styles[i]=!0)}h=a.hostMethods.logError||function(){}};
q.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){"boolean"==typeof this.contentEditable&&this.element.setAttribute("contentEditable",this.contentEditable);this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(a){this._isTracking=!1;try{var b=this.element;b&&(b.removeEventListener("keyup",this._boundEventHandler,
!0),b.removeEventListener("keydown",this._boundEventHandler,!0),b.removeEventListener("keypress",this._boundEventHandler,!0));!a&&"undefined"!=typeof this.contentEditable&&this.element.setAttribute("contentEditable",!this.contentEditable)}catch(d){h(d,"While trying to stop tracking")}this._updateTooltipsState();return this},listenToEvents:function(){this.unlistenToEvents();this.element&&this.element.addEventListener("keydown",this._boundEventHandler,!0)},unlistenToEvents:function(){this.element&&
this.element.removeEventListener("keydown",this._boundEventHandler,!0)},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},
isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=!0},disableChangeTracking:function(){this._isTracking=!1},toggleChangeTracking:function(a){this._isTracking=a=void 0===a?!this._isTracking:!!a},setCurrentUser:function(a){this.currentUser=a;this._updateUserData(a)},setSessionId:function(a){this._sessionId=a},toggleTooltips:function(a){this.tooltips=a=void 0===a?!this.tooltips:Boolean(a);this._updateTooltipsState()},visible:function(a){a.nodeType===ice.dom.TEXT_NODE&&
(a=a.parentNode);a=a.getBoundingClientRect();return 0<a.top&&0<a.left},_createIceNode:function(a,b,d){var i=this.env.document.createElement(this.changeTypes[a].tag);i.setAttribute("class",this._getIceNodeClass(a));b&&i.appendChild(b);this._addChange(a,[i],d);return i},insert:function(a){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();var b=this._isRangeInElement(this.getCurrentRange(),this.element),d=b?null:this.hostMethods.getHostRange(),i=this._startBatchChange(),c=!(!b||b.collapsed),
g=!1,a=a||{};try{if(c&&(this._deleteContents(!1,b),b=this.getCurrentRange()),b||d){var j=a.nodes;j&&!e.isArray(j)&&(j=[j]);this._moveRangeToValidTrackingPos(b,d);g=this._insertNodes(b,d,{nodes:j,text:a.text,insertStubText:!1!==a.insertStubText})}}catch(o){h(o,"while trying to insert nodes")}finally{this._endBatchChange(i)}return g},_deleteContents:function(a,b){var d=!0,i=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete();b?this.selection.addRange(b):b=this.getCurrentRange();
var c=this._startBatchChange();try{if(!1===b.collapsed){if((b=this._deleteSelection(b))&&!this.visible(b.endContainer))b.setEnd(b.endContainer,Math.max(0,b.endOffset-1)),b.collapse(!1)}else if(this._cleanupSelection(b,!1,!0),a)if("mozilla"===i.type)d=this._deleteRight(b),this.visible(b.endContainer)||(b.endContainer.parentNode.nextSibling?b.setEndBefore(b.endContainer.parentNode.nextSibling):b.setEndAfter(b.endContainer),b.collapse(!1));else{if(b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var g=
b.startContainer.nextSibling;if(ice.dom.is(g,"."+this._getIceNodeClass("deleteType")))for(;g;)if(ice.dom.is(g,"."+this._getIceNodeClass("deleteType")))g=g.nextSibling;else{b.setStart(g,0);b.collapse(!0);break}}d=this._deleteRight(b);!this.visible(b.endContainer)&&ice.dom.is(b.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(b.setStartAfter(b.endContainer.parentNode),b.collapse(!0))}else if(i.mozilla)d=this._deleteLeft(b),this.visible(b.startContainer)||
(b.startContainer.parentNode.previousSibling?b.setEnd(b.startContainer.parentNode.previousSibling,0):b.setEnd(b.startContainer.parentNode,0),b.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(b.endContainer)),b.collapse(!1));else{if(!this.visible(b.startContainer)&&b.endOffset===ice.dom.getNodeCharacterLength(b.endContainer)){var h=b.startContainer.previousSibling;if(ice.dom.is(h,"."+this._getIceNodeClass("deleteType")))for(;h;)if(ice.dom.is(h,"."+this._getIceNodeClass("deleteType")))h=
h.prevSibling;else{b.setEndBefore(h.nextSibling,0);b.collapse(!1);break}}d=this._deleteLeft(b)}b&&this.selection.addRange(b)}finally{this._endBatchChange(c)}return d},getChanges:function(){return this._changes},getChangeUserids:function(){var a=this,b=Object.keys(this._changes);return b.map(function(d){return a._changes[b[d]].userid}).sort().filter(function(a,b,f){return b===f.indexOf(a)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(a,b,d){return(a=this.getCleanDOM(a,
{callback:b,prepare:d,clone:!0}))&&a.innerHTML||""},getCleanDOM:function(a,b){var d="",i=this,b=b||{};ice.dom.each(this.changeTypes,function(a,b){"deleteType"!=a&&(0<b&&(d+=","),d+="."+i._getIceNodeClass(a))});a?"string"===typeof a?a=ice.dom.create("<div>"+a+"</div>"):b.clone&&(a=ice.dom.cloneNode(a,!1)[0]):a=b.clone?ice.dom.cloneNode(this.element,!1)[0]:this.element;return this._cleanBody(a,d,b)},_cleanBody:function(a,b,d){a=d.prepare?d.prepare.call(this,a):a;b=ice.dom.find(a,b);ice.dom.each(b,function(a,
b){for(;b.firstChild;)b.parentNode.insertBefore(b.firstChild,b);b.parentNode.removeChild(b)});b=ice.dom.find(a,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(b);return a=d.callback?d.callback.call(this,a):a},acceptAll:function(a){if(a)return this._acceptRejectSome(a,!0);this.getCleanDOM(this.element,{clone:!1});this._changes={};this._triggerChange()},rejectAll:function(a){if(a)return this._acceptRejectSome(a,!1);var a="."+this._getIceNodeClass("insertType"),b="."+this._getIceNodeClass("deleteType"),
d,i=this;ice.dom.find(this.element,a).each(function(a,b){i._removeNode(b)});ice.dom.each(ice.dom.find(this.element,b),function(a,b){d=ice.dom.contents(b);ice.dom.replaceWith(b,d);e.each(d,function(a,b){i._normalizeNode(b&&b.parentNode)})});this._changes={};this._triggerChange()},acceptChange:function(a){this.acceptRejectChange(a,!0)},rejectChange:function(a){this.acceptRejectChange(a,!1)},acceptRejectChange:function(a,b){var d,i,c,g,h=ice.dom,j=this,n,w,l=this._userStyles,p,r=this.attributes.userId,
q=this._getIceNodeClass("deleteType"),u=this._getIceNodeClass("insertType");if(!a){g=this.getCurrentRange();if(!g||!g.collapsed)return;a=g.startContainer}d=c="."+q;i=g="."+u;b||(c=i,g=d);d=h.getNode(a,d+","+i);d=h.attr(d,this.attributes.changeId);c=h.find(this.element,c+"["+this.attributes.changeId+"="+d+"]");i=c.length;c.each(function(a,b){j._removeNode(b)});c=h.find(this.element,g+"["+this.attributes.changeId+"="+d+"]");i+=c.length;h.each(c,function(a,b){if(k(b))return m(b);p=b.getAttribute(r);
w=p!==null?l[p]||"":"";n=ice.dom.contents(b);e(b).removeClass(u+" "+q+" "+w);h.replaceWith(b,n);e.each(n,function(a,b){var f=ice.dom.TEXT_NODE==b.nodeType&&b.nodeValue;if(f){for(var d=false;f.indexOf("  ")>=0;){d=true;f=f.replace("  ","  ")}if(d)b.nodeValue=f}j._normalizeNode(b&&b.parentNode)})});delete this._changes[d];0<i&&this._triggerChange()},isInsideChange:function(a,b,d){try{return!!this.currentChangeNode(a,b,d)}catch(i){return h(i,"While testing if isInsideChange"),!1}},getIceNodes:function(){var a=
[],b=this;ice.dom.each(this.changeTypes,function(d){a.push("."+b._getIceNodeClass(d))});a=a.join(",");return e(this.element).find(a)},_getIceNode:function(a,b){var d=this.changeTypes[b].tag+"."+this._getIceNodeClass(b);return ice.dom.getNode(a&&a.$||a,d)},_isNodeOfChangeType:function(a,b){if(!a)return!1;var d="."+this._getIceNodeClass(b);return ice.dom.is(a.$||a,d)},_isInsertNode:function(a){return this._isNodeOfChangeType(a,"insertType")},_isDeleteNode:function(a){return this._isNodeOfChangeType(a,
"deleteType")},_normalizeNode:function(a){return ice.dom.normalizeNode(a,this._browser.msie)},_moveRangeToValidTrackingPos:function(a,b){if(a=b||a)for(var d,i,c=-1,g,j=[],e=b?this.hostMethods.getHostNode:l,n=!1;!n;){i=a.startContainer;if(!i||0<=j.indexOf(i))break;g=e(i);j.push(i);if(d=this._getVoidElement(g)){if(d!=i&&0<=j.indexOf(d))break;j.push(d)}else n=ice.dom.isTextContainer(g);if(!n){if(-1==c){c=e(a.startContainer);i=a.startOffset;if(c)var k=c.nodeType,c=ice.dom.TEXT_NODE==k?i&&c.nodeValue&&
i>=c.nodeValue.length-1:ice.dom.ELEMENT_NODE==k?c.childNodes&&c.childNodes.length&&i>=c.childNodes.length:!1;else c=!1;c=!c}d=c?ice.dom.findPrevTextContainer(d||g,this.element):ice.dom.findNextTextContainer(d||g,this.element);g=d.node;b&&(g=this.hostMethods.makeHostElement(g));try{c?a.setStart(g,d.offset):a.setEnd(g,d.offset),a.collapse(c)}catch(p){h(p,"While trying to move range to valid tracking position");break}}}},_isRangeInElement:function(a,b){for(var d=a&&a.startContainer;d;){if(d==b)return a;
d=d.parentNode}return null},_getVoidElement:function(a){try{var b=this._getIceNode(a,"deleteType");return!b&&3==a.nodeType&&"​"==a.nodeValue?a:b}catch(d){return h(d,"While trying to get void element of",a),null}},_cleanupSelection:function(a,b,d){var c;if(a&&a.collapsed&&(c=a.startContainer))return b&&(c=this.hostMethods.getHostNode(c)),ice.dom.TEXT_NODE==c.nodeType?this._cleanupTextSelection(a,c,b,d):this._cleanupElementSelection(a,b)},_cleanupTextSelection:function(a,b,d,c){this._cleanupAroundNode(b);
if(c&&ice.dom.isEmptyTextNode(b)){var c=b.parentNode,g=ice.dom.getNodeIndex(b),d=d?this.hostMethods.makeHostElement:l;c.removeChild(b);g=Math.max(0,g);a.setStart(d(c),g);a.setEnd(d(c),g)}},_cleanupElementSelection:function(a,b){var d,c=!1,g=b?this.hostMethods.getHostNode(a.startContainer):a.startContainer,h=g.childNodes.length;if(!(1>h)){try{if(0<a.startOffset?d=g.childNodes[a.startOffset-1]:(d=g.firstChild,c=!0),!d)return}catch(j){return}this._cleanupAroundNode(d,c);if(0!==a.startOffset&&(c=ice.dom.getNodeIndex(d)+
1,ice.dom.isEmptyTextNode(d)&&(c=Math.max(0,c-1),g.removeChild(d)),g.childNodes.length!=h))d=b?this.hostMethods.makeHostElement:l,a.setStart(d(g),c),a.setEnd(d(g),c)}},_cleanupAroundNode:function(a,b){for(var d=a.parentNode,c=a.nextSibling,g;c;)ice.dom.isEmptyTextNode(c)?(g=c,c=c.nextSibling,d.removeChild(g)):c=c.nextSibling;for(c=a.previousSibling;c;)ice.dom.isEmptyTextNode(c)?(g=c,c=c.previousSibling,d.removeChild(g)):c=c.previousSibling;b&&ice.dom.isEmptyTextNode(a)&&d.removeChild(a)},_isCurrentUserIceNode:function(a){var b=
a&&ice.dom.attr(a,this.attributes.userId)==this.currentUser.id;b&&this._sessionId&&(b=ice.dom.attr(a,this.attributes.sessionId)===this._sessionId);return b},_getChangeTypeFromAlias:function(a){var b,d=null;for(b in this.changeTypes)this.changeTypes.hasOwnProperty(b)&&this.changeTypes[b].alias==a&&(d=b);return d},_getIceNodeClass:function(a){return this.attrValuePrefix+this.changeTypes[a].alias},_getUserStyle:function(a){if(null===a||""===a||"undefined"==typeof a)return this.stylePrefix;var b=null;
return b=this._userStyles[a]?this._userStyles[a]:this._setUserStyle(a,this._getNewStyleId())},_setUserStyle:function(a,b){var d=this.stylePrefix+"-"+b;this._styles[b]||(this._styles[b]=!0);return this._userStyles[a]=d},_getNewStyleId:function(){var a=++this._uniqueStyleIndex;if(this._styles[a])return this._getNewStyleId();this._styles[a]=!0;return a},_addChange:function(a,b,d){var c=d||this._batchChangeId||this.getNewChangeId(),g=this;this._changes[c]||(d=(new Date).getTime(),this._changes[c]={type:a,
time:d,lastTime:d,sessionId:this._sessionId,userid:""+this.currentUser.id,username:this.currentUser.name,data:this._changeData||""},this._triggerChange());ice.dom.foreach(b,function(a){g._addNodeToChange(c,b[a])});return c},_addNodeToChange:function(a,b){var d=this.getChange(a),c={};b.getAttribute(this.attributes.changeId)||(c[this.attributes.changeId]=a);var g=b.getAttribute(this.attributes.userId);g||(g=d.userid,c[this.attributes.userId]=g);g==d.userid&&(c[this.attributes.userName]=d.username);
null===b.getAttribute(this.attributes.changeData)&&(c[this.attributes.changeData]=this._changeData||"");b.getAttribute(this.attributes.time)||(c[this.attributes.time]=d.time);b.getAttribute(this.attributes.lastTime)||(c[this.attributes.lastTime]=d.lastTime);d.sessionId&&!b.getAttribute(this.attributes.sessionId)&&(c[this.attributes.sessionId]=d.sessionId);d.style||(d.style=this._getUserStyle(d.userid));e(b).attr(c).addClass(d.style);this._updateNodeTooltip(b)},getChange:function(a){return this._changes[a]||
null},getNewChangeId:function(){var a=++this._uniqueIDIndex;this._changes[a]&&(a=this.getNewChangeId());return a},_startBatchChange:function(){return this._batchChangeId?null:this._batchChangeId=this.getNewChangeId()},getContentElement:function(){return this.element},_endBatchChange:function(a){a&&a===this._batchChangeId&&(this._batchChangeId=null,this._triggerChangeText())},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(a){return h(a,"While trying to get current range"),
null}},_insertNodes:function(a,b,d){var a=b||a,d=d||{},c=a.startContainer,g=b?this.hostMethods.makeHostElement:l,h=d.nodes,j=!1!==d.insertStubText,e=d.text,n,k=this.env.document,d=!1;n=this._getIceNode(c&&c.$||c,"insertType");c=this._isCurrentUserIceNode(n);this._cleanupSelection(a,Boolean(b),!0);if(c){c=h&&h[0];e=n.getAttribute(this.attributes.changeId);if(c){d=!0;a.insertNode(g(c));g=c.parentNode;k=c.nextSibling;n=h.length;for(j=1;j<n;++j)k?g.insertBefore(h[j],k):g.appendChild(h[j]);h=h[n-1];ice.dom.TEXT_NODE==
h.nodeType?a.setEnd(h,h.nodeValue&&h.nodeValue.length||0):a.setEndAfter(h);a.collapse();b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}else p(null,a,k,j);this._updateChangeTime(e)}else{c=this._createIceNode("insertType");if(n){var m=n.childNodes.length;this._normalizeNode(n);m!=n.childNodes.length&&(b?b=a=this.hostMethods.getHostRange():a.refresh());if(n&&(m=b&&this.hostMethods.getHostNode(b.endContainer)||a.endContainer,3==m.nodeType&&a.endOffset<a.endContainer.length||m!=n.lastChild))n=
this._splitNode(n,a.endContainer,a.endOffset)}n&&(a.setStartAfter(g(n)),a.collapse(!0));a.insertNode(g(c));if(n=h&&h.length||0){d=!0;for(j=0;j<n;++j)c.appendChild(h[j]);a.setEndAfter(g(c.lastChild));a.collapse()}else e?(d=!0,h=k.createTextNode(e),c.appendChild(h),a.setEnd(h,1),a.collapse()):p(c,a,k,j);b?this.hostMethods.setHostRange(b):this.selection.addRange(a)}return d},_updateChangeTime:function(a){var b=this._changes[a];if(b){var d=(new Date).getTime(),a=ice.dom.find(this.element,"["+this.attributes.changeId+
"="+a+"]"),c=this.attributes.lastTime;b.lastTime=d;a.each(function(a,b){b.setAttribute(c,d)})}},_handleVoidEl:function(a,b){var d=a&&this._getVoidElement(a);return d&&!this._getIceNode(d,"deleteType")?(b.collapse(!0),!0):!1},_deleteSelection:function(a){for(var b=new ice.Bookmark(this.env,a),d=ice.dom.getElementsBetween(b.start,b.end),c=[],g=0;g<d.length;g++){var h=d[g];if(h&&h.parentNode){if(ice.dom.isBlockElement(h)&&(c.push(h),!ice.dom.canContainTextElement(h))){for(var e=0;e<h.childNodes.length;e++)d.push(h.childNodes[e]);
continue}if(ice.dom.isEmptyTextNode(h))this._removeNode(h);else if(!this._getVoidElement(h))if(h.nodeType!==ice.dom.TEXT_NODE)if(j(h))this._addDeleteTrackingToBreak(h);else if(ice.dom.isStubElement(h))this._addDeleteTracking(h,{range:null,moveLeft:!0});else if(ice.dom.hasNoTextOrStubContent(h))this._removeNode(h);else for(e=0;e<h.childNodes.length;e++)d.push(h.childNodes[e]);else e=ice.dom.getBlockParent(h),this._addDeleteTracking(h,{range:null,moveLeft:!0}),ice.dom.hasNoTextOrStubContent(e)&&ice.dom.remove(e)}}b.selectBookmark();
(a=this.getCurrentRange())&&a.collapse(!0);return a},_deleteRight:function(a){var b=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,d=b?ice.dom.hasNoTextOrStubContent(b):!1,g=b&&ice.dom.getNextContentNode(b,this.element),h=g?ice.dom.hasNoTextOrStubContent(g):!1,e=a.endContainer,k=a.endOffset,o=a.commonAncestorContainer,n,l=!1;if(d)return!1;if(j(o))return this._addDeleteTrackingToBreak(o,{range:a}),!0;if(o.nodeType!==ice.dom.TEXT_NODE){if(0===
k&&(ice.dom.isBlockElement(o)&&!ice.dom.canContainTextElement(o))&&(b=o.firstElementChild))return a.setStart(b,0),a.collapse(),this._deleteRight(a);if(o.childNodes.length>k){b=o.childNodes[k];if(j(b))return this._addDeleteTrackingToBreak(b,{range:a}),!0;a.setStart(o.childNodes[k],0);a.collapse(!0);l=this._deleteRight(a);a.refresh();return l}if(n=ice.dom.getNextContentNode(o,this.element)){if(j(n))return this._addDeleteTrackingToBreak(n,{range:a}),!0;a.setEnd(n,0)}a.collapse();return this._deleteRight(a)}try{a.moveEnd(ice.dom.CHARACTER_UNIT,
1),a.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(m){}if(k===e.data.length&&!ice.dom.hasNoTextOrStubContent(e)){n=ice.dom.getNextNode(e,this.element);if(!n)return a.selectNodeContents(e),a.collapse(),!1;if(j(n))return this._addDeleteTrackingToBreak(n,{range:a}),!0;n.nodeType===ice.dom.TEXT_NODE&&(n=n.parentNode);if(!n.isContentEditable)return l=this._addDeleteTracking(n,{range:null,moveLeft:!1,merge:!0}),b=this.env.document.createTextNode(""),n.parentNode.insertBefore(b,n.nextSibling),a.selectNode(b),
a.collapse(!0),l;if(this._handleVoidEl(n,a))return!0;if(ice.dom.isChildOf(n,b)&&ice.dom.isStubElement(n))return this._addDeleteTracking(n,{range:a,moveLeft:!1,merge:!0})}if(this._handleVoidEl(n,a))return!0;if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(n,this.element),this.blockEl)){g!==ice.dom.getBlockParent(a.endContainer,this.element)&&a.setEnd(g,0);o=ice.dom.getElementsBetween(a.startContainer,a.endContainer);
for(k=0;k<o.length;k++)ice.dom.remove(o[k]);return ice.dom.mergeBlockWithSibling(a,ice.dom.getBlockParent(a.endContainer,this.element)||b)}if(h)return ice.dom.remove(g),a.collapse(!0),!0;a.setStart(g,0);a.collapse(!0);return!0}return this._addDeleteTracking(c(a.endContainer,a.endOffset,1),{range:a,moveLeft:!1,merge:!0})},_deleteLeft:function(a){var b=ice.dom.isBlockElement(a.startContainer)&&a.startContainer||ice.dom.getBlockParent(a.startContainer,this.element)||null,d=b?ice.dom.hasNoTextOrStubContent(b):
!1,g=b&&ice.dom.getPrevContentNode(b,this.element),h=g?ice.dom.hasNoTextOrStubContent(g):!1,e=a.startContainer,k=a.startOffset,o=a.commonAncestorContainer;if(d)return!1;if(j(o))return this._addDeleteTrackingToBreak(o,{range:a,moveLeft:!0}),!0;if(0===k||o.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(o)&&!ice.dom.canContainTextElement(o))if(0===k){if(d=o.firstElementChild)return a.setStart(d,0),a.collapse(),this._deleteLeft(a)}else if(d=o.lastElementChild)if(d=a.getLastSelectableChild(d))return a.setStart(d,
d.data.length),a.collapse(),this._deleteLeft(a);e=0===k?ice.dom.getPrevContentNode(e,this.element):o.childNodes[k-1];if(!e)return!1;ice.dom.is(e,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(0<e.childNodes.length&&e.lastChild)&&(e=e.lastChild);if(j(e))return this._addDeleteTrackingToBreak(e,{range:a,moveLeft:!0}),!0;e.nodeType===ice.dom.TEXT_NODE&&(e=e.parentNode);if(!e.isContentEditable)return b=this._addDeleteTracking(e,{range:null,moveLeft:!0,merge:!0}),g=
document.createTextNode(""),e.parentNode.insertBefore(g,e),a.selectNode(g),a.collapse(!0),b;if(this._handleVoidEl(e,a))return!0;if(ice.dom.isStubElement(e)&&ice.dom.isChildOf(e,b)||!e.isContentEditable)return this._addDeleteTracking(e,{range:a,moveLeft:!0,merge:!0}),!0;if(ice.dom.isStubElement(e))return ice.dom.remove(e),a.collapse(!0),!1;if(e!==b&&!ice.dom.isChildOf(e,b)){ice.dom.canContainTextElement(e)||(e=e.lastElementChild);if(e.lastChild&&e.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(e.lastChild)&&
"BR"!==e.lastChild.tagName)return a.setStartAfter(e.lastChild),a.collapse(!0),!0;if((d=a.getLastSelectableChild(e))&&!ice.dom.isOnBlockBoundary(a.startContainer,d,this.element))return a.selectNodeContents(d),a.collapse(),!0}}if(1===k&&!ice.dom.isBlockElement(o)&&1<a.startContainer.childNodes.length&&a.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===a.startContainer.childNodes[0].data.length)return a.setStart(a.startContainer,0),this._deleteLeft(a);try{a.moveStart(ice.dom.CHARACTER_UNIT,
-1),a.moveStart(ice.dom.CHARACTER_UNIT,1)}catch(n){}if(ice.dom.isOnBlockBoundary(a.startContainer,a.endContainer,this.element)){if(h)return ice.dom.remove(g),a.collapse(),!0;if(g&&g.lastChild&&ice.dom.isStubElement(g.lastChild))return a.setStartAfter(g.lastChild),a.collapse(!0),!0;(d=a.getLastSelectableChild(g))?(a.setStart(d,d.data.length),a.collapse(!0)):g&&(a.setStart(g,g.childNodes.length),a.collapse(!0));return!0}return(b=a.startContainer)&&b.nodeType===ice.dom.TEXT_NODE?(this._addDeleteTracking(c(b,
a.startOffset-1,1),{range:a,moveLeft:!0,merge:!0}),!0):!1},_removeNode:function(a){var b=a&&a.parentNode;b&&(b.removeChild(a),b!=this.element&&ice.dom.hasNoTextOrStubContent(b)&&this._removeNode(b))},_addDeleteTracking:function(a,b){var d=b&&b.moveLeft,c=this._getIceNode(a,"insertType"),g;if(c)return this._addDeletionInInsertNode(a,c,b);if((c=b&&b.range)&&this._getIceNode(a,"deleteType"))return this._deleteInDeleted(a,b);a.previousSibling&&ice.dom.isEmptyTextNode(a.previousSibling)&&a.parentNode.removeChild(a.previousSibling);
a.nextSibling&&ice.dom.isEmptyTextNode(a.nextSibling)&&a.parentNode.removeChild(a.nextSibling);g=this._getIceNode(a.previousSibling,"deleteType");var h=this._getIceNode(a.nextSibling,"deleteType");if(g&&this._isCurrentUserIceNode(g)){if(g.appendChild(a),h&&this._isCurrentUserIceNode(h)){var e=ice.dom.extractContent(h);ice.dom.append(g,e);h.parentNode.removeChild(h)}}else h&&this._isCurrentUserIceNode(h)?(g=h,g.insertBefore(a,g.firstChild)):(g=this._createIceNode("deleteType",null,this.getAdjacentChangeId(a,
d)),a.parentNode.insertBefore(g,a),g.appendChild(a));c&&(ice.dom.isStubElement(a)?c.selectNode(a):c.selectNodeContents(a),d?c.collapse(!0):c.collapse());g&&(this._normalizeNode(g),c&&c.refresh());return!0},_addDeleteTrackingToBreak:function(a,b){function d(){var d=b&&b.range;d&&(j(a)||ice.dom.hasNoTextOrStubContent(a)||c?c?(d.setStartBefore(a),d.setEndBefore(a)):(d.setStartAfter(a),d.setEndAfter(a)):a.firstChild&&(d.setStartBefore(a.firstChild),d.setEndBefore(a.firstChild)),d.collapse())}var c=Boolean(b&&
b.moveLeft);if(j(a)){if(this._isDeleteNode(a))return d();m(a);ice.dom.addClass(a,this._getIceNodeClass("deleteType"));var g=this.getAdjacentChangeId(a,c);this._addChange("deleteType",[a],g);d()}else h("addDeleteTracking to BR: not a break element")},_deleteInDeleted:function(a,b){var d=b.range,c=b.moveLeft;this._normalizeNode(a);var g=!1;if(c){for(var h=ice.dom.getPrevContentNode(a,this.element);!g;)(c=this._getIceNode(h,"deleteType"))?h=ice.dom.getPrevContentNode(h,this.element):g=!0;h&&((g=d.getLastSelectableChild(h))&&
(h=g),d.setStart(h,ice.dom.getNodeCharacterLength(h)),d.collapse(!0))}else{for(h=ice.dom.getNextContentNode(a,this.element);!g;)(c=this._getIceNode(h,"deleteType"))?h=ice.dom.getNextContentNode(h,this.element):g=!0;h&&(d.selectNodeContents(h),d.collapse(!0))}return!0},_addDeletionInInsertNode:function(a,b,d){var c=d&&d.range,g=d&&d.moveLeft;if(this._isCurrentUserIceNode(b)){if(c&&(g?c.setStartBefore(a):c.setStartAfter(a),c.collapse(g)),a.parentNode.removeChild(a),this._browser.msie||this._normalizeNode(b),
0<ice.dom.find(b,".iceBookmark").length?(a=ice.dom.cloneNode(b),ice.dom.remove(ice.dom.find(a,".iceBookmark")),a=a[0]):a=b,ice.dom.hasNoTextOrStubContent(a))c&&(c.setStartBefore(b),c.collapse(!0)),ice.dom.replaceWith(b,ice.dom.contents(b))}else{var h=rangy.dom.getNodeIndex(a),e=a.parentNode,j=e.childNodes.length,n;e.removeChild(a);n=this._createIceNode("deleteType");n.appendChild(a);0<h&&h>=j-1?ice.dom.insertAfter(b,n):(0<h&&this._splitNode(b,e,h),b.parentNode.insertBefore(n,b));this._deleteEmptyNode(b);
c&&g&&(c.setStartBefore(n),c.collapse(!0),this.selection.addRange(c));d&&d.merge&&this._mergeDeleteNode(n);c&&c.refresh()}return!0},_deleteEmptyNode:function(a){var b=a&&a.parentNode;b&&ice.dom.hasNoTextOrStubContent(a)&&b.removeChild(a)},_mergeDeleteNode:function(a){var b,d;if(this._isCurrentUserIceNode(b=this._getIceNode(a.previousSibling,"deleteType")))d=ice.dom.extractContent(a),a.parentNode.removeChild(a),ice.dom.append(b,d),this._mergeDeleteNode(b);else if(this._isCurrentUserIceNode(b=this._getIceNode(a.nextSibling,
"deleteType")))d=ice.dom.extractContent(b),a.parentNode.removeChild(b),ice.dom.append(a,d),this._mergeDeleteNode(a)},handleEvent:function(a){if(!this._isTracking)return!0;var b=!1;"keypress"==a.type?b=this.keyPress(a):"keydown"==a.type&&(b=!this.handleKeyDown(a));b&&(a.stopImmediatePropagation(),a.preventDefault(),this.hostMethods.notifyChange());return!b},_handleAncillaryKey:function(a){var b=this._browser,d=!1,c=this.getCurrentRange();switch(a){case ice.dom.DOM_VK_DELETE:d=this._deleteContents();
break;case 46:d=this._deleteContents(!0);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:"mozilla"===b.type&&!this.visible(c.startContainer)&&(c.startContainer.parentNode.previousSibling?(c.setEnd(c.startContainer.parentNode.previousSibling,0),c.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(c.endContainer))):c.setEnd(c.startContainer.parentNode.nextSibling,0),c.collapse(!1));d=!1;break;case ice.dom.DOM_VK_RIGHT:"mozilla"===b.type&&(!this.visible(c.startContainer)&&
c.startContainer.parentNode.nextSibling)&&(c.setStart(c.startContainer.parentNode.nextSibling,0),c.collapse(!0))}return d},handleKeyDown:function(a){return this._handleSpecialKey(a)?!0:!this.keyPress(a)},onKeyDown:function(a){return this._handleSpecialKey(a)?!1:this._handleAncillaryKey(a)},keyPress:function(a){var b=null;if(a.ctrlKey||a.metaKey)return!1;var c=(b=this.getCurrentRange())&&ice.dom.parents(b.startContainer,"br")[0]||null;c&&b.moveToNextEl(c);a=a.keyCode?a.keyCode:a.which;switch(a){case 32:return this.insert({text:" "});
case ice.dom.DOM_VK_DELETE:case 46:case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:case ice.dom.DOM_VK_RIGHT:return this._handleAncillaryKey(a);case ice.dom.DOM_VK_ENTER:return this._handleEnter(),!1;default:return b=String.fromCharCode(a),null!==b?this.insert():!1}},_handleEnter:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._deleteContents()},_handleSpecialKey:function(a){var b=a.which;null===b&&(b=a.keyCode);switch(b){case 120:case 88:if(!0===a.ctrlKey||
!0===a.metaKey)return this.prepareToCut(),!0;break;case 67:case 99:if(!0===a.ctrlKey||!0===a.metaKey)return this.prepareToCopy(),!0}return!1},currentChangeNode:function(a,b,c){var g="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"),h=null;if(!a){h=this.getCurrentRange();if(!h)return!1;!1!==c&&h.collapsed?(this._cleanupSelection(h,!1,!1),a=h.startContainer):a=h.commonAncestorContainer}a=b?ice.dom.is(a,g)&&a:ice.dom.getNode(a,g);if(!a&&h&&h.collapsed){b=h.endContainer;
h=h.endOffset;c=null;if(b.nodeType===ice.dom.TEXT_NODE)h===b.length?c=ice.dom.getNextNode(b):0===h&&(c=ice.dom.getPrevNode(b,this.element));else if(b.nodeType===ice.dom.ELEMENT_NODE)if(0===h)c=ice.dom.getPrevNode(b,this.element);else if(b.childNodes.length>h){b=b.childNodes[h-1];if(ice.dom.is(b,g))return b;c=ice.dom.getNextNode(b)}c&&(a=ice.dom.is(c,g))}return a},setShowChanges:function(a){this._isVisible=a=!!a;e(this.element).toggleClass("ICE-Tracking",a);this._showTitles(a);this._updateTooltipsState()},
reload:function(){this._loadFromDom()},hasChanges:function(){for(var a in this._changes){var b=this._changes[a];if(b&&b.type)return!0}return!1},countChanges:function(a){return this._filterChanges(a).count},setChangeData:function(a){if(null==a||"undefined"==typeof a)a="";this._changeData=""+a},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},prepareToCopy:function(){var a=this.getCurrentRange();a&&!a.collapsed&&this._removeTrackingInRange(a)},prepareToCut:function(){var a=this.getCurrentRange(),
b=this.hostMethods.getHostRange();if(a&&b&&a.collapsed&&!b.collapsed)try{var c=this.hostMethods.getHostRangeData(b);a.setStart(c.startContainer,c.startOffset);a.setEnd(c.endContainer,c.endOffset)}catch(g){return}if(!a||a.collapsed)return!1;b=this.element;if(a&&b&&!a.collapsed){var e;try{for(;(e=a.endContainer)&&(e!=b&&0==a.endOffset&&!a.collapsed)&&!(e.previousSibling?a.setEndBefore(e):e.parentNode&&e.parentNode!=b&&a.setEndBefore(e.parentNode),a.endContainer==e););}catch(j){h(j,"fixSelection, while trying to set end")}try{for(;(e=
a.startContainer)&&(e!=b&&!a.collapsed)&&!(e=a.startContainer,e.nodeType==ice.dom.TEXT_NODE?a.startOffset>=e.nodeValue.length&&a.setStartAfter(e):a.startOffset>=e.childNodes.length&&a.setStartAfter(e),a.startContainer==e););}catch(k){h(k,"fixSelection, while trying to set start")}}b=a.cloneContents();e=a.cloneRange();var c=b.firstChild,o=b.lastChild;this.hostMethods.beforeEdit();a.collapse(!1);a.insertNode(b);a.setStartBefore(c);a.setEndAfter(o);b=this._startBatchChange();try{this._deleteSelection(a)}catch(n){h(n,
"While trying to delete selection")}finally{this._endBatchChange(b),this.selection.addRange(e),this._removeTrackingInRange(e,!1)}return!0},toString:function(){return"ICE "+(this.element&&this.element.id||"(no element id)")},_splitNode:function(a,b,c){var g=a.parentNode,h=rangy.dom.getNodeIndex(a),e=b.ownerDocument.createRange();e.setStart(g,h);e.setEnd(b,c);b=e.extractContents();g.insertBefore(b,a);this.isInsideChange(a,!0)&&this._updateNodeTooltip(a.previousSibling);return a.previousSibling},_triggerChange:function(){this._isTracking&&
this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(a){this.tooltips&&this._isVisible&&this._addTooltip(a)},_acceptRejectSome:function(a,b){var c=function(a,c){this.acceptRejectChange(c,b)}.bind(this),g=this._filterChanges(a),h;for(h in g.changes)ice.dom.find(this.element,"["+this.attributes.changeId+"="+h+"]").each(c);g.count&&this._triggerChange()},_filterChanges:function(a){var b=0,c={},g;g=a||{};var a=g.filter,h=g.exclude?e.map(g.exclude,
function(a){return""+a}):null,j=g.include?e.map(g.include,function(a){return""+a}):null,k=g.verify,o=null,n;for(n in this._changes)if((g=this._changes[n])&&g.type)if(o=a&&!a({userid:g.userid,time:g.time,data:g.data})||h&&0<=h.indexOf(g.userid)||j&&0>j.indexOf(g.userid),!o&&(k&&(o=ice.dom.find(this.element,"["+this.attributes.changeId+"]"),o=!o.length),!o))++b,c[n]=g;return{count:b,changes:c}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var a=this.currentUser&&this.currentUser.id,
b=this.currentUser&&this.currentUser.name||"",c=(new Date).getTime(),g,h=RegExp(this.stylePrefix+"-(\\d+)"),e=[],j;for(j in this.changeTypes)e.push(this._getIceNodeClass(j));j=this.getIceNodes();var k=function(j,k){for(var o=0,l,m="",p=k.className.split(" "),j=0;j<p.length;j++){if(g=h.exec(p[j]))l=g[0],o=g[1];var q=RegExp("("+e.join("|")+")").exec(p[j]);q&&(m=this._getChangeTypeFromAlias(q[1]))}p=ice.dom.attr(k,this.attributes.userId);a&&p==a?(q=b,k.setAttribute(this.attributes.userName,b)):q=k.getAttribute(this.attributes.userName);
this._setUserStyle(p,Number(o));o=parseInt(ice.dom.attr(k,this.attributes.changeId)||"");isNaN(o)&&(o=this.getNewChangeId(),k.setAttribute(this.attributes.changeId,o));var u=parseInt(k.getAttribute(this.attributes.time)||"");isNaN(u)&&(u=c);var C=parseInt(k.getAttribute(this.attributes.lastTime)||"");isNaN(C)&&(C=u);var z=k.getAttribute(this.attributes.sessionId),F=ice.dom.attr(k,this.attributes.changeData)||"";this._changes[o]={type:m,style:l,userid:""+p,username:q,time:u,lastTime:C,sessionId:z,
data:F};this._updateNodeTooltip(k)}.bind(this);j.each(k);this._triggerChange()},_updateUserData:function(a){if(a)for(var b in this._changes){var c=this._changes[b];c.userid==a.id&&(c.username=a.name)}this.getIceNodes().each(function(b,c){var d=!a||a.id==c.getAttribute(this.attributes.userId);a&&d&&c.setAttribute(this.attributes.userName,a.name)}.bind(this))},_showTitles:function(a){var b=this.getIceNodes();a?e(b).each(function(a,b){this._updateNodeTooltip(b)}.bind(this)):e(b).removeAttr("title")},
_updateTooltipsState:function(){var a,b=this;this.tooltips&&this._isVisible?this._showingTips||(this._showingTips=!0,a=this.getIceNodes(),a.each(function(a,c){b._addTooltip(c)})):this._showingTips&&(this._showingTips=!1,a=this.getIceNodes(),a.each(function(a,b){e(b).unbind("mouseover").unbind("mouseout")}))},_addTooltip:function(a){e(a).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(a){var b=a.currentTarget,c=e(b),
g=this;c.data("_tooltip_t")||(a=setTimeout(function(){var a=g.currentChangeNode(b),h=a&&a.getAttribute(g.attributes.changeId),e=h&&g.getChange(h);e&&(a=ice.dom.hasClass(a,g._getIceNodeClass("insertType"))?"insert":"delete",c.removeData("_tooltip_t"),g.hostMethods.showTooltip(b,{userName:e.username,changeId:h,userId:e.userid,time:e.time,lastTime:e.lastTime,type:a}))},this.tooltipsDelay),c.data("_tooltip_t",a))},_tooltipMouseOut:function(a){var a=a.currentTarget,b=e(a),c=b.data("_tooltip_t");b.removeData("_tooltip_t");
c?clearTimeout(c):this.hostMethods.hideTooltip(a)},_removeTrackingInRangeOld:function(a){var b=this._getIceNodeClass("insertType"),c=this._getIceNodeClass("deleteType"),g="."+b+",."+c;a.getNodes(null,function(a){var b=null;a.nodeType==ice.dom.TEXT_NODE?b=e(a).parents(g):(a=e(a),b=a.is(g)?a:a.parents(g));return(a=b&&b[0])?(a.setAttribute("data-ice-class",a.className),a.setAttribute("class","ice-no-decoration"),!0):!1});var h=this.element;setTimeout(function(){e(h).find("[data-ice-class]").each(function(a,
b){var c=b.getAttribute("data-ice-class");c&&(b.setAttribute("class",c),b.removeAttribute("data-ice-class"))})},10)},_removeTrackingInRange:function(a){var b=this._getIceNodeClass("insertType"),c=this._getIceNodeClass("deleteType"),g="."+b+",."+c,j=this._savedNodesMap,k=Date.now()%1E6;a.getNodes(null,function(a){var b=null;a.nodeType==ice.dom.TEXT_NODE?b=e(a).parents(g):(a=e(a),b=a.is(g)?a:a.parents(g));if(a=b&&b[0]){for(var c=a.attributes,d,f=c&&c.length,b={},h=0;h<f;++h)d=c[h],b[d.name]=d.value;
d=a.className;c=""+k++;j[c]={attributes:b,className:d};a:{var b=null,l;try{for(;0<a.attributes.length;){l=a.attributes[0];if(l===b)break a;b=l;a.removeAttribute(l.name)}}catch(p){}}a.setAttribute("data-ice-class",c);a.setAttribute("class","ice-no-decoration");return!0}return!1});var l=this.element;setTimeout(function(){e(l).find("[data-ice-class]").each(function(a,b){var c=b.getAttribute("data-ice-class"),d=j[c];c?(delete j[c],Object.keys(d.attributes).forEach(function(a){b.setAttribute(a,d.attributes[a])}),
b.setAttribute("class",d.className),b.removeAttribute("data-ice-class")):h("missing save data for node")})},10)},getAdjacentChangeId:function(a,b){var c=b?ice.dom.getNextNode(a):ice.dom.getPrevNode(a),g,h=null;g=this._getIceNode(c,"insertType")||this._getIceNode(c,"deleteType");if(!g&&(this._isInsertNode(c)||this._isDeleteNode(c)))g=c;g&&this._isCurrentUserIceNode(g)&&(h=ice.dom.attr(g,this.attributes.changeId));return h}};var g=window&&window.console||{log:function(){},error:function(){},info:function(){},
assert:function(){},count:function(){}},h=null;this.ice=this.ice||{};this.ice.printRange=function(a,b){function c(a){if(!a)return"";a=a.replace("/\n/g","\\n").replace("/\r/g","").replace("​","{filler}").replace("﻿","{filler}");return 15>=a.length?a:a.substring(0,5)+"..."+a.substring(a.length-5)}function h(a){if(3===a.nodeType)a="Text:"+c(a.nodeValue);else var b=a.innerText,a=a.nodeName+(b?"("+c(b)+")":"");j.push("<"+a+" />")}function e(a,b,g){"number"!=typeof g&&(g=-1);if(3==a.nodeType)a=a.nodeValue,
j.push(c(a.substring(0,b))),j.push("|"),g>b?(j.push(c(a.substring(b,g))),j.push("|"),j.push(c(a.substring(g)))):j.push(c(a.substring(b)));else if(1==a.nodeType){var f=0,k=a.childNodes;h(a);for(f=0;f<b;++f)h(k[f]);j.push("|");if(g>b){for(f=b;f<g;++f)h(k[f]);j.push("|")}if(0<g&&g<k.length)for(b=k[g];b;)h(b),b=b.nextSibling}}if(a&&a.startContainer&&a.endContainer){var j=[];a.startContainer===a.endContainer?e(a.startContainer,a.startOffset,a.endOffset):(e(a.startContainer,a.startOffset),e(a.endContainer,
a.endOffset));var k=j.join(" ");b&&g.log(b+":"+k);return k}};this.ice.InlineChangeEditor=q}).call(this,window.jQuery);
(function(e){function l(b){if(!b)return!0;for(var c=b.length-1,h;0<=c;)if(h=b[c--],"​"!==h&&"﻿"!==h)return!1;return!0}function m(b,g){for(;b;){if(c.TEXT_NODE==b.nodeType)return b;for(var h=b.firstChild;h;h=h.nextSibling){var a=m(h,g);if(a)return a}if(c.isTextContainer(b))return b;b=b.nextSibling}return null}function j(b,g){for(;b;){if(c.TEXT_NODE==b.nodeType)return b;for(var h=b.lastChild;h;h=h.previousSibling){var a=j(h,g);if(a)return a}if(c.isTextContainer(b))return b;b=b.previousSibling}return null}
function k(b){if(b)for(var c=b.firstChild;c;){if(1==c.nodeType)k(c);else if(3==c.nodeType)for(var h;(h=c.nextSibling)&&3==h.nodeType;){var a=h.nodeValue;null!=a&&a.length&&(c.nodeValue+=a);b.removeChild(h)}c=c.nextSibling}}var c={},p=null,u=/^\s*$/,q=/^\d+$/;c.DOM_VK_DELETE=8;c.DOM_VK_LEFT=37;c.DOM_VK_UP=38;c.DOM_VK_RIGHT=39;c.DOM_VK_DOWN=40;c.DOM_VK_ENTER=13;c.ELEMENT_NODE=1;c.ATTRIBUTE_NODE=2;c.TEXT_NODE=3;c.CDATA_SECTION_NODE=4;c.ENTITY_REFERENCE_NODE=5;c.ENTITY_NODE=6;c.PROCESSING_INSTRUCTION_NODE=
7;c.COMMENT_NODE=8;c.DOCUMENT_NODE=9;c.DOCUMENT_TYPE_NODE=10;c.DOCUMENT_FRAGMENT_NODE=11;c.NOTATION_NODE=12;c.CHARACTER_UNIT="character";c.WORD_UNIT="word";c.BREAK_ELEMENT="br";c.PARAGRAPH_ELEMENT="p";c.CONTENT_STUB_ELEMENTS="img hr iframe param link meta input frame col base area".split(" ");c.BLOCK_ELEMENTS="body p div pre ul ol li table tbody td th fieldset form blockquote dl dt dd dir center address h1 h2 h3 h4 h5 h6".split(" ");c.TEXT_CONTAINER_ELEMENTS="body p div pre span b strong i li td th blockquote dt dd center address h1 h2 h3 h4 h5 h6 ins del".split(" ");
c.STUB_ELEMENTS=c.CONTENT_STUB_ELEMENTS.slice();c.STUB_ELEMENTS.push(c.BREAK_ELEMENT);var z=c.CONTENT_STUB_ELEMENTS.join(", ");c.getKeyChar=function(b){return String.fromCharCode(b.which)};c.getClass=function(b,c,h){c||(c=document.body);b="."+b.split(" ").join(".");h&&(b=h+b);return e.makeArray(e(c).find(b))};c.getId=function(b,c){c||(c=document);return element=c.getElementById(b)};c.getTag=function(b,c){c||(c=document);return e.makeArray(e(c).find(b))};c.getElementWidth=function(b){return b.offsetWidth};
c.getElementHeight=function(b){return b.offsetHeight};c.getElementDimensions=function(b){return{width:c.getElementWidth(b),height:c.getElementHeight(b)}};c.empty=function(b){if(b)return e(b).empty()};c.remove=function(b){if(b)return e(b).remove()};c.prepend=function(b,c){e(b).prepend(c)};c.append=function(b,c){e(b).append(c)};c.insertBefore=function(b,c){e(b).before(c)};c.insertAfter=function(b,c){if(b&&c){var h=b.nextSibling,a=b.parentNode;return h?a.insertBefore(c,h):a.appendChild(c)}};c.getHtml=
function(b){return e(b).html()};c.setHtml=function(b,c){b&&e(b).html(c)};c.removeWhitespace=function(b){e(b).contents().filter(function(){return this.nodeType!=ice.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(c.removeWhitespace(this),!1):this.nodeType!=ice.dom.TEXT_NODE?!1:!/\S/.test(this.nodeValue)}).remove()};c.contents=function(b){return e.makeArray(e(b).contents())};c.extractContent=function(b){for(var c=document.createDocumentFragment(),h;h=b.firstChild;)c.appendChild(h);return c};
c.getNode=function(b,g){if(!b)return null;b=b.$||b;return b.nodeType!=c.TEXT_NODE&&c.is(b,g)?b:c.parents(b,g)[0]||null};c.getParents=function(b,c,h){for(var b=e(b).parents(c),c=b.length,a=[],f=0;f<c&&b[f]!==h;f++)a.push(b[f]);return a};c.hasBlockChildren=function(b){for(var g=b.childNodes.length,h=0;h<g;h++)if(b.childNodes[h].nodeType===c.ELEMENT_NODE&&!0===c.isBlockElement(b.childNodes[h]))return!0;return!1};c.removeTag=function(b,c){e(b).find(c).replaceWith(function(){return e(this).contents()});
return b};c.stripEnclosingTags=function(b,c){var h=e(b);h.find("*").not(c).replaceWith(function(){var a=e(),b;try{b=e(this),a=b.contents()}catch(c){}0===a.length&&b.remove();return a});return h[0]};c.getSiblings=function(b,c,h,a){if(!0===h)return"prev"===c?e(b).prevAll():e(b).nextAll();h=[];if("prev"===c)for(;b.previousSibling;){b=b.previousSibling;if(b===a)break;h.push(b)}else for(;b.nextSibling;){b=b.nextSibling;if(b===a)break;h.push(b)}return h};c.getNodeTextContent=function(b){return e(b).text()};
c.getNodeStubContent=function(b){return e(b).find(z)};c.hasNoTextOrStubContent=function(b){var g=c.getNodeTextContent(b);return!l(g)?!1:!b.firstChild?!0:0===e(b).find(z).length};c.isEmptyTextNode=function(b){return!b||c.TEXT_NODE!==b.nodeType?!1:0===b.length?!0:l(b.nodeValue)};c.getNodeCharacterLength=function(b){return c.getNodeTextContent(b).length+e(b).find(c.STUB_ELEMENTS.join(", ")).length};c.setNodeTextContent=function(b,c){return e(b).text(c)};c.getTagName=function(b){return b&&b.tagName&&
b.tagName.toLowerCase()||null};c.getIframeDocument=function(b){var c=null;b.contentDocument?c=b.contentDocument:b.contentWindow?c=b.contentWindow.document:b.document&&(c=b.document);return c};c.isBlockElement=function(b){return-1!=c.BLOCK_ELEMENTS.indexOf(b.nodeName.toLowerCase())};c.isStubElement=function(b){return-1!=c.STUB_ELEMENTS.indexOf(b.nodeName.toLowerCase())};c.removeBRFromChild=function(b){if(b&&b.hasChildNodes())for(var c=0;c<b.childNodes.length;c++){var h=b.childNodes[c];h&&ice.dom.BREAK_ELEMENT==
ice.dom.getTagName(h)&&h.parentNode.removeChild(h)}};c.isChildOf=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode===c)return!0;b=b.parentNode}}catch(h){}return!1};c.isChildOfTagName=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName&&b.parentNode.tagName.toLowerCase()===c)return b.parentNode;b=b.parentNode}}catch(h){}return!1};c.isChildOfTagNames=function(b,c){try{for(;b&&b.parentNode;){if(b.parentNode&&b.parentNode.tagName){tagName=b.parentNode.tagName.toLowerCase();
for(var h=0;h<c.length;h++)if(tagName===c[h])return b.parentNode}b=b.parentNode}}catch(a){}return null};c.isChildOfClassName=function(b,c){try{for(;b&&b.parentNode;){if(e(b.parentNode).hasClass(c))return b.parentNode;b=b.parentNode}}catch(h){}return null};c.cloneNode=function(b,c){void 0===c&&(c=!0);return e(b).clone(c)};c.bind=function(b,c,h){return e(b).bind(c,h)};c.unbind=function(b,c,h){return e(b).unbind(c,h)};c.attr=function(b,c,h){return h?e(b).attr(c,h):e(b).attr(c)};c.replaceWith=function(b,
c){return e(b).replaceWith(c)};c.removeAttr=function(b,c){e(b).removeAttr(c)};c.getElementsBetween=function(b,g){var h=[];if(b===g)return h;if(!0===c.isChildOf(g,b)){for(var a=b.childNodes.length,f=0;f<a&&b.childNodes[f]!==g;f++){if(!0===c.isChildOf(g,b.childNodes[f]))return c.arrayMerge(h,c.getElementsBetween(b.childNodes[f],g));h.push(b.childNodes[f])}return h}for(a=b.nextSibling;a;){if(!0===c.isChildOf(g,a))return h=c.arrayMerge(h,c.getElementsBetween(a,g));if(a===g)return h;h.push(a);a=a.nextSibling}for(var a=
c.getParents(b),f=c.getParents(g),a=c.arrayDiff(a,f,!0),f=a.length,d=0;d<f-1;d++)h=c.arrayMerge(h,c.getSiblings(a[d],"next"));return h=c.arrayMerge(h,c.getElementsBetween(a[a.length-1],g))};c.getCommonAncestor=function(b,g){for(var h=b;h;){if(!0===c.isChildOf(g,h))return h;h=h.parentNode}return null};c.getNextNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.nextSibling){if(b.nextSibling.nodeType===c.TEXT_NODE&&0===b.nextSibling.length){b=b.nextSibling;continue}return c.getFirstChild(b.nextSibling)}b=
b.parentNode}return null};c.getNextContentNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.nextSibling&&c.canContainTextElement(c.getBlockParent(b))){if(b.nextSibling.nodeType===c.TEXT_NODE&&0===b.nextSibling.length){b=b.nextSibling;continue}return b.nextSibling}if(b.nextElementSibling)return b.nextElementSibling;b=b.parentNode}return null};c.getPrevNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.previousSibling){if(b.previousSibling.nodeType===c.TEXT_NODE&&0===b.previousSibling.length){b=
b.previousSibling;continue}return c.getLastChild(b.previousSibling)}b=b.parentNode}return null};c.getPrevContentNode=function(b,g){if(b)for(;b.parentNode&&b!==g;){if(b.previousSibling&&c.canContainTextElement(c.getBlockParent(b))){if(b.previousSibling.nodeType===c.TEXT_NODE&&0===b.previousSibling.length){b=b.previousSibling;continue}return b.previousSibling}if(b.previousElementSibling)return b.previousElementSibling;b=b.parentNode}return null};c.findPrevTextContainer=function(b,g){if(!b||b==g)return{node:g,
offset:0};if(b.parentNode&&c.isTextContainer(b.parentNode))return{node:b.parentNode,offset:c.getNodeIndex(b)};for(;b.previousSibling;){var h=j(b.previousSibling);if(h)return{node:h,offset:c.getNodeLength(h)};b=b.previousSibling}return c.findPrevTextContainer(b.parentNode&&b.parentNode.previousSibling,g)};c.findNextTextContainer=function(b,g){if(!b||b==g)return{node:g,offset:c.getNodeLength(g)};if(b.parentNode&&c.isTextContainer(b.parentNode))return{node:b.parentNode,offset:c.getNodeIndex(b)+1};for(;b.nextSibling;){var h=
m(b.nextSibling);if(h)return{node:h,offset:0};b=b.previousSibling}return c.findNextTextContainer(b.parentNode&&b.parentNode.nextSibling,g)};c.getNodeLength=function(b){return b?c.TEXT_NODE==b.nodeType?b.length:b.childNodes&&b.childNodes.length||0:0};c.isTextContainer=function(b){return b&&c.TEXT_NODE==b.nodeType||0<=c.TEXT_CONTAINER_ELEMENTS.indexOf((b.nodeName||"").toLowerCase())};c.getNodeIndex=function(b){for(var c=0;b=b.previousSibling;)++c;return c};c.canContainTextElement=function(b){return b&&
b.nodeName?-1!=c.TEXT_CONTAINER_ELEMENTS.lastIndexOf(b.nodeName.toLowerCase()):!1};c.getFirstChild=function(b){return b.firstChild?b.firstChild.nodeType===c.ELEMENT_NODE?c.getFirstChild(b.firstChild):b.firstChild:b};c.getLastChild=function(b){return b.lastChild?b.lastChild.nodeType===c.ELEMENT_NODE?c.getLastChild(b.lastChild):b.lastChild:b};c.removeEmptyNodes=function(b,g){for(var h=e(b).find(":empty"),a=h.length;0<a;)a--,!1===c.isStubElement(h[a])&&(!g||!1!==g.call(this,h[a]))&&c.remove(h[a])};c.create=
function(b){return e(b)[0]};c.find=function(b,c){return e(b).find(c)};c.children=function(b,c){return e(b).children(c)};c.parent=function(b,c){return e(b).parent(c)[0]};c.parents=function(b,c){return e(b).parents(c)};c.is=function(b,c){return e(b).is(c)};c.extend=function(b,c,h,a){return e.extend.apply(this,arguments)};c.walk=function(b,g,h){b&&(h||(h=0),!1!==g.call(this,b,h)&&(b.childNodes&&0<b.childNodes.length?c.walk(b.firstChild,g,h+1):b.nextSibling?c.walk(b.nextSibling,g,h):b.parentNode&&b.parentNode.nextSibling&&
c.walk(b.parentNode.nextSibling,g,h-1)))};c.revWalk=function(b,g){b&&!1!==g.call(this,b)&&(b.childNodes&&0<b.childNodes.length?c.walk(b.lastChild,g):b.previousSibling?c.walk(b.previousSibling,g):b.parentNode&&b.parentNode.previousSibling&&c.walk(b.parentNode.previousSibling,g))};c.setStyle=function(b,c,h){b&&e(b).css(c,h)};c.getStyle=function(b,c){return e(b).css(c)};c.hasClass=function(b,c){return e(b).hasClass(c)};c.addClass=function(b,c){e(b).addClass(c)};c.removeClass=function(b,c){e(b).removeClass(c)};
c.preventDefault=function(b){b.preventDefault();c.stopPropagation(b)};c.stopPropagation=function(b){b.stopPropagation()};c.each=function(b,c){e.each(b,function(b,a){c.call(this,b,a)})};c.foreach=function(b,c){var h,a;if(b instanceof Array||b instanceof NodeList||"undefined"!=typeof b.length&&"undefined"!=typeof b.item){a=b.length;for(var f=0;f<a&&!(h=c.call(this,f,b[f]),!1===h);f++);}else for(a in b)if(!0===b.hasOwnProperty(a)&&(h=c.call(this,a),!1===h))break};c.isBlank=function(b){return!b||u.test(b)};
c.isFn=function(b){return"function"===typeof b};c.isObj=function(b){return null!==b&&"object"===typeof b};c.isset=function(b){return"undefined"!==typeof b&&null!==b};c.isArray=function(b){return e.isArray(b)};c.isNumeric=function(b){return null!==b.match(q)};c.getUniqueId=function(){var b=(new Date).getTime(),c=Math.ceil(1E6*Math.random());return(b+""+c).substr(5,18).replace(/,/,"")};c.inArray=function(b,c){for(var h=c.length,a=0;a<h;a++)if(b===c[a])return!0;return!1};c.arrayDiff=function(b,g,h){var a=
b.length,f,d=[];for(f=0;f<a;f++)!1===c.inArray(b[f],g)&&d.push(b[f]);if(!0!==h){a=g.length;for(f=0;f<a;f++)!1===c.inArray(g[f],b)&&d.push(g[f])}return d};c.arrayMerge=function(b,c){var h=c.length,a;for(a=0;a<h;a++)b.push(c[a]);return b};c.stripTags=function(b,g){if("string"===typeof g){var h=e("<div>"+b+"</div>");h.find("*").not(g).remove();return h.html()}for(var a=RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),f=b;null!=(h=a.exec(b));)if(!1===c.isset(g)||!0!==c.inArray(h[1],
g))f=f.replace(h[0],"");return f};c.browser=function(){if(p)return e.extend({},p);var b,c,h=navigator.userAgent.toLowerCase();b=h.toLowerCase();c=/(chrome)[ \/]([\w.]+)/.exec(b)||/(webkit)[ \/]([\w.]+)/.exec(b)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(b)||/(msie) ([\w.]+)/.exec(b)||0>b.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(b)||[];b=c[1]||"";c=c[2]||"0";var a={type:"unknown",version:0,msie:!1};b&&(a[b]=!0,a.version=c||0,a.type=b);a.chrome?a.webkit=!0:a.webkit&&(a.safari=!0);
a.webkit&&(a.type="webkit");a.firefox=!0==/firefox/.test(h);a.msie||(a.msie=!!/trident/.test(h));p=a;return e.extend({},p)};c.getBrowserType=function(){if(null===this._browserType){for(var b=["msie","firefox","chrome","safari"],c=b.length,h=0;h<c;h++)if(!0===RegExp(b[h],"i").test(navigator.userAgent))return this._browserType=b[h];this._browserType="other"}return this._browserType};c.getWebkitType=function(){return"webkit"!==c.browser().type?(console.log("Not a webkit!"),!1):0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")?
"safari":"chrome"};c.isBrowser=function(b){return c.browser().type===b};c.getBlockParent=function(b,g){if(!0===c.isBlockElement(b))return b;if(b)for(;b.parentNode;){b=b.parentNode;if(!0===c.isBlockElement(b))return b;if(b===g)break}return null};c.findNodeParent=function(b,g,h){if(b)for(;b.parentNode&&b!==h;){if(!0===c.is(b,g))return b;b=b.parentNode}return null};c.onBlockBoundary=function(b,g,h){if(!b||!g)return!1;b=c.isChildOfTagNames(b,h)||c.is(b,h.join(", "))&&b||null;g=c.isChildOfTagNames(g,h)||
c.is(g,h.join(", "))&&g||null;return b!==g};c.isOnBlockBoundary=function(b,g,h){if(!b||!g)return!1;b=c.getBlockParent(b,h)||c.isBlockElement(b,h)&&b||null;g=c.getBlockParent(g,h)||c.isBlockElement(g,h)&&g||null;return b!==g};c.mergeContainers=function(b,g){if(!b||!g)return!1;if(b.nodeType===c.TEXT_NODE||c.isStubElement(b))g.appendChild(b);else if(b.nodeType===c.ELEMENT_NODE){for(;b.firstChild;)g.appendChild(b.firstChild);c.remove(b)}return!0};c.mergeBlockWithSibling=function(b,g,h){var a=h?e(g).next().get(0):
e(g).prev().get(0);h?c.mergeContainers(a,g):c.mergeContainers(g,a);b.collapse(!0);return!0};c.date=function(b,g,h){if(null===g&&h&&(g=c.tsIso8601ToTimestamp(h),!g))return;for(var g=new Date(g),b=b.split(""),h=b.length,a="",f=0;f<h;f++){var d="",e=b[f];switch(e){case "D":case "l":d="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" ")[g.getDay()];"D"===e&&(d=d.substring(0,3));break;case "F":case "m":d=g.getMonth()+1;10>d&&(d="0"+d);break;case "M":months="January February March April May June July August September October November December".split(" ");
d=months[g.getMonth()];"M"===e&&(d=d.substring(0,3));break;case "d":d=g.getDate();break;case "S":d=c.getOrdinalSuffix(g.getDate());break;case "Y":d=g.getFullYear();break;case "y":d=g.getFullYear();d=d.toString().substring(2);break;case "H":d=g.getHours();break;case "h":d=g.getHours();0===d?d=12:12<d&&(d-=12);break;case "i":d=c.addNumberPadding(g.getMinutes());break;case "a":d="am";12<=g.getHours()&&(d="pm");break;default:d=e}a+=d}return a};c.getOrdinalSuffix=function(b){var c="",c=b%100;if(4<=c&&
20>=c)c="th";else switch(b%10){case 1:c="st";break;case 2:c="nd";break;case 3:c="rd";break;default:c="th"}return c};c.addNumberPadding=function(b){10>b&&(b="0"+b);return b};c.tsIso8601ToTimestamp=function(b){if(b=b.match(RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/))){var c=new Date;c.setDate(b[3]);c.setFullYear(b[1]);c.setMonth(b[2]-1);c.setHours(b[4]);c.setMinutes(b[5]);c.setSeconds(b[6]);var h=60*b[9];"+"===
b[8]&&(h*=-1);h-=c.getTimezoneOffset();return c.getTime()+6E4*h}return null};c.normalizeNode=function(b,c){if(b)return!0!==c&&"function"==typeof b.normalize?b.normalize():k(b)};this.dom=c}).call(this.ice,window.jQuery);
(function(){var e;e=function(e){this._selection=null;this.env=e;this._initializeRangeLibrary();this._getSelection()};e.prototype={_getSelection:function(){this._selection?this._selection.refresh():this._selection=this.env.frame?rangy.getSelection(this.env.frame):rangy.getSelection();return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(e){try{return this._selection.refresh(),this._selection.getRangeAt(e)}catch(m){this._selection=null;try{return this._getSelection().getRangeAt(0)}catch(j){}}return null},
addRange:function(e){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(e);this._selection.ranges=[e]},_initializeRangeLibrary:function(){var e=this;rangy.init();rangy.config.checkSelectionRanges=!1;var m=function(e,k,c,l){if(0!==c){var m=e.collapsed;switch(k){case ice.dom.CHARACTER_UNIT:0<c?e.moveCharRight(l,c):e.moveCharLeft(l,-1*c)}m&&e.collapse(l)}};rangy.rangePrototype.moveStart=function(e,k){m(this,e,k,!0)};rangy.rangePrototype.moveEnd=function(e,k){m(this,
e,k,!1)};rangy.rangePrototype.setRange=function(e,k,c){e?this.setStart(k,c):this.setEnd(k,c)};rangy.rangePrototype.moveCharLeft=function(e,k){var c,l;e?(c=this.startContainer,l=this.startOffset):(c=this.endContainer,l=this.endOffset);if(c.nodeType===ice.dom.ELEMENT_NODE)if(c.hasChildNodes()&&0<l){c=c.childNodes[l-1];c=(l=this.getLastSelectableChild(c))?l:this.getPreviousTextNode(c);if(!c)return;l=c.data.length-k}else l=-1*k;else l-=k;if(0>l)for(;0>l;){c=this.getPreviousTextNode(c);if(!c)return;c.nodeType!==
ice.dom.ELEMENT_NODE&&(l+=c.data.length)}this.setRange(e,c,l)};rangy.rangePrototype.moveCharRight=function(e,k){var c,l;e?(c=this.startContainer,l=this.startOffset):(c=this.endContainer,l=this.endOffset);c.nodeType===ice.dom.ELEMENT_NODE?(c=(l=this.getNextTextNode(c.childNodes[Math.min(l,c.childNodes.length-1)]))?l:this.getNextTextNode(c),l=k):l+=k;if(c){var m=l-c.data.length;if(0<m){for(;0<m;){c=this.getNextContainer(c);if(!c)return;if(c.nodeType!==ice.dom.ELEMENT_NODE)if(c.data.length>=m)break;
else 0<c.data.length&&(m-=c.data.length)}l=m}this.setRange(e,c,l)}};rangy.rangePrototype.getNextContainer=function(e,k){if(!e)return null;for(k=k||[];e.nextSibling;)if(e=e.nextSibling,e.nodeType!==ice.dom.TEXT_NODE){var c=this.getFirstSelectableChild(e);if(null!==c)return c}else if(!0===this.isSelectable(e))return e;for(;e&&!e.nextSibling;)e=e.parentNode;if(!e)return null;e=e.nextSibling;if(!0===this.isSelectable(e))return e;!0===ice.dom.isBlockElement(e)&&k.push(e);c=this.getFirstSelectableChild(e);
return null!==c?c:this.getNextContainer(e,k)};rangy.rangePrototype.getPreviousContainer=function(e,k){if(!e)return null;for(k=k||[];e.previousSibling;)if(e=e.previousSibling,e.nodeType!==ice.dom.TEXT_NODE){if(!0===ice.dom.isStubElement(e))return e;var c=this.getLastSelectableChild(e);if(null!==c)return c}else if(!0===this.isSelectable(e))return e;for(;e&&!e.previousSibling;)e=e.parentNode;if(!e)return null;e=e.previousSibling;if(!0===this.isSelectable(e))return e;!0===ice.dom.isBlockElement(e)&&k.push(e);
c=this.getLastSelectableChild(e);return null!==c?c:this.getPreviousContainer(e,k)};rangy.rangePrototype.getNextTextNode=function(e){if(e.nodeType===ice.dom.ELEMENT_NODE&&e.firstChild){var k=this.getFirstSelectableChild(e);if(k)return k}e=this.getNextContainer(e);return!e?null:e.nodeType===ice.dom.TEXT_NODE?e:this.getNextTextNode(e)};rangy.rangePrototype.getPreviousTextNode=function(e,k){e=this.getPreviousContainer(e,k);return!e?null:e.nodeType===ice.dom.TEXT_NODE?e:this.getPreviousTextNode(e,k)};
rangy.rangePrototype.getFirstSelectableChild=function(e){if(!e)return null;if(e.nodeType===ice.dom.TEXT_NODE)return e;for(e=e.firstChild;e;){if(!0===this.isSelectable(e))return e;if(e.firstChild){var k=this.getFirstSelectableChild(e);if(null!==k)return k}e=e.nextSibling}return null};rangy.rangePrototype.getLastSelectableChild=function(e){if(!e)return null;if(e.nodeType==ice.dom.TEXT_NODE)return e;for(e=e.lastChild;e;){if(!0===this.isSelectable(e))return e;if(e.lastChild){var k=this.getLastSelectableChild(e);
if(null!==k)return k}e=e.previousSibling}return null};rangy.rangePrototype.isSelectable=function(e){return Boolean(e&&e.nodeType===ice.dom.TEXT_NODE&&0!==e.data.length)};rangy.rangePrototype.getHTMLContents=function(j){j||(j=this.cloneContents());var k=e.env.document.createElement("div");k.appendChild(j.cloneNode(!0));return k.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};this.Selection=e}).call(this.ice);
(function(){var e;e=function(e,m,j){this.env=e;this.element=e.element;this.selection=this.env.selection;j||this.removeBookmarks(this.element);var e=m||this.selection.getRangeAt(0),m=e.cloneRange(),k=m.startContainer,c=m.startOffset,p;m.collapse(!1);j=this.env.document.createElement("span");j.style.display="none";ice.dom.setHtml(j,"&nbsp;");ice.dom.addClass(j,"iceBookmark iceBookmark_end");j.setAttribute("iceBookmark","end");m.insertNode(j);ice.dom.isChildOf(j,this.element)||this.element.appendChild(j);
m.setStart(k,c);m.collapse(!0);k=this.env.document.createElement("span");k.style.display="none";ice.dom.addClass(k,"iceBookmark iceBookmark_start");ice.dom.setHtml(k,"&nbsp;");k.setAttribute("iceBookmark","start");try{m.insertNode(k),k.previousSibling===j&&(p=k,k=j,j=p)}catch(u){ice.dom.insertBefore(j,k)}!1===ice.dom.isChildOf(k,this.element)&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,k):this.element.appendChild(k));j.previousSibling||(p=this.env.document.createTextNode(""),
ice.dom.insertBefore(j,p));k.nextSibling||(p=this.env.document.createTextNode(""),ice.dom.insertAfter(k,p));e.setStart(k.nextSibling,0);e.setEnd(j.previousSibling,j.previousSibling.length||0);this.start=k;this.end=j};e.prototype={selectBookmark:function(){var e=this.selection.getRangeAt(0),m=null,j=null,k=0,c=null,p=this.start&&this.start.parentNode;this.start.nextSibling===this.end||0===ice.dom.getElementsBetween(this.start,this.end).length?this.end.nextSibling?m=ice.dom.getFirstChild(this.end.nextSibling):
this.start.previousSibling?(m=ice.dom.getFirstChild(this.start.previousSibling),m.nodeType===ice.dom.TEXT_NODE&&(k=m.length)):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),m=ice.dom.getFirstChild(this.end.nextSibling)):(this.start.nextSibling?m=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(m=this.env.document.createTextNode(""),ice.dom.insertBefore(this.start,m)),m=ice.dom.getLastChild(this.start.previousSibling),k=m.length),this.end.previousSibling)?
j=ice.dom.getLastChild(this.end.previousSibling):(j=ice.dom.getFirstChild(this.end.nextSibling||this.end),c=0);ice.dom.remove([this.start,this.end]);try{ice.dom.normalize(p)}catch(u){}null===j?(e.setEnd(m,k),e.collapse(!1)):(e.setStart(m,k),null===c&&(c=j.length||0),e.setEnd(j,c));try{this.selection.addRange(e)}catch(q){}},getBookmark:function(e,m){return ice.dom.getClass("iceBookmark_"+m,e)[0]},removeBookmarks:function(e){ice.dom.remove(ice.dom.getClass("iceBookmark",e,"span"))}};this.Bookmark=e}).call(this.ice);
var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking",CHANGE:"lite:change",HOVER_IN:"lite:hover-in",HOVER_OUT:"lite:hover-out"},Commands:{TOGGLE_TRACKING:"lite-toggletracking",TOGGLE_SHOW:"lite-toggleshow",ACCEPT_ALL:"lite-acceptall",REJECT_ALL:"lite-rejectall",ACCEPT_ONE:"lite-acceptone",REJECT_ONE:"lite-rejectone",TOGGLE_TOOLTIPS:"lite-toggletooltips"}};